<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0038)https://nixos.org/manual/nixos/stable/ -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
 <title>NixOS Manual</title>
<style class="anchorjs"></style><link rel="stylesheet" type="text/css" href="./NixOS Manual_files/style.css"><link rel="stylesheet" type="text/css" href="./NixOS Manual_files/mono-blue.css">
<script src="./NixOS Manual_files/highlight.pack.js" type="text/javascript"></script><script src="./NixOS Manual_files/loader.js" type="text/javascript"></script><script src="./NixOS Manual_files/anchor.min.js" type="text/javascript"></script><script src="./NixOS Manual_files/anchor-use.js" type="text/javascript"></script>
 <meta name="generator" content="nixos-render-docs 23.11pre-git">
 <link rel="home" href="https://nixos.org/manual/nixos/stable/index.html" title="NixOS Manual">
 <link rel="next" href="https://nixos.org/manual/nixos/stable/options.html" title="Appendix A. Configuration Options">
   <link rel="canonical" url="">
</head>
 <body data-nixos-channels="[{&quot;channel&quot;:&quot;unstable&quot;,&quot;version&quot;:&quot;24.05&quot;},{&quot;channel&quot;:&quot;stable&quot;,&quot;version&quot;:&quot;23.11&quot;}]" class="vsc-initialized">
  <div class="navheader">
   <table width="100%" summary="Navigation header">
    <tbody><tr>
    <th colspan="3" align="center">NixOS Manual</th>
    </tr>
    <tr>
    <td width="20%" align="left">&nbsp;</td>
    <th width="60%" align="center">&nbsp;</th>
    <td width="20%" align="right">&nbsp;<a accesskey="n" href="https://nixos.org/manual/nixos/stable/options">Next</a></td>
    </tr>
   </tbody></table>
   <hr>
  </div>
 <div class="book">
  <div class="titlepage">
   <div>
   <div><h1 class="title"><a id="book-nixos-manual"></a>NixOS Manual</h1></div>
   <div><h2 class="subtitle">Version 23.11</h2></div>
   </div>
   <hr>
  </div>
<div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="preface">  <a href="https://nixos.org/manual/nixos/stable/#preface">Preface</a> </span></dt><dt> <span class="part">  <a href="https://nixos.org/manual/nixos/stable/#ch-installation">Installation</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-obtaining">Obtaining NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation">Installing NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-changing-config">Changing the Configuration</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-upgrading">Upgrading NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-image">Building a NixOS (Live) ISO</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-image-repart">Building Images via <code class="literal">systemd-repart</code></a> </span></dt></dl></dd><dt> <span class="part">  <a href="https://nixos.org/manual/nixos/stable/#ch-configuration">Configuration</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax">Configuration Syntax</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-package-management">Package Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-user-management">User Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-file-systems">File Systems</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11">X Window System</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-wayland">Wayland</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel">GPU acceleration</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-xfce">Xfce Desktop Environment</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-networking">Networking</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-kernel-config">Linux Kernel</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-subversion">Subversion</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-pantheon">Pantheon Desktop</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-gnome">GNOME Desktop</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-bootloader-external">External Bootloader Backends</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-garage">Garage</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-plausible">Plausible</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs">Pict-rs</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud">Nextcloud</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo">Matomo</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-lemmy">Lemmy</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak">Keycloak</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-meet">Jitsi Meet</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-honk">Honk</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-grocy">Grocy</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gotosocial">GoToSocial</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse">Discourse</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-c2fmzq">c2FmZQ</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-akkoma">Akkoma</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch">Meilisearch</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil">Yggdrasil</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prosody">Prosody</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma">Pleroma</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto">Mosquitto</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver">Firefox Sync server</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-litestream">Litestream</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters">Prometheus exporters</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc">parsedmarc</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-ocsinventory-agent">OCS Inventory Agent</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-goss">Goss</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-certspotter">Cert Spotter</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-weechat">WeeChat</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver">Taskserver</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut">Sourcehut</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gitlab">GitLab</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-forgejo">Forgejo</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka">Apache Kafka</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matrix">Matrix</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir">Mjolnir (Matrix Moderation Tool)</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mailman">Mailman</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#trezor">Trezor</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs">Emacs</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-livebook">Livebook</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-blackfire">Blackfire profiler</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-flatpak">Flatpak</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-postgresql">PostgreSQL</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb">FoundationDB</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-borgbase">BorgBackup</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-castopod">Castopod</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme">SSL/TLS Certificates with ACME</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-zsh-ohmyzsh">Oh my ZSH</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-program-plotinus">Plotinus</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-digitalbitbox">Digital Bitbox</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods">Input Methods</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-profiles">Profiles</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-kubernetes">Kubernetes</a> </span></dt></dl></dd><dt> <span class="part">  <a href="https://nixos.org/manual/nixos/stable/#ch-running">Administration</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-systemctl">Service Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-rebooting">Rebooting and Shutting Down</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-user-sessions">User Sessions</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-cgroups">Control Groups</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-logging">Logging</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-nix-gc">Cleaning the Nix Store</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-containers">Container Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-troubleshooting">Troubleshooting</a> </span></dt></dl></dd><dt> <span class="part">  <a href="https://nixos.org/manual/nixos/stable/#ch-development">Development</a> </span></dt><dd><dl><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-getting-sources">Getting the Sources</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-modules">Writing NixOS Modules</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-parts">Building Specific Parts of NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec">Experimental feature: Bootspec</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-switching-systems">What happens during a system switch?</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-documentation">Writing NixOS Documentation</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests">NixOS Tests</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-developing-the-test-driver">Developing the NixOS Test Driver</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-testing-installer">Testing the Installer</a> </span></dt></dl></dd><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-contributing">Contributing to this manual</a> </span></dt><dt> <span class="appendix">  <a href="https://nixos.org/manual/nixos/stable/options">A. Configuration Options</a> </span></dt><dt> <span class="appendix">  <a href="https://nixos.org/manual/nixos/stable/release-notes">B. Release Notes</a> </span></dt> </dl></div><div class="list-of-examples"><p><strong>List of Examples</strong></p><dl><dt>1. <a href="https://nixos.org/manual/nixos/stable/#ex-partition-scheme-MBR">Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (MBR)</a></dt><dt>2. <a href="https://nixos.org/manual/nixos/stable/#ex-partition-scheme-UEFI">Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (UEFI)</a></dt><dt>3. <a href="https://nixos.org/manual/nixos/stable/#ex-install-sequence">Commands for Installing NixOS on <code class="literal">/dev/sda</code></a></dt><dt>4. <a href="https://nixos.org/manual/nixos/stable/#ex-config">Example: NixOS Configuration</a></dt><dt>5. <a href="https://nixos.org/manual/nixos/stable/#ex-emacsNix">Nix expression to build Emacs with packages (<code class="literal">emacs.nix</code>)</a></dt><dt>6. <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-querying-packages">Querying Emacs packages</a></dt><dt>7. <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-configuration-nix">Custom Emacs in <code class="literal">configuration.nix</code></a></dt><dt>8. <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-config-nix">Custom Emacs in <code class="literal">~/.config/nixpkgs/config.nix</code></a></dt><dt>9. <a href="https://nixos.org/manual/nixos/stable/#ex-emacsGtk3Nix">Custom Emacs build</a></dt><dt>10. <a href="https://nixos.org/manual/nixos/stable/#ex-emacs-docbook-xml">nXML Schema Configuration (<code class="literal">~/.emacs.d/schemas.xml</code>)</a></dt><dt>11. <a href="https://nixos.org/manual/nixos/stable/#ex-module-syntax">Structure of NixOS Modules</a></dt><dt>12. <a href="https://nixos.org/manual/nixos/stable/#locate-example">NixOS Module for the “locate” Service</a></dt><dt>13. <a href="https://nixos.org/manual/nixos/stable/#exec-escaping-example">Escaping in Exec directives</a></dt><dt>14. <a href="https://nixos.org/manual/nixos/stable/#ex-options-declarations-util-mkEnableOption-magic"><code class="literal">mkEnableOption</code> usage</a></dt><dt>15. <a href="https://nixos.org/manual/nixos/stable/#ex-options-declarations-util-mkPackageOption-hello">Simple <code class="literal">mkPackageOption</code> usage</a></dt><dt>16. <a href="https://nixos.org/manual/nixos/stable/#ex-options-declarations-util-mkPackageOption-ghc"><code class="literal">mkPackageOption</code> with explicit default and example</a></dt><dt>17. <a href="https://nixos.org/manual/nixos/stable/#ex-options-declarations-util-mkPackageOption-extraDescription"><code class="literal">mkPackageOption</code> with additional description text</a></dt><dt>18. <a href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-service">Extensible type placeholder in the service module</a></dt><dt>19. <a href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-backend-gdm">Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</a></dt><dt>20. <a href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-backend-sddm">Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</a></dt><dt>21. <a href="https://nixos.org/manual/nixos/stable/#ex-types-anything"><code class="literal">types.anything</code></a></dt><dt>22. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-direct">Directly defined submodule</a></dt><dt>23. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-reference">Submodule defined as a reference</a></dt><dt>24. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-listof-declaration">Declaration of a list of submodules</a></dt><dt>25. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-listof-definition">Definition of a list of submodules</a></dt><dt>26. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-attrsof-declaration">Declaration of attribute sets of submodules</a></dt><dt>27. <a href="https://nixos.org/manual/nixos/stable/#ex-submodule-attrsof-definition">Definition of attribute sets of submodules</a></dt><dt>28. <a href="https://nixos.org/manual/nixos/stable/#ex-extending-type-check-1">Adding a type check</a></dt><dt>29. <a href="https://nixos.org/manual/nixos/stable/#ex-extending-type-check-2">Overriding a type check</a></dt><dt>30. <a href="https://nixos.org/manual/nixos/stable/#ex-freeform-module">Freeform submodule</a></dt><dt>31. <a href="https://nixos.org/manual/nixos/stable/#ex-settings-nix-representable">Module with conventional <code class="literal">settings</code> option</a></dt><dt>32. <a href="https://nixos.org/manual/nixos/stable/#ex-settings-typed-attrs">Declaring a type-checked <code class="literal">settings</code> attribute</a></dt></dl></div>
<div class="preface"> <div class="titlepage">  <div>   <div>    <h1 id="preface" class="title">Preface   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#preface" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><p>This manual describes how to install, use and extend NixOS, a Linux distribution based on the purely functional package management system <a class="link" href="https://nixos.org/nix" target="_top">Nix</a>, that is composed using modules and packages defined in the <a class="link" href="https://nixos.org/nixpkgs" target="_top">Nixpkgs</a> project.</p><p>Additional information regarding the Nix package manager and the Nixpkgs project can be found in respectively the <a class="link" href="https://nixos.org/nix/manual" target="_top">Nix manual</a> and the <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top">Nixpkgs manual</a>.</p><p>If you encounter problems, please report them on the <a class="link" href="https://discourse.nixos.org/" target="_top"><code class="literal">Discourse</code></a>, the <a class="link" href="https://matrix.to/#/%23nix:nixos.org" target="_top">Matrix room</a>, or on the <a class="link" href="irc://irc.libera.chat/#nixos" target="_top"><code class="literal">#nixos</code> channel on Libera.Chat</a>. Alternatively, consider <a class="link" href="https://nixos.org/manual/nixos/stable/#chap-contributing" title="Contributing to this manual">contributing to this manual</a>. Bugs should be reported in <a class="link" href="https://github.com/NixOS/nixpkgs/issues" target="_top">NixOS’ GitHub issue tracker</a>.</p><div class="note"><h3 class="title">Note</h3><p>Commands prefixed with <code class="literal">#</code> have to be run as root, either requiring to login as root user or temporarily switching to it using <code class="literal">sudo</code> for example.</p></div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-installation" class="title">Installation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-installation" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><div class="partintro"><p>This section describes how to obtain, install, and configure NixOS for first-time use.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-obtaining">Obtaining NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation">Installing NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-changing-config">Changing the Configuration</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-upgrading">Upgrading NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-image">Building a NixOS (Live) ISO</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-image-repart">Building Images via <code class="literal">systemd-repart</code></a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-obtaining" class="title">Obtaining NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-obtaining" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS ISO images can be downloaded from the <a class="link" href="https://nixos.org/download.html#nixos-iso" target="_top">NixOS download
page</a>. Follow the instructions in
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb" title="Booting from a USB flash drive">the section called “Booting from a USB flash drive”</a> to create a bootable USB flash drive.</p><p>If you have a very old system that can’t boot from USB, you can burn the image
to an empty CD. NixOS might not work very well on such systems.</p><p>As an alternative to installing NixOS yourself, you can get a running
NixOS system through several other means:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Using virtual appliances in Open Virtualization Format (OVF) that
can be imported into VirtualBox. These are available from the <a class="link" href="https://nixos.org/download.html#nixos-virtualbox" target="_top">NixOS
download page</a>.</p></li><li class="listitem"><p>Using AMIs for Amazon’s EC2. To find one for your region, please refer
to the <a class="link" href="https://nixos.org/download.html#nixos-amazon" target="_top">download page</a>.</p></li><li class="listitem"><p>Using NixOps, the NixOS-based cloud deployment tool, which allows
you to provision VirtualBox and EC2 NixOS instances from declarative
specifications. Check out the <a class="link" href="https://nixos.org/nixops" target="_top">NixOps
homepage</a> for details.</p></li></ul></div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation" class="title">Installing NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation-booting">Booting from the install medium</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation-graphical">Graphical Installation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation-manual">Manual Installation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-installation-additional-notes">Additional installation notes</a> </span></dt> </dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-booting" class="title" style="clear: both">Booting from the install medium   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-booting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To begin the installation, you have to boot your computer from the install drive.</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Plug in the install drive. Then turn on or restart your computer.</p></li><li class="listitem"><p>Open the boot menu by pressing the appropriate key, which is usually shown
on the display on early boot.
Select the USB flash drive (the option usually contains the word “USB”).
If you choose the incorrect drive, your computer will likely continue to
boot as normal. In that case restart your computer and pick a
different drive.</p><div class="note"><h3 class="title">Note</h3><p>The key to open the boot menu is different across computer brands and even
models. It can be <span class="keycap"><strong>F12</strong></span>, but also <span class="keycap"><strong>F1</strong></span>,
<span class="keycap"><strong>F9</strong></span>, <span class="keycap"><strong>F10</strong></span>, <span class="keycap"><strong>Enter</strong></span>, <span class="keycap"><strong>Del</strong></span>,
<span class="keycap"><strong>Esc</strong></span> or another function key. If you are unsure and don’t see
it on the early boot screen, you can search online for your computers
brand, model followed by “boot from usb”.
The computer might not even have that feature, so you have to go into the
BIOS/UEFI settings to change the boot order. Again, search online for
details about your specific computer model.</p><p>For Apple computers with Intel processors press and hold the <span class="keycap"><strong>⌥</strong></span>
(Option or Alt) key until you see the boot menu. On Apple silicon press
and hold the power button.</p></div><div class="note"><h3 class="title">Note</h3><p>If your computer supports both BIOS and UEFI boot, choose the UEFI option.</p></div><div class="note"><h3 class="title">Note</h3><p>If you use a CD for the installation, the computer will probably boot from
it automatically. If not, choose the option containing the word “CD” from
the boot menu.</p></div></li><li class="listitem"><p>Shortly after selecting the appropriate boot drive, you should be
presented with a menu with different installer options. Leave the default
and wait (or press <span class="keycap"><strong>Enter</strong></span> to speed up).</p></li><li class="listitem"><p>The graphical images will start their corresponding desktop environment
and the graphical installer, which can take some time. The minimal images
will boot to a command line. You have to follow the instructions in
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual" title="Manual Installation">the section called “Manual Installation”</a> there.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-graphical" class="title" style="clear: both">Graphical Installation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-graphical" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The graphical installer is recommended for desktop users and will guide you
through the installation.</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>In the “Welcome” screen, you can select the language of the Installer and
the installed system.</p><div class="tip"><h3 class="title">Tip</h3><p>Leaving the language as “American English” will make it easier to search for
error messages in a search engine or to report an issue.</p></div></li><li class="listitem"><p>Next you should choose your location to have the timezone set correctly.
You can actually click on the map!</p><div class="note"><h3 class="title">Note</h3><p>The installer will use an online service to guess your location based on
your public IP address.</p></div></li><li class="listitem"><p>Then you can select the keyboard layout. The default keyboard model should
work well with most desktop keyboards. If you have a special keyboard or
notebook, your model might be in the list. Select the language you are most
comfortable typing in.</p></li><li class="listitem"><p>On the “Users” screen, you have to type in your display name, login name
and password. You can also enable an option to automatically login to the
desktop.</p></li><li class="listitem"><p>Then you have the option to choose a desktop environment. If you want to
create a custom setup with a window manager, you can select “No desktop”.</p><div class="tip"><h3 class="title">Tip</h3><p>If you don’t have a favorite desktop and don’t know which one to choose,
you can stick to either GNOME or Plasma. They have a quite different
design, so you should choose whichever you like better.
They are both popular choices and well tested on NixOS.</p></div></li><li class="listitem"><p>You have the option to allow unfree software in the next screen.</p></li><li class="listitem"><p>The easiest option in the “Partitioning” screen is “Erase disk”, which will
delete all data from the selected disk and install the system on it.
Also select “Swap (with Hibernation)” in the dropdown below it.
You have the option to encrypt the whole disk with LUKS.</p><div class="note"><h3 class="title">Note</h3><p>At the top left you see if the Installer was booted with BIOS or UEFI. If
you know your system supports UEFI and it shows “BIOS”, reboot with the
correct option.</p></div><div class="warning"><h3 class="title">Warning</h3><p>Make sure you have selected the correct disk at the top and that no
valuable data is still on the disk! It will be deleted when
formatting the disk.</p></div></li><li class="listitem"><p>Check the choices you made in the “Summary” and click “Install”.</p><div class="note"><h3 class="title">Note</h3><p>The installation takes about 15 minutes. The time varies based on the
selected desktop environment, internet connection speed and disk write speed.</p></div></li><li class="listitem"><p>When the install is complete, remove the USB flash drive and
reboot into your new system!</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-manual" class="title" style="clear: both">Manual Installation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS can be installed on BIOS or UEFI systems. The procedure for a UEFI
installation is broadly the same as for a BIOS installation. The differences
are mentioned in the following steps.</p><p>The NixOS manual is available by running <code class="literal">nixos-help</code> in the command line
or from the application menu in the desktop environment.</p><p>To have access to the command line on the graphical images, open
Terminal (GNOME) or Konsole (Plasma) from the application menu.</p><p>You are logged-in automatically as <code class="literal">nixos</code>. The <code class="literal">nixos</code> user account has
an empty password so you can use <code class="literal">sudo</code> without a password:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -i</span>
</code></pre><p>You can use <code class="literal">loadkeys</code> to switch to your preferred keyboard layout.
(We even provide neo2 via <code class="literal">loadkeys de neo</code>!)</p><p>If the text is too small to be legible, try <code class="literal">setfont ter-v32n</code> to
increase the font size.</p><p>To install over a serial port connect with <code class="literal">115200n8</code> (e.g.
<code class="literal">picocom -b 115200 /dev/ttyUSB0</code>). When the bootloader lists boot
entries, select the serial console boot entry.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-networking" class="title">Networking in the installer   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-networking" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><span id="sec-installation-booting-networking"></span> </p><p>The boot process should have brought up networking (check <code class="literal">ip a</code>). Networking is necessary for the installer, since it will
download lots of stuff (such as source tarballs or Nixpkgs channel
binaries). It’s best if you have a DHCP server on your network.
Otherwise configure networking manually using <code class="literal">ifconfig</code>.</p><p>On the graphical installer, you can configure the network, wifi
included, through NetworkManager. Using the <code class="literal">nmtui</code> program, you can do
so even in a non-graphical session. If you prefer to configure the
network manually, disable NetworkManager with
<code class="literal">systemctl stop NetworkManager</code>.</p><p>On the minimal installer, NetworkManager is not available, so
configuration must be performed manually. To configure the wifi, first
start wpa_supplicant with <code class="literal">sudo systemctl start wpa_supplicant</code>, then
run <code class="literal">wpa_cli</code>. For most home networks, you need to type in the following
commands:</p><pre><code class="programlisting plain hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">add_network</span>
0
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 ssid <span class="hljs-string">"myhomenetwork"</span></span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 psk <span class="hljs-string">"mypassword"</span></span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 key_mgmt WPA-PSK</span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">enable_network 0</span>
OK
</code></pre><p>For enterprise networks, for example <span class="emphasis"><em>eduroam</em></span>, instead do:</p><pre><code class="programlisting plain hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">add_network</span>
0
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 ssid <span class="hljs-string">"eduroam"</span></span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 identity <span class="hljs-string">"myname@example.com"</span></span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 password <span class="hljs-string">"mypassword"</span></span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">set_network 0 key_mgmt WPA-EAP</span>
OK
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">enable_network 0</span>
OK
</code></pre><p>When successfully connected, you should see a line such as this one</p><pre><code class="programlisting plain hljs language-bash" data-highlighted="yes">&lt;3&gt;CTRL-EVENT-CONNECTED - Connection to 32:85:ab:ef:24:5c completed [<span class="hljs-built_in">id</span>=0 id_str=]
</code></pre><p>you can now leave <code class="literal">wpa_cli</code> by typing <code class="literal">quit</code>.</p><p>If you would like to continue the installation from a different machine
you can use activated SSH daemon. You need to copy your ssh key to
either <code class="literal">/home/nixos/.ssh/authorized_keys</code> or
<code class="literal">/root/.ssh/authorized_keys</code> (Tip: For installers with a modifiable
filesystem such as the sd-card installer image a key can be manually
placed by mounting the image on a different machine). Alternatively you
must set a password for either <code class="literal">root</code> or <code class="literal">nixos</code> with <code class="literal">passwd</code> to be
able to login.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-partitioning" class="title">Partitioning and formatting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><span id="sec-installation-partitioning"></span> </p><p>The NixOS installer doesn’t do any partitioning or formatting, so you
need to do that yourself.</p><p>The NixOS installer ships with multiple partitioning tools. The examples
below use <code class="literal">parted</code>, but also provides <code class="literal">fdisk</code>, <code class="literal">gdisk</code>, <code class="literal">cfdisk</code>, and
<code class="literal">cgdisk</code>.</p><p>The recommended partition scheme differs depending if the computer uses
<span class="emphasis"><em>Legacy Boot</em></span> or <span class="emphasis"><em>UEFI</em></span>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-UEFI" class="title">UEFI (GPT)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning-UEFI" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p><span id="sec-installation-partitioning-UEFI"></span> </p><p>Here’s an example partition scheme for UEFI, using <code class="literal">/dev/sda</code> as the
device.</p><div class="note"><h3 class="title">Note</h3><p>You can safely ignore <code class="literal">parted</code>’s informational message about needing to
update /etc/fstab.</p></div><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Create a <span class="emphasis"><em>GPT</em></span> partition table.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mklabel gpt</span>
</code></pre></li><li class="listitem"><p>Add the <span class="emphasis"><em>root</em></span> partition. This will fill the disk except for the end
part, where the swap will live, and the space left in front (512MiB)
which will be used by the boot partition.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart root ext4 512MB -8GB</span>
</code></pre></li><li class="listitem"><p>Next, add a <span class="emphasis"><em>swap</em></span> partition. The size required will vary according
to needs, here a 8GB one is created.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart swap linux-swap -8GB 100%</span>
</code></pre><div class="note"><h3 class="title">Note</h3><p>The swap partition size rules are no different than for other Linux
distributions.</p></div></li><li class="listitem"><p>Finally, the <span class="emphasis"><em>boot</em></span> partition. NixOS by default uses the ESP (EFI
system partition) as its <span class="emphasis"><em>/boot</em></span> partition. It uses the initially
reserved 512MiB at the start of the disk.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart ESP fat32 1MB 512MB</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- <span class="hljs-built_in">set</span> 3 esp on</span>
</code></pre><div class="note"><h3 class="title">Note</h3><p>In case you decided to not create a swap partition, replace <code class="literal">3</code> by <code class="literal">2</code>. To be sure of the id number of ESP, run <code class="literal">parted --list</code>.</p></div></li></ol></div><p>Once complete, you can follow with
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning-formatting" title="Formatting">the section called “Formatting”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-MBR" class="title">Legacy Boot (MBR)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning-MBR" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p><span id="sec-installation-partitioning-MBR"></span> </p><p>Here’s an example partition scheme for Legacy Boot, using <code class="literal">/dev/sda</code> as
the device.</p><div class="note"><h3 class="title">Note</h3><p>You can safely ignore <code class="literal">parted</code>’s informational message about needing to
update /etc/fstab.</p></div><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Create a <span class="emphasis"><em>MBR</em></span> partition table.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mklabel msdos</span>
</code></pre></li><li class="listitem"><p>Add the <span class="emphasis"><em>root</em></span> partition. This will fill the the disk except for the
end part, where the swap will live.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart primary 1MB -8GB</span>
</code></pre></li><li class="listitem"><p>Set the root partition’s boot flag to on. This allows the disk to be booted from.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- <span class="hljs-built_in">set</span> 1 boot on</span>
</code></pre></li><li class="listitem"><p>Finally, add a <span class="emphasis"><em>swap</em></span> partition. The size required will vary
according to needs, here a 8GB one is created.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart primary linux-swap -8GB 100%</span>
</code></pre><div class="note"><h3 class="title">Note</h3><p>The swap partition size rules are no different than for other Linux
distributions.</p></div></li></ol></div><p>Once complete, you can follow with
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning-formatting" title="Formatting">the section called “Formatting”</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-installation-manual-partitioning-formatting" class="title">Formatting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-partitioning-formatting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p><span id="sec-installation-partitioning-formatting"></span> </p><p>Use the following commands:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For initialising Ext4 partitions: <code class="literal">mkfs.ext4</code>. It is recommended
that you assign a unique symbolic label to the file system using the
option <code class="literal">-L label</code>, since this makes the file system configuration
independent from device changes. For example:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.ext4 -L nixos /dev/sda1</span>
</code></pre></li><li class="listitem"><p>For creating swap partitions: <code class="literal">mkswap</code>. Again it’s recommended to
assign a label to the swap partition: <code class="literal">-L label</code>. For example:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mkswap -L swap /dev/sda2</span>
</code></pre></li><li class="listitem"><p><span class="strong"><strong>UEFI systems</strong></span></p><p>For creating boot partitions: <code class="literal">mkfs.fat</code>. Again it’s recommended
to assign a label to the boot partition: <code class="literal">-n label</code>. For
example:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.fat -F 32 -n boot /dev/sda3</span>
</code></pre></li><li class="listitem"><p>For creating LVM volumes, the LVM commands, e.g., <code class="literal">pvcreate</code>,
<code class="literal">vgcreate</code>, and <code class="literal">lvcreate</code>.</p></li><li class="listitem"><p>For creating software RAID devices, use <code class="literal">mdadm</code>.</p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-installing" class="title">Installing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-installing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><span id="sec-installation-installing"></span> </p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Mount the target file system on which NixOS should be installed on
<code class="literal">/mnt</code>, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/disk/by-label/nixos /mnt</span>
</code></pre></li><li class="listitem"><p><span class="strong"><strong>UEFI systems</strong></span></p><p>Mount the boot file system on <code class="literal">/mnt/boot</code>, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /mnt/boot</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/disk/by-label/boot /mnt/boot</span>
</code></pre></li><li class="listitem"><p>If your machine has a limited amount of memory, you may want to
activate swap devices now (<code class="literal">swapon device</code>).
The installer (or rather, the build actions that it
may spawn) may need quite a bit of RAM, depending on your
configuration.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">swapon /dev/sda2</span>
</code></pre></li><li class="listitem"><p>You now need to create a file <code class="literal">/mnt/etc/nixos/configuration.nix</code>
that specifies the intended configuration of the system. This is
because NixOS has a <span class="emphasis"><em>declarative</em></span> configuration model: you create or
edit a description of the desired configuration of your system, and
then NixOS takes care of making it happen. The syntax of the NixOS
configuration file is described in <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax" title="Configuration Syntax"><em>Configuration Syntax</em></a>,
while a list of available configuration options appears in
<a class="xref" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">Appendix&nbsp;A</a>. A minimal example is shown in
<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-config" title="Example 4. Example: NixOS Configuration">Example: NixOS Configuration</a>.</p><p>The command <code class="literal">nixos-generate-config</code> can generate an initial
configuration file for you:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-generate-config --root /mnt</span>
</code></pre><p>You should then edit <code class="literal">/mnt/etc/nixos/configuration.nix</code> to suit your
needs:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nano /mnt/etc/nixos/configuration.nix</span>
</code></pre><p>If you’re using the graphical ISO image, other editors may be
available (such as <code class="literal">vim</code>). If you have network access, you can also
install other editors – for instance, you can install Emacs by
running <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA emacs</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">BIOS systems</span></dt><dd><p>You <span class="emphasis"><em>must</em></span> set the option <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.device"><code class="option">boot.loader.grub.device</code></a> to
specify on which disk the GRUB boot loader is to be installed.
Without it, NixOS cannot boot.</p><p>If there are other operating systems running on the machine before
installing NixOS, the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.useOSProber"><code class="option">boot.loader.grub.useOSProber</code></a>
option can be set to <code class="literal">true</code> to automatically add them to the grub
menu.</p></dd><dt><span class="term">UEFI systems</span></dt><dd><p>You must select a boot-loader, either systemd-boot or GRUB. The recommended
option is systemd-boot: set the option <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.systemd-boot.enable"><code class="option">boot.loader.systemd-boot.enable</code></a>
to <code class="literal">true</code>. <code class="literal">nixos-generate-config</code> should do this automatically
for new configurations when booted in UEFI mode.</p><p>You may want to look at the options starting with
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.efi.canTouchEfiVariables"><code class="literal">boot.loader.efi</code></a> and
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.systemd-boot.enable"><code class="literal">boot.loader.systemd-boot</code></a>
as well.</p><p>If you want to use GRUB, set <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.device"><code class="option">boot.loader.grub.device</code></a> to <code class="literal">nodev</code> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.efiSupport"><code class="option">boot.loader.grub.efiSupport</code></a> to <code class="literal">true</code>.</p><p>With systemd-boot, you should not need any special configuration to detect
other installed systems. With GRUB, set <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.useOSProber"><code class="option">boot.loader.grub.useOSProber</code></a>
to <code class="literal">true</code>, but this will only detect windows partitions, not other Linux
distributions. If you dual boot another Linux distribution, use systemd-boot
instead.</p></dd></dl></div><p>If you need to configure networking for your machine the
configuration options are described in <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-networking" title="Networking"><em>Networking</em></a>. In
particular, while wifi is supported on the installation image, it is
not enabled by default in the configuration generated by
<code class="literal">nixos-generate-config</code>.</p><p>Another critical option is <code class="literal">fileSystems</code>, specifying the file
systems that need to be mounted by NixOS. However, you typically
don’t need to set it yourself, because <code class="literal">nixos-generate-config</code> sets
it automatically in <code class="literal">/mnt/etc/nixos/hardware-configuration.nix</code> from
your currently mounted file systems. (The configuration file
<code class="literal">hardware-configuration.nix</code> is included from <code class="literal">configuration.nix</code>
and will be overwritten by future invocations of
<code class="literal">nixos-generate-config</code>; thus, you generally should not modify it.)
Additionally, you may want to look at <a class="link" href="https://github.com/NixOS/nixos-hardware" target="_top">Hardware configuration for
known-hardware</a> at this
point or after installation.</p><div class="note"><h3 class="title">Note</h3><p>Depending on your hardware configuration or type of file system, you
may need to set the option <code class="literal">boot.initrd.kernelModules</code> to include
the kernel modules that are necessary for mounting the root file
system, otherwise the installed system will not be able to boot. (If
this happens, boot from the installation media again, mount the
target file system on <code class="literal">/mnt</code>, fix <code class="literal">/mnt/etc/nixos/configuration.nix</code>
and rerun <code class="literal">nixos-install</code>.) In most cases, <code class="literal">nixos-generate-config</code>
will figure out the required modules.</p></div></li><li class="listitem"><p>Do the installation:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-install</span>
</code></pre><p>This will install your system based on the configuration you
provided. If anything fails due to a configuration problem or any
other issue (such as a network outage while downloading binaries
from the NixOS binary cache), you can re-run <code class="literal">nixos-install</code> after
fixing your <code class="literal">configuration.nix</code>.</p><p>As the last step, <code class="literal">nixos-install</code> will ask you to set the password
for the <code class="literal">root</code> user, e.g.</p><pre><code class="programlisting plain hljs language-undefined" data-highlighted="yes">setting root password...
New password: ***
Retype new password: ***
</code></pre><div class="note"><h3 class="title">Note</h3><p>For unattended installations, it is possible to use
<code class="literal">nixos-install --no-root-passwd</code> in order to disable the password
prompt entirely.</p></div></li><li class="listitem"><p>If everything went well:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">reboot</span>
</code></pre></li><li class="listitem"><p>You should now be able to boot into the installed NixOS. The GRUB
boot menu shows a list of <span class="emphasis"><em>available configurations</em></span> (initially just
one). Every time you change the NixOS configuration (see <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-changing-config" title="Changing the Configuration">Changing
Configuration</a>), a new item is added to the
menu. This allows you to easily roll back to a previous
configuration if something goes wrong.</p><p>You should log in and change the <code class="literal">root</code> password with <code class="literal">passwd</code>.</p><p>You’ll probably want to create some user accounts as well, which can
be done with <code class="literal">useradd</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">useradd -c <span class="hljs-string">'Eelco Dolstra'</span> -m eelco</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">passwd eelco</span>
</code></pre><p>You may also want to install some software. This will be covered in
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-package-management" title="Package Management"><em>Package Management</em></a>.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installation-manual-summary" class="title">Installation summary   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-manual-summary" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><span id="sec-installation-summary"></span> </p><p>To summarise, <a class="link" href="https://nixos.org/manual/nixos/stable/#ex-install-sequence" title="Example 3. Commands for Installing NixOS on /dev/sda">Example: Commands for Installing NixOS on <code class="literal">/dev/sda</code></a>
shows a typical sequence of commands for installing NixOS on an empty hard
drive (here <code class="literal">/dev/sda</code>). <a class="link" href="https://nixos.org/manual/nixos/stable/#ex-config" title="Example 4. Example: NixOS Configuration">Example: NixOS Configuration</a> shows a
corresponding configuration Nix expression.</p><div class="example"><span id="ex-partition-scheme-MBR"></span><p class="title"><strong>Example&nbsp;1.&nbsp;Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (MBR)</strong></p><div class="example-contents"><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mklabel msdos</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart primary 1MB -8GB</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart primary linux-swap -8GB 100%</span>
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-partition-scheme-UEFI"></span><p class="title"><strong>Example&nbsp;2.&nbsp;Example partition schemes for NixOS on <code class="literal">/dev/sda</code> (UEFI)</strong></p><div class="example-contents"><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mklabel gpt</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart root ext4 512MB -8GB</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart swap linux-swap -8GB 100%</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- mkpart ESP fat32 1MB 512MB</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">parted /dev/sda -- <span class="hljs-built_in">set</span> 3 esp on</span>
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-install-sequence"></span><p class="title"><strong>Example&nbsp;3.&nbsp;Commands for Installing NixOS on <code class="literal">/dev/sda</code></strong></p><div class="example-contents"><p>With a partitioned disk.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.ext4 -L nixos /dev/sda1</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mkswap -L swap /dev/sda2</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">swapon /dev/sda2</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mkfs.fat -F 32 -n boot /dev/sda3        <span class="hljs-comment"># (for UEFI systems only)</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/disk/by-label/nixos /mnt</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p /mnt/boot                      <span class="hljs-comment"># (for UEFI systems only)</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/disk/by-label/boot /mnt/boot <span class="hljs-comment"># (for UEFI systems only)</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-generate-config --root /mnt</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">nano /mnt/etc/nixos/configuration.nix</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-install</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">reboot</span>
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-config"></span><p class="title"><strong>Example&nbsp;4.&nbsp;Example: NixOS Configuration</strong></p><div class="example-contents"><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">{ config, pkgs, ... }: {
  imports = [
    # Include the results of the hardware scan.
    ./hardware-configuration.nix
  ];

  boot.loader.grub.device = "/dev/sda";   # (for BIOS systems only)
  boot.loader.systemd-boot.enable = true; # (for UEFI systems only)
<span class="hljs-meta prompt_">
  # </span><span class="language-bash">Note: setting fileSystems is generally not</span>
<span class="hljs-meta prompt_">  # </span><span class="language-bash">necessary, since nixos-generate-config figures them out</span>
<span class="hljs-meta prompt_">  # </span><span class="language-bash">automatically <span class="hljs-keyword">in</span> hardware-configuration.nix.</span>
<span class="hljs-meta prompt_">  #</span><span class="language-bash">fileSystems.<span class="hljs-string">"/"</span>.device = <span class="hljs-string">"/dev/disk/by-label/nixos"</span>;</span>
<span class="hljs-meta prompt_">
  # </span><span class="language-bash">Enable the OpenSSH server.</span>
  services.sshd.enable = true;
}
</code></pre></div></div><br class="example-break">
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-installation-additional-notes" class="title" style="clear: both">Additional installation notes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installation-additional-notes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-from-usb" class="title">Booting from a USB flash drive   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The image has to be written verbatim to the USB flash drive for it to be
bootable on UEFI and BIOS systems. Here are the recommended tools to do that.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-graphical" class="title">Creating bootable USB flash drive with a graphical tool   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb-graphical" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Etcher is a popular and user-friendly tool. It works on Linux, Windows and macOS.</p><p>Download it from <a class="link" href="https://www.balena.io/etcher/" target="_top">balena.io</a>, start the program,
select the downloaded NixOS ISO, then select the USB flash drive and flash it.</p><div class="warning"><h3 class="title">Warning</h3><p>Etcher reports errors and usage statistics by default, which can be disabled in
the settings.</p></div><p>An alternative is <a class="link" href="https://bztsrc.gitlab.io/usbimager" target="_top">USBImager</a>,
which is very simple and does not connect to the internet. Download the version
with write-only (wo) interface for your system. Start the program,
select the image, select the USB flash drive and click “Write”.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-linux" class="title">Creating bootable USB flash drive from a Terminal on Linux   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb-linux" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Plug in the USB flash drive.</p></li><li class="listitem"><p>Find the corresponding device with <code class="literal">lsblk</code>. You can distinguish them by
their size.</p></li><li class="listitem"><p>Make sure all partitions on the device are properly unmounted. Replace <code class="literal">sdX</code>
with your device (e.g. <code class="literal">sdb</code>).</p></li></ol></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">sudo umount /dev/sdX*
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="4" type="1"><li class="listitem"><p>Then use the <code class="literal">dd</code> utility to write the image to the USB flash drive.</p></li></ol></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">sudo dd if=&lt;path-to-image&gt; of=/dev/sdX bs=4M conv=fsync
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-booting-from-usb-macos" class="title">Creating bootable USB flash drive from a Terminal on macOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-usb-macos" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Plug in the USB flash drive.</p></li><li class="listitem"><p>Find the corresponding device with <code class="literal">diskutil list</code>. You can distinguish them
by their size.</p></li><li class="listitem"><p>Make sure all partitions on the device are properly unmounted. Replace <code class="literal">diskX</code>
with your device (e.g. <code class="literal">disk1</code>).</p></li></ol></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">diskutil unmountDisk diskX
</code></pre><div class="orderedlist"><ol class="orderedlist compact" start="4" type="1"><li class="listitem"><p>Then use the <code class="literal">dd</code> utility to write the image to the USB flash drive.</p></li></ol></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">sudo dd if=&lt;path-to-image&gt; of=/dev/rdiskX bs=4m
</code></pre><p>After <code class="literal">dd</code> completes, a GUI dialog “The disk
you inserted was not readable by this computer” will pop up, which can
be ignored.</p><div class="note"><h3 class="title">Note</h3><p>Using the ‘raw’ <code class="literal">rdiskX</code> device instead of <code class="literal">diskX</code> with dd completes in
minutes instead of hours.</p></div><div class="orderedlist"><ol class="orderedlist compact" start="5" type="1"><li class="listitem"><p>Eject the disk when it is finished.</p></li></ol></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">diskutil eject /dev/diskX
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-from-pxe" class="title">Booting from the “netboot” media (PXE)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-from-pxe" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Advanced users may wish to install NixOS using an existing PXE or iPXE
setup.</p><p>These instructions assume that you have an existing PXE or iPXE
infrastructure and want to add the NixOS installer as another
option. To build the necessary files from your current version of nixpkgs,
you can run:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">nix-build -A netboot.x86_64-linux '&lt;nixpkgs/nixos/release.nix&gt;'
</code></pre><p>This will create a <code class="literal">result</code> directory containing: * <code class="literal">bzImage</code> – the
Linux kernel * <code class="literal">initrd</code> – the initrd file * <code class="literal">netboot.ipxe</code> – an
example ipxe script demonstrating the appropriate kernel command line
arguments for this image</p><p>If you’re using plain PXE, configure your boot loader to use the
<code class="literal">bzImage</code> and <code class="literal">initrd</code> files and have it provide the same kernel command
line arguments found in <code class="literal">netboot.ipxe</code>.</p><p>If you’re using iPXE, depending on how your HTTP/FTP/etc. server is
configured you may be able to use <code class="literal">netboot.ipxe</code> unmodified, or you may
need to update the paths to the files to match your server’s directory
layout.</p><p>In the future we may begin making these files available as build
products from hydra at which point we will update this documentation
with instructions on how to obtain them either for placing on a
dedicated TFTP server or to boot them directly over the internet.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-booting-via-kexec" class="title">“Booting” into NixOS via kexec   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-booting-via-kexec" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>In some cases, your system might already be booted into/preinstalled with
another Linux distribution, and booting NixOS by attaching an installation
image is quite a manual process.</p><p>This is particularly useful for (cloud) providers where you can’t boot a custom
image, but get some Debian or Ubuntu installation.</p><p>In these cases, it might be easier to use <code class="literal">kexec</code> to “jump into NixOS” from the
running system, which only assumes <code class="literal">bash</code> and <code class="literal">kexec</code> to be installed on the
machine.</p><p>Note that kexec may not work correctly on some hardware, as devices are not
fully re-initialized in the process. In practice, this however is rarely the
case.</p><p>To build the necessary files from your current version of nixpkgs,
you can run:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">nix-build -A kexec.x86_64-linux '&lt;nixpkgs/nixos/release.nix&gt;'
</code></pre><p>This will create a <code class="literal">result</code> directory containing the following:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">bzImage</code> (the Linux kernel)</p></li><li class="listitem"><p><code class="literal">initrd</code> (the initrd file)</p></li><li class="listitem"><p><code class="literal">kexec-boot</code> (a shellscript invoking <code class="literal">kexec</code>)</p></li></ul></div><p>These three files are meant to be copied over to the other already running
Linux Distribution.</p><p>Note its symlinks pointing elsewhere, so <code class="literal">cd</code> in, and use
<code class="literal">scp * root@$destination</code> to copy it over, rather than rsync.</p><p>Once you finished copying, execute <code class="literal">kexec-boot</code> <span class="emphasis"><em>on the destination</em></span>, and after
some seconds, the machine should be booting into an (ephemeral) NixOS
installation medium.</p><p>In case you want to describe your own system closure to kexec into, instead of
the default installer image, you can build your own <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ modulesPath, ... }: {
  <span class="hljs-attr">imports</span> = [
    (modulesPath + <span class="hljs-string">"/installer/netboot/netboot-minimal.nix"</span>)
  ];

  services.openssh.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  users.users.root.openssh.authorizedKeys.<span class="hljs-attr">keys</span> = [
    <span class="hljs-string">"my-ssh-pubkey"</span>
  ];
}
</code></pre><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">nix-build '&lt;nixpkgs/nixos&gt;' \
  --arg configuration ./configuration.nix
  --attr config.system.build.kexecTree
</code></pre><p>Make sure your <code class="literal">configuration.nix</code> does still import <code class="literal">netboot-minimal.nix</code> (or
<code class="literal">netboot-base.nix</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-virtualbox-guest" class="title">Installing in a VirtualBox guest   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installing-virtualbox-guest" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Installing NixOS into a VirtualBox guest is convenient for users who
want to try NixOS without installing it on bare metal. If you want to
use a pre-made VirtualBox appliance, it is available at <a class="link" href="https://nixos.org/nixos/download.html" target="_top">the downloads
page</a>. If you want to set up a
VirtualBox guest manually, follow these instructions:</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Add a New Machine in VirtualBox with OS Type “Linux / Other Linux”</p></li><li class="listitem"><p>Base Memory Size: 768 MB or higher.</p></li><li class="listitem"><p>New Hard Disk of 8 GB or higher.</p></li><li class="listitem"><p>Mount the CD-ROM with the NixOS ISO (by clicking on CD/DVD-ROM)</p></li><li class="listitem"><p>Click on Settings / System / Processor and enable PAE/NX</p></li><li class="listitem"><p>Click on Settings / System / Acceleration and enable “VT-x/AMD-V”
acceleration</p></li><li class="listitem"><p>Click on Settings / Display / Screen and select VMSVGA as Graphics
Controller</p></li><li class="listitem"><p>Save the settings, start the virtual machine, and continue
installation like normal</p></li></ol></div><p>There are a few modifications you should make in configuration.nix.
Enable booting:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.loader.grub.<span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/sda"</span>;
</code></pre><p>Also remove the fsck that runs at startup. It will always fail to run,
stopping your boot until you press <code class="literal">*</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.<span class="hljs-attr">checkJournalingFS</span> = <span class="hljs-literal">false</span>;
</code></pre><p>Shared folders can be given a name and a path in the host system in the
VirtualBox settings (Machine / Settings / Shared Folders, then click on
the “Add” icon). Add the following to the
<code class="literal">/etc/nixos/configuration.nix</code> to auto-mount them. If you do not add
<code class="literal">"nofail"</code>, the system will not boot properly.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ...} :
{
  fileSystems.<span class="hljs-string">"/virtualboxshare"</span> = {
    <span class="hljs-attr">fsType</span> = <span class="hljs-string">"vboxsf"</span>;
    <span class="hljs-attr">device</span> = <span class="hljs-string">"nameofthesharedfolder"</span>;
    <span class="hljs-attr">options</span> = [ <span class="hljs-string">"rw"</span> <span class="hljs-string">"nofail"</span> ];
  };
}
</code></pre><p>The folder will be available directly under the root directory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-from-other-distro" class="title">Installing from another Linux distribution   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installing-from-other-distro" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Because Nix (the package manager) &amp; Nixpkgs (the Nix packages
collection) can both be installed on any (most?) Linux distributions,
they can be used to install NixOS in various creative ways. You can, for
instance:</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Install NixOS on another partition, from your existing Linux
distribution (without the use of a USB or optical device!)</p></li><li class="listitem"><p>Install NixOS on the same partition (in place!), from your existing
non-NixOS Linux distribution using <code class="literal">NIXOS_LUSTRATE</code>.</p></li><li class="listitem"><p>Install NixOS on your hard drive from the Live CD of any Linux
distribution.</p></li></ol></div><p>The first steps to all these are the same:</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Install the Nix package manager:</p><p>Short version:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">curl -L https://nixos.org/nix/install | sh</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">. <span class="hljs-variable">$HOME</span>/.nix-profile/etc/profile.d/nix.sh <span class="hljs-comment"># …or open a fresh shell</span></span>
</code></pre><p>More details in the <a class="link" href="https://nixos.org/nix/manual/#chap-quick-start" target="_top"> Nix
manual</a></p></li><li class="listitem"><p>Switch to the NixOS channel:</p><p>If you’ve just installed Nix on a non-NixOS distribution, you will
be on the <code class="literal">nixpkgs</code> channel by default.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-channel --list</span>
nixpkgs https://nixos.org/channels/nixpkgs-unstable
</code></pre><p>As that channel gets released without running the NixOS tests, it
will be safer to use the <code class="literal">nixos-*</code> channels instead:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-channel --add https://nixos.org/channels/nixos-version nixpkgs</span>
</code></pre><p>You may want to throw in a <code class="literal">nix-channel --update</code> for good measure.</p></li><li class="listitem"><p>Install the NixOS installation tools:</p><p>You’ll need <code class="literal">nixos-generate-config</code> and <code class="literal">nixos-install</code>, but this
also makes some man pages and <code class="literal">nixos-enter</code> available, just in case
you want to chroot into your NixOS partition. NixOS installs these
by default, but you don’t have NixOS yet…</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -f <span class="hljs-string">'&lt;nixpkgs&gt;'</span> -iA nixos-install-tools</span>
</code></pre></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>The following 5 steps are only for installing NixOS to another
partition. For installing NixOS in place using <code class="literal">NIXOS_LUSTRATE</code>,
skip ahead.</p></div><p>Prepare your target partition:</p><p>At this point it is time to prepare your target partition. Please
refer to the partitioning, file-system creation, and mounting steps
of <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation" title="Installing NixOS"><em>Installing NixOS</em></a></p><p>If you’re about to install NixOS in place using <code class="literal">NIXOS_LUSTRATE</code>
there is nothing to do for this step.</p></li><li class="listitem"><p>Generate your NixOS configuration:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo `<span class="hljs-built_in">which</span> nixos-generate-config` --root /mnt</span>
</code></pre><p>You’ll probably want to edit the configuration files. Refer to the
<code class="literal">nixos-generate-config</code> step in <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation" title="Installing NixOS"><em>Installing NixOS</em></a> for more
information.</p><p>Consider setting up the NixOS bootloader to give you the ability to
boot on your existing Linux partition. For instance, if you’re
using GRUB and your existing distribution is running Ubuntu, you may
want to add something like this to your <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.loader.grub.<span class="hljs-attr">extraEntries</span> = <span class="hljs-string">''
  menuentry "Ubuntu" {
    search --set=ubuntu --fs-uuid 3cc3e652-0c1f-4800-8451-033754f68e6e
    configfile "($ubuntu)/boot/grub/grub.cfg"
  }
''</span>;
</code></pre><p>(You can find the appropriate UUID for your partition in
<code class="literal">/dev/disk/by-uuid</code>)</p></li><li class="listitem"><p>Create the <code class="literal">nixbld</code> group and user on your original distribution:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupadd -g 30000 nixbld</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo useradd -u 30000 -g nixbld -G nixbld nixbld</span>
</code></pre></li><li class="listitem"><p>Download/build/install NixOS:</p><div class="warning"><h3 class="title">Warning</h3><p>Once you complete this step, you might no longer be able to boot on
existing systems without the help of a rescue USB drive or similar.</p></div><div class="note"><h3 class="title">Note</h3><p>On some distributions there are separate PATHS for programs intended
only for root. In order for the installation to succeed, you might
have to use <code class="literal">PATH="$PATH:/usr/sbin:/sbin"</code> in the following command.</p></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo PATH=<span class="hljs-string">"<span class="hljs-variable">$PATH</span>"</span> NIX_PATH=<span class="hljs-string">"<span class="hljs-variable">$NIX_PATH</span>"</span> `<span class="hljs-built_in">which</span> nixos-install` --root /mnt</span>
</code></pre><p>Again, please refer to the <code class="literal">nixos-install</code> step in
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation" title="Installing NixOS"><em>Installing NixOS</em></a> for more information.</p><p>That should be it for installation to another partition!</p></li><li class="listitem"><p>Optionally, you may want to clean up your non-NixOS distribution:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo userdel nixbld</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo groupdel nixbld</span>
</code></pre><p>If you do not wish to keep the Nix package manager installed either,
run something like <code class="literal">sudo rm -rv ~/.nix-* /nix</code> and remove the line
that the Nix installer added to your <code class="literal">~/.profile</code>.</p></li><li class="listitem"><div class="note"><h3 class="title">Note</h3><p>The following steps are only for installing NixOS in place using
<code class="literal">NIXOS_LUSTRATE</code>:</p></div><p>Generate your NixOS configuration:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo `<span class="hljs-built_in">which</span> nixos-generate-config`</span>
</code></pre><p>Note that this will place the generated configuration files in
<code class="literal">/etc/nixos</code>. You’ll probably want to edit the configuration files.
Refer to the <code class="literal">nixos-generate-config</code> step in
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-installation" title="Installing NixOS"><em>Installing NixOS</em></a> for more information.</p><p>You’ll likely want to set a root password for your first boot using
the configuration files because you won’t have a chance to enter a
password until after you reboot. You can initialize the root password
to an empty one with this line: (and of course don’t forget to set
one once you’ve rebooted or to lock the account with
<code class="literal">sudo passwd -l root</code> if you use <code class="literal">sudo</code>)</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.users.root.<span class="hljs-attr">initialHashedPassword</span> = <span class="hljs-string">""</span>;
</code></pre></li><li class="listitem"><p>Build the NixOS closure and install it in the <code class="literal">system</code> profile:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -p /nix/var/nix/profiles/system -f <span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span> -I nixos-config=/etc/nixos/configuration.nix -iA system</span>
</code></pre></li><li class="listitem"><p>Change ownership of the <code class="literal">/nix</code> tree to root (since your Nix install
was probably single user):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">chown</span> -R 0:0 /nix</span>
</code></pre></li><li class="listitem"><p>Set up the <code class="literal">/etc/NIXOS</code> and <code class="literal">/etc/NIXOS_LUSTRATE</code> files:</p><p><code class="literal">/etc/NIXOS</code> officializes that this is now a NixOS partition (the
bootup scripts require its presence).</p><p><code class="literal">/etc/NIXOS_LUSTRATE</code> tells the NixOS bootup scripts to move
<span class="emphasis"><em>everything</em></span> that’s in the root partition to <code class="literal">/old-root</code>. This will
move your existing distribution out of the way in the very early
stages of the NixOS bootup. There are exceptions (we do need to keep
NixOS there after all), so the NixOS lustrate process will not
touch:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The <code class="literal">/nix</code> directory</p></li><li class="listitem"><p>The <code class="literal">/boot</code> directory</p></li><li class="listitem"><p>Any file or directory listed in <code class="literal">/etc/NIXOS_LUSTRATE</code> (one per
line)</p></li></ul></div><div class="note"><h3 class="title">Note</h3><p>Support for <code class="literal">NIXOS_LUSTRATE</code> was added in NixOS 16.09. The act of
“lustrating” refers to the wiping of the existing distribution.
Creating <code class="literal">/etc/NIXOS_LUSTRATE</code> can also be used on NixOS to remove
all mutable files from your root partition (anything that’s not in
<code class="literal">/nix</code> or <code class="literal">/boot</code> gets “lustrated” on the next boot.</p><p>lustrate /ˈlʌstreɪt/ verb.</p><p>purify by expiatory sacrifice, ceremonial washing, or some other
ritual action.</p></div><p>Let’s create the files:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /etc/NIXOS</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">touch</span> /etc/NIXOS_LUSTRATE</span>
</code></pre><p>Let’s also make sure the NixOS configuration files are kept once we
reboot on NixOS:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> etc/nixos | sudo <span class="hljs-built_in">tee</span> -a /etc/NIXOS_LUSTRATE</span>
</code></pre></li><li class="listitem"><p>Finally, move the <code class="literal">/boot</code> directory of your current distribution out
of the way (the lustrate process will take care of the rest once you
reboot, but this one must be moved out now because NixOS needs to
install its own boot files:</p><div class="warning"><h3 class="title">Warning</h3><p>Once you complete this step, your current distribution will no
longer be bootable! If you didn’t get all the NixOS configuration
right, especially those settings pertaining to boot loading and root
partition, NixOS may not be bootable either. Have a USB rescue
device ready in case this happens.</p></div><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo <span class="hljs-built_in">mv</span> -v /boot /boot.bak &amp;&amp;</span>
sudo /nix/var/nix/profiles/system/bin/switch-to-configuration boot
</code></pre><p>Cross your fingers, reboot, hopefully you should get a NixOS prompt!</p></li><li class="listitem"><p>If for some reason you want to revert to the old distribution,
you’ll need to boot on a USB rescue disk and do something along
these lines:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> root</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">mount /dev/sdaX root</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> root/nixos-root</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mv</span> -v root/* root/nixos-root/</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mv</span> -v root/nixos-root/old-root/* root/</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">mv</span> -v root/boot.bak root/boot  <span class="hljs-comment"># We had renamed this by hand earlier</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">umount root</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">reboot</span>
</code></pre><p>This may work as is or you might also need to reinstall the boot
loader.</p><p>And of course, if you’re happy with NixOS and no longer need the
old distribution:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">sudo rm -rf /old-root
</code></pre></li><li class="listitem"><p>It’s also worth noting that this whole process can be automated.
This is especially useful for Cloud VMs, where provider do not
provide NixOS. For instance,
<a class="link" href="https://github.com/elitak/nixos-infect" target="_top">nixos-infect</a> uses the
lustrate process to convert Digital Ocean droplets to NixOS from
other distributions automatically.</p></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-installing-behind-proxy" class="title">Installing behind a proxy   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-installing-behind-proxy" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>To install NixOS behind a proxy, do the following before running
<code class="literal">nixos-install</code>.</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Update proxy configuration in <code class="literal">/mnt/etc/nixos/configuration.nix</code> to
keep the internet accessible after reboot.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.proxy.<span class="hljs-attr">default</span> = <span class="hljs-string">"http://user:password@proxy:port/"</span>;
networking.proxy.<span class="hljs-attr">noProxy</span> = <span class="hljs-string">"127.0.0.1,localhost,internal.domain"</span>;
</code></pre></li><li class="listitem"><p>Setup the proxy environment variables in the shell where you are
running <code class="literal">nixos-install</code>.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">proxy_url=<span class="hljs-string">"http://user:password@proxy:port/"</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> http_proxy=<span class="hljs-string">"<span class="hljs-variable">$proxy_url</span>"</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> HTTP_PROXY=<span class="hljs-string">"<span class="hljs-variable">$proxy_url</span>"</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> https_proxy=<span class="hljs-string">"<span class="hljs-variable">$proxy_url</span>"</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> HTTPS_PROXY=<span class="hljs-string">"<span class="hljs-variable">$proxy_url</span>"</span></span>
</code></pre></li></ol></div><div class="note"><h3 class="title">Note</h3><p>If you are switching networks with different proxy configurations, use
the <code class="literal">specialisation</code> option in <code class="literal">configuration.nix</code> to switch proxies at
runtime. Refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">Appendix&nbsp;A</a> for more information.</p></div>
</div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-changing-config" class="title">Changing the Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-changing-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The file <code class="literal">/etc/nixos/configuration.nix</code> contains the current
configuration of your machine. Whenever you’ve <a class="link" href="https://nixos.org/manual/nixos/stable/#ch-configuration" title="Configuration">changed
something</a> in that file, you should do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch</span>
</code></pre><p>to build the new configuration, make it the default configuration for
booting, and try to realise the configuration in the running system
(e.g., by restarting system services).</p><div class="warning"><h3 class="title">Warning</h3><p>This command doesn’t start/stop <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.user.services">user services</a>
automatically. <code class="literal">nixos-rebuild</code> only runs a <code class="literal">daemon-reload</code> for each user with running
user services.</p></div><div class="warning"><h3 class="title">Warning</h3><p>These commands must be executed as root, so you should either run them
from a root shell or by prefixing them with <code class="literal">sudo -i</code>.</p></div><p>You can also do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild <span class="hljs-built_in">test</span></span>
</code></pre><p>to build the configuration and switch the running system to it, but
without making it the boot default. So if (say) the configuration locks
up your machine, you can just reboot to get back to a working
configuration.</p><p>There is also</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild boot</span>
</code></pre><p>to build the configuration and make it the boot default, but not switch
to it now (so it will only take effect after the next reboot).</p><p>You can make your configuration show up in a different submenu of the
GRUB 2 boot screen by giving it a different <span class="emphasis"><em>profile name</em></span>, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch -p <span class="hljs-built_in">test</span></span>
</code></pre><p>which causes the new configuration (and previous ones created using
<code class="literal">-p test</code>) to show up in the GRUB submenu “NixOS - Profile ‘test’”.
This can be useful to separate test configurations from “stable”
configurations.</p><p>Finally, you can do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-rebuild build</span>
</code></pre><p>to build the configuration but nothing more. This is useful to see
whether everything compiles cleanly.</p><p>If you have a machine that supports hardware virtualisation, you can
also test the new configuration in a sandbox by building and running a
QEMU <span class="emphasis"><em>virtual machine</em></span> that contains the desired configuration. Just do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-rebuild build-vm</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./result/bin/run-*-vm</span>
</code></pre><p>The VM does not have any data from your host system, so your existing
user accounts and home directories will not be available unless you have
set <code class="literal">mutableUsers = false</code>. Another way is to temporarily add the
following to your configuration:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.users.your-user.<span class="hljs-attr">initialHashedPassword</span> = <span class="hljs-string">"test"</span>;
</code></pre><p><span class="emphasis"><em>Important:</em></span> delete the $hostname.qcow2 file if you have started the
virtual machine at least once without the right users, otherwise the
changes will not get picked up. You can forward ports on the host to the
guest. For instance, the following will forward host port 2222 to guest
port 22 (SSH):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">QEMU_NET_OPTS=<span class="hljs-string">"hostfwd=tcp:127.0.0.1:2222-:22"</span> ./result/bin/run-*-vm</span>
</code></pre><p>allowing you to log in via SSH (assuming you have set the appropriate
passwords or SSH authorized keys):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -p 2222 localhost</span>
</code></pre><p>Such port forwardings connect via the VM’s virtual network interface.
Thus they cannot connect to ports that are only bound to the VM’s
loopback interface (<code class="literal">127.0.0.1</code>), and the VM’s NixOS firewall
must be configured to allow these connections.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-upgrading" class="title">Upgrading NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-upgrading" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-upgrading-automatic">Automatic Upgrades</a> </span></dt> </dl></div><p>The best way to keep your NixOS installation up to date is to use one of
the NixOS <span class="emphasis"><em>channels</em></span>. A channel is a Nix mechanism for distributing Nix
expressions and associated binaries. The NixOS channels are updated
automatically from NixOS’s Git repository after certain tests have
passed and all packages have been built. These channels are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em>Stable channels</em></span>, such as <a class="link" href="https://channels.nixos.org/nixos-23.11" target="_top"><code class="literal">nixos-23.11</code></a>.
These only get conservative bug fixes and package upgrades. For
instance, a channel update may cause the Linux kernel on your system
to be upgraded from 4.19.34 to 4.19.38 (a minor bug fix), but not
from 4.19.x to 4.20.x (a major change that has the potential to break things).
Stable channels are generally maintained until the next stable
branch is created.</p></li><li class="listitem"><p>The <span class="emphasis"><em>unstable channel</em></span>, <a class="link" href="https://channels.nixos.org/nixos-unstable" target="_top"><code class="literal">nixos-unstable</code></a>.
This corresponds to NixOS’s main development branch, and may thus see
radical changes between channel updates. It’s not recommended for
production systems.</p></li><li class="listitem"><p><span class="emphasis"><em>Small channels</em></span>, such as <a class="link" href="https://channels.nixos.org/nixos-23.11-small" target="_top"><code class="literal">nixos-23.11-small</code></a>
or <a class="link" href="https://channels.nixos.org/nixos-unstable-small" target="_top"><code class="literal">nixos-unstable-small</code></a>.
These are identical to the stable and unstable channels described above,
except that they contain fewer binary packages. This means they get updated
faster than the regular channels (for instance, when a critical security patch
is committed to NixOS’s source tree), but may require more packages to be
built from source than usual. They’re mostly intended for server environments
and as such contain few GUI applications.</p></li></ul></div><p>To see what channels are available, go to <a class="link" href="https://channels.nixos.org/" target="_top">https://channels.nixos.org</a>.
(Note that the URIs of the various channels redirect to a directory that
contains the channel’s latest version and includes ISO images and
VirtualBox appliances.) Please note that during the release process,
channels that are not yet released will be present here as well. See the
Getting NixOS page <a class="link" href="https://nixos.org/nixos/download.html" target="_top">https://nixos.org/nixos/download.html</a> to find the
newest supported stable release.</p><p>When you first install NixOS, you’re automatically subscribed to the
NixOS channel that corresponds to your installation source. For
instance, if you installed from a 23.11 ISO, you will be subscribed to
the <code class="literal">nixos-23.11</code> channel. To see which NixOS channel you’re subscribed
to, run the following as root:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-channel --list | grep nixos</span>
nixos https://channels.nixos.org/nixos-unstable
</code></pre><p>To switch to a different NixOS channel, do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-channel --add https://channels.nixos.org/channel-name nixos</span>
</code></pre><p>(Be sure to include the <code class="literal">nixos</code> parameter at the end.) For instance, to
use the NixOS 23.11 stable channel:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-channel --add https://channels.nixos.org/nixos-23.11 nixos</span>
</code></pre><p>If you have a server, you may want to use the “small” channel instead:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-channel --add https://channels.nixos.org/nixos-23.11-small nixos</span>
</code></pre><p>And if you want to live on the bleeding edge:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-channel --add https://channels.nixos.org/nixos-unstable nixos</span>
</code></pre><p>You can then upgrade NixOS to the latest version in your chosen channel
by running</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch --upgrade</span>
</code></pre><p>which is equivalent to the more verbose <code class="literal">nix-channel --update nixos; nixos-rebuild switch</code>.</p><div class="note"><h3 class="title">Note</h3><p>Channels are set per user. This means that running <code class="literal">nix-channel --add</code>
as a non root user (or without sudo) will not affect
configuration in <code class="literal">/etc/nixos/configuration.nix</code></p></div><div class="warning"><h3 class="title">Warning</h3><p>It is generally safe to switch back and forth between channels. The only
exception is that a newer NixOS may also have a newer Nix version, which
may involve an upgrade of Nix’s database schema. This cannot be undone
easily, so in that case you will not be able to go back to your original
channel.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-upgrading-automatic" class="title" style="clear: both">Automatic Upgrades   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-upgrading-automatic" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can keep a NixOS system up-to-date automatically by adding the
following to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">system.autoUpgrade.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
system.autoUpgrade.<span class="hljs-attr">allowReboot</span> = <span class="hljs-literal">true</span>;
</code></pre><p>This enables a periodically executed systemd service named
<code class="literal">nixos-upgrade.service</code>. If the <code class="literal">allowReboot</code> option is <code class="literal">false</code>, it runs
<code class="literal">nixos-rebuild switch --upgrade</code> to upgrade NixOS to the latest version
in the current channel. (To see when the service runs, see <code class="literal">systemctl list-timers</code>.)
If <code class="literal">allowReboot</code> is <code class="literal">true</code>, then the system will automatically reboot if
the new generation contains a different kernel, initrd or kernel
modules. You can also specify a channel explicitly, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">system.autoUpgrade.<span class="hljs-attr">channel</span> = <span class="hljs-string">"https://channels.nixos.org/nixos-23.11"</span>;
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image" class="title">Building a NixOS (Live) ISO   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-building-image" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-image-instructions">Practical Instructions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-image-drivers">Additional drivers or firmware</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-image-tech-notes">Technical Notes</a> </span></dt> </dl></div><p>Default live installer configurations are available inside <code class="literal">nixos/modules/installer/cd-dvd</code>.
For building other system images, <a class="link" href="https://github.com/nix-community/nixos-generators" target="_top">nixos-generators</a> is a good place to start looking at.</p><p>You have two options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use any of those default configurations as is</p></li><li class="listitem"><p>Combine them with (any of) your host config(s)</p></li></ul></div><p>System images, such as the live installer ones, know how to enforce configuration settings
on which they immediately depend in order to work correctly.</p><p>However, if you are confident, you can opt to override those
enforced values with <code class="literal">mkForce</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-instructions" class="title" style="clear: both">Practical Instructions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-building-image-instructions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To build an ISO image for the channel <code class="literal">nixos-unstable</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/NixOS/nixpkgs.git</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> nixpkgs/nixos</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">git switch nixos-unstable</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/cd-dvd/installation-cd-minimal.nix default.nix</span>
</code></pre><p>To check the content of an ISO image, mount it like so:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mount -o loop -t iso9660 ./result/iso/cd.iso /mnt/iso</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-drivers" class="title" style="clear: both">Additional drivers or firmware   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-building-image-drivers" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If you need additional (non-distributable) drivers or firmware in the
installer, you might want to extend these configurations.</p><p>For example, to build the GNOME graphical installer ISO, but with support for
certain WiFi adapters present in some MacBooks, you can create the following
file at <code class="literal">modules/installer/cd-dvd/installation-cd-graphical-gnome-macbook.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, ... }:

{
  <span class="hljs-attr">imports</span> = [ ./installation-cd-graphical-gnome.nix ];

  boot.initrd.<span class="hljs-attr">kernelModules</span> = [ <span class="hljs-string">"wl"</span> ];

  boot.<span class="hljs-attr">kernelModules</span> = [ <span class="hljs-string">"kvm-intel"</span> <span class="hljs-string">"wl"</span> ];
  boot.<span class="hljs-attr">extraModulePackages</span> = [ config.boot.kernelPackages.broadcom_sta ];
}
</code></pre><p>Then build it like in the example above:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/NixOS/nixpkgs.git</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> nixpkgs/nixos</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> NIXPKGS_ALLOW_UNFREE=1</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A config.system.build.isoImage -I nixos-config=modules/installer/cd-dvd/installation-cd-graphical-gnome-macbook.nix default.nix</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-image-tech-notes" class="title" style="clear: both">Technical Notes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-building-image-tech-notes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The config value enforcement is implemented via <code class="literal">mkImageMediaOverride = mkOverride 60;</code>
and therefore primes over simple value assignments, but also yields to <code class="literal">mkForce</code>.</p><p>This property allows image designers to implement in semantically correct ways those
configuration values upon which the correct functioning of the image depends.</p><p>For example, the iso base image overrides those file systems which it needs at a minimum
for correct functioning, while the installer base image overrides the entire file system
layout because there can’t be any other guarantees on a live medium than those given
by the live medium itself. The latter is especially true before formatting the target
block device(s). On the other hand, the netboot iso only overrides its minimum dependencies
since netboot images are always made-to-target.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart" class="title">Building Images via <code class="literal">systemd-repart</code>   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-image-repart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-image-repart-store-partition">Nix Store Partition</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-image-repart-appliance">Appliance Image</a> </span></dt> </dl></div><p>You can build disk images in NixOS with the <code class="literal">image.repart</code> option provided by
the module <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/image/repart.nix" target="_top">image/repart.nix</a>. This module uses <code class="literal">systemd-repart</code> to build the
images and exposes it’s entire interface via the <code class="literal">repartConfig</code> option.</p><p>An example of how to build an image:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, modulesPath, ... }: {

  <span class="hljs-attr">imports</span> = [ <span class="hljs-string">"<span class="hljs-subst">${modulesPath}</span>/image/repart.nix"</span> ];

  image.<span class="hljs-attr">repart</span> = {
    <span class="hljs-attr">name</span> = <span class="hljs-string">"image"</span>;
    <span class="hljs-attr">partitions</span> = {
      <span class="hljs-string">"esp"</span> = {
        <span class="hljs-attr">contents</span> = {
          ...
        };
        <span class="hljs-attr">repartConfig</span> = {
          <span class="hljs-attr">Type</span> = <span class="hljs-string">"esp"</span>;
          ...
        };
      };
      <span class="hljs-string">"root"</span> = {
        <span class="hljs-attr">storePaths</span> = [ config.system.build.toplevel ];
        <span class="hljs-attr">repartConfig</span> = {
          <span class="hljs-attr">Type</span> = <span class="hljs-string">"root"</span>;
          <span class="hljs-attr">Label</span> = <span class="hljs-string">"nixos"</span>;
          ...
        };
      };
    };
  };

}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart-store-partition" class="title" style="clear: both">Nix Store Partition   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-image-repart-store-partition" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can define a partition that only contains the Nix store and then mount it
under <code class="literal">/nix/store</code>. Because the <code class="literal">/nix/store</code> part of the paths is already
determined by the mount point, you have to set <code class="literal">stripNixStorePrefix = true;</code> so
that the prefix is stripped from the paths before copying them into the image.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">fileSystems.<span class="hljs-string">"/nix/store"</span>.<span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/disk/by-partlabel/nix-store"</span>

image.repart.<span class="hljs-attr">partitions</span> = {
  <span class="hljs-string">"store"</span> = {
    <span class="hljs-attr">storePaths</span> = [ config.system.build.toplevel ];
    <span class="hljs-attr">stripNixStorePrefix</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">repartConfig</span> = {
      <span class="hljs-attr">Type</span> = <span class="hljs-string">"linux-generic"</span>;
      <span class="hljs-attr">Label</span> = <span class="hljs-string">"nix-store"</span>;
      ...
    };
  };
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-image-repart-appliance" class="title" style="clear: both">Appliance Image   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-image-repart-appliance" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The <code class="literal">image/repart.nix</code> module can also be used to build self-contained <a class="link" href="https://en.wikipedia.org/wiki/Software_appliance" target="_top">software
appliances</a>.</p><p>The generation based update mechanism of NixOS is not suited for appliances.
Updates of appliances are usually either performed by replacing the entire
image with a new one or by updating partitions via an A/B scheme. See the
<a class="link" href="https://chromium.googlesource.com/aosp/platform/system/update_engine/+/HEAD/README.md" target="_top">Chrome OS update process</a> for an example of how to achieve
this. The appliance image built in the following example does not contain a
<code class="literal">configuration.nix</code> and thus you will not be able to call <code class="literal">nixos-rebuild</code> from
this system.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">pkgs</span> = <span class="hljs-built_in">import</span> &lt;nixpkgs&gt; { };
  <span class="hljs-attr">efiArch</span> = pkgs.stdenv.hostPlatform.efiArch;
<span class="hljs-keyword">in</span>
(pkgs.nixos [
  ({ config, lib, pkgs, modulesPath, ... }: {

    <span class="hljs-attr">imports</span> = [ <span class="hljs-string">"<span class="hljs-subst">${modulesPath}</span>/image/repart.nix"</span> ];

    boot.loader.grub.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;

    fileSystems.<span class="hljs-string">"/"</span>.<span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/disk/by-label/nixos"</span>;

    image.<span class="hljs-attr">repart</span> = {
      <span class="hljs-attr">name</span> = <span class="hljs-string">"image"</span>;
      <span class="hljs-attr">partitions</span> = {
        <span class="hljs-string">"esp"</span> = {
          <span class="hljs-attr">contents</span> = {
            <span class="hljs-string">"/EFI/BOOT/BOOT<span class="hljs-subst">${lib.toUpper efiArch}</span>.EFI"</span>.<span class="hljs-attr">source</span> =
              <span class="hljs-string">"<span class="hljs-subst">${pkgs.systemd}</span>/lib/systemd/boot/efi/systemd-boot<span class="hljs-subst">${efiArch}</span>.efi"</span>;

            <span class="hljs-string">"/loader/entries/nixos.conf"</span>.<span class="hljs-attr">source</span> = pkgs.writeText <span class="hljs-string">"nixos.conf"</span> <span class="hljs-string">''
              title NixOS
              linux /EFI/nixos/kernel.efi
              initrd /EFI/nixos/initrd.efi
              options init=<span class="hljs-subst">${config.system.build.toplevel}</span>/init <span class="hljs-subst">${<span class="hljs-built_in">toString</span> config.boot.kernelParams}</span>
            ''</span>;

            <span class="hljs-string">"/EFI/nixos/kernel.efi"</span>.<span class="hljs-attr">source</span> =
              <span class="hljs-string">"<span class="hljs-subst">${config.boot.kernelPackages.kernel}</span>/<span class="hljs-subst">${config.system.boot.loader.kernelFile}</span>"</span>;

            <span class="hljs-string">"/EFI/nixos/initrd.efi"</span>.<span class="hljs-attr">source</span> =
              <span class="hljs-string">"<span class="hljs-subst">${config.system.build.initialRamdisk}</span>/<span class="hljs-subst">${config.system.boot.loader.initrdFile}</span>"</span>;
          };
          <span class="hljs-attr">repartConfig</span> = {
            <span class="hljs-attr">Type</span> = <span class="hljs-string">"esp"</span>;
            <span class="hljs-attr">Format</span> = <span class="hljs-string">"vfat"</span>;
            <span class="hljs-attr">SizeMinBytes</span> = <span class="hljs-string">"96M"</span>;
          };
        };
        <span class="hljs-string">"root"</span> = {
          <span class="hljs-attr">storePaths</span> = [ config.system.build.toplevel ];
          <span class="hljs-attr">repartConfig</span> = {
            <span class="hljs-attr">Type</span> = <span class="hljs-string">"root"</span>;
            <span class="hljs-attr">Format</span> = <span class="hljs-string">"ext4"</span>;
            <span class="hljs-attr">Label</span> = <span class="hljs-string">"nixos"</span>;
            <span class="hljs-attr">Minimize</span> = <span class="hljs-string">"guess"</span>;
          };
        };
      };
    };

  })
]).image
</code></pre>
</div>

</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-configuration" class="title">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><div class="partintro"><p>This chapter describes how to configure various aspects of a NixOS machine through the configuration file <code class="filename">/etc/nixos/configuration.nix</code>. As described in <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-changing-config" title="Changing the Configuration"><em>Changing the Configuration</em></a>, changes to this file only take effect after you run <span class="command"><strong>nixos-rebuild</strong></span>.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax">Configuration Syntax</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-package-management">Package Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-user-management">User Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-file-systems">File Systems</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11">X Window System</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-wayland">Wayland</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel">GPU acceleration</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-xfce">Xfce Desktop Environment</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-networking">Networking</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-kernel-config">Linux Kernel</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-subversion">Subversion</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-pantheon">Pantheon Desktop</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-gnome">GNOME Desktop</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-bootloader-external">External Bootloader Backends</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-garage">Garage</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-plausible">Plausible</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs">Pict-rs</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud">Nextcloud</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo">Matomo</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-lemmy">Lemmy</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak">Keycloak</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-meet">Jitsi Meet</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-honk">Honk</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-grocy">Grocy</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gotosocial">GoToSocial</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse">Discourse</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-c2fmzq">c2FmZQ</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-akkoma">Akkoma</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch">Meilisearch</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil">Yggdrasil</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prosody">Prosody</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma">Pleroma</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto">Mosquitto</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver">Firefox Sync server</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-litestream">Litestream</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters">Prometheus exporters</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc">parsedmarc</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-ocsinventory-agent">OCS Inventory Agent</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-goss">Goss</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-certspotter">Cert Spotter</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-weechat">WeeChat</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver">Taskserver</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut">Sourcehut</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gitlab">GitLab</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-forgejo">Forgejo</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka">Apache Kafka</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matrix">Matrix</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir">Mjolnir (Matrix Moderation Tool)</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mailman">Mailman</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#trezor">Trezor</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs">Emacs</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-livebook">Livebook</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-blackfire">Blackfire profiler</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-flatpak">Flatpak</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-postgresql">PostgreSQL</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb">FoundationDB</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-borgbase">BorgBackup</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-castopod">Castopod</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme">SSL/TLS Certificates with ACME</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-zsh-ohmyzsh">Oh my ZSH</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-program-plotinus">Plotinus</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-digitalbitbox">Digital Bitbox</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods">Input Methods</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-profiles">Profiles</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-kubernetes">Kubernetes</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-configuration-syntax" class="title">Configuration Syntax   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-configuration-file">NixOS Configuration File</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-module-abstractions">Abstractions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-modularity">Modularity</a> </span></dt> </dl></div><p>The NixOS configuration file <code class="literal">/etc/nixos/configuration.nix</code> is actually
a <span class="emphasis"><em>Nix expression</em></span>, which is the Nix package manager’s purely functional
language for describing how to build packages and configurations. This
means you have all the expressive power of that language at your
disposal, including the ability to abstract over common patterns, which
is very useful when managing complex systems. The syntax and semantics
of the Nix language are fully described in the <a class="link" href="https://nixos.org/nix/manual/#chap-writing-nix-expressions" target="_top">Nix
manual</a>, but
here we give a short overview of the most important constructs useful in
NixOS configuration files.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-configuration-file" class="title" style="clear: both">NixOS Configuration File   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-configuration-file" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The NixOS configuration file generally looks like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ option definitions
}
</code></pre><p>The first line (<code class="literal">{ config, pkgs, ... }:</code>) denotes that this is actually
a function that takes at least the two arguments <code class="literal">config</code> and <code class="literal">pkgs</code>.
(These are explained later, in chapter <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-writing-modules" title="Writing NixOS Modules"><em>Writing NixOS Modules</em></a>) The
function returns a <span class="emphasis"><em>set</em></span> of option definitions (<code class="literal">{ ... }</code>).
These definitions have the form <code class="literal">name = value</code>, where <code class="literal">name</code> is the
name of an option and <code class="literal">value</code> is its value. For example,</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  services.httpd.<span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
  services.httpd.virtualHosts.localhost.<span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot"</span>;
}
</code></pre><p>defines a configuration with three option definitions that together
enable the Apache HTTP Server with <code class="literal">/webroot</code> as the document root.</p><p>Sets can be nested, and in fact dots in option names are shorthand for
defining a set containing another set. For instance,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.httpd.enable"><code class="option">services.httpd.enable</code></a> defines a set named
<code class="literal">services</code> that contains a set named <code class="literal">httpd</code>, which in turn contains an
option definition named <code class="literal">enable</code> with value <code class="literal">true</code>. This means that the
example above can also be written as:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ <span class="hljs-attr">services</span> = {
    <span class="hljs-attr">httpd</span> = {
      <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
      <span class="hljs-attr">virtualHosts</span> = {
        <span class="hljs-attr">localhost</span> = {
          <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot"</span>;
        };
      };
    };
  };
}
</code></pre><p>which may be more convenient if you have lots of option definitions that
share the same prefix (such as <code class="literal">services.httpd</code>).</p><p>NixOS checks your option definitions for correctness. For instance, if
you try to define an option that doesn’t exist (that is, doesn’t have a
corresponding <span class="emphasis"><em>option declaration</em></span>), <code class="literal">nixos-rebuild</code> will give an error
like:</p><pre><code class="programlisting plain hljs language-bash" data-highlighted="yes">The option `services.httpd.enable<span class="hljs-string">' defined in `/etc/nixos/configuration.nix'</span> does not exist.
</code></pre><p>Likewise, values in option definitions must have a correct type. For
instance, <code class="literal">services.httpd.enable</code> must be a Boolean (<code class="literal">true</code> or <code class="literal">false</code>).
Trying to give it a value of another type, such as a string, will cause
an error:</p><pre><code class="programlisting plain hljs language-bash" data-highlighted="yes">The option value `services.httpd.enable<span class="hljs-string">' in `/etc/nixos/configuration.nix'</span> is not a boolean.
</code></pre><p>Options have various types of values. The most important are:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Strings</span></dt><dd><p>Strings are enclosed in double quotes, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">hostName</span> = <span class="hljs-string">"dexter"</span>;
</code></pre><p>Special characters can be escaped by prefixing them with a backslash
(e.g. <code class="literal">\"</code>).</p><p>Multi-line strings can be enclosed in <span class="emphasis"><em>double single quotes</em></span>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">extraHosts</span> =
  <span class="hljs-string">''
    127.0.0.2 other-localhost
    10.0.0.1 server
  ''</span>;
</code></pre><p>The main difference is that it strips from each line a number of
spaces equal to the minimal indentation of the string as a whole
(disregarding the indentation of empty lines), and that characters
like <code class="literal">"</code> and <code class="literal">\</code> are not special (making it more convenient for
including things like shell code). See more info about this in the
Nix manual <a class="link" href="https://nixos.org/nix/manual/#ssec-values" target="_top">here</a>.</p></dd><dt><span class="term">Booleans</span></dt><dd><p>These can be <code class="literal">true</code> or <code class="literal">false</code>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
networking.firewall.<span class="hljs-attr">allowPing</span> = <span class="hljs-literal">false</span>;
</code></pre></dd><dt><span class="term">Integers</span></dt><dd><p>For example,</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.kernel.sysctl.<span class="hljs-string">"net.ipv4.tcp_keepalive_time"</span> = <span class="hljs-number">60</span>;
</code></pre><p>(Note that here the attribute name <code class="literal">net.ipv4.tcp_keepalive_time</code> is
enclosed in quotes to prevent it from being interpreted as a set
named <code class="literal">net</code> containing a set named <code class="literal">ipv4</code>, and so on. This is
because it’s not a NixOS option but the literal name of a Linux
kernel setting.)</p></dd><dt><span class="term">Sets</span></dt><dd><p>Sets were introduced above. They are name/value pairs enclosed in
braces, as in the option definition</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">fileSystems.<span class="hljs-string">"/boot"</span> =
  { <span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/sda1"</span>;
    <span class="hljs-attr">fsType</span> = <span class="hljs-string">"ext4"</span>;
    <span class="hljs-attr">options</span> = [ <span class="hljs-string">"rw"</span> <span class="hljs-string">"data=ordered"</span> <span class="hljs-string">"relatime"</span> ];
  };
</code></pre></dd><dt><span class="term">Lists</span></dt><dd><p>The important thing to note about lists is that list elements are
separated by whitespace, like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.<span class="hljs-attr">kernelModules</span> = [ <span class="hljs-string">"fuse"</span> <span class="hljs-string">"kvm-intel"</span> <span class="hljs-string">"coretemp"</span> ];
</code></pre><p>List elements can be any other type, e.g. sets:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">swapDevices</span> = [ { <span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/disk/by-label/swap"</span>; } ];
</code></pre></dd><dt><span class="term">Packages</span></dt><dd><p>Usually, the packages you need are already part of the Nix Packages
collection, which is a set that can be accessed through the function
argument <code class="literal">pkgs</code>. Typical uses:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> =
  [ pkgs.thunderbird
    pkgs.emacs
  ];

services.postgresql.<span class="hljs-attr">package</span> = pkgs.postgresql_14;
</code></pre><p>The latter option definition changes the default PostgreSQL package
used by NixOS’s PostgreSQL service to 14.x. For more information on
packages, including how to add new ones, see
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-custom-packages" title="Adding Custom Packages">the section called “Adding Custom Packages”</a>.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-module-abstractions" class="title" style="clear: both">Abstractions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-module-abstractions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If you find yourself repeating yourself over and over, it’s time to abstract. Take, for instance, this Apache HTTP Server configuration:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.httpd.<span class="hljs-attr">virtualHosts</span> =
    { <span class="hljs-string">"blog.example.org"</span> = {
        <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot/blog.example.org"</span>;
        <span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
        <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">enablePHP</span> = <span class="hljs-literal">true</span>;
      };
      <span class="hljs-string">"wiki.example.org"</span> = {
        <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot/wiki.example.org"</span>;
        <span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
        <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">enablePHP</span> = <span class="hljs-literal">true</span>;
      };
    };
}
</code></pre><p>It defines two virtual hosts with nearly identical configuration; the only difference is the document root directories. To prevent this duplication, we can use a <code class="literal">let</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">commonConfig</span> =
    { <span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
      <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
    };
<span class="hljs-keyword">in</span>
{
  services.httpd.<span class="hljs-attr">virtualHosts</span> =
    { <span class="hljs-string">"blog.example.org"</span> = (commonConfig // { <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot/blog.example.org"</span>; });
      <span class="hljs-string">"wiki.example.org"</span> = (commonConfig // { <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/webroot/wiki.example.com"</span>; });
    };
}
</code></pre><p>The <code class="literal">let commonConfig = ...</code> defines a variable named <code class="literal">commonConfig</code>. The <code class="literal">//</code> operator merges two attribute sets, so the configuration of the second virtual host is the set <code class="literal">commonConfig</code> extended with the document root option.</p><p>You can write a <code class="literal">let</code> wherever an expression is allowed. Thus, you also could have written:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.httpd.<span class="hljs-attr">virtualHosts</span> =
    <span class="hljs-keyword">let</span> <span class="hljs-attr">commonConfig</span> = ...; <span class="hljs-keyword">in</span>
    { <span class="hljs-string">"blog.example.org"</span> = (commonConfig // { ... })
      <span class="hljs-string">"wiki.example.org"</span> = (commonConfig // { ... })
    };
}
</code></pre><p>but not <code class="literal">{ let commonConfig = ...; in ...; }</code> since attributes (as opposed to attribute values) are not expressions.</p><p><span class="strong"><strong>Functions</strong></span> provide another method of abstraction. For instance, suppose that we want to generate lots of different virtual hosts, all with identical configuration except for the document root. This can be done as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.httpd.<span class="hljs-attr">virtualHosts</span> =
    <span class="hljs-keyword">let</span>
      <span class="hljs-attr">makeVirtualHost</span> = webroot:
        { <span class="hljs-attr">documentRoot</span> = webroot;
          <span class="hljs-attr">adminAddr</span> = <span class="hljs-string">"alice@example.org"</span>;
          <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
        };
    <span class="hljs-keyword">in</span>
      { <span class="hljs-string">"example.org"</span> = (makeVirtualHost <span class="hljs-string">"/webroot/example.org"</span>);
        <span class="hljs-string">"example.com"</span> = (makeVirtualHost <span class="hljs-string">"/webroot/example.com"</span>);
        <span class="hljs-string">"example.gov"</span> = (makeVirtualHost <span class="hljs-string">"/webroot/example.gov"</span>);
        <span class="hljs-string">"example.nl"</span> = (makeVirtualHost <span class="hljs-string">"/webroot/example.nl"</span>);
      };
}
</code></pre><p>Here, <code class="literal">makeVirtualHost</code> is a function that takes a single argument <code class="literal">webroot</code> and returns the configuration for a virtual host. That function is then called for several names to produce the list of virtual host configurations.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-modularity" class="title" style="clear: both">Modularity   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-modularity" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The NixOS configuration mechanism is modular. If your
<code class="literal">configuration.nix</code> becomes too big, you can split it into multiple
files. Likewise, if you have multiple NixOS configurations (e.g. for
different computers) with some commonality, you can move the common
configuration into a shared file.</p><p>Modules have exactly the same syntax as <code class="literal">configuration.nix</code>. In fact,
<code class="literal">configuration.nix</code> is itself a module. You can use other modules by
including them from <code class="literal">configuration.nix</code>, e.g.:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ <span class="hljs-attr">imports</span> = [ ./vpn.nix ./kde.nix ];
  services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  environment.<span class="hljs-attr">systemPackages</span> = [ pkgs.emacs ];
  ...
}
</code></pre><p>Here, we include two modules from the same directory, <code class="literal">vpn.nix</code> and
<code class="literal">kde.nix</code>. The latter might look like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ services.xserver.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  services.xserver.displayManager.sddm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  services.xserver.desktopManager.plasma5.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  environment.<span class="hljs-attr">systemPackages</span> = [ pkgs.vim ];
}
</code></pre><p>Note that both <code class="literal">configuration.nix</code> and <code class="literal">kde.nix</code> define the option
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>. When multiple modules define an
option, NixOS will try to <span class="emphasis"><em>merge</em></span> the definitions. In the case of
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> the lists of packages will be
concatenated. The value in <code class="literal">configuration.nix</code> is
merged last, so for list-type options, it will appear at the end of the
merged list. If you want it to appear first, you can use <code class="literal">mkBefore</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.<span class="hljs-attr">kernelModules</span> = mkBefore [ <span class="hljs-string">"kvm-intel"</span> ];
</code></pre><p>This causes the <code class="literal">kvm-intel</code> kernel module to be loaded before any other
kernel modules.</p><p>For other types of options, a merge may not be possible. For instance,
if two modules define <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.httpd.adminAddr"><code class="option">services.httpd.adminAddr</code></a>,
<code class="literal">nixos-rebuild</code> will give an error:</p><pre><code class="programlisting plain hljs language-bash" data-highlighted="yes">The unique option `services.httpd.adminAddr<span class="hljs-string">' is defined multiple times, in `/etc/nixos/httpd.nix'</span> and `/etc/nixos/configuration.nix<span class="hljs-string">'.
</span></code></pre><p>When that happens, it’s possible to force one definition take precedence
over the others:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.httpd.<span class="hljs-attr">adminAddr</span> = pkgs.lib.mkForce <span class="hljs-string">"bob@example.org"</span>;
</code></pre><p>When using multiple modules, you may need to access configuration values
defined in other modules. This is what the <code class="literal">config</code> function argument is
for: it contains the complete, merged system configuration. That is,
<code class="literal">config</code> is the result of combining the configurations returned by every
module. (If you’re wondering how it’s possible that the (indirect) <span class="emphasis"><em>result</em></span>
of a function is passed as an <span class="emphasis"><em>input</em></span> to that same function: that’s
because Nix is a “lazy” language — it only computes values when
they are needed. This works as long as no individual configuration
value depends on itself.)</p><p>For example, here is a module that adds some packages to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> only if
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.enable"><code class="option">services.xserver.enable</code></a> is set to <code class="literal">true</code> somewhere else:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ environment.<span class="hljs-attr">systemPackages</span> =
    <span class="hljs-keyword">if</span> config.services.xserver.enable <span class="hljs-keyword">then</span>
      [ pkgs.firefox
        pkgs.thunderbird
      ]
    <span class="hljs-keyword">else</span>
      [ ];
}
</code></pre><p>With multiple modules, it may not be obvious what the final value of a
configuration option is. The command <code class="literal">nixos-option</code> allows you to find
out:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-option services.xserver.enable</span>
true
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">nixos-option boot.kernelModules</span>
[ "tun" "ipv6" "loop" ... ]
</code></pre><p>Interactive exploration of the configuration is possible using <code class="literal">nix   repl</code>, a read-eval-print loop for Nix expressions. A typical use:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix repl <span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span></span>
<span class="hljs-meta prompt_">
nix-repl&gt; </span><span class="language-bash">config.networking.hostName</span>
"mandark"
<span class="hljs-meta prompt_">
nix-repl&gt; </span><span class="language-bash">map (x: x.hostName) config.services.httpd.virtualHosts</span>
[ "example.org" "example.gov" ]
</code></pre><p>While abstracting your configuration, you may find it useful to generate
modules using code, instead of writing files. The example below would
have the same effect as importing a file which sets those options.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

<span class="hljs-keyword">let</span> <span class="hljs-attr">netConfig</span> = hostName: {
  networking.<span class="hljs-attr">hostName</span> = hostName;
  networking.<span class="hljs-attr">useDHCP</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">in</span>

{ <span class="hljs-attr">imports</span> = [ (netConfig <span class="hljs-string">"nixos.localdomain"</span>) ]; }
</code></pre>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-package-management" class="title">Package Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-package-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-declarative-package-mgmt">Declarative Package Management</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-ad-hoc-packages">Ad-Hoc Package Management</a> </span></dt> </dl></div><p>This section describes how to add additional packages to your system.
NixOS has two distinct styles of package management:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em>Declarative</em></span>, where you declare what packages you want in your
<code class="literal">configuration.nix</code>. Every time you run <code class="literal">nixos-rebuild</code>, NixOS will
ensure that you get a consistent set of binaries corresponding to
your specification.</p></li><li class="listitem"><p><span class="emphasis"><em>Ad hoc</em></span>, where you install, upgrade and uninstall packages via the
<code class="literal">nix-env</code> command. This style allows mixing packages from different
Nixpkgs versions. It’s the only choice for non-root users.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-declarative-package-mgmt" class="title" style="clear: both">Declarative Package Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-declarative-package-mgmt" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>With declarative package management, you specify which packages you want
on your system by setting the option
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>. For instance, adding the
following line to <code class="literal">configuration.nix</code> enables the Mozilla Thunderbird
email application:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [ pkgs.thunderbird ];
</code></pre><p>The effect of this specification is that the Thunderbird package from
Nixpkgs will be built or downloaded as part of the system when you run
<code class="literal">nixos-rebuild switch</code>.</p><div class="note"><h3 class="title">Note</h3><p>Some packages require additional global configuration such as D-Bus or
systemd service registration so adding them to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> might not be sufficient. You are
advised to check the <a class="link" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">list of options</a> whether a NixOS
module for the package does not exist.</p></div><p>You can get a list of the available packages as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -qaP <span class="hljs-string">'*'</span> --description</span>
nixos.firefox   firefox-23.0   Mozilla Firefox - the browser, reloaded
...
</code></pre><p>The first column in the output is the <span class="emphasis"><em>attribute name</em></span>, such as
<code class="literal">nixos.thunderbird</code>.</p><p>Note: the <code class="literal">nixos</code> prefix tells us that we want to get the package from
the <code class="literal">nixos</code> channel and works only in CLI tools. In declarative
configuration use <code class="literal">pkgs</code> prefix (variable).</p><p>To “uninstall” a package, remove it from
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> and run <code class="literal">nixos-rebuild switch</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-customising-packages" class="title">Customising Packages   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-customising-packages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Some packages in Nixpkgs have options to enable or disable optional
functionality or change other aspects of the package.</p><div class="warning"><h3 class="title">Warning</h3><p>Unfortunately, Nixpkgs currently lacks a way to query available
configuration options.</p></div><div class="note"><h3 class="title">Note</h3><p>For example, many packages come with extensions one might add.
Examples include:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="link" href="https://search.nixos.org/packages/query=passExtensions.pass-otp" target="_top"><code class="literal">passExtensions.pass-otp</code></a></p></li><li class="listitem"><p><a class="link" href="https://search.nixos.org/packages/query=python310Packages.requests" target="_top"><code class="literal">python310Packages.requests</code></a></p></li></ul></div><p>You can use them like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = <span class="hljs-keyword">with</span> pkgs; [
  sl
  (pass.withExtensions (subpkgs: <span class="hljs-keyword">with</span> subpkgs; [
    pass-audit
    pass-otp
    pass-genphrase
  ]))
  (python3.withPackages (subpkgs: <span class="hljs-keyword">with</span> subpkgs; [
      requests
  ]))
  cowsay
];
</code></pre></div><p>Apart from high-level options, it’s possible to tweak a package in
almost arbitrary ways, such as changing or disabling dependencies of a
package. For instance, the Emacs package in Nixpkgs by default has a
dependency on GTK 2. If you want to build it against GTK 3, you can
specify that as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [ (pkgs.emacs.override { <span class="hljs-attr">gtk</span> = pkgs.gtk3; }) ];
</code></pre><p>The function <code class="literal">override</code> performs the call to the Nix function that
produces Emacs, with the original arguments amended by the set of
arguments specified by you. So here the function argument <code class="literal">gtk</code> gets the
value <code class="literal">pkgs.gtk3</code>, causing Emacs to depend on GTK 3. (The parentheses
are necessary because in Nix, function application binds more weakly
than list construction, so without them,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>
would be a list with two elements.)</p><p>Even greater customisation is possible using the function
<code class="literal">overrideAttrs</code>. While the <code class="literal">override</code> mechanism above overrides the
arguments of a package function, <code class="literal">overrideAttrs</code> allows changing the
<span class="emphasis"><em>attributes</em></span> passed to <code class="literal">mkDerivation</code>. This permits changing any aspect
of the package, such as the source code. For instance, if you want to
override the source code of Emacs, you can say:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [
  (pkgs.emacs.overrideAttrs (oldAttrs: {
    <span class="hljs-attr">name</span> = <span class="hljs-string">"emacs-25.0-pre"</span>;
    <span class="hljs-attr">src</span> = /path/to/my/emacs/tree;
  }))
];
</code></pre><p>Here, <code class="literal">overrideAttrs</code> takes the Nix derivation specified by <code class="literal">pkgs.emacs</code>
and produces a new derivation in which the original’s <code class="literal">name</code> and <code class="literal">src</code>
attribute have been replaced by the given values by re-calling
<code class="literal">stdenv.mkDerivation</code>. The original attributes are accessible via the
function argument, which is conventionally named <code class="literal">oldAttrs</code>.</p><p>The overrides shown above are not global. They do not affect the
original package; other packages in Nixpkgs continue to depend on the
original rather than the customised package. This means that if another
package in your system depends on the original package, you end up with
two instances of the package. If you want to have everything depend on
your customised instance, you can apply a <span class="emphasis"><em>global</em></span> override as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">nixpkgs.config.<span class="hljs-attr">packageOverrides</span> = pkgs:
  { <span class="hljs-attr">emacs</span> = pkgs.emacs.override { <span class="hljs-attr">gtk</span> = pkgs.gtk3; };
  };
</code></pre><p>The effect of this definition is essentially equivalent to modifying the
<code class="literal">emacs</code> attribute in the Nixpkgs source tree. Any package in Nixpkgs
that depends on <code class="literal">emacs</code> will be passed your customised instance.
(However, the value <code class="literal">pkgs.emacs</code> in <code class="literal">nixpkgs.config.packageOverrides</code>
refers to the original rather than overridden instance, to prevent an
infinite recursion.)</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-custom-packages" class="title">Adding Custom Packages   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-custom-packages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>It’s possible that a package you need is not available in NixOS. In that
case, you can do two things. Either you can package it with Nix, or you can try
to use prebuilt packages from upstream. Due to the peculiarities of NixOS, it
is important to note that building software from source is often easier than
using pre-built executables.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-custom-packages-nix" class="title">Building with Nix   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-custom-packages-nix" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>This can be done either in-tree or out-of-tree. For an in-tree build, you can
clone the Nixpkgs repository, add the package to your clone, and (optionally)
submit a patch or pull request to have it accepted into the main Nixpkgs
repository. This is described in detail in the <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top">Nixpkgs
manual</a>. In short, you clone Nixpkgs:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/NixOS/nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> nixpkgs</span>
</code></pre><p>Then you write and test the package as described in the Nixpkgs manual.
Finally, you add it to <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [ pkgs.my-package ];
</code></pre><p>and you run <code class="literal">nixos-rebuild</code>, specifying your own Nixpkgs tree:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch -I nixpkgs=/path/to/my/nixpkgs</span>
</code></pre><p>The second possibility is to add the package outside of the Nixpkgs
tree. For instance, here is how you specify a build of the
<a class="link" href="https://www.gnu.org/software/hello/" target="_top">GNU Hello</a> package directly in
<code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> =
  <span class="hljs-keyword">let</span>
    <span class="hljs-attr">my-hello</span> = <span class="hljs-keyword">with</span> pkgs; stdenv.mkDerivation <span class="hljs-keyword">rec</span> {
      <span class="hljs-attr">name</span> = <span class="hljs-string">"hello-2.8"</span>;
      <span class="hljs-attr">src</span> = fetchurl {
        <span class="hljs-attr">url</span> = <span class="hljs-string">"mirror://gnu/hello/<span class="hljs-subst">${name}</span>.tar.gz"</span>;
        <span class="hljs-attr">hash</span> = <span class="hljs-string">"sha256-5rd/gffPfa761Kn1tl3myunD8TuM+66oy1O7XqVGDXM="</span>;
      };
    };
  <span class="hljs-keyword">in</span>
  [ my-hello ];
</code></pre><p>Of course, you can also move the definition of <code class="literal">my-hello</code> into a
separate Nix expression, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [ (<span class="hljs-built_in">import</span> ./my-hello.nix) ];
</code></pre><p>where <code class="literal">my-hello.nix</code> contains:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">with</span> <span class="hljs-built_in">import</span> &lt;nixpkgs&gt; {}; <span class="hljs-comment"># bring all of Nixpkgs into scope</span>

stdenv.mkDerivation <span class="hljs-keyword">rec</span> {
  <span class="hljs-attr">name</span> = <span class="hljs-string">"hello-2.8"</span>;
  <span class="hljs-attr">src</span> = fetchurl {
    <span class="hljs-attr">url</span> = <span class="hljs-string">"mirror://gnu/hello/<span class="hljs-subst">${name}</span>.tar.gz"</span>;
    <span class="hljs-attr">hash</span> = <span class="hljs-string">"sha256-5rd/gffPfa761Kn1tl3myunD8TuM+66oy1O7XqVGDXM="</span>;
  };
}
</code></pre><p>This allows testing the package easily:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build my-hello.nix</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./result/bin/hello</span>
Hello, world!
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-custom-packages-prebuilt" class="title">Using pre-built executables   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-custom-packages-prebuilt" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Most pre-built executables will not work on NixOS. There are two notable
exceptions: flatpaks and AppImages. For flatpaks see the <a class="link" href="https://nixos.org/manual/nixos/stable/#module-services-flatpak" title="Flatpak">dedicated
section</a>. AppImages will not run “as-is” on NixOS.
First you need to install <code class="literal">appimage-run</code>: add to <code class="literal">/etc/nixos/configuration.nix</code></p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [ pkgs.appimage-run ];
</code></pre><p>Then instead of running the AppImage “as-is”, run <code class="literal">appimage-run foo.appimage</code>.</p><p>To make other pre-built executables work on NixOS, you need to package them
with Nix and special helpers like <code class="literal">autoPatchelfHook</code> or <code class="literal">buildFHSEnv</code>. See
the <a class="link" href="https://nixos.org/nixpkgs/manual" target="_top">Nixpkgs manual</a> for details. This
is complex and often doing a source build is easier.</p>
</div>

</div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ad-hoc-packages" class="title" style="clear: both">Ad-Hoc Package Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-ad-hoc-packages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>With the command <code class="literal">nix-env</code>, you can install and uninstall packages from
the command line. For instance, to install Mozilla Thunderbird:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -iA nixos.thunderbird</span>
</code></pre><p>If you invoke this as root, the package is installed in the Nix profile
<code class="literal">/nix/var/nix/profiles/default</code> and visible to all users of the system;
otherwise, the package ends up in
<code class="literal">/nix/var/nix/profiles/per-user/username/profile</code> and is not visible to
other users. The <code class="literal">-A</code> flag specifies the package by its attribute name;
without it, the package is installed by matching against its package
name (e.g. <code class="literal">thunderbird</code>). The latter is slower because it requires
matching against all available Nix packages, and is ambiguous if there
are multiple matching packages.</p><p>Packages come from the NixOS channel. You typically upgrade a package by
updating to the latest version of the NixOS channel:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-channel --update nixos</span>
</code></pre><p>and then running <code class="literal">nix-env -i</code> again. Other packages in the profile are
<span class="emphasis"><em>not</em></span> affected; this is the crucial difference with the declarative
style of package management, where running <code class="literal">nixos-rebuild switch</code> causes
all packages to be updated to their current versions in the NixOS
channel. You can however upgrade all packages for which there is a newer
version by doing:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -u <span class="hljs-string">'*'</span></span>
</code></pre><p>A package can be uninstalled using the <code class="literal">-e</code> flag:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -e thunderbird</span>
</code></pre><p>Finally, you can roll back an undesirable <code class="literal">nix-env</code> action:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env --rollback</span>
</code></pre><p><code class="literal">nix-env</code> has many more flags. For details, see the nix-env(1) manpage or
the Nix manual.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-user-management" class="title">User Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-user-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS supports both declarative and imperative styles of user
management. In the declarative style, users are specified in
<code class="literal">configuration.nix</code>. For instance, the following states that a user
account named <code class="literal">alice</code> shall exist:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.users.<span class="hljs-attr">alice</span> = {
  <span class="hljs-attr">isNormalUser</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">home</span> = <span class="hljs-string">"/home/alice"</span>;
  <span class="hljs-attr">description</span> = <span class="hljs-string">"Alice Foobar"</span>;
  <span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">"wheel"</span> <span class="hljs-string">"networkmanager"</span> ];
  openssh.authorizedKeys.<span class="hljs-attr">keys</span> = [ <span class="hljs-string">"ssh-dss AAAAB3Nza... alice@foobar"</span> ];
};
</code></pre><p>Note that <code class="literal">alice</code> is a member of the <code class="literal">wheel</code> and <code class="literal">networkmanager</code>
groups, which allows her to use <code class="literal">sudo</code> to execute commands as <code class="literal">root</code> and
to configure the network, respectively. Also note the SSH public key
that allows remote logins with the corresponding private key. Users
created in this way do not have a password by default, so they cannot
log in via mechanisms that require a password. However, you can use the
<code class="literal">passwd</code> program to set a password, which is retained across invocations
of <code class="literal">nixos-rebuild</code>.</p><p>If you set <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-users.mutableUsers"><code class="option">users.mutableUsers</code></a> to
false, then the contents of <code class="literal">/etc/passwd</code> and <code class="literal">/etc/group</code> will be congruent
to your NixOS configuration. For instance, if you remove a user from
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-users.users"><code class="option">users.users</code></a> and run nixos-rebuild, the user
account will cease to exist. Also, imperative commands for managing users and
groups, such as useradd, are no longer available. Passwords may still be
assigned by setting the user’s
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-users.users._name_.hashedPassword">hashedPassword</a> option. A
hashed password can be generated using <code class="literal">mkpasswd</code>.</p><p>A user ID (uid) is assigned automatically. You can also specify a uid
manually by adding</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">uid</span> = <span class="hljs-number">1000</span>;
</code></pre><p>to the user specification.</p><p>Groups can be specified similarly. The following states that a group
named <code class="literal">students</code> shall exist:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.groups.students.<span class="hljs-attr">gid</span> = <span class="hljs-number">1000</span>;
</code></pre><p>As with users, the group ID (gid) is optional and will be assigned
automatically if it’s missing.</p><p>In the imperative style, users and groups are managed by commands such
as <code class="literal">useradd</code>, <code class="literal">groupmod</code> and so on. For instance, to create a user
account named <code class="literal">alice</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">useradd -m alice</span>
</code></pre><p>To make all nix tools available to this new user use `su - USER` which
opens a login shell (==shell that loads the profile) for given user.
This will create the ~/.nix-defexpr symlink. So run:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">su - alice -c <span class="hljs-string">"true"</span></span>
</code></pre><p>The flag <code class="literal">-m</code> causes the creation of a home directory for the new user,
which is generally what you want. The user does not have an initial
password and therefore cannot log in. A password can be set using the
<code class="literal">passwd</code> utility:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">passwd alice</span>
Enter new UNIX password: ***
Retype new UNIX password: ***
</code></pre><p>A user can be deleted using <code class="literal">userdel</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">userdel -r alice</span>
</code></pre><p>The flag <code class="literal">-r</code> deletes the user’s home directory. Accounts can be
modified using <code class="literal">usermod</code>. Unix groups can be managed using <code class="literal">groupadd</code>,
<code class="literal">groupmod</code> and <code class="literal">groupdel</code>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-file-systems" class="title">File Systems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-file-systems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-luks-file-systems">LUKS-Encrypted File Systems</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-sshfs-file-systems">SSHFS File Systems</a> </span></dt> </dl></div><p>You can define file systems using the <code class="literal">fileSystems</code> configuration
option. For instance, the following definition causes NixOS to mount the
Ext4 file system on device <code class="literal">/dev/disk/by-label/data</code> onto the mount
point <code class="literal">/data</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">fileSystems.<span class="hljs-string">"/data"</span> =
  { <span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/disk/by-label/data"</span>;
    <span class="hljs-attr">fsType</span> = <span class="hljs-string">"ext4"</span>;
  };
</code></pre><p>This will create an entry in <code class="literal">/etc/fstab</code>, which will generate a
corresponding <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.mount.html" target="_top">systemd.mount</a>
unit via <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd-fstab-generator.html" target="_top">systemd-fstab-generator</a>.
The filesystem will be mounted automatically unless <code class="literal">"noauto"</code> is
present in <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-fileSystems._name_.options">options</a>. <code class="literal">"noauto"</code>
filesystems can be mounted explicitly using <code class="literal">systemctl</code> e.g.
<code class="literal">systemctl start data.mount</code>. Mount points are created automatically if they don’t
already exist. For <code class="literal">device</code>, it’s best to use the topology-independent
device aliases in <code class="literal">/dev/disk/by-label</code> and <code class="literal">/dev/disk/by-uuid</code>, as these
don’t change if the topology changes (e.g. if a disk is moved to another
IDE controller).</p><p>You can usually omit the file system type (<code class="literal">fsType</code>), since <code class="literal">mount</code> can
usually detect the type and load the necessary kernel module
automatically. However, if the file system is needed at early boot (in
the initial ramdisk) and is not <code class="literal">ext2</code>, <code class="literal">ext3</code> or <code class="literal">ext4</code>, then it’s best
to specify <code class="literal">fsType</code> to ensure that the kernel module is available.</p><div class="note"><h3 class="title">Note</h3><p>System startup will fail if any of the filesystems fails to mount,
dropping you to the emergency shell. You can make a mount asynchronous
and non-critical by adding <code class="literal">options = [ "nofail" ];</code>.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-luks-file-systems" class="title" style="clear: both">LUKS-Encrypted File Systems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-luks-file-systems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS supports file systems that are encrypted using <span class="emphasis"><em>LUKS</em></span> (Linux
Unified Key Setup). For example, here is how you create an encrypted
Ext4 file system on the device
<code class="literal">/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">cryptsetup luksFormat /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d</span>

WARNING!
========
This will overwrite data on /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d irrevocably.

Are you sure? (Type uppercase yes): YES
Enter LUKS passphrase: ***
Verify passphrase: ***
<span class="hljs-meta prompt_">
# </span><span class="language-bash">cryptsetup luksOpen /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d crypted</span>
Enter passphrase for /dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d: ***
<span class="hljs-meta prompt_">
# </span><span class="language-bash">mkfs.ext4 /dev/mapper/crypted</span>
</code></pre><p>The LUKS volume should be automatically picked up by
<code class="literal">nixos-generate-config</code>, but you might want to verify that your
<code class="literal">hardware-configuration.nix</code> looks correct. To manually ensure that the
system is automatically mounted at boot time as <code class="literal">/</code>, add the following
to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.luks.devices.crypted.<span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/disk/by-uuid/3f6b0024-3a44-4fde-a43a-767b872abe5d"</span>;
fileSystems.<span class="hljs-string">"/"</span>.<span class="hljs-attr">device</span> = <span class="hljs-string">"/dev/mapper/crypted"</span>;
</code></pre><p>Should grub be used as bootloader, and <code class="literal">/boot</code> is located on an
encrypted partition, it is necessary to add the following grub option:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.loader.grub.<span class="hljs-attr">enableCryptodisk</span> = <span class="hljs-literal">true</span>;
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-luks-file-systems-fido2" class="title">FIDO2   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-luks-file-systems-fido2" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>NixOS also supports unlocking your LUKS-Encrypted file system using a
FIDO2 compatible token. In the following example, we will create a new
FIDO2 credential and add it as a new key to our existing device
<code class="literal">/dev/sda2</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">export</span> FIDO2_LABEL=<span class="hljs-string">"/dev/sda2 @ <span class="hljs-variable">$HOSTNAME</span>"</span></span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">fido2luks credential <span class="hljs-string">"<span class="hljs-variable">$FIDO2_LABEL</span>"</span></span>
f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7
<span class="hljs-meta prompt_">
# </span><span class="language-bash">fido2luks -i add-key /dev/sda2 f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7</span>
Password:
Password (again):
Old password:
Old password (again):
Added to key to device /dev/sda2, slot: 2
</code></pre><p>To ensure that this file system is decrypted using the FIDO2 compatible
key, add the following to <code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.luks.<span class="hljs-attr">fido2Support</span> = <span class="hljs-literal">true</span>;
boot.initrd.luks.devices.<span class="hljs-string">"/dev/sda2"</span>.fido2.<span class="hljs-attr">credential</span> = <span class="hljs-string">"f1d00200108b9d6e849a8b388da457688e3dd653b4e53770012d8f28e5d3b269865038c346802f36f3da7278b13ad6a3bb6a1452e24ebeeaa24ba40eef559b1b287d2a2f80b7"</span>;
</code></pre><p>You can also use the FIDO2 passwordless setup, but for security reasons,
you might want to enable it only when your device is PIN protected, such
as <a class="link" href="https://trezor.io/" target="_top">Trezor</a>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.luks.devices.<span class="hljs-string">"/dev/sda2"</span>.fido2.<span class="hljs-attr">passwordLess</span> = <span class="hljs-literal">true</span>;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-sshfs-file-systems" class="title" style="clear: both">SSHFS File Systems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-sshfs-file-systems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://github.com/libfuse/sshfs" target="_top">SSHFS</a> is a <a class="link" href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace" target="_top">FUSE</a> filesystem that allows easy access to directories on a remote machine using the SSH File Transfer Protocol (SFTP).
It means that if you have SSH access to a machine, no additional setup is needed to mount a directory.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-sshfs-interactive" class="title">Interactive mounting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-sshfs-interactive" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>In NixOS, SSHFS is packaged as <code class="literal">sshfs</code>.
Once installed, mounting a directory interactively is simple as running:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sshfs my-user@example.com:/my-dir /mnt/my-dir</span>
</code></pre><p>Like any other FUSE file system, the directory is unmounted using:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">fusermount -u /mnt/my-dir</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-sshfs-non-interactive" class="title">Non-interactive mounting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-sshfs-non-interactive" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Mounting non-interactively requires some precautions because <code class="literal">sshfs</code> will run at boot and under a different user (root).
For obvious reason, you can’t input a password, so public key authentication using an unencrypted key is needed.
To create a new key without a passphrase you can do:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh-keygen -t ed25519 -P <span class="hljs-string">''</span> -f example-key</span>
Generating public/private ed25519 key pair.
Your identification has been saved in test-key
Your public key has been saved in test-key.pub
The key fingerprint is:
SHA256:yjxl3UbTn31fLWeyLYTAKYJPRmzknjQZoyG8gSNEoIE my-user@workstation
</code></pre><p>To keep the key safe, change the ownership to <code class="literal">root:root</code> and make sure the permissions are <code class="literal">600</code>:
OpenSSH normally refuses to use the key if it’s not well-protected.</p><p>The file system can be configured in NixOS via the usual <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-fileSystems">fileSystems</a> option.
Here’s a typical setup:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  system.<span class="hljs-attr">fsPackages</span> = [ pkgs.sshfs ];

  fileSystems.<span class="hljs-string">"/mnt/my-dir"</span> = {
    <span class="hljs-attr">device</span> = <span class="hljs-string">"my-user@example.com:/my-dir/"</span>;
    <span class="hljs-attr">fsType</span> = <span class="hljs-string">"sshfs"</span>;
    <span class="hljs-attr">options</span> =
      [ <span class="hljs-comment"># Filesystem options</span>
        <span class="hljs-string">"allow_other"</span>          <span class="hljs-comment"># for non-root access</span>
        <span class="hljs-string">"_netdev"</span>              <span class="hljs-comment"># this is a network fs</span>
        <span class="hljs-string">"x-systemd.automount"</span>  <span class="hljs-comment"># mount on demand</span>

        <span class="hljs-comment"># SSH options</span>
        <span class="hljs-string">"reconnect"</span>              <span class="hljs-comment"># handle connection drops</span>
        <span class="hljs-string">"ServerAliveInterval=15"</span> <span class="hljs-comment"># keep connections alive</span>
        <span class="hljs-string">"IdentityFile=/var/secrets/example-key"</span>
      ];
  };
}
</code></pre><p>More options from <code class="literal">ssh_config(5)</code> can be given as well, for example you can change the default SSH port or specify a jump proxy:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">options</span> =
    [ <span class="hljs-string">"ProxyJump=bastion@example.com"</span>
      <span class="hljs-string">"Port=22"</span>
    ];
}
</code></pre><p>It’s also possible to change the <code class="literal">ssh</code> command used by SSHFS to connect to the server.
For example:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">options</span> =
    [ (<span class="hljs-built_in">builtins</span>.replaceStrings [<span class="hljs-string">" "</span>] [<span class="hljs-string">"\\040"</span>]
        <span class="hljs-string">"ssh_command=<span class="hljs-subst">${pkgs.openssh}</span>/bin/ssh -v -L 8080:localhost:80"</span>)
    ];

}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The escaping of spaces is needed because every option is written to the <code class="literal">/etc/fstab</code> file, which is a space-separated table.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-sshfs-troubleshooting" class="title">Troubleshooting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-sshfs-troubleshooting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>If you’re having a hard time figuring out why mounting is failing, you can add the option <code class="literal">"debug"</code>.
This enables a verbose log in SSHFS that you can access via:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">journalctl -u $(systemd-escape -p /mnt/my-dir/).mount</span>
Jun 22 11:41:18 workstation mount[87790]: SSHFS version 3.7.1
Jun 22 11:41:18 workstation mount[87793]: executing &lt;ssh&gt; &lt;-x&gt; &lt;-a&gt; &lt;-oClearAllForwardings=yes&gt; &lt;-oServerAliveInterval=15&gt; &lt;-oIdentityFile=/var/secrets/wrong-key&gt; &lt;-2&gt; &lt;my-user@example.com&gt; &lt;-s&gt; &lt;sftp&gt;
Jun 22 11:41:19 workstation mount[87793]: my-user@example.com: Permission denied (publickey).
Jun 22 11:41:19 workstation mount[87790]: read: Connection reset by peer
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Mount process exited, code=exited, status=1/FAILURE
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Failed with result 'exit-code'.
Jun 22 11:41:19 workstation systemd[1]: Failed to mount /mnt/my-dir.
Jun 22 11:41:19 workstation systemd[1]: mnt-my\x2ddir.mount: Consumed 54ms CPU time, received 2.3K IP traffic, sent 2.7K IP traffic.
</code></pre><div class="note"><h3 class="title">Note</h3><p>If the mount point contains special characters it needs to be escaped using <code class="literal">systemd-escape</code>.
This is due to the way systemd converts paths into unit names.</p></div>
</div>

</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11" class="title">X Window System   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11-auto-login">Auto-login</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-intel">Intel Graphics drivers</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11-graphics-cards-nvidia">Proprietary NVIDIA drivers</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-amd">Proprietary AMD drivers</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11-touchpads">Touchpads</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-x11-gtk-and-qt-themes">GTK/Qt themes</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#custom-xkb-layouts">Custom XKB layouts</a> </span></dt> </dl></div><p>The X Window System (X11) provides the basis of NixOS’ graphical user
interface. It can be enabled as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>The X server will automatically detect and use the appropriate video
driver from a set of X.org drivers (such as <code class="literal">vesa</code> and <code class="literal">intel</code>). You can
also specify a driver manually, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"r128"</span> ];
</code></pre><p>to enable X.org’s <code class="literal">xf86-video-r128</code> driver.</p><p>You also need to enable at least one desktop or window manager.
Otherwise, you can only log into a plain undecorated <code class="literal">xterm</code> window.
Thus you should pick one or more of the following lines:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.plasma5.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.desktopManager.xfce.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.desktopManager.gnome.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.desktopManager.mate.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.windowManager.xmonad.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.windowManager.twm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.windowManager.icewm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.windowManager.i3.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.windowManager.herbstluftwm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>NixOS’s default <span class="emphasis"><em>display manager</em></span> (the program that provides a graphical
login prompt and manages the X server) is LightDM. You can select an
alternative one by picking one of the following lines:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.sddm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.displayManager.gdm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>You can set the keyboard layout (and optionally the layout variant):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.xkb.<span class="hljs-attr">layout</span> = <span class="hljs-string">"de"</span>;
services.xserver.xkb.<span class="hljs-attr">variant</span> = <span class="hljs-string">"neo"</span>;
</code></pre><p>The X server is started automatically at boot time. If you don’t want
this to happen, you can set:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">autorun</span> = <span class="hljs-literal">false</span>;
</code></pre><p>The X server can then be started manually:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start display-manager.service</span>
</code></pre><p>On 64-bit systems, if you want OpenGL for 32-bit programs such as in
Wine, you should also set the following:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">driSupport32Bit</span> = <span class="hljs-literal">true</span>;
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-auto-login" class="title" style="clear: both">Auto-login   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11-auto-login" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The x11 login screen can be skipped entirely, automatically logging you
into your window manager and desktop environment when you boot your
computer.</p><p>This is especially helpful if you have disk encryption enabled. Since
you already have to provide a password to decrypt your disk, entering a
second password to login can be redundant.</p><p>To enable auto-login, you need to define your default window manager and
desktop environment. If you wanted no desktop environment and i3 as your
your window manager, you’d define:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.<span class="hljs-attr">defaultSession</span> = <span class="hljs-string">"none+i3"</span>;
</code></pre><p>Every display manager in NixOS supports auto-login, here is an example
using lightdm for a user <code class="literal">alice</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.lightdm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.displayManager.autoLogin.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.displayManager.autoLogin.<span class="hljs-attr">user</span> = <span class="hljs-string">"alice"</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11--graphics-cards-intel" class="title" style="clear: both">Intel Graphics drivers   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-intel" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>There are two choices for Intel Graphics drivers in X.org: <code class="literal">modesetting</code>
(included in the xorg-server itself) and <code class="literal">intel</code> (provided by the
package xf86-video-intel).</p><p>The default and recommended is <code class="literal">modesetting</code>. It is a generic driver
which uses the kernel <a class="link" href="https://en.wikipedia.org/wiki/Mode_setting" target="_top">mode
setting</a> (KMS) mechanism. It
supports Glamor (2D graphics acceleration via OpenGL) and is actively
maintained but may perform worse in some cases (like in old chipsets).</p><p>The second driver, <code class="literal">intel</code>, is specific to Intel GPUs, but not
recommended by most distributions: it lacks several modern features (for
example, it doesn’t support Glamor) and the package hasn’t been
officially updated since 2015.</p><p>The results vary depending on the hardware, so you may have to try both
drivers. Use the option
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.videoDrivers"><code class="option">services.xserver.videoDrivers</code></a>
to set one. The recommended configuration for modern systems is:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"modesetting"</span> ];
</code></pre><p>If you experience screen tearing no matter what, this configuration was
reported to resolve the issue:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"intel"</span> ];
services.xserver.<span class="hljs-attr">deviceSection</span> = <span class="hljs-string">''
  Option "DRI" "2"
  Option "TearFree" "true"
''</span>;
</code></pre><p>Note that this will likely downgrade the performance compared to
<code class="literal">modesetting</code> or <code class="literal">intel</code> with DRI 3 (default).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-graphics-cards-nvidia" class="title" style="clear: both">Proprietary NVIDIA drivers   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11-graphics-cards-nvidia" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NVIDIA provides a proprietary driver for its graphics cards that has
better 3D performance than the X.org drivers. It is not enabled by
default because it’s not free software. You can enable it as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"nvidia"</span> ];
</code></pre><p>Or if you have an older card, you may have to use one of the legacy
drivers:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"nvidiaLegacy390"</span> ];
services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"nvidiaLegacy340"</span> ];
services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"nvidiaLegacy304"</span> ];
</code></pre><p>You may need to reboot after enabling this driver to prevent a clash
with other kernel modules.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11--graphics-cards-amd" class="title" style="clear: both">Proprietary AMD drivers   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11--graphics-cards-amd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>AMD provides a proprietary driver for its graphics cards that is not
enabled by default because it’s not Free Software, is often broken in
nixpkgs and as of this writing doesn’t offer more features or
performance. If you still want to use it anyway, you need to explicitly
set:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.<span class="hljs-attr">videoDrivers</span> = [ <span class="hljs-string">"amdgpu-pro"</span> ];
</code></pre><p>You will need to reboot after enabling this driver to prevent a clash
with other kernel modules.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-touchpads" class="title" style="clear: both">Touchpads   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11-touchpads" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Support for Synaptics touchpads (found in many laptops such as the Dell
Latitude series) can be enabled as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.libinput.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>The driver has many options (see <a class="xref" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">Appendix&nbsp;A</a>).
For instance, the following disables tap-to-click behavior:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.libinput.touchpad.<span class="hljs-attr">tapping</span> = <span class="hljs-literal">false</span>;
</code></pre><p>Note: the use of <code class="literal">services.xserver.synaptics</code> is deprecated since NixOS
17.09.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-x11-gtk-and-qt-themes" class="title" style="clear: both">GTK/Qt themes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-x11-gtk-and-qt-themes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>GTK themes can be installed either to user profile or system-wide (via
<code class="literal">environment.systemPackages</code>). To make Qt 5 applications look similar to
GTK ones, you can use the following configuration:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">qt.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
qt.<span class="hljs-attr">platformTheme</span> = <span class="hljs-string">"gtk2"</span>;
qt.<span class="hljs-attr">style</span> = <span class="hljs-string">"gtk2"</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="custom-xkb-layouts" class="title" style="clear: both">Custom XKB layouts   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#custom-xkb-layouts" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>It is possible to install custom <a class="link" href="https://en.wikipedia.org/wiki/X_keyboard_extension" target="_top"> XKB
</a> keyboard layouts
using the option <code class="literal">services.xserver.xkb.extraLayouts</code>.</p><p>As a first example, we are going to create a layout based on the basic
US layout, with an additional layer to type some greek symbols by
pressing the right-alt key.</p><p>Create a file called <code class="literal">us-greek</code> with the following content (under a
directory called <code class="literal">symbols</code>; it’s an XKB peculiarity that will help with
testing):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">xkb_symbols <span class="hljs-string">"us-greek"</span>
{
  include <span class="hljs-string">"us(basic)"</span>            // includes the base US keys
  include <span class="hljs-string">"level3(ralt_switch)"</span>  // configures right alt as a third level switch

  key &lt;LatA&gt; { [ a, A, Greek_alpha ] };
  key &lt;LatB&gt; { [ b, B, Greek_beta  ] };
  key &lt;LatG&gt; { [ g, G, Greek_gamma ] };
  key &lt;LatD&gt; { [ d, D, Greek_delta ] };
  key &lt;LatZ&gt; { [ z, Z, Greek_zeta  ] };
};
</code></pre><p>A minimal layout specification must include the following:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.xkb.extraLayouts.<span class="hljs-attr">us-greek</span> = {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"US layout with alt-gr greek"</span>;
  <span class="hljs-attr">languages</span>   = [ <span class="hljs-string">"eng"</span> ];
  <span class="hljs-attr">symbolsFile</span> = /yourpath/symbols/us-greek;
};
</code></pre><div class="note"><h3 class="title">Note</h3><p>The name (after <code class="literal">extraLayouts.</code>) should match the one given to the
<code class="literal">xkb_symbols</code> block.</p></div><p>Applying this customization requires rebuilding several packages, and a
broken XKB file can lead to the X session crashing at login. Therefore,
you’re strongly advised to <span class="strong"><strong>test your layout before applying it</strong></span>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell -p xorg.xkbcomp</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">setxkbmap -I/yourpath us-greek -<span class="hljs-built_in">print</span> | xkbcomp -I/yourpath - <span class="hljs-variable">$DISPLAY</span></span>
</code></pre><p>You can inspect the predefined XKB files for examples:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(nix-build --no-out-link '&lt;nixpkgs&gt;' -A xorg.xkeyboardconfig)</span>/etc/X11/xkb/"</span></span>
</code></pre><p>Once the configuration is applied, and you did a logout/login cycle, the
layout should be ready to use. You can try it by e.g. running
<code class="literal">setxkbmap us-greek</code> and then type <code class="literal">&lt;alt&gt;+a</code> (it may not get applied in
your terminal straight away). To change the default, the usual
<code class="literal">services.xserver.xkb.layout</code> option can still be used.</p><p>A layout can have several other components besides <code class="literal">xkb_symbols</code>, for
example we will define new keycodes for some multimedia key and bind
these to some symbol.</p><p>Use the <span class="emphasis"><em>xev</em></span> utility from <code class="literal">pkgs.xorg.xev</code> to find the codes of the keys
of interest, then create a <code class="literal">media-key</code> file to hold the keycodes
definitions</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">xkb_keycodes <span class="hljs-string">"media"</span>
{
 &lt;volUp&gt;   = <span class="hljs-number">123</span>;
 &lt;volDown&gt; = <span class="hljs-number">456</span>;
}
</code></pre><p>Now use the newly define keycodes in <code class="literal">media-sym</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">xkb_symbols <span class="hljs-string">"media"</span>
{
 key.<span class="hljs-attr">type</span> = <span class="hljs-string">"ONE_LEVEL"</span>;
 key &lt;volUp&gt;   { [ XF86AudioLowerVolume ] };
 key &lt;volDown&gt; { [ XF86AudioRaiseVolume ] };
}
</code></pre><p>As before, to install the layout do</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.xkb.extraLayouts.<span class="hljs-attr">media</span> = {
  <span class="hljs-attr">description</span>  = <span class="hljs-string">"Multimedia keys remapping"</span>;
  <span class="hljs-attr">languages</span>    = [ <span class="hljs-string">"eng"</span> ];
  <span class="hljs-attr">symbolsFile</span>  = /path/to/media-key;
  <span class="hljs-attr">keycodesFile</span> = /path/to/media-sym;
};
</code></pre><div class="note"><h3 class="title">Note</h3><p>The function <code class="literal">pkgs.writeText &lt;filename&gt; &lt;content&gt;</code> can be useful if you
prefer to keep the layout definitions inside the NixOS configuration.</p></div><p>Unfortunately, the Xorg server does not (currently) support setting a
keymap directly but relies instead on XKB rules to select the matching
components (keycodes, types, …) of a layout. This means that
components other than symbols won’t be loaded by default. As a
workaround, you can set the keymap using <code class="literal">setxkbmap</code> at the start of the
session with:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.<span class="hljs-attr">sessionCommands</span> = <span class="hljs-string">"setxkbmap -keycodes media"</span>;
</code></pre><p>If you are manually starting the X server, you should set the argument
<code class="literal">-xkbdir /etc/X11/xkb</code>, otherwise X won’t find your layout files. For
example with <code class="literal">xinit</code> run</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">xinit -- -xkbdir /etc/X11/xkb</span>
</code></pre><p>To learn how to write layouts take a look at the XKB <a class="link" href="https://www.x.org/releases/current/doc/xorg-docs/input/XKB-Enhancing.html#Defining_New_Layouts" target="_top">documentation
</a>.
More example layouts can also be found <a class="link" href="https://wiki.archlinux.org/index.php/X_KeyBoard_extension#Basic_examples" target="_top">here
</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-wayland" class="title">Wayland   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-wayland" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>While X11 (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-x11" title="X Window System"><em>X Window System</em></a>) is still the primary display technology
on NixOS, Wayland support is steadily improving. Where X11 separates the
X Server and the window manager, on Wayland those are combined: a
Wayland Compositor is like an X11 window manager, but also embeds the
Wayland ‘Server’ functionality. This means it is sufficient to install
a Wayland Compositor such as sway without separately enabling a Wayland
server:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">programs.sway.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>This installs the sway compositor along with some essential utilities.
Now you can start sway from the TTY console.</p><p>If you are using a wlroots-based compositor, like sway, and want to be
able to share your screen, you might want to activate this option:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">xdg.portal.wlr.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>and configure Pipewire using
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.pipewire.enable"><code class="option">services.pipewire.enable</code></a>
and related options.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel" class="title">GPU acceleration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl">OpenCL</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-vulkan">Vulkan</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-va-api">VA-API</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues">Common issues</a> </span></dt> </dl></div><p>NixOS provides various APIs that benefit from GPU hardware acceleration,
such as VA-API and VDPAU for video playback; OpenGL and Vulkan for 3D
graphics; and OpenCL for general-purpose computing. This chapter
describes how to set up GPU hardware acceleration (as far as this is not
done automatically) and how to verify that hardware acceleration is
indeed used.</p><p>Most of the aforementioned APIs are agnostic with regards to which
display server is used. Consequently, these instructions should apply
both to the X Window System and Wayland compositors.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-opencl" class="title" style="clear: both">OpenCL   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/OpenCL" target="_top">OpenCL</a> is a general compute API.
It is used by various applications such as Blender and Darktable to
accelerate certain operations.</p><p>OpenCL applications load drivers through the <span class="emphasis"><em>Installable Client Driver</em></span>
(ICD) mechanism. In this mechanism, an ICD file specifies the path to
the OpenCL driver for a particular GPU family. In NixOS, there are two
ways to make ICD files visible to the ICD loader. The first is through
the <code class="literal">OCL_ICD_VENDORS</code> environment variable. This variable can contain a
directory which is scanned by the ICL loader for ICD files. For example:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> \
  OCL_ICD_VENDORS=`nix-build <span class="hljs-string">'&lt;nixpkgs&gt;'</span> --no-out-link -A rocmPackages.clr.icd`/etc/OpenCL/vendors/</span>
</code></pre><p>The second mechanism is to add the OpenCL driver package to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>.
This links the ICD file under <code class="literal">/run/opengl-driver</code>, where it will be visible
to the ICD loader.</p><p>The proper installation of OpenCL drivers can be verified through the
<code class="literal">clinfo</code> command of the clinfo package. This command will report the
number of hardware devices that is found and give detailed information
for each device:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">clinfo | <span class="hljs-built_in">head</span> -n3</span>
Number of platforms  1
Platform Name        AMD Accelerated Parallel Processing
Platform Vendor      Advanced Micro Devices, Inc.
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-opencl-amd" class="title">AMD   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl-amd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top">Graphics Core
Next</a> (GCN) GPUs are
supported through the rocmPackages.clr.icd package. Adding this package to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>
enables OpenCL support:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">extraPackages</span> = [
  rocmPackages.clr.icd
];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-opencl-intel" class="title">Intel   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-opencl-intel" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units#Gen8" target="_top">Intel Gen8 and later
GPUs</a>
are supported by the Intel NEO OpenCL runtime that is provided by the
intel-compute-runtime package. For Gen7 GPUs, the deprecated Beignet
runtime can be used, which is provided by the beignet package. The
proprietary Intel OpenCL runtime, in the intel-ocl package, is an
alternative for Gen7 GPUs.</p><p>The intel-compute-runtime, beignet, or intel-ocl package can be added to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>
to enable OpenCL support. For example, for Gen8 and later GPUs, the following
configuration can be used:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">extraPackages</span> = [
  intel-compute-runtime
];
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-vulkan" class="title" style="clear: both">Vulkan   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-vulkan" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://en.wikipedia.org/wiki/Vulkan_(API)" target="_top">Vulkan</a> is a graphics and
compute API for GPUs. It is used directly by games or indirectly though
compatibility layers like
<a class="link" href="https://github.com/doitsujin/dxvk/wiki" target="_top">DXVK</a>.</p><p>By default, if <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.driSupport"><code class="option">hardware.opengl.driSupport</code></a>
is enabled, mesa is installed and provides Vulkan for supported hardware.</p><p>Similar to OpenCL, Vulkan drivers are loaded through the <span class="emphasis"><em>Installable
Client Driver</em></span> (ICD) mechanism. ICD files for Vulkan are JSON files that
specify the path to the driver library and the supported Vulkan version.
All successfully loaded drivers are exposed to the application as
different GPUs. In NixOS, there are two ways to make ICD files visible
to Vulkan applications: an environment variable and a module option.</p><p>The first option is through the <code class="literal">VK_ICD_FILENAMES</code> environment variable.
This variable can contain multiple JSON files, separated by <code class="literal">:</code>. For
example:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">export</span> \
  VK_ICD_FILENAMES=`nix-build <span class="hljs-string">'&lt;nixpkgs&gt;'</span> --no-out-link -A amdvlk`/share/vulkan/icd.d/amd_icd64.json</span>
</code></pre><p>The second mechanism is to add the Vulkan driver package to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>.
This links the ICD file under <code class="literal">/run/opengl-driver</code>, where it will be
visible to the ICD loader.</p><p>The proper installation of Vulkan drivers can be verified through the
<code class="literal">vulkaninfo</code> command of the vulkan-tools package. This command will
report the hardware devices and drivers found, in this example output
amdvlk and radv:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">vulkaninfo | grep GPU</span>
                GPU id  : 0 (Unknown AMD GPU)
                GPU id  : 1 (AMD RADV NAVI10 (LLVM 9.0.1))
     ...
GPU0:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
        deviceName     = Unknown AMD GPU
GPU1:
        deviceType     = PHYSICAL_DEVICE_TYPE_DISCRETE_GPU
</code></pre><p>A simple graphical application that uses Vulkan is <code class="literal">vkcube</code> from the
vulkan-tools package.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-vulkan-amd" class="title">AMD   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-vulkan-amd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Modern AMD <a class="link" href="https://en.wikipedia.org/wiki/Graphics_Core_Next" target="_top">Graphics Core
Next</a> (GCN) GPUs are
supported through either radv, which is part of mesa, or the amdvlk
package. Adding the amdvlk package to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>
makes amdvlk the default driver and hides radv and lavapipe from the device list.
A specific driver can be forced as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">extraPackages</span> = [
  pkgs.amdvlk
];

<span class="hljs-comment"># To enable Vulkan support for 32-bit applications, also add:</span>
hardware.opengl.<span class="hljs-attr">extraPackages32</span> = [
  pkgs.driversi686Linux.amdvlk
];

<span class="hljs-comment"># Force radv</span>
environment.variables.<span class="hljs-attr">AMD_VULKAN_ICD</span> = <span class="hljs-string">"RADV"</span>;
<span class="hljs-comment"># Or</span>
environment.variables.<span class="hljs-attr">VK_ICD_FILENAMES</span> =
  <span class="hljs-string">"/run/opengl-driver/share/vulkan/icd.d/radeon_icd.x86_64.json"</span>;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-va-api" class="title" style="clear: both">VA-API   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-va-api" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/linuxmedia-vaapi.html" target="_top">VA-API (Video Acceleration API)</a>
is an open-source library and API specification, which provides access to
graphics hardware acceleration capabilities for video processing.</p><p>VA-API drivers are loaded by <code class="literal">libva</code>. The version in nixpkgs is built to search
the opengl driver path, so drivers can be installed in
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.opengl.extraPackages"><code class="option">hardware.opengl.extraPackages</code></a>.</p><p>VA-API can be tested using:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell -p libva-utils --run vainfo</span>
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-va-api-intel" class="title">Intel   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-va-api-intel" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Modern Intel GPUs use the iHD driver, which can be installed with:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">extraPackages</span> = [
  intel-media-driver
];
</code></pre><p>Older Intel GPUs use the i965 driver, which can be installed with:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.opengl.<span class="hljs-attr">extraPackages</span> = [
  intel-vaapi-driver
];
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gpu-accel-common-issues" class="title" style="clear: both">Common issues   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-common-issues-permissions" class="title">User permissions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues-permissions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Except where noted explicitly, it should not be necessary to adjust user
permissions to use these acceleration APIs. In the default
configuration, GPU devices have world-read/write permissions
(<code class="literal">/dev/dri/renderD*</code>) or are tagged as <code class="literal">uaccess</code> (<code class="literal">/dev/dri/card*</code>). The
access control lists of devices with the <code class="literal">uaccess</code> tag will be updated
automatically when a user logs in through <code class="literal">systemd-logind</code>. For example,
if the user <span class="emphasis"><em>alice</em></span> is logged in, the access control list should look as
follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">getfacl /dev/dri/card0</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">file: dev/dri/card0</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">owner: root</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">group: video</span>
user::rw-
user:alice:rw-
group::rw-
mask::rw-
other::---
</code></pre><p>If you disabled (this functionality of) <code class="literal">systemd-logind</code>, you may need
to add the user to the <code class="literal">video</code> group and log in again.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gpu-accel-common-issues-mixing-nixpkgs" class="title">Mixing different versions of nixpkgs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gpu-accel-common-issues-mixing-nixpkgs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The <span class="emphasis"><em>Installable Client Driver</em></span> (ICD) mechanism used by OpenCL and
Vulkan loads runtimes into its address space using <code class="literal">dlopen</code>. Mixing an
ICD loader mechanism and runtimes from different version of nixpkgs may
not work. For example, if the ICD loader uses an older version of glibc
than the runtime, the runtime may not be loadable due to missing
symbols. Unfortunately, the loader will generally be quiet about such
issues.</p><p>If you suspect that you are running into library version mismatches
between an ICL loader and a runtime, you could run an application with
the <code class="literal">LD_DEBUG</code> variable set to get more diagnostic information. For
example, OpenCL can be tested with <code class="literal">LD_DEBUG=files clinfo</code>, which should
report missing symbols.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce" class="title">Xfce Desktop Environment   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-xfce" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-xfce-thunar-plugins">Thunar</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-xfce-troubleshooting">Troubleshooting</a> </span></dt> </dl></div><p>To enable the Xfce Desktop Environment, set</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.xfce.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.displayManager.<span class="hljs-attr">defaultSession</span> = <span class="hljs-string">"xfce"</span>;
</code></pre><p>Optionally, <span class="emphasis"><em>picom</em></span> can be enabled for nice graphical effects, some
example settings:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">picom</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">fade</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">inactiveOpacity</span> = <span class="hljs-number">0.9</span>;
  <span class="hljs-attr">shadow</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">fadeDelta</span> = <span class="hljs-number">4</span>;
};
</code></pre><p>Some Xfce programs are not installed automatically. To install them
manually (system wide), put them into your
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> from <code class="literal">pkgs.xfce</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce-thunar-plugins" class="title" style="clear: both">Thunar   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-xfce-thunar-plugins" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Thunar (the Xfce file manager) is automatically enabled when Xfce is
enabled. To enable Thunar without enabling Xfce, use the configuration
option <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-programs.thunar.enable"><code class="option">programs.thunar.enable</code></a> instead of adding
<code class="literal">pkgs.xfce.thunar</code> to <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>.</p><p>If you’d like to add extra plugins to Thunar, add them to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-programs.thunar.plugins"><code class="option">programs.thunar.plugins</code></a>. You shouldn’t just add them to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-xfce-troubleshooting" class="title" style="clear: both">Troubleshooting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-xfce-troubleshooting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Even after enabling udisks2, volume management might not work. Thunar
and/or the desktop takes time to show up. Thunar will spit out this kind
of message on start (look at <code class="literal">journalctl --user -b</code>).</p><pre><code class="programlisting plain hljs language-nix" data-highlighted="yes">Thunar:<span class="hljs-number">2410</span>): GVFS-RemoteVolumeMonitor-WARNING **: remote volume monitor <span class="hljs-keyword">with</span> dbus name org.gtk.Private.UDisks2VolumeMonitor is not supported
</code></pre><p>This is caused by some needed GNOME services not running. This is all
fixed by enabling “Launch GNOME services on startup” in the Advanced
tab of the Session and Startup settings panel. Alternatively, you can
run this command to do the same thing.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">xfconf-query -c xfce4-session -p /compat/LaunchGNOME -s <span class="hljs-literal">true</span></span>
</code></pre><p>It is necessary to log out and log in again for this to take effect.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-networking" class="title">Networking   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-networking" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-networkmanager">NetworkManager</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-ssh">Secure Shell Access</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-ipv4">IPv4 Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-ipv6">IPv6 Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-firewall">Firewall</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-wireless">Wireless Networks</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#ad-hoc-network-config">Ad-Hoc Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-rename-ifs">Renaming network interfaces</a> </span></dt> </dl></div><p>This section describes how to configure networking components
on your NixOS machine.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-networkmanager" class="title" style="clear: both">NetworkManager   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-networkmanager" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To facilitate network configuration, some desktop environments use
NetworkManager. You can enable NetworkManager by setting:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.networkmanager.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>some desktop managers (e.g., GNOME) enable NetworkManager automatically
for you.</p><p>All users that should have permission to change network settings must
belong to the <code class="literal">networkmanager</code> group:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.users.alice.<span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">"networkmanager"</span> ];
</code></pre><p>NetworkManager is controlled using either <code class="literal">nmcli</code> or <code class="literal">nmtui</code>
(curses-based terminal user interface). See their manual pages for
details on their usage. Some desktop environments (GNOME, KDE) have
their own configuration tools for NetworkManager. On XFCE, there is no
configuration tool for NetworkManager by default: by enabling
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-programs.nm-applet.enable"><code class="option">programs.nm-applet.enable</code></a>, the graphical applet will be
installed and will launch automatically when the graphical session is
started.</p><div class="note"><h3 class="title">Note</h3><p><code class="literal">networking.networkmanager</code> and <code class="literal">networking.wireless</code> (WPA Supplicant)
can be used together if desired. To do this you need to instruct
NetworkManager to ignore those interfaces like:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.networkmanager.<span class="hljs-attr">unmanaged</span> = [
   <span class="hljs-string">"*"</span> <span class="hljs-string">"except:type:wwan"</span> <span class="hljs-string">"except:type:gsm"</span>
];
</code></pre><p>Refer to the option description for the exact syntax and references to
external documentation.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ssh" class="title" style="clear: both">Secure Shell Access   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-ssh" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Secure shell (SSH) access to your machine can be enabled by setting:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.openssh.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>By default, root logins using a password are disallowed. They can be
disabled entirely by setting
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.openssh.settings.PermitRootLogin"><code class="option">services.openssh.settings.PermitRootLogin</code></a> to <code class="literal">"no"</code>.</p><p>You can declaratively specify authorised RSA/DSA public keys for a user
as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">users.users.alice.openssh.authorizedKeys.<span class="hljs-attr">keys</span> =
  [ <span class="hljs-string">"ssh-dss AAAAB3NzaC1kc3MAAACBAPIkGWVEt4..."</span> ];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ipv4" class="title" style="clear: both">IPv4 Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-ipv4" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, NixOS uses DHCP (specifically, <code class="literal">dhcpcd</code>) to automatically
configure network interfaces. However, you can configure an interface
manually as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.interfaces.eth0.ipv4.<span class="hljs-attr">addresses</span> = [ {
  <span class="hljs-attr">address</span> = <span class="hljs-string">"192.168.1.2"</span>;
  <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">24</span>;
} ];
</code></pre><p>Typically you’ll also want to set a default gateway and set of name
servers:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">defaultGateway</span> = <span class="hljs-string">"192.168.1.1"</span>;
networking.<span class="hljs-attr">nameservers</span> = [ <span class="hljs-string">"8.8.8.8"</span> ];
</code></pre><div class="note"><h3 class="title">Note</h3><p>Statically configured interfaces are set up by the systemd service
<code class="literal">interface-name-cfg.service</code>. The default gateway and name server
configuration is performed by <code class="literal">network-setup.service</code>.</p></div><p>The host name is set using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.hostName"><code class="option">networking.hostName</code></a>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">hostName</span> = <span class="hljs-string">"cartman"</span>;
</code></pre><p>The default host name is <code class="literal">nixos</code>. Set it to the empty string (<code class="literal">""</code>) to
allow the DHCP server to provide the host name.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-ipv6" class="title" style="clear: both">IPv6 Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-ipv6" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>IPv6 is enabled by default. Stateless address autoconfiguration is used
to automatically assign IPv6 addresses to all interfaces, and Privacy
Extensions (RFC 4946) are enabled by default. You can adjust the default
for this by setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.tempAddresses"><code class="option">networking.tempAddresses</code></a>. This option
may be overridden on a per-interface basis by
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.interfaces._name_.tempAddress"><code class="option">networking.interfaces.&lt;name&gt;.tempAddress</code></a>. You can disable
IPv6 support globally by setting:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">enableIPv6</span> = <span class="hljs-literal">false</span>;
</code></pre><p>You can disable IPv6 on a single interface using a normal sysctl (in
this example, we use interface <code class="literal">eth0</code>):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.kernel.sysctl.<span class="hljs-string">"net.ipv6.conf.eth0.disable_ipv6"</span> = <span class="hljs-literal">true</span>;
</code></pre><p>As with IPv4 networking interfaces are automatically configured via
DHCPv6. You can configure an interface manually:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.interfaces.eth0.ipv6.<span class="hljs-attr">addresses</span> = [ {
  <span class="hljs-attr">address</span> = <span class="hljs-string">"fe00:aa:bb:cc::2"</span>;
  <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">64</span>;
} ];
</code></pre><p>For configuring a gateway, optionally with explicitly specified
interface:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">defaultGateway6</span> = {
  <span class="hljs-attr">address</span> = <span class="hljs-string">"fe00::1"</span>;
  <span class="hljs-attr">interface</span> = <span class="hljs-string">"enp0s3"</span>;
};
</code></pre><p>See <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-ipv4" title="IPv4 Configuration">the section called “IPv4 Configuration”</a> for similar examples and additional information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-firewall" class="title" style="clear: both">Firewall   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-firewall" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS has a simple stateful firewall that blocks incoming connections
and other unexpected packets. The firewall applies to both IPv4 and IPv6
traffic. It is enabled by default. It can be disabled as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
</code></pre><p>If the firewall is enabled, you can open specific TCP ports to the
outside world:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
</code></pre><p>Note that TCP port 22 (ssh) is opened automatically if the SSH daemon is
enabled (<code class="literal">services.openssh.enable = true</code>). UDP ports can be opened through
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.firewall.allowedUDPPorts"><code class="option">networking.firewall.allowedUDPPorts</code></a>.</p><p>To open ranges of TCP ports:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">allowedTCPPortRanges</span> = [
  { <span class="hljs-attr">from</span> = <span class="hljs-number">4000</span>; <span class="hljs-attr">to</span> = <span class="hljs-number">4007</span>; }
  { <span class="hljs-attr">from</span> = <span class="hljs-number">8000</span>; <span class="hljs-attr">to</span> = <span class="hljs-number">8010</span>; }
];
</code></pre><p>Similarly, UDP port ranges can be opened through
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.firewall.allowedUDPPortRanges"><code class="option">networking.firewall.allowedUDPPortRanges</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-wireless" class="title" style="clear: both">Wireless Networks   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-wireless" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>For a desktop installation using NetworkManager (e.g., GNOME), you just
have to make sure the user is in the <code class="literal">networkmanager</code> group and you can
skip the rest of this section on wireless networks.</p><p>NixOS will start wpa_supplicant for you if you enable this setting:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.wireless.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>NixOS lets you specify networks for wpa_supplicant declaratively:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.wireless.<span class="hljs-attr">networks</span> = {
  <span class="hljs-attr">echelon</span> = {                <span class="hljs-comment"># SSID with no spaces or special characters</span>
    <span class="hljs-attr">psk</span> = <span class="hljs-string">"abcdefgh"</span>;
  };
  <span class="hljs-string">"echelon's AP"</span> = {         <span class="hljs-comment"># SSID with spaces and/or special characters</span>
    <span class="hljs-attr">psk</span> = <span class="hljs-string">"ijklmnop"</span>;
  };
  <span class="hljs-attr">echelon</span> = {                <span class="hljs-comment"># Hidden SSID</span>
    <span class="hljs-attr">hidden</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">psk</span> = <span class="hljs-string">"qrstuvwx"</span>;
  };
  free.<span class="hljs-attr">wifi</span> = {};            <span class="hljs-comment"># Public wireless network</span>
};
</code></pre><p>Be aware that keys will be written to the nix store in plaintext! When
no networks are set, it will default to using a configuration file at
<code class="literal">/etc/wpa_supplicant.conf</code>. You should edit this file yourself to define
wireless networks, WPA keys and so on (see wpa_supplicant.conf(5)).</p><p>If you are using WPA2 you can generate pskRaw key using
<code class="literal">wpa_passphrase</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">wpa_passphrase ESSID PSK</span>
network={
        ssid="echelon"
        #psk="abcdefgh"
        psk=dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435
}
</code></pre><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.wireless.<span class="hljs-attr">networks</span> = {
  <span class="hljs-attr">echelon</span> = {
    <span class="hljs-attr">pskRaw</span> = <span class="hljs-string">"dca6d6ed41f4ab5a984c9f55f6f66d4efdc720ebf66959810f4329bb391c5435"</span>;
  };
};
</code></pre><p>or you can use it to directly generate the <code class="literal">wpa_supplicant.conf</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">wpa_passphrase ESSID PSK &gt; /etc/wpa_supplicant.conf</span>
</code></pre><p>After you have edited the <code class="literal">wpa_supplicant.conf</code>, you need to restart the
wpa_supplicant service.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl restart wpa_supplicant.service</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ad-hoc-network-config" class="title" style="clear: both">Ad-Hoc Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ad-hoc-network-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can use <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.localCommands"><code class="option">networking.localCommands</code></a> to
specify shell commands to be run at the end of <code class="literal">network-setup.service</code>. This
is useful for doing network configuration not covered by the existing NixOS
modules. For instance, to statically configure an IPv6 address:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.<span class="hljs-attr">localCommands</span> =
  <span class="hljs-string">''
    ip -6 addr add 2001:610:685:1::1/64 dev eth0
  ''</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rename-ifs" class="title" style="clear: both">Renaming network interfaces   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-rename-ifs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS uses the udev <a class="link" href="https://systemd.io/PREDICTABLE_INTERFACE_NAMES/" target="_top">predictable naming
scheme</a> to assign names
to network interfaces. This means that by default cards are not given
the traditional names like <code class="literal">eth0</code> or <code class="literal">eth1</code>, whose order can change
unpredictably across reboots. Instead, relying on physical locations and
firmware information, the scheme produces names like <code class="literal">ens1</code>, <code class="literal">enp2s0</code>,
etc.</p><p>These names are predictable but less memorable and not necessarily
stable: for example installing new hardware or changing firmware
settings can result in a <a class="link" href="https://github.com/systemd/systemd/issues/3715#issue-165347602" target="_top">name
change</a>.
If this is undesirable, for example if you have a single ethernet card,
you can revert to the traditional scheme by setting
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-networking.usePredictableInterfaceNames"><code class="option">networking.usePredictableInterfaceNames</code></a>
to <code class="literal">false</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-custom-ifnames" class="title">Assigning custom names   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-custom-ifnames" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>In case there are multiple interfaces of the same type, it’s better to
assign custom names based on the device hardware address. For example,
we assign the name <code class="literal">wan</code> to the interface with MAC address
<code class="literal">52:54:00:12:01:01</code> using a netword link unit:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">systemd.network.links.<span class="hljs-string">"10-wan"</span> = {
  matchConfig.<span class="hljs-attr">PermanentMACAddress</span> = <span class="hljs-string">"52:54:00:12:01:01"</span>;
  linkConfig.<span class="hljs-attr">Name</span> = <span class="hljs-string">"wan"</span>;
};
</code></pre><p>Note that links are directly read by udev, <span class="emphasis"><em>not networkd</em></span>, and will work
even if networkd is disabled.</p><p>Alternatively, we can use a plain old udev rule:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.services.udev.<span class="hljs-attr">rules</span> = <span class="hljs-string">''
  SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", \
  ATTR{address}=="52:54:00:12:01:01", KERNEL=="eth*", NAME="wan"
''</span>;
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>The rule must be installed in the initrd using
<code class="literal">boot.initrd.services.udev.rules</code>, not the usual <code class="literal">services.udev.extraRules</code>
option. This is to avoid race conditions with other programs controlling
the interface.</p></div>
</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-kernel-config" class="title">Linux Kernel   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-kernel-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-linux-config-customizing">Building a custom kernel</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-linux-config-developing-modules">Developing kernel modules</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-linux-zfs">ZFS</a> </span></dt> </dl></div><p>You can override the Linux kernel and associated packages using the
option <code class="literal">boot.kernelPackages</code>. For instance, this selects the Linux 3.10
kernel:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.<span class="hljs-attr">kernelPackages</span> = pkgs.linuxKernel.packages.linux_3_10;
</code></pre><p>Note that this not only replaces the kernel, but also packages that are
specific to the kernel version, such as the NVIDIA video drivers. This
ensures that driver packages are consistent with the kernel.</p><p>While <code class="literal">pkgs.linuxKernel.packages</code> contains all available kernel packages,
you may want to use one of the unversioned <code class="literal">pkgs.linuxPackages_*</code> aliases
such as <code class="literal">pkgs.linuxPackages_latest</code>, that are kept up to date with new
versions.</p><p>Please note that the current convention in NixOS is to only keep actively
maintained kernel versions on both unstable and the currently supported stable
release(s) of NixOS. This means that a non-longterm kernel will be removed after it’s
abandoned by the kernel developers, even on stable NixOS versions. If you
pin your kernel onto a non-longterm version, expect your evaluation to fail as
soon as the version is out of maintenance.</p><p>Longterm versions of kernels will be removed before the next stable NixOS that will
exceed the maintenance period of the kernel version.</p><p>The default Linux kernel configuration should be fine for most users.
You can see the configuration of your current kernel with the following
command:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">zcat /proc/config.gz
</code></pre><p>If you want to change the kernel configuration, you can use the
<code class="literal">packageOverrides</code> feature (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-customising-packages" title="Customising Packages">the section called “Customising Packages”</a>). For
instance, to enable support for the kernel debugger KGDB:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">nixpkgs.config.<span class="hljs-attr">packageOverrides</span> = pkgs: pkgs.lib.recursiveUpdate pkgs {
  linuxKernel.kernels.<span class="hljs-attr">linux_5_10</span> = pkgs.linuxKernel.kernels.linux_5_10.override {
    <span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
      KGDB y
    ''</span>;
  };
};
</code></pre><p><code class="literal">extraConfig</code> takes a list of Linux kernel configuration options, one
per line. The name of the option should not include the prefix
<code class="literal">CONFIG_</code>. The option value is typically <code class="literal">y</code>, <code class="literal">n</code> or <code class="literal">m</code> (to build
something as a kernel module).</p><p>Kernel modules for hardware devices are generally loaded automatically
by <code class="literal">udev</code>. You can force a module to be loaded via
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.kernelModules"><code class="option">boot.kernelModules</code></a>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.<span class="hljs-attr">kernelModules</span> = [ <span class="hljs-string">"fuse"</span> <span class="hljs-string">"kvm-intel"</span> <span class="hljs-string">"coretemp"</span> ];
</code></pre><p>If the module is required early during the boot (e.g. to mount the root
file system), you can use <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.initrd.kernelModules"><code class="option">boot.initrd.kernelModules</code></a>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.initrd.<span class="hljs-attr">kernelModules</span> = [ <span class="hljs-string">"cifs"</span> ];
</code></pre><p>This causes the specified modules and their dependencies to be added to
the initial ramdisk.</p><p>Kernel runtime parameters can be set through
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.kernel.sysctl"><code class="option">boot.kernel.sysctl</code></a>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.kernel.sysctl.<span class="hljs-string">"net.ipv4.tcp_keepalive_time"</span> = <span class="hljs-number">120</span>;
</code></pre><p>sets the kernel’s TCP keepalive time to 120 seconds. To see the
available parameters, run <code class="literal">sysctl -a</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-config-customizing" class="title" style="clear: both">Building a custom kernel   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-linux-config-customizing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can customize the default kernel configuration by overriding the arguments for your kernel package:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">pkgs.linux_latest.override {
  <span class="hljs-attr">ignoreConfigErrors</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">autoModules</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">kernelPreferBuiltin</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">extraStructuredConfig</span> = <span class="hljs-keyword">with</span> lib.kernel; {
    <span class="hljs-attr">DEBUG_KERNEL</span> = yes;
    <span class="hljs-attr">FRAME_POINTER</span> = yes;
    <span class="hljs-attr">KGDB</span> = yes;
    <span class="hljs-attr">KGDB_SERIAL_CONSOLE</span> = yes;
    <span class="hljs-attr">DEBUG_INFO</span> = yes;
  };
}
</code></pre><p>See <code class="literal">pkgs/os-specific/linux/kernel/generic.nix</code> for details on how these arguments
affect the generated configuration. You can also build a custom version of Linux by calling
<code class="literal">pkgs.buildLinux</code> directly, which requires the <code class="literal">src</code> and <code class="literal">version</code> arguments to be specified.</p><p>To use your custom kernel package in your NixOS configuration, set</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">boot.<span class="hljs-attr">kernelPackages</span> = pkgs.linuxPackagesFor yourCustomKernel;
</code></pre><p>Note that this method will use the common configuration defined in <code class="literal">pkgs/os-specific/linux/kernel/common-config.nix</code>,
which is suitable for a NixOS system.</p><p>If you already have a generated configuration file, you can build a kernel that uses it with <code class="literal">pkgs.linuxManualConfig</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">baseKernel</span> = pkgs.linux_latest;
<span class="hljs-keyword">in</span> pkgs.linuxManualConfig {
  <span class="hljs-keyword">inherit</span> (baseKernel) src modDirVersion;
  <span class="hljs-attr">version</span> = <span class="hljs-string">"<span class="hljs-subst">${baseKernel.version}</span>-custom"</span>;
  <span class="hljs-attr">configfile</span> = ./my_kernel_config;
  <span class="hljs-attr">allowImportFromDerivation</span> = <span class="hljs-literal">true</span>;
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The build will fail if <code class="literal">modDirVersion</code> does not match the source’s <code class="literal">kernel.release</code> file,
so <code class="literal">modDirVersion</code> should remain tied to <code class="literal">src</code>.</p></div><p>To edit the <code class="literal">.config</code> file for Linux X.Y, proceed as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell <span class="hljs-string">'&lt;nixpkgs&gt;'</span> -A linuxKernel.kernels.linux_X_Y.configEnv</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">unpackPhase</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> linux-*</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make nconfig</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-config-developing-modules" class="title" style="clear: both">Developing kernel modules   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-linux-config-developing-modules" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>When developing kernel modules it’s often convenient to run
edit-compile-run loop as quickly as possible. See below snippet as an
example of developing <code class="literal">mellanox</code> drivers.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build <span class="hljs-string">'&lt;nixpkgs&gt;'</span> -A linuxPackages.kernel.dev</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell <span class="hljs-string">'&lt;nixpkgs&gt;'</span> -A linuxPackages.kernel</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">unpackPhase</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> linux-*</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">make -C <span class="hljs-variable">$dev</span>/lib/modules/*/build M=$(<span class="hljs-built_in">pwd</span>)/drivers/net/ethernet/mellanox modules</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">insmod ./drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.ko</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linux-zfs" class="title" style="clear: both">ZFS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-linux-zfs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>It’s a common issue that the latest stable version of ZFS doesn’t support the latest
available Linux kernel. It is recommended to use the latest available LTS that’s compatible
with ZFS. Usually this is the default kernel provided by nixpkgs (i.e. <code class="literal">pkgs.linuxPackages</code>).</p><p>Alternatively, it’s possible to pin the system to the latest available kernel
version <span class="emphasis"><em>that is supported by ZFS</em></span> like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  boot.<span class="hljs-attr">kernelPackages</span> = pkgs.zfs.latestCompatibleLinuxPackages;
}
</code></pre><p>Please note that the version this attribute points to isn’t monotonic because the latest kernel
version only refers to kernel versions supported by the Linux developers. In other words,
the latest kernel version that ZFS is compatible with may decrease over time.</p><p>An example: the latest version ZFS is compatible with is 5.19 which is a non-longterm version. When 5.19
is out of maintenance, the latest supported kernel version is 5.15 because it’s longterm and the versions
5.16, 5.17 and 5.18 are already out of maintenance because they’re non-longterm.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-subversion" class="title">Subversion   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-subversion" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-subversion-apache-httpd">Subversion inside Apache HTTP</a> </span></dt> </dl></div><p><a class="link" href="https://subversion.apache.org/" target="_top">Subversion</a> is a centralized
version-control system. It can use a <a class="link" href="https://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.choosing" target="_top">variety of
protocols</a>
for communication between client and server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-subversion-apache-httpd" class="title" style="clear: both">Subversion inside Apache HTTP   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-subversion-apache-httpd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This section focuses on configuring a web-based server on top of the
Apache HTTP server, which uses
<a class="link" href="http://www.webdav.org/" target="_top">WebDAV</a>/<a class="link" href="http://www.webdav.org/deltav/WWW10/deltav-intro.htm" target="_top">DeltaV</a>
for communication.</p><p>For more information on the general setup, please refer to the <a class="link" href="https://svnbook.red-bean.com/en/1.7/svn-book.html#svn.serverconfig.httpd" target="_top">the
appropriate section of the Subversion
book</a>.</p><p>To configure, include in <code class="literal">/etc/nixos/configuration.nix</code> code to activate
Apache HTTP, setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.httpd.adminAddr"><code class="option">services.httpd.adminAddr</code></a>
appropriately:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.httpd.<span class="hljs-attr">adminAddr</span> = ...;
networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
</code></pre><p>For a simple Subversion server with basic authentication, configure the
Subversion module for Apache as follows, setting <code class="literal">hostName</code> and
<code class="literal">documentRoot</code> appropriately, and <code class="literal">SVNParentPath</code> to the parent
directory of the repositories, <code class="literal">AuthzSVNAccessFile</code> to the location of
the <code class="literal">.authz</code> file describing access permission, and <code class="literal">AuthUserFile</code> to
the password file.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.httpd.<span class="hljs-attr">extraModules</span> = [
    <span class="hljs-comment"># note that order is *super* important here</span>
    { <span class="hljs-attr">name</span> = <span class="hljs-string">"dav_svn"</span>; <span class="hljs-attr">path</span> = <span class="hljs-string">"<span class="hljs-subst">${pkgs.apacheHttpdPackages.subversion}</span>/modules/mod_dav_svn.so"</span>; }
    { <span class="hljs-attr">name</span> = <span class="hljs-string">"authz_svn"</span>; <span class="hljs-attr">path</span> = <span class="hljs-string">"<span class="hljs-subst">${pkgs.apacheHttpdPackages.subversion}</span>/modules/mod_authz_svn.so"</span>; }
  ];
  services.httpd.<span class="hljs-attr">virtualHosts</span> = {
    <span class="hljs-string">"svn"</span> = {
       <span class="hljs-attr">hostName</span> = HOSTNAME;
       <span class="hljs-attr">documentRoot</span> = DOCUMENTROOT;
       locations.<span class="hljs-string">"/svn"</span>.<span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
           DAV svn
           SVNParentPath REPO_PARENT
           AuthzSVNAccessFile ACCESS_FILE
           AuthName "SVN Repositories"
           AuthType Basic
           AuthUserFile PASSWORD_FILE
           Require valid-user
      ''</span>;
    }
</code></pre><p>The key <code class="literal">"svn"</code> is just a symbolic name identifying the virtual host.
The <code class="literal">"/svn"</code> in <code class="literal">locations."/svn".extraConfig</code> is the path underneath
which the repositories will be served.</p><p><a class="link" href="https://wiki.archlinux.org/index.php/Subversion" target="_top">This page</a> explains
how to set up the Subversion configuration itself. This boils down to
the following:</p><p>Underneath <code class="literal">REPO_PARENT</code> repositories can be set up as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">svn create REPO_NAME</span>
</code></pre><p>Repository files need to be accessible by <code class="literal">wwwrun</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">chown</span> -R wwwrun:wwwrun REPO_PARENT</span>
</code></pre><p>The password file <code class="literal">PASSWORD_FILE</code> can be created as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">htpasswd -cs PASSWORD_FILE USER_NAME</span>
</code></pre><p>Additional users can be set up similarly, omitting the <code class="literal">c</code> flag:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">htpasswd -s PASSWORD_FILE USER_NAME</span>
</code></pre><p>The file describing access permissions <code class="literal">ACCESS_FILE</code> will look something
like the following:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">[/]
* = r

[REPO_NAME:/]
<span class="hljs-attr">USER_NAME</span> = rw
</code></pre><p>The Subversion repositories will be accessible as
<code class="literal">http://HOSTNAME/svn/REPO_NAME</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-pantheon" class="title">Pantheon Desktop   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#chap-pantheon" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-pantheon-enable">Enabling Pantheon</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-pantheon-wingpanel-switchboard">Wingpanel and Switchboard plugins</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-pantheon-faq">FAQ</a> </span></dt> </dl></div><p>Pantheon is the desktop environment created for the elementary OS distribution. It is written from scratch in Vala, utilizing GNOME technologies with GTK and Granite.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-enable" class="title" style="clear: both">Enabling Pantheon   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-pantheon-enable" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>All of Pantheon is working in NixOS and the applications should be available, aside from a few <a class="link" href="https://github.com/NixOS/nixpkgs/issues/58161" target="_top">exceptions</a>. To enable Pantheon, set</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.pantheon.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>This automatically enables LightDM and Pantheon’s LightDM greeter. If you’d like to disable this, set</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.xserver.displayManager.lightdm.greeters.pantheon.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
services.xserver.displayManager.lightdm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
</code></pre><p>but please be aware using Pantheon without LightDM as a display manager will break screenlocking from the UI. The NixOS module for Pantheon installs all of Pantheon’s default applications. If you’d like to not install Pantheon’s apps, set</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.pantheon.apps.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
</code></pre><p>You can also use <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.pantheon.excludePackages"><code class="option">environment.pantheon.excludePackages</code></a> to remove any other app (like <code class="literal">elementary-mail</code>).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-wingpanel-switchboard" class="title" style="clear: both">Wingpanel and Switchboard plugins   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-pantheon-wingpanel-switchboard" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Wingpanel and Switchboard work differently than they do in other distributions, as far as using plugins. You cannot install a plugin globally (like with <code class="option">environment.systemPackages</code>) to start using it. You should instead be using the following options:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.pantheon.extraWingpanelIndicators"><code class="option">services.xserver.desktopManager.pantheon.extraWingpanelIndicators</code></a></p></li><li class="listitem"><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.pantheon.extraSwitchboardPlugs"><code class="option">services.xserver.desktopManager.pantheon.extraSwitchboardPlugs</code></a></p></li></ul></div><p>to configure the programs with plugs or indicators.</p><p>The difference in NixOS is both these programs are patched to load plugins from a directory that is the value of an environment variable. All of which is controlled in Nix. If you need to configure the particular packages manually you can override the packages like:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">wingpanel-<span class="hljs-keyword">with</span>-indicators.override {
  <span class="hljs-attr">indicators</span> = [
    pkgs.some-special-indicator
  ];
};

switchboard-<span class="hljs-keyword">with</span>-plugs.override {
  <span class="hljs-attr">plugs</span> = [
    pkgs.some-special-plug
  ];
};
</code></pre><p>please note that, like how the NixOS options describe these as extra plugins, this would only add to the default plugins included with the programs. If for some reason you’d like to configure which plugins to use exactly, both packages have an argument for this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">wingpanel-<span class="hljs-keyword">with</span>-indicators.override {
  <span class="hljs-attr">useDefaultIndicators</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">indicators</span> = specialListOfIndicators;
};

switchboard-<span class="hljs-keyword">with</span>-plugs.override {
  <span class="hljs-attr">useDefaultPlugs</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">plugs</span> = specialListOfPlugs;
};
</code></pre><p>this could be most useful for testing a particular plug-in in isolation.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-pantheon-faq" class="title" style="clear: both">FAQ   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-pantheon-faq" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span id="sec-pantheon-faq-messed-up-theme"></span>I have switched from a different desktop and Pantheon’s theming looks messed up.</span></dt><dd><p>Open Switchboard and go to: Administration → About → Restore Default Settings → Restore Settings. This will reset any dconf settings to their Pantheon defaults. Note this could reset certain GNOME specific preferences if that desktop was used prior.</p></dd><dt><span class="term"><span id="sec-pantheon-faq-gnome-and-pantheon"></span>I cannot enable both GNOME and Pantheon.</span></dt><dd><p>This is a known <a class="link" href="https://github.com/NixOS/nixpkgs/issues/64611" target="_top">issue</a> and there is no known workaround.</p></dd><dt><span class="term"><span id="sec-pantheon-faq-appcenter"></span>Does AppCenter work, or is it available?</span></dt><dd><p>AppCenter has been available since 20.03. Starting from 21.11, the Flatpak backend should work so you can install some Flatpak applications using it. However, due to missing appstream metadata, the Packagekit backend does not function currently. See this <a class="link" href="https://github.com/NixOS/nixpkgs/issues/15932" target="_top">issue</a>.</p><p>If you are using Pantheon, AppCenter should be installed by default if you have <a class="link" href="https://nixos.org/manual/nixos/stable/#module-services-flatpak" title="Flatpak">Flatpak support</a> enabled. If you also wish to add the <code class="literal">appcenter</code> Flatpak remote:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak remote-add --if-not-exists appcenter https://flatpak.elementary.io/repo.flatpakrepo</span>
</code></pre></dd></dl></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-gnome" class="title">GNOME Desktop   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#chap-gnome" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-enable">Enabling GNOME</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-enable-flashback">Enabling GNOME Flashback</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-icons-and-gtk-themes">Icons and GTK Themes</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-shell-extensions">Shell Extensions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-gsettings-overrides">GSettings Overrides</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-gnome-faq">Frequently Asked Questions</a> </span></dt> </dl></div><p>GNOME provides a simple, yet full-featured desktop environment with a focus on productivity. Its Mutter compositor supports both Wayland and X server, and the GNOME Shell user interface is fully customizable by extensions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-enable" class="title" style="clear: both">Enabling GNOME   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-enable" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>All of the core apps, optional apps, games, and core developer tools from GNOME are available.</p><p>To enable the GNOME desktop use:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.gnome.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.xserver.displayManager.gdm.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><div class="note"><h3 class="title">Note</h3><p>While it is not strictly necessary to use GDM as the display manager with GNOME, it is recommended, as some features such as screen lock <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-gnome-faq-can-i-use-lightdm-with-gnome" title="Can I use LightDM with GNOME?">might not work</a> without it.</p></div><p>The default applications used in NixOS are very minimal, inspired by the defaults used in <a class="link" href="https://gitlab.gnome.org/GNOME/gnome-build-meta/blob/40.0/elements/core/meta-gnome-core-utilities.bst" target="_top">gnome-build-meta</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-without-the-apps" class="title">GNOME without the apps   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-without-the-apps" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If you’d like to only use the GNOME desktop and not the apps, you can disable them with:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.gnome.core-utilities.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
</code></pre><p>and none of them will be installed.</p><p>If you’d only like to omit a subset of the core utilities, you can use
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.gnome.excludePackages"><code class="option">environment.gnome.excludePackages</code></a>.
Note that this mechanism can only exclude core utilities, games and core developer tools.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-disabling-services" class="title">Disabling GNOME services   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-disabling-services" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>It is also possible to disable many of the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/b8ec4fd2a4edc4e30d02ba7b1a2cc1358f3db1d5/nixos/modules/services/x11/desktop-managers/gnome.nix#L329-L348" target="_top">core services</a>. For example, if you do not need indexing files, you can disable Tracker with:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.gnome.tracker-miners.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
services.gnome.tracker.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
</code></pre><p>Note, however, that doing so is not supported and might break some applications. Notably, GNOME Music cannot work without Tracker.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-games" class="title">GNOME games   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-games" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>You can install all of the GNOME games with:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.gnome.games.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-core-developer-tools" class="title">GNOME core developer tools   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-core-developer-tools" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>You can install GNOME core developer tools with:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.gnome.core-developer-tools.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-enable-flashback" class="title" style="clear: both">Enabling GNOME Flashback   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-enable-flashback" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>GNOME Flashback provides a desktop environment based on the classic GNOME 2 architecture. You can enable the default GNOME Flashback session, which uses the Metacity window manager, with:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.gnome.flashback.<span class="hljs-attr">enableMetacity</span> = <span class="hljs-literal">true</span>;
</code></pre><p>It is also possible to create custom sessions that replace Metacity with a different window manager using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.gnome.flashback.customSessions"><code class="option">services.xserver.desktopManager.gnome.flashback.customSessions</code></a>.</p><p>The following example uses <code class="literal">xmonad</code> window manager:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.xserver.desktopManager.gnome.flashback.<span class="hljs-attr">customSessions</span> = [
  {
    <span class="hljs-attr">wmName</span> = <span class="hljs-string">"xmonad"</span>;
    <span class="hljs-attr">wmLabel</span> = <span class="hljs-string">"XMonad"</span>;
    <span class="hljs-attr">wmCommand</span> = <span class="hljs-string">"<span class="hljs-subst">${pkgs.haskellPackages.xmonad}</span>/bin/xmonad"</span>;
    <span class="hljs-attr">enableGnomePanel</span> = <span class="hljs-literal">false</span>;
  }
];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-icons-and-gtk-themes" class="title" style="clear: both">Icons and GTK Themes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-icons-and-gtk-themes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Icon themes and GTK themes don’t require any special option to install in NixOS.</p><p>You can add them to <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a> and switch to them with GNOME Tweaks.
If you’d like to do this manually in dconf, change the values of the following keys:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">/org/gnome/desktop/interface/gtk-theme
/org/gnome/desktop/interface/icon-theme
</code></pre><p>in <code class="literal">dconf-editor</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-shell-extensions" class="title" style="clear: both">Shell Extensions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-shell-extensions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Most Shell extensions are packaged under the <code class="literal">gnomeExtensions</code> attribute.
Some packages that include Shell extensions, like <code class="literal">gnome.gpaste</code>, don’t have their extension decoupled under this attribute.</p><p>You can install them like any other package:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [
  gnomeExtensions.dash-to-dock
  gnomeExtensions.gsconnect
  gnomeExtensions.mpris-indicator-button
];
</code></pre><p>Unfortunately, we lack a way for these to be managed in a completely declarative way.
So you have to enable them manually with an Extensions application.
It is possible to use a <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-gnome-gsettings-overrides" title="GSettings Overrides">GSettings override</a> for this on <code class="literal">org.gnome.shell.enabled-extensions</code>, but that will only influence the default value.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-gsettings-overrides" class="title" style="clear: both">GSettings Overrides   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-gsettings-overrides" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Majority of software building on the GNOME platform use GLib’s <a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html" target="_top">GSettings</a> system to manage runtime configuration. For our purposes, the system consists of XML schemas describing the individual configuration options, stored in the package, and a settings backend, where the values of the settings are stored. On NixOS, like on most Linux distributions, dconf database is used as the backend.</p><p><a class="link" href="https://developer.gnome.org/gio/unstable/GSettings.html#id-1.4.19.2.9.25" target="_top">GSettings vendor overrides</a> can be used to adjust the default values for settings of the GNOME desktop and apps by replacing the default values specified in the XML schemas. Using overrides will allow you to pre-seed user settings before you even start the session.</p><div class="warning"><h3 class="title">Warning</h3><p>Overrides really only change the default values for GSettings keys so if you or an application changes the setting value, the value set by the override will be ignored. Until <a class="link" href="https://github.com/NixOS/nixpkgs/issues/54150" target="_top">NixOS’s dconf module implements changing values</a>, you will either need to keep that in mind and clear the setting from the backend using <code class="literal">dconf reset</code> command when that happens, or use the <a class="link" href="https://nix-community.github.io/home-manager/options.html#opt-dconf.settings" target="_top">module from home-manager</a>.</p></div><p>You can override the default GSettings values using the
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.gnome.extraGSettingsOverrides"><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverrides</code></a> option.</p><p>Take note that whatever packages you want to override GSettings for, you need to add them to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.gnome.extraGSettingsOverridePackages"><code class="option">services.xserver.desktopManager.gnome.extraGSettingsOverridePackages</code></a>.</p><p>You can use <code class="literal">dconf-editor</code> tool to explore which GSettings you can set.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-gsettings-overrides-example" class="title">Example   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-gsettings-overrides-example" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><pre><code class="programlisting hljs language-bash" data-highlighted="yes">services.xserver.desktopManager.gnome = {
  extraGSettingsOverrides = <span class="hljs-string">''</span>
    <span class="hljs-comment"># Change default background</span>
    [org.gnome.desktop.background]
    picture-uri=<span class="hljs-string">'file://${pkgs.nixos-artwork.wallpapers.mosaic-blue.gnomeFilePath}'</span>

    <span class="hljs-comment"># Favorite apps in gnome-shell</span>
    [org.gnome.shell]
    favorite-apps=[<span class="hljs-string">'org.gnome.Console.desktop'</span>, <span class="hljs-string">'org.gnome.Nautilus.desktop'</span>]
  <span class="hljs-string">''</span>;

  extraGSettingsOverridePackages = [
    pkgs.gsettings-desktop-schemas <span class="hljs-comment"># for org.gnome.desktop</span>
    pkgs.gnome.gnome-shell <span class="hljs-comment"># for org.gnome.shell</span>
  ];
};
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-gnome-faq" class="title" style="clear: both">Frequently Asked Questions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-faq" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-gnome-faq-can-i-use-lightdm-with-gnome" class="title">Can I use LightDM with GNOME?   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-gnome-faq-can-i-use-lightdm-with-gnome" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Yes you can, and any other display-manager in NixOS.</p><p>However, it doesn’t work correctly for the Wayland session of GNOME Shell yet, and
won’t be able to lock your screen.</p><p>See <a class="link" href="https://github.com/NixOS/nixpkgs/issues/56342" target="_top">this issue.</a></p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootloader-external" class="title">External Bootloader Backends   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-bootloader-external" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-bootloader-external-developing">Developing Custom Bootloader Backends</a> </span></dt> </dl></div><p>NixOS has support for several bootloader backends by default: systemd-boot, grub, uboot, etc.
The built-in bootloader backend support is generic and supports most use cases.
Some users may prefer to create advanced workflows around managing the bootloader and bootable entries.</p><p>You can replace the built-in bootloader support with your own tooling using the “external” bootloader option.</p><p>Imagine you have created a new package called FooBoot.
FooBoot provides a program at <code class="literal">${pkgs.fooboot}/bin/fooboot-install</code> which takes the system closure’s path as its only argument and configures the system’s bootloader.</p><p>You can enable FooBoot like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ pkgs, ... }: {
  boot.loader.<span class="hljs-attr">external</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">installHook</span> = <span class="hljs-string">"<span class="hljs-subst">${pkgs.fooboot}</span>/bin/fooboot-install"</span>;
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-bootloader-external-developing" class="title" style="clear: both">Developing Custom Bootloader Backends   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-bootloader-external-developing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Bootloaders should use <a class="link" href="https://github.com/NixOS/rfcs/pull/125" target="_top">RFC-0125</a>’s Bootspec format and synthesis tools to identify the key properties for bootable system generations.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage" class="title">Garage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-garage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-garage-upgrade-scenarios">General considerations on upgrades</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-garage-advanced-upgrades">Advanced upgrades (minor/major version upgrades)</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-garage-maintainer-info">Maintainer information</a> </span></dt> </dl></div><p><a class="link" href="https://garagehq.deuxfleurs.fr/" target="_top">Garage</a>
is an open-source, self-hostable S3 store, simpler than MinIO, for geodistributed stores.
The server setup can be automated using
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.garage.enable">services.garage</a>. A
client configured to your local Garage instance is available in
the global environment as <code class="literal">garage-manage</code>.</p><p>The current default by NixOS is <code class="literal">garage_0_8</code> which is also the latest
major version available.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-upgrade-scenarios" class="title" style="clear: both">General considerations on upgrades   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-garage-upgrade-scenarios" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Garage provides a cookbook documentation on how to upgrade:
<a class="link" href="https://garagehq.deuxfleurs.fr/documentation/cookbook/upgrading/" target="_top">https://garagehq.deuxfleurs.fr/documentation/cookbook/upgrading/</a></p><div class="warning"><h3 class="title">Warning</h3><p>Garage has two types of upgrades: patch-level upgrades and minor/major version upgrades.</p><p>In all cases, you should read the changelog and ideally test the upgrade on a staging cluster.</p><p>Checking the health of your cluster can be achieved using <code class="literal">garage-manage repair</code>.</p></div><div class="warning"><h3 class="title">Warning</h3><p>Until 1.0 is released, patch-level upgrades are considered as minor version upgrades.
Minor version upgrades are considered as major version upgrades.
i.e. 0.6 to 0.7 is a major version upgrade.</p></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><span class="strong"><strong>Straightforward upgrades (patch-level upgrades).</strong></span>
Upgrades must be performed one by one, i.e. for each node, stop it, upgrade it : change <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-system.stateVersion">stateVersion</a> or <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.garage.package">services.garage.package</a>, restart it if it was not already by switching.</p></li><li class="listitem"><p><span class="strong"><strong>Multiple version upgrades.</strong></span>
Garage do not provide any guarantee on moving more than one major-version forward.
E.g., if you’re on <code class="literal">0.7</code>, you cannot upgrade to <code class="literal">0.9</code>.
You need to upgrade to <code class="literal">0.8</code> first.
As long as <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-system.stateVersion">stateVersion</a> is declared properly,
this is enforced automatically. The module will issue a warning to remind the user to upgrade to latest
Garage <span class="emphasis"><em>after</em></span> that deploy.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-advanced-upgrades" class="title" style="clear: both">Advanced upgrades (minor/major version upgrades)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-garage-advanced-upgrades" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Here are some baseline instructions to handle advanced upgrades in Garage, when in doubt, please refer to upstream instructions.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Disable API and web access to Garage.</p></li><li class="listitem"><p>Perform <code class="literal">garage-manage repair --all-nodes --yes tables</code> and <code class="literal">garage-manage repair --all-nodes --yes blocks</code>.</p></li><li class="listitem"><p>Verify the resulting logs and check that data is synced properly between all nodes.
If you have time, do additional checks (<code class="literal">scrub</code>, <code class="literal">block_refs</code>, etc.).</p></li><li class="listitem"><p>Check if queues are empty by <code class="literal">garage-manage stats</code> or through monitoring tools.</p></li><li class="listitem"><p>Run <code class="literal">systemctl stop garage</code> to stop the actual Garage version.</p></li><li class="listitem"><p>Backup the metadata folder of ALL your nodes, e.g. for a metadata directory (the default one) in <code class="literal">/var/lib/garage/meta</code>,
you can run <code class="literal">pushd /var/lib/garage; tar -acf meta-v0.7.tar.zst meta/; popd</code>.</p></li><li class="listitem"><p>Run the offline migration: <code class="literal">nix-shell -p garage_0_8 --run "garage offline-repair --yes"</code>, this can take some time depending on how many objects are stored in your cluster.</p></li><li class="listitem"><p>Bump Garage version in your NixOS configuration, either by changing <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-system.stateVersion">stateVersion</a> or bumping <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.garage.package">services.garage.package</a>, this should restart Garage automatically.</p></li><li class="listitem"><p>Perform <code class="literal">garage-manage repair --all-nodes --yes tables</code> and <code class="literal">garage-manage repair --all-nodes --yes blocks</code>.</p></li><li class="listitem"><p>Wait for a full table sync to run.</p></li></ul></div><p>Your upgraded cluster should be in a working state, re-enable API and web access.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-garage-maintainer-info" class="title" style="clear: both">Maintainer information   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-garage-maintainer-info" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>As stated in the previous paragraph, we must provide a clean upgrade-path for Garage
since it cannot move more than one major version forward on a single upgrade. This chapter
adds some notes how Garage updates should be rolled out in the future.
This is inspired from how Nextcloud does it.</p><p>While patch-level updates are no problem and can be done directly in the
package-expression (and should be backported to supported stable branches after that),
major-releases should be added in a new attribute (e.g. Garage <code class="literal">v0.8.0</code>
should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.garage_0_8_0</code>).
To provide simple upgrade paths it’s generally useful to backport those as well to stable
branches. As long as the package-default isn’t altered, this won’t break existing setups.
After that, the versioning-warning in the <code class="literal">garage</code>-module should be
updated to make sure that the
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.garage.package">package</a>-option selects the latest version
on fresh setups.</p><p>If major-releases will be abandoned by upstream, we should check first if those are needed
in NixOS for a safe upgrade-path before removing those. In that case we should keep those
packages, but mark them as insecure in an expression like this (in
<code class="literal">&lt;nixpkgs/pkgs/tools/filesystem/garage/default.nix&gt;</code>):</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment">/* ... */</span>
{
  <span class="hljs-attr">garage_0_7_3</span> = generic {
    <span class="hljs-attr">version</span> = <span class="hljs-string">"0.7.3"</span>;
    <span class="hljs-attr">sha256</span> = <span class="hljs-string">"0000000000000000000000000000000000000000000000000000"</span>;
    <span class="hljs-attr">eol</span> = <span class="hljs-literal">true</span>;
  };
}
</code></pre><p>Ideally we should make sure that it’s possible to jump two NixOS versions forward:
i.e. the warnings and the logic in the module should guard a user to upgrade from a
Garage on e.g. 22.11 to a Garage on 23.11.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-plausible" class="title">Plausible   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-plausible" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-plausible-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://plausible.io/" target="_top">Plausible</a> is a privacy-friendly alternative to
Google analytics.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-plausible-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-plausible-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>At first, a secret key is needed to be generated. This can be done with e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">openssl rand -<span class="hljs-built_in">base64</span> 64</span>
</code></pre><p>After that, <code class="literal">plausible</code> can be deployed like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">plausible</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">adminUser</span> = {
      <span class="hljs-comment"># activate is used to skip the email verification of the admin-user that's</span>
      <span class="hljs-comment"># automatically created by plausible. This is only supported if</span>
      <span class="hljs-comment"># postgresql is configured by the module. This is done by default, but</span>
      <span class="hljs-comment"># can be turned off with services.plausible.database.postgres.setup.</span>
      <span class="hljs-attr">activate</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@localhost"</span>;
      <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/run/secrets/plausible-admin-pwd"</span>;
    };
    <span class="hljs-attr">server</span> = {
      <span class="hljs-attr">baseUrl</span> = <span class="hljs-string">"http://analytics.example.org"</span>;
      <span class="hljs-comment"># secretKeybaseFile is a path to the file which contains the secret generated</span>
      <span class="hljs-comment"># with openssl as described above.</span>
      <span class="hljs-attr">secretKeybaseFile</span> = <span class="hljs-string">"/run/secrets/plausible-secret-key-base"</span>;
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs" class="title">Pict-rs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-missing">Missing</a> </span></dt> </dl></div><p>pict-rs is a  a simple image hosting service.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>the minimum to start pict-rs is</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.pict-rs.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>this will start the http server on port 8080 by default.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-usage" class="title" style="clear: both">Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>pict-rs offers the following endpoints:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">POST /image</code> for uploading an image. Uploaded content must be valid multipart/form-data with an
image array located within the <code class="literal">images[]</code> key</p><p>This endpoint returns the following JSON structure on success with a 201 Created status</p><pre><code class="programlisting json hljs language-bash" data-highlighted="yes">{
    <span class="hljs-string">"files"</span>: [
        {
            <span class="hljs-string">"delete_token"</span>: <span class="hljs-string">"JFvFhqJA98"</span>,
            <span class="hljs-string">"file"</span>: <span class="hljs-string">"lkWZDRvugm.jpg"</span>
        },
        {
            <span class="hljs-string">"delete_token"</span>: <span class="hljs-string">"kAYy9nk2WK"</span>,
            <span class="hljs-string">"file"</span>: <span class="hljs-string">"8qFS0QooAn.jpg"</span>
        },
        {
            <span class="hljs-string">"delete_token"</span>: <span class="hljs-string">"OxRpM3sf0Y"</span>,
            <span class="hljs-string">"file"</span>: <span class="hljs-string">"1hJaYfGE01.jpg"</span>
        }
    ],
    <span class="hljs-string">"msg"</span>: <span class="hljs-string">"ok"</span>
}
</code></pre></li><li class="listitem"><p><code class="literal">GET /image/download?url=...</code> Download an image from a remote server, returning the same JSON
payload as the <code class="literal">POST</code> endpoint</p></li><li class="listitem"><p><code class="literal">GET /image/original/{file}</code> for getting a full-resolution image. <code class="literal">file</code> here is the <code class="literal">file</code> key from the
<code class="literal">/image</code> endpoint’s JSON</p></li><li class="listitem"><p><code class="literal">GET /image/details/original/{file}</code> for getting the details of a full-resolution image.
The returned JSON is structured like so:</p><pre><code class="programlisting json hljs language-bash" data-highlighted="yes">{
    <span class="hljs-string">"width"</span>: 800,
    <span class="hljs-string">"height"</span>: 537,
    <span class="hljs-string">"content_type"</span>: <span class="hljs-string">"image/webp"</span>,
    <span class="hljs-string">"created_at"</span>: [
        2020,
        345,
        67376,
        394363487
    ]
}
</code></pre></li><li class="listitem"><p><code class="literal">GET /image/process.{ext}?src={file}&amp;...</code> get a file with transformations applied.
existing transformations include</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">identity=true</code>: apply no changes</p></li><li class="listitem"><p><code class="literal">blur={float}</code>: apply a gaussian blur to the file</p></li><li class="listitem"><p><code class="literal">thumbnail={int}</code>: produce a thumbnail of the image fitting inside an <code class="literal">{int}</code> by <code class="literal">{int}</code>
square using raw pixel sampling</p></li><li class="listitem"><p><code class="literal">resize={int}</code>: produce a thumbnail of the image fitting inside an <code class="literal">{int}</code> by <code class="literal">{int}</code> square
using a Lanczos2 filter. This is slower than sampling but looks a bit better in some cases</p></li><li class="listitem"><p><code class="literal">crop={int-w}x{int-h}</code>: produce a cropped version of the image with an <code class="literal">{int-w}</code> by <code class="literal">{int-h}</code>
aspect ratio. The resulting crop will be centered on the image. Either the width or height
of the image will remain full-size, depending on the image’s aspect ratio and the requested
aspect ratio. For example, a 1600x900 image cropped with a 1x1 aspect ratio will become 900x900. A
1600x1100 image cropped with a 16x9 aspect ratio will become 1600x900.</p></li></ul></div><p>Supported <code class="literal">ext</code> file extensions include <code class="literal">png</code>, <code class="literal">jpg</code>, and <code class="literal">webp</code></p><p>An example of usage could be</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">GET /image/process.jpg?src=asdf.png&amp;thumbnail=256&amp;blur=3.0
</code></pre><p>which would create a 256x256px JPEG thumbnail and blur it</p></li><li class="listitem"><p><code class="literal">GET /image/details/process.{ext}?src={file}&amp;...</code> for getting the details of a processed image.
The returned JSON is the same format as listed for the full-resolution details endpoint.</p></li><li class="listitem"><p><code class="literal">DELETE /image/delete/{delete_token}/{file}</code> or <code class="literal">GET /image/delete/{delete_token}/{file}</code> to
delete a file, where <code class="literal">delete_token</code> and <code class="literal">file</code> are from the <code class="literal">/image</code> endpoint’s JSON</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pict-rs-missing" class="title" style="clear: both">Missing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pict-rs-missing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Configuring the secure-api-key is not included yet. The envisioned basic use case is consumption on localhost by other services without exposing the service to the internet.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud" class="title">Nextcloud   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-pitfalls-during-upgrade">Common problems</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-httpd">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#installing-apps-php-extensions-nextcloud">Installing Apps and PHP extensions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-maintainer-info">Maintainer information</a> </span></dt> </dl></div><p><a class="link" href="https://nextcloud.com/" target="_top">Nextcloud</a> is an open-source,
self-hostable cloud platform. The server setup can be automated using
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.enable">services.nextcloud</a>. A
desktop client is packaged at <code class="literal">pkgs.nextcloud-client</code>.</p><p>The current default by NixOS is <code class="literal">nextcloud27</code> which is also the latest
major version available.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Nextcloud is a PHP-based application which requires an HTTP server
(<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.enable"><code class="literal">services.nextcloud</code></a>
and optionally supports
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nginx.enable"><code class="literal">services.nginx</code></a>).</p><p>For the database, you can set
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.config.dbtype"><code class="literal">services.nextcloud.config.dbtype</code></a> to
either <code class="literal">sqlite</code> (the default), <code class="literal">mysql</code>, or <code class="literal">pgsql</code>. The simplest is <code class="literal">sqlite</code>,
which will be automatically created and managed by the application. For the
last two, you can easily create a local database by setting
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.database.createLocally"><code class="literal">services.nextcloud.database.createLocally</code></a>
to <code class="literal">true</code>, Nextcloud will automatically be configured to connect to it through
socket.</p><p>A very basic configuration may look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ pkgs, ... }:
{
  services.<span class="hljs-attr">nextcloud</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hostName</span> = <span class="hljs-string">"nextcloud.tld"</span>;
    database.<span class="hljs-attr">createLocally</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">config</span> = {
      <span class="hljs-attr">dbtype</span> = <span class="hljs-string">"pgsql"</span>;
      <span class="hljs-attr">adminpassFile</span> = <span class="hljs-string">"/path/to/admin-pass-file"</span>;
    };
  };

  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
}
</code></pre><p>The <code class="literal">hostName</code> option is used internally to configure an HTTP
server using <a class="link" href="https://php-fpm.org/" target="_top"><code class="literal">PHP-FPM</code></a>
and <code class="literal">nginx</code>. The <code class="literal">config</code> attribute set is
used by the imperative installer and all values are written to an additional file
to ensure that changes can be applied by changing the module’s options.</p><p>In case the application serves multiple domains (those are checked with
<a class="link" href="https://www.php.net/manual/en/reserved.variables.server.php" target="_top"><code class="literal">$_SERVER['HTTP_HOST']</code></a>)
it’s needed to add them to
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.config.extraTrustedDomains"><code class="literal">services.nextcloud.config.extraTrustedDomains</code></a>.</p><p>Auto updates for Nextcloud apps can be enabled using
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.autoUpdateApps.enable"><code class="literal">services.nextcloud.autoUpdateApps</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-pitfalls-during-upgrade" class="title" style="clear: both">Common problems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-pitfalls-during-upgrade" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="strong"><strong>General notes.</strong></span>
Unfortunately Nextcloud appears to be very stateful when it comes to
managing its own configuration. The config file lives in the home directory
of the <code class="literal">nextcloud</code> user (by default
<code class="literal">/var/lib/nextcloud/config/config.php</code>) and is also used to
track several states of the application (e.g., whether installed or not).</p><p>All configuration parameters are also stored in
<code class="filename">/var/lib/nextcloud/config/override.config.php</code> which is generated by
the module and linked from the store to ensure that all values from
<code class="filename">config.php</code> can be modified by the module.
However <code class="filename">config.php</code> manages the application’s state and shouldn’t be
touched manually because of that.</p><div class="warning"><h3 class="title">Warning</h3><p>Don’t delete <code class="filename">config.php</code>! This file
tracks the application’s state and a deletion can cause unwanted
side-effects!</p></div><div class="warning"><h3 class="title">Warning</h3><p>Don’t rerun <code class="literal">nextcloud-occ maintenance:install</code>!
This command tries to install the application
and can cause unwanted side-effects!</p></div></li><li class="listitem"><p><span class="strong"><strong>Multiple version upgrades.</strong></span>
Nextcloud doesn’t allow to move more than one major-version forward. E.g., if you’re on
<code class="literal">v16</code>, you cannot upgrade to <code class="literal">v18</code>, you need to upgrade to
<code class="literal">v17</code> first. This is ensured automatically as long as the
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-system.stateVersion">stateVersion</a> is declared properly. In that case
the oldest version available (one major behind the one from the previous NixOS
release) will be selected by default and the module will generate a warning that reminds
the user to upgrade to latest Nextcloud <span class="emphasis"><em>after</em></span> that deploy.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Error: Command "upgrade" is not defined.</code></strong></span>
This error usually occurs if the initial installation
(<span class="command"><strong>nextcloud-occ maintenance:install</strong></span>) has failed. After that, the application
is not installed, but the upgrade is attempted to be executed. Further context can
be found in <a class="link" href="https://github.com/NixOS/nixpkgs/issues/111175" target="_top">NixOS/nixpkgs#111175</a>.</p><p>First of all, it makes sense to find out what went wrong by looking at the logs
of the installation via <span class="command"><strong>journalctl -u nextcloud-setup</strong></span> and try to fix
the underlying issue.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p>If this occurs on an <span class="emphasis"><em>existing</em></span> setup, this is most likely because
the maintenance mode is active. It can be deactivated by running
<span class="command"><strong>nextcloud-occ maintenance:mode --off</strong></span>. It’s advisable though to
check the logs first on why the maintenance mode was activated.</p></li><li class="listitem"><div class="warning"><h3 class="title">Warning</h3><p>Only perform the following measures on
<span class="emphasis"><em>freshly installed instances!</em></span></p></div><p>A re-run of the installer can be forced by <span class="emphasis"><em>deleting</em></span>
<code class="filename">/var/lib/nextcloud/config/config.php</code>. This is the only time
advisable because the fresh install doesn’t have any state that can be lost.
In case that doesn’t help, an entire re-creation can be forced via
<span class="command"><strong>rm -rf ~nextcloud/</strong></span>.</p></li></ul></div></li><li class="listitem"><p><span class="strong"><strong>Server-side encryption.</strong></span>
Nextcloud supports <a class="link" href="https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/encryption_configuration.html" target="_top">server-side encryption (SSE)</a>.
This is not an end-to-end encryption, but can be used to encrypt files that will be persisted
to external storage such as S3.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-httpd" class="title" style="clear: both">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-httpd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, <code class="literal">nginx</code> is used as reverse-proxy for <code class="literal">nextcloud</code>.
However, it’s possible to use e.g. <code class="literal">httpd</code> by explicitly disabling
<code class="literal">nginx</code> using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.nginx.enable"><code class="option">services.nginx.enable</code></a> and fixing the
settings <code class="literal">listen.owner</code> &amp; <code class="literal">listen.group</code> in the
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.phpfpm.pools">corresponding <code class="literal">phpfpm</code> pool</a>.</p><p>An exemplary configuration may look like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ config, lib, pkgs, ... }: {
  services.nginx.enable = <span class="hljs-literal">false</span>;
  services.nextcloud = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    hostName = <span class="hljs-string">"localhost"</span>;

    /* further, required options */
  };
  services.phpfpm.pools.nextcloud.settings = {
    <span class="hljs-string">"listen.owner"</span> = config.services.httpd.user;
    <span class="hljs-string">"listen.group"</span> = config.services.httpd.group;
  };
  services.httpd = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    adminAddr = <span class="hljs-string">"webmaster@localhost"</span>;
    extraModules = [ <span class="hljs-string">"proxy_fcgi"</span> ];
    virtualHosts.<span class="hljs-string">"localhost"</span> = {
      documentRoot = config.services.nextcloud.package;
      extraConfig = <span class="hljs-string">''</span>
        &lt;Directory <span class="hljs-string">"<span class="hljs-variable">${config.services.nextcloud.package}</span>"</span>&gt;
          &lt;FilesMatch <span class="hljs-string">"\.php$"</span>&gt;
            &lt;If <span class="hljs-string">"-f %{REQUEST_FILENAME}"</span>&gt;
              SetHandler <span class="hljs-string">"proxy:unix:<span class="hljs-variable">${config.services.phpfpm.pools.nextcloud.socket}</span>|fcgi://localhost/"</span>
            &lt;/If&gt;
          &lt;/FilesMatch&gt;
          &lt;IfModule mod_rewrite.c&gt;
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.php$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.php [L]
          &lt;/IfModule&gt;
          DirectoryIndex index.php
          Require all granted
          Options +FollowSymLinks
        &lt;/Directory&gt;
      <span class="hljs-string">''</span>;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="installing-apps-php-extensions-nextcloud" class="title" style="clear: both">Installing Apps and PHP extensions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#installing-apps-php-extensions-nextcloud" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Nextcloud apps are installed statefully through the web interface.
Some apps may require extra PHP extensions to be installed.
This can be configured with the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.phpExtraExtensions"><code class="option">services.nextcloud.phpExtraExtensions</code></a> setting.</p><p>Alternatively, extra apps can also be declared with the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.extraApps"><code class="option">services.nextcloud.extraApps</code></a> setting.
When using this setting, apps can no longer be managed statefully because this can lead to Nextcloud updating apps
that are managed by Nix. If you want automatic updates it is recommended that you use web interface to install apps.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-nextcloud-maintainer-info" class="title" style="clear: both">Maintainer information   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-nextcloud-maintainer-info" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>As stated in the previous paragraph, we must provide a clean upgrade-path for Nextcloud
since it cannot move more than one major version forward on a single upgrade. This chapter
adds some notes how Nextcloud updates should be rolled out in the future.</p><p>While minor and patch-level updates are no problem and can be done directly in the
package-expression (and should be backported to supported stable branches after that),
major-releases should be added in a new attribute (e.g. Nextcloud <code class="literal">v19.0.0</code>
should be available in <code class="literal">nixpkgs</code> as <code class="literal">pkgs.nextcloud19</code>).
To provide simple upgrade paths it’s generally useful to backport those as well to stable
branches. As long as the package-default isn’t altered, this won’t break existing setups.
After that, the versioning-warning in the <code class="literal">nextcloud</code>-module should be
updated to make sure that the
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nextcloud.package">package</a>-option selects the latest version
on fresh setups.</p><p>If major-releases will be abandoned by upstream, we should check first if those are needed
in NixOS for a safe upgrade-path before removing those. In that case we should keep those
packages, but mark them as insecure in an expression like this (in
<code class="literal">&lt;nixpkgs/pkgs/servers/nextcloud/default.nix&gt;</code>):</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment">/* ... */</span>
{
  <span class="hljs-attr">nextcloud17</span> = generic {
    <span class="hljs-attr">version</span> = <span class="hljs-string">"17.0.x"</span>;
    <span class="hljs-attr">sha256</span> = <span class="hljs-string">"0000000000000000000000000000000000000000000000000000"</span>;
    <span class="hljs-attr">eol</span> = <span class="hljs-literal">true</span>;
  };
}
</code></pre><p>Ideally we should make sure that it’s possible to jump two NixOS versions forward:
i.e. the warnings and the logic in the module should guard a user to upgrade from a
Nextcloud on e.g. 19.09 to a Nextcloud on 20.09.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo" class="title">Matomo   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo-database-setup">Database Setup</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo-archive-processing">Archive Processing</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo-backups">Backup</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo-issues">Issues</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matomo-other-web-servers">Using other Web Servers than nginx</a> </span></dt> </dl></div><p>Matomo is a real-time web analytics application. This module configures
php-fpm as backend for Matomo, optionally configuring an nginx vhost as well.</p><p>An automatic setup is not supported by Matomo, so you need to configure Matomo
itself in the browser-based Matomo setup.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-database-setup" class="title" style="clear: both">Database Setup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo-database-setup" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You also need to configure a MariaDB or MySQL database and -user for Matomo
yourself, and enter those credentials in your browser. You can use
passwordless database authentication via the UNIX_SOCKET authentication
plugin with the following SQL commands:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes"><span class="hljs-comment"># For MariaDB</span>
INSTALL PLUGIN unix_socket SONAME <span class="hljs-string">'auth_socket'</span>;
CREATE DATABASE matomo;
CREATE USER <span class="hljs-string">'matomo'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED WITH unix_socket;
GRANT ALL PRIVILEGES ON matomo.* TO <span class="hljs-string">'matomo'</span>@<span class="hljs-string">'localhost'</span>;

<span class="hljs-comment"># For MySQL</span>
INSTALL PLUGIN auth_socket SONAME <span class="hljs-string">'auth_socket.so'</span>;
CREATE DATABASE matomo;
CREATE USER <span class="hljs-string">'matomo'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED WITH auth_socket;
GRANT ALL PRIVILEGES ON matomo.* TO <span class="hljs-string">'matomo'</span>@<span class="hljs-string">'localhost'</span>;
</code></pre><p>Then fill in <code class="literal">matomo</code> as database user and database name,
and leave the password field blank. This authentication works by allowing
only the <code class="literal">matomo</code> unix user to authenticate as the
<code class="literal">matomo</code> database user (without needing a password), but no
other users. For more information on passwordless login, see
<a class="link" href="https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/" target="_top">https://mariadb.com/kb/en/mariadb/unix_socket-authentication-plugin/</a>.</p><p>Of course, you can use password based authentication as well, e.g. when the
database is not on the same host.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-archive-processing" class="title" style="clear: both">Archive Processing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo-archive-processing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This module comes with the systemd service
<code class="literal">matomo-archive-processing.service</code> and a timer that
automatically triggers archive processing every hour. This means that you
can safely
<a class="link" href="https://matomo.org/docs/setup-auto-archiving/#disable-browser-triggers-for-matomo-archiving-and-limit-matomo-reports-to-updating-every-hour" target="_top">disable browser triggers for Matomo archiving</a> at
<code class="literal">Administration &gt; System &gt; General Settings</code>.</p><p>With automatic archive processing, you can now also enable to
<a class="link" href="https://matomo.org/docs/privacy/#step-2-delete-old-visitors-logs" target="_top">delete old visitor logs</a>
at <code class="literal">Administration &gt; System &gt; Privacy</code>, but make sure that you run <code class="literal">systemctl start matomo-archive-processing.service</code> at least once without errors if
you have already collected data before, so that the reports get archived
before the source data gets deleted.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-backups" class="title" style="clear: both">Backup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo-backups" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You only need to take backups of your MySQL database and the
<code class="filename">/var/lib/matomo/config/config.ini.php</code> file. Use a user
in the <code class="literal">matomo</code> group or root to access the file. For more
information, see
<a class="link" href="https://matomo.org/faq/how-to-install/faq_138/" target="_top">https://matomo.org/faq/how-to-install/faq_138/</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-issues" class="title" style="clear: both">Issues   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo-issues" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Matomo will warn you that the JavaScript tracker is not writable. This is
because it’s located in the read-only nix store. You can safely ignore
this, unless you need a plugin that needs JavaScript tracker access.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matomo-other-web-servers" class="title" style="clear: both">Using other Web Servers than nginx   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matomo-other-web-servers" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can use other web servers by forwarding calls for
<code class="filename">index.php</code> and <code class="filename">piwik.php</code> to the
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.phpfpm.pools._name_.socket"><code class="literal">services.phpfpm.pools.&lt;name&gt;.socket</code></a>
fastcgi unix socket. You can use
the nginx configuration in the module code as a reference to what else
should be configured.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy" class="title">Lemmy   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-lemmy" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-missing">Missing</a> </span></dt> </dl></div><p>Lemmy is a federated alternative to reddit in rust.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>the minimum to start lemmy is</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">lemmy</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">settings</span> = {
    <span class="hljs-attr">hostname</span> = <span class="hljs-string">"lemmy.union.rocks"</span>;
    database.<span class="hljs-attr">createLocally</span> = <span class="hljs-literal">true</span>;
  };
  caddy.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>this will start the backend on port 8536 and the frontend on port 1234.
It will expose your instance with a caddy reverse proxy to the hostname you’ve provided.
Postgres will be initialized on that same instance automatically.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-usage" class="title" style="clear: both">Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>On first connection you will be asked to define an admin user.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-lemmy-missing" class="title" style="clear: both">Missing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-lemmy-missing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Exposing with nginx is not implemented yet.</p></li><li class="listitem"><p>This has been tested using a local database with a unix socket connection. Using different database settings will likely require modifications</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak" class="title">Keycloak   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-admin">Administration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-database">Database access</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-hostname">Hostname</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-tls">Setting up TLS/SSL</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-themes">Themes</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-settings">Configuration file settings</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-example-config">Example configuration</a> </span></dt> </dl></div><p><a class="link" href="https://www.keycloak.org/" target="_top">Keycloak</a> is an
open source identity and access management server with support for
<a class="link" href="https://openid.net/connect/" target="_top">OpenID Connect</a>,
<a class="link" href="https://oauth.net/2/" target="_top">OAUTH 2.0</a> and
<a class="link" href="https://en.wikipedia.org/wiki/SAML_2.0" target="_top">SAML 2.0</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-admin" class="title" style="clear: both">Administration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-admin" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>An administrative user with the username
<code class="literal">admin</code> is automatically created in the
<code class="literal">master</code> realm. Its initial password can be
configured by setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.initialAdminPassword"><code class="option">services.keycloak.initialAdminPassword</code></a>
and defaults to <code class="literal">changeme</code>. The password is
not stored safely and should be changed immediately in the
admin panel.</p><p>Refer to the <a class="link" href="https://www.keycloak.org/docs/latest/server_admin/index.html" target="_top">Keycloak Server Administration Guide</a> for information on
how to administer your Keycloak
instance.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-database" class="title" style="clear: both">Database access   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-database" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Keycloak can be used with either PostgreSQL, MariaDB or
MySQL. Which one is used can be
configured in <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.type"><code class="option">services.keycloak.database.type</code></a>. The selected
database will automatically be enabled and a database and role
created unless <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a> is changed
from its default of <code class="literal">localhost</code> or
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.createLocally"><code class="option">services.keycloak.database.createLocally</code></a> is set to <code class="literal">false</code>.</p><p>External database access can also be configured by setting
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.name"><code class="option">services.keycloak.database.name</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.username"><code class="option">services.keycloak.database.username</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.useSSL"><code class="option">services.keycloak.database.useSSL</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.caCert"><code class="option">services.keycloak.database.caCert</code></a> as
appropriate. Note that you need to manually create the database
and allow the configured database user full access to it.</p><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.passwordFile"><code class="option">services.keycloak.database.passwordFile</code></a>
must be set to the path to a file containing the password used
to log in to the database. If <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.host"><code class="option">services.keycloak.database.host</code></a>
and <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.database.createLocally"><code class="option">services.keycloak.database.createLocally</code></a>
are kept at their defaults, the database role
<code class="literal">keycloak</code> with that password is provisioned
on the local database instance.</p><div class="warning"><h3 class="title">Warning</h3><p>The path should be provided as a string, not a Nix path, since Nix
paths are copied into the world readable Nix store.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-hostname" class="title" style="clear: both">Hostname   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-hostname" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The hostname is used to build the public URL used as base for
all frontend requests and must be configured through
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.settings.hostname"><code class="option">services.keycloak.settings.hostname</code></a>.</p><div class="note"><h3 class="title">Note</h3><p>If you’re migrating an old Wildfly based Keycloak instance
and want to keep compatibility with your current clients,
you’ll likely want to set <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.settings.http-relative-path"><code class="option">services.keycloak.settings.http-relative-path</code></a>
to <code class="literal">/auth</code>. See the option description
for more details.</p></div><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.settings.hostname-strict-backchannel"><code class="option">services.keycloak.settings.hostname-strict-backchannel</code></a>
determines whether Keycloak should force all requests to go
through the frontend URL. By default,
Keycloak allows backend requests to
instead use its local hostname or IP address and may also
advertise it to clients through its OpenID Connect Discovery
endpoint.</p><p>For more information on hostname configuration, see the <a class="link" href="https://www.keycloak.org/server/hostname" target="_top">Hostname
section of the Keycloak Server Installation and Configuration
Guide</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-tls" class="title" style="clear: both">Setting up TLS/SSL   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-tls" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, Keycloak won’t accept
unsecured HTTP connections originating from outside its local
network.</p><p>HTTPS support requires a TLS/SSL certificate and a private key,
both <a class="link" href="https://en.wikipedia.org/wiki/Privacy-Enhanced_Mail" target="_top">PEM formatted</a>.
Their paths should be set through
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.sslCertificate"><code class="option">services.keycloak.sslCertificate</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.sslCertificateKey"><code class="option">services.keycloak.sslCertificateKey</code></a>.</p><div class="warning"><h3 class="title">Warning</h3><p>The paths should be provided as a strings, not a Nix paths,
since Nix paths are copied into the world readable Nix store.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-themes" class="title" style="clear: both">Themes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-themes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can package custom themes and make them visible to
Keycloak through <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.themes"><code class="option">services.keycloak.themes</code></a>. See the
<a class="link" href="https://www.keycloak.org/docs/latest/server_development/#_themes" target="_top">Themes section of the Keycloak Server Development Guide</a> and the description of the aforementioned NixOS option for
more information.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-settings" class="title" style="clear: both">Configuration file settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Keycloak server configuration parameters can be set in
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.settings"><code class="option">services.keycloak.settings</code></a>. These correspond
directly to options in
<code class="filename">conf/keycloak.conf</code>. Some of the most
important parameters are documented as suboptions, the rest can
be found in the <a class="link" href="https://www.keycloak.org/server/all-config" target="_top">All
configuration section of the Keycloak Server Installation and
Configuration Guide</a>.</p><p>Options containing secret data should be set to an attribute
set containing the attribute <code class="literal">_secret</code> - a
string pointing to a file containing the value the option
should be set to. See the description of
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.keycloak.settings"><code class="option">services.keycloak.settings</code></a> for an example.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-keycloak-example-config" class="title" style="clear: both">Example configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-keycloak-example-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A basic configuration with some custom settings could look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">keycloak</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">settings</span> = {
    <span class="hljs-attr">hostname</span> = <span class="hljs-string">"keycloak.example.com"</span>;
    <span class="hljs-attr">hostname-strict-backchannel</span> = <span class="hljs-literal">true</span>;
  };
  <span class="hljs-attr">initialAdminPassword</span> = <span class="hljs-string">"e6Wcm0RrtegMEHl"</span>;  <span class="hljs-comment"># change on first login</span>
  <span class="hljs-attr">sslCertificate</span> = <span class="hljs-string">"/run/keys/ssl_cert"</span>;
  <span class="hljs-attr">sslCertificateKey</span> = <span class="hljs-string">"/run/keys/ssl_key"</span>;
  database.<span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/run/keys/db_password"</span>;
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-meet" class="title">Jitsi Meet   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-meet" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-configuration">Configuration</a> </span></dt> </dl></div><p>With Jitsi Meet on NixOS you can quickly configure a complete,
private, self-hosted video conferencing solution.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration using Let’s Encrypt for TLS certificates looks like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">jitsi-meet</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hostName</span> = <span class="hljs-string">"jitsi.example.com"</span>;
  };
  services.jitsi-videobridge.<span class="hljs-attr">openFirewall</span> = <span class="hljs-literal">true</span>;
  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
  security.acme.<span class="hljs-attr">email</span> = <span class="hljs-string">"me@example.com"</span>;
  security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-jitsi-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-jitsi-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Here is the minimal configuration with additional configurations:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">jitsi-meet</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hostName</span> = <span class="hljs-string">"jitsi.example.com"</span>;
    <span class="hljs-attr">config</span> = {
      <span class="hljs-attr">enableWelcomePage</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-attr">prejoinPageEnabled</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">defaultLang</span> = <span class="hljs-string">"fi"</span>;
    };
    <span class="hljs-attr">interfaceConfig</span> = {
      <span class="hljs-attr">SHOW_JITSI_WATERMARK</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-attr">SHOW_WATERMARK_FOR_GUESTS</span> = <span class="hljs-literal">false</span>;
    };
  };
  services.jitsi-videobridge.<span class="hljs-attr">openFirewall</span> = <span class="hljs-literal">true</span>;
  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
  security.acme.<span class="hljs-attr">email</span> = <span class="hljs-string">"me@example.com"</span>;
  security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-honk" class="title">Honk   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-honk" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-honk-basic-usage">Basic usage</a> </span></dt> </dl></div><p>With Honk on NixOS you can quickly configure a complete ActivityPub server with
minimal setup and support costs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-honk-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-honk-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">honk</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">host</span> = <span class="hljs-string">"0.0.0.0"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">8080</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"username"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/etc/honk/password.txt"</span>;
    <span class="hljs-attr">servername</span> = <span class="hljs-string">"honk.example.com"</span>;
  };

  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">8080</span> ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy" class="title">Grocy   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-grocy" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-grocy-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-grocy-settings">Settings</a> </span></dt> </dl></div><p><a class="link" href="https://grocy.info/" target="_top">Grocy</a> is a web-based self-hosted groceries
&amp; household management solution for your home.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-grocy-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A very basic configuration may look like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ pkgs, ... }:
{
  services.grocy = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    hostName = <span class="hljs-string">"grocy.tld"</span>;
  };
}
</code></pre><p>This configures a simple vhost using <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nginx.enable">nginx</a>
which listens to <code class="literal">grocy.tld</code> with fully configured ACME/LE (this can be
disabled by setting <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.grocy.nginx.enableSSL">services.grocy.nginx.enableSSL</a>
to <code class="literal">false</code>). After the initial setup the credentials <code class="literal">admin:admin</code>
can be used to login.</p><p>The application’s state is persisted at <code class="literal">/var/lib/grocy/grocy.db</code> in a
<code class="literal">sqlite3</code> database. The migration is applied when requesting the <code class="literal">/</code>-route
of the application.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-grocy-settings" class="title" style="clear: both">Settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-grocy-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The configuration for <code class="literal">grocy</code> is located at <code class="literal">/etc/grocy/config.php</code>.
By default, the following settings can be defined in the NixOS-configuration:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ pkgs, ... }:
{
  services.grocy.<span class="hljs-attr">settings</span> = {
    <span class="hljs-comment"># The default currency in the system for invoices etc.</span>
    <span class="hljs-comment"># Please note that exchange rates aren't taken into account, this</span>
    <span class="hljs-comment"># is just the setting for what's shown in the frontend.</span>
    <span class="hljs-attr">currency</span> = <span class="hljs-string">"EUR"</span>;

    <span class="hljs-comment"># The display language (and locale configuration) for grocy.</span>
    <span class="hljs-attr">culture</span> = <span class="hljs-string">"de"</span>;

    <span class="hljs-attr">calendar</span> = {
      <span class="hljs-comment"># Whether or not to show the week-numbers</span>
      <span class="hljs-comment"># in the calendar.</span>
      <span class="hljs-attr">showWeekNumber</span> = <span class="hljs-literal">true</span>;

      <span class="hljs-comment"># Index of the first day to be shown in the calendar (0=Sunday, 1=Monday,</span>
      <span class="hljs-comment"># 2=Tuesday and so on).</span>
      <span class="hljs-attr">firstDayOfWeek</span> = <span class="hljs-number">2</span>;
    };
  };
}
</code></pre><p>If you want to alter the configuration file on your own, you can do this manually with
an expression like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ lib, ... }:
{
  environment.etc.<span class="hljs-string">"grocy/config.php"</span>.text = lib.mkAfter <span class="hljs-string">''</span>
    // Arbitrary PHP code <span class="hljs-keyword">in</span> grocy<span class="hljs-string">'s configuration file
  '</span><span class="hljs-string">';
}
</span></code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gotosocial" class="title">GoToSocial   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gotosocial" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-service-configuration">Service configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-proxy-configuration">Proxy configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-user-management">User management</a> </span></dt> </dl></div><p><a class="link" href="https://gotosocial.org/" target="_top">GoToSocial</a> is an ActivityPub social network server, written in Golang.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-service-configuration" class="title" style="clear: both">Service configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-service-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The following configuration sets up the PostgreSQL as database backend and binds
GoToSocial to <code class="literal">127.0.0.1:8080</code>, expecting to be run behind a HTTP proxy on <code class="literal">gotosocial.example.com</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">gotosocial</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">setupPostgresqlDB</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">settings</span> = {
    <span class="hljs-attr">application-name</span> = <span class="hljs-string">"My GoToSocial"</span>;
    <span class="hljs-attr">host</span> = <span class="hljs-string">"gotosocial.example.com"</span>;
    <span class="hljs-attr">protocol</span> = <span class="hljs-string">"https"</span>;
    <span class="hljs-attr">bind-address</span> = <span class="hljs-string">"127.0.0.1"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">8080</span>;
  };
};
</code></pre><p>Please refer to the <a class="link" href="https://docs.gotosocial.org/en/latest/configuration/general/" target="_top">GoToSocial Documentation</a>
for additional configuration options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-proxy-configuration" class="title" style="clear: both">Proxy configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-proxy-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Although it is possible to expose GoToSocial directly, it is common practice to operate it behind an
HTTP reverse proxy such as nginx.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">clientMaxBodySize</span> = <span class="hljs-string">"40M"</span>;
  <span class="hljs-attr">virtualHosts</span> = <span class="hljs-keyword">with</span> config.services.gotosocial.settings; {
    <span class="hljs-string">"<span class="hljs-subst">${host}</span>"</span> = {
      <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">locations</span> = {
        <span class="hljs-string">"/"</span> = {
          <span class="hljs-attr">recommendedProxySettings</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-attr">proxyWebsockets</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://<span class="hljs-subst">${bind-address}</span>:<span class="hljs-subst">${<span class="hljs-built_in">toString</span> port}</span>"</span>;
        };
      };
    };
  };
};
</code></pre><p>Please refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/#module-security-acme" title="SSL/TLS Certificates with ACME"><em>SSL/TLS Certificates with ACME</em></a> for details on how to provision an SSL/TLS certificate.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-gotosocial-user-management" class="title" style="clear: both">User management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-gotosocial-user-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>After the GoToSocial service is running, the <code class="literal">gotosocial-admin</code> utility can be used to manage users. In particular an
administrative user can be created with</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo gotosocial-admin account create --username &lt;nickname&gt; --email &lt;email&gt; --password &lt;password&gt;</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo gotosocial-admin account confirm --username &lt;nickname&gt;</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo gotosocial-admin account promote --username &lt;nickname&gt;</span>
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse" class="title">Discourse   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-tls">Using a regular TLS certificate</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-database">Database access</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-mail">Email</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-settings">Additional settings</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-discourse-plugins">Plugins</a> </span></dt> </dl></div><p><a class="link" href="https://www.discourse.org/" target="_top">Discourse</a> is a
modern and open source discussion platform.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration using Let’s Encrypt for TLS certificates looks like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">discourse</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostname</span> = <span class="hljs-string">"discourse.example.com"</span>;
  <span class="hljs-attr">admin</span> = {
    <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">fullName</span> = <span class="hljs-string">"Administrator"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/password_file"</span>;
  };
  <span class="hljs-attr">secretKeyBaseFile</span> = <span class="hljs-string">"/path/to/secret_key_base_file"</span>;
};
security.acme.<span class="hljs-attr">email</span> = <span class="hljs-string">"me@example.com"</span>;
security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
</code></pre><p>Provided a proper DNS setup, you’ll be able to connect to the
instance at <code class="literal">discourse.example.com</code> and log in
using the credentials provided in
<code class="literal">services.discourse.admin</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-tls" class="title" style="clear: both">Using a regular TLS certificate   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-tls" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To set up TLS using a regular certificate and key on file, use
the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.sslCertificate"><code class="option">services.discourse.sslCertificate</code></a>
and <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.sslCertificateKey"><code class="option">services.discourse.sslCertificateKey</code></a>
options:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">discourse</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostname</span> = <span class="hljs-string">"discourse.example.com"</span>;
  <span class="hljs-attr">sslCertificate</span> = <span class="hljs-string">"/path/to/ssl_certificate"</span>;
  <span class="hljs-attr">sslCertificateKey</span> = <span class="hljs-string">"/path/to/ssl_certificate_key"</span>;
  <span class="hljs-attr">admin</span> = {
    <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">fullName</span> = <span class="hljs-string">"Administrator"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/password_file"</span>;
  };
  <span class="hljs-attr">secretKeyBaseFile</span> = <span class="hljs-string">"/path/to/secret_key_base_file"</span>;
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-database" class="title" style="clear: both">Database access   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-database" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Discourse uses PostgreSQL to store most of its
data. A database will automatically be enabled and a database
and role created unless <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.host"><code class="option">services.discourse.database.host</code></a> is changed from
its default of <code class="literal">null</code> or <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.createLocally"><code class="option">services.discourse.database.createLocally</code></a> is set
to <code class="literal">false</code>.</p><p>External database access can also be configured by setting
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.host"><code class="option">services.discourse.database.host</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.username"><code class="option">services.discourse.database.username</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.passwordFile"><code class="option">services.discourse.database.passwordFile</code></a> as
appropriate. Note that you need to manually create a database
called <code class="literal">discourse</code> (or the name you chose in
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.database.name"><code class="option">services.discourse.database.name</code></a>) and
allow the configured database user full access to it.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-mail" class="title" style="clear: both">Email   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-mail" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In addition to the basic setup, you’ll want to configure an SMTP
server Discourse can use to send user
registration and password reset emails, among others. You can
also optionally let Discourse receive
email, which enables people to reply to threads and conversations
via email.</p><p>A basic setup which assumes you want to use your configured
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.hostname">hostname</a> as
email domain can be done like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">discourse</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostname</span> = <span class="hljs-string">"discourse.example.com"</span>;
  <span class="hljs-attr">sslCertificate</span> = <span class="hljs-string">"/path/to/ssl_certificate"</span>;
  <span class="hljs-attr">sslCertificateKey</span> = <span class="hljs-string">"/path/to/ssl_certificate_key"</span>;
  <span class="hljs-attr">admin</span> = {
    <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">fullName</span> = <span class="hljs-string">"Administrator"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/password_file"</span>;
  };
  mail.<span class="hljs-attr">outgoing</span> = {
    <span class="hljs-attr">serverAddress</span> = <span class="hljs-string">"smtp.emailprovider.com"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">587</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"user@emailprovider.com"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/smtp_password_file"</span>;
  };
  mail.incoming.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">secretKeyBaseFile</span> = <span class="hljs-string">"/path/to/secret_key_base_file"</span>;
};
</code></pre><p>This assumes you have set up an MX record for the address you’ve
set in <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.hostname">hostname</a> and
requires proper SPF, DKIM and DMARC configuration to be done for
the domain you’re sending from, in order for email to be reliably delivered.</p><p>If you want to use a different domain for your outgoing email
(for example <code class="literal">example.com</code> instead of
<code class="literal">discourse.example.com</code>) you should set
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.mail.notificationEmailAddress"><code class="option">services.discourse.mail.notificationEmailAddress</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.mail.contactEmailAddress"><code class="option">services.discourse.mail.contactEmailAddress</code></a> manually.</p><div class="note"><h3 class="title">Note</h3><p>Setup of TLS for incoming email is currently only configured
automatically when a regular TLS certificate is used, i.e. when
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.sslCertificate"><code class="option">services.discourse.sslCertificate</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.sslCertificateKey"><code class="option">services.discourse.sslCertificateKey</code></a> are
set.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-settings" class="title" style="clear: both">Additional settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Additional site settings and backend settings, for which no
explicit NixOS options are provided,
can be set in <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a> and
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.backendSettings"><code class="option">services.discourse.backendSettings</code></a> respectively.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-site-settings" class="title">Site settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-site-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>“Site settings” are the settings that can be
changed through the Discourse
UI. Their <span class="emphasis"><em>default</em></span> values can be set using
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a>.</p><p>Settings are expressed as a Nix attribute set which matches the
structure of the configuration in
<a class="link" href="https://github.com/discourse/discourse/blob/master/config/site_settings.yml" target="_top">config/site_settings.yml</a>.
To find a setting’s path, you only need to care about the first
two levels; i.e. its category (e.g. <code class="literal">login</code>)
and name (e.g. <code class="literal">invite_only</code>).</p><p>Settings containing secret data should be set to an attribute
set containing the attribute <code class="literal">_secret</code> - a
string pointing to a file containing the value the option
should be set to. See the example.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-backend-settings" class="title">Backend settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-backend-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Settings are expressed as a Nix attribute set which matches the
structure of the configuration in
<a class="link" href="https://github.com/discourse/discourse/blob/stable/config/discourse_defaults.conf" target="_top">config/discourse.conf</a>.
Empty parameters can be defined by setting them to
<code class="literal">null</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-discourse-settings-example" class="title">Example   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-settings-example" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The following example sets the title and description of the
Discourse instance and enables
GitHub login in the site settings,
and changes a few request limits in the backend settings:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">discourse</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostname</span> = <span class="hljs-string">"discourse.example.com"</span>;
  <span class="hljs-attr">sslCertificate</span> = <span class="hljs-string">"/path/to/ssl_certificate"</span>;
  <span class="hljs-attr">sslCertificateKey</span> = <span class="hljs-string">"/path/to/ssl_certificate_key"</span>;
  <span class="hljs-attr">admin</span> = {
    <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">fullName</span> = <span class="hljs-string">"Administrator"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/password_file"</span>;
  };
  mail.<span class="hljs-attr">outgoing</span> = {
    <span class="hljs-attr">serverAddress</span> = <span class="hljs-string">"smtp.emailprovider.com"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">587</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"user@emailprovider.com"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/smtp_password_file"</span>;
  };
  mail.incoming.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">siteSettings</span> = {
    <span class="hljs-attr">required</span> = {
      <span class="hljs-attr">title</span> = <span class="hljs-string">"My Cats"</span>;
      <span class="hljs-attr">site_description</span> = <span class="hljs-string">"Discuss My Cats (and be nice plz)"</span>;
    };
    <span class="hljs-attr">login</span> = {
      <span class="hljs-attr">enable_github_logins</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">github_client_id</span> = <span class="hljs-string">"a2f6dfe838cb3206ce20"</span>;
      github_client_secret.<span class="hljs-attr">_secret</span> = /run/keys/discourse_github_client_secret;
    };
  };
  <span class="hljs-attr">backendSettings</span> = {
    <span class="hljs-attr">max_reqs_per_ip_per_minute</span> = <span class="hljs-number">300</span>;
    <span class="hljs-attr">max_reqs_per_ip_per_10_seconds</span> = <span class="hljs-number">60</span>;
    <span class="hljs-attr">max_asset_reqs_per_ip_per_10_seconds</span> = <span class="hljs-number">250</span>;
    <span class="hljs-attr">max_reqs_per_ip_mode</span> = <span class="hljs-string">"warn+block"</span>;
  };
  <span class="hljs-attr">secretKeyBaseFile</span> = <span class="hljs-string">"/path/to/secret_key_base_file"</span>;
};
</code></pre><p>In the resulting site settings file, the
<code class="literal">login.github_client_secret</code> key will be set
to the contents of the
<code class="filename">/run/keys/discourse_github_client_secret</code>
file.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-discourse-plugins" class="title" style="clear: both">Plugins   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-plugins" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can install Discourse plugins
using the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.plugins"><code class="option">services.discourse.plugins</code></a>
option. Pre-packaged plugins are provided in
<code class="literal">&lt;your_discourse_package_here&gt;.plugins</code>. If
you want the full suite of plugins provided through
<code class="literal">nixpkgs</code>, you can also set the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.package"><code class="option">services.discourse.package</code></a> option to
<code class="literal">pkgs.discourseAllPlugins</code>.</p><p>Plugins can be built with the
<code class="literal">&lt;your_discourse_package_here&gt;.mkDiscoursePlugin</code>
function. Normally, it should suffice to provide a
<code class="literal">name</code> and <code class="literal">src</code> attribute. If
the plugin has Ruby dependencies, however, they need to be
packaged in accordance with the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#developing-with-ruby" target="_top">Developing with Ruby</a>
section of the Nixpkgs manual and the
appropriate gem options set in <code class="literal">bundlerEnvArgs</code>
(normally <code class="literal">gemdir</code> is sufficient). A plugin’s
Ruby dependencies are listed in its
<code class="filename">plugin.rb</code> file as function calls to
<code class="literal">gem</code>. To construct the corresponding
<code class="filename">Gemfile</code> manually, run <span class="command"><strong>bundle init</strong></span>, then add the <code class="literal">gem</code> lines to it
verbatim.</p><p>Much of the packaging can be done automatically by the
<code class="filename">nixpkgs/pkgs/servers/web-apps/discourse/update.py</code>
script - just add the plugin to the <code class="literal">plugins</code>
list in the <code class="literal">update_plugins</code> function and run
the script:</p><pre><code class="programlisting bash hljs language-bash" data-highlighted="yes">./update.py update-plugins
</code></pre><p>Some plugins provide <a class="link" href="https://nixos.org/manual/nixos/stable/#module-services-discourse-site-settings" title="Site settings">site settings</a>.
Their defaults can be configured using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.discourse.siteSettings"><code class="option">services.discourse.siteSettings</code></a>, just like
regular site settings. To find the names of these settings, look
in the <code class="literal">config/settings.yml</code> file of the plugin
repo.</p><p>For example, to add the <a class="link" href="https://github.com/discourse/discourse-spoiler-alert" target="_top">discourse-spoiler-alert</a>
and <a class="link" href="https://github.com/discourse/discourse-solved" target="_top">discourse-solved</a>
plugins, and disable <code class="literal">discourse-spoiler-alert</code>
by default:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">discourse</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostname</span> = <span class="hljs-string">"discourse.example.com"</span>;
  <span class="hljs-attr">sslCertificate</span> = <span class="hljs-string">"/path/to/ssl_certificate"</span>;
  <span class="hljs-attr">sslCertificateKey</span> = <span class="hljs-string">"/path/to/ssl_certificate_key"</span>;
  <span class="hljs-attr">admin</span> = {
    <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">fullName</span> = <span class="hljs-string">"Administrator"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/password_file"</span>;
  };
  mail.<span class="hljs-attr">outgoing</span> = {
    <span class="hljs-attr">serverAddress</span> = <span class="hljs-string">"smtp.emailprovider.com"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">587</span>;
    <span class="hljs-attr">username</span> = <span class="hljs-string">"user@emailprovider.com"</span>;
    <span class="hljs-attr">passwordFile</span> = <span class="hljs-string">"/path/to/smtp_password_file"</span>;
  };
  mail.incoming.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">plugins</span> = <span class="hljs-keyword">with</span> config.services.discourse.package.plugins; [
    discourse-spoiler-alert
    discourse-solved
  ];
  <span class="hljs-attr">siteSettings</span> = {
    <span class="hljs-attr">plugins</span> = {
      <span class="hljs-attr">spoiler_enabled</span> = <span class="hljs-literal">false</span>;
    };
  };
  <span class="hljs-attr">secretKeyBaseFile</span> = <span class="hljs-string">"/path/to/secret_key_base_file"</span>;
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-c2fmzq" class="title">c2FmZQ   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-c2fmzq" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>c2FmZQ is an application that can securely encrypt, store, and share files,
including but not limited to pictures and videos.</p><p>The service <code class="literal">c2fmzq-server</code> can be enabled by setting</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.c2fmzq-server.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>This will spin up an instance of the server which is API-compatible with
<a class="link" href="https://stingle.org/" target="_top">Stingle Photos</a> and an experimental Progressive Web App
(PWA) to interact with the storage via the browser.</p><p>In principle the server can be exposed directly on a public interface and there
are command line options to manage HTTPS certificates directly, but the module
is designed to be served behind a reverse proxy or only accessed via localhost.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{
  services.c2fmzq-server = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    bindIP = <span class="hljs-string">"127.0.0.1"</span>; <span class="hljs-comment"># default</span>
    port = 8080; <span class="hljs-comment"># default</span>
  };

  services.nginx = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    recommendedProxySettings = <span class="hljs-literal">true</span>;
    virtualHosts.<span class="hljs-string">"example.com"</span> = {
      enableACME = <span class="hljs-literal">true</span>;
      forceSSL = <span class="hljs-literal">true</span>;
      locations.<span class="hljs-string">"/"</span> = {
        proxyPass = <span class="hljs-string">"http://127.0.0.1:8080"</span>;
      };
    };
  };
}
</code></pre><p>For more information, see <a class="link" href="https://github.com/c2FmZQ/c2FmZQ/" target="_top">https://github.com/c2FmZQ/c2FmZQ/</a>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-akkoma" class="title">Akkoma   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-akkoma" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-service-configuration">Service configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-user-management">User management</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-proxy-configuration">Proxy configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-frontend-management">Frontend management</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-federation-policies">Federation policies</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-upload-filters">Upload filters</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-migration-pleroma">Migration from Pleroma</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-advanced-deployment">Advanced deployment options</a> </span></dt> </dl></div><p><a class="link" href="https://akkoma.dev/" target="_top">Akkoma</a> is a lightweight ActivityPub microblogging server forked from Pleroma.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-service-configuration" class="title" style="clear: both">Service configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-service-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The Elixir configuration file required by Akkoma is generated automatically from
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.akkoma.config" target="_top"><code class="option">services.akkoma.config</code></a>. Secrets must be
included from external files outside of the Nix store by setting the configuration option to
an attribute set containing the attribute <code class="option">_secret</code> – a string pointing to the file
containing the actual value of the option.</p><p>For the mandatory configuration settings these secrets will be generated automatically if the
referenced file does not exist during startup, unless disabled through
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.akkoma.initSecrets" target="_top"><code class="option">services.akkoma.initSecrets</code></a>.</p><p>The following configuration binds Akkoma to the Unix socket <code class="literal">/run/akkoma/socket</code>, expecting to
be run behind a HTTP proxy on <code class="literal">fediverse.example.com</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.akkoma.<span class="hljs-attr">config</span> = {
  <span class="hljs-string">":pleroma"</span> = {
    <span class="hljs-string">":instance"</span> = {
      <span class="hljs-attr">name</span> = <span class="hljs-string">"My Akkoma instance"</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">"More detailed description"</span>;
      <span class="hljs-attr">email</span> = <span class="hljs-string">"admin@example.com"</span>;
      <span class="hljs-attr">registration_open</span> = <span class="hljs-literal">false</span>;
    };

    <span class="hljs-string">"Pleroma.Web.Endpoint"</span> = {
      url.<span class="hljs-attr">host</span> = <span class="hljs-string">"fediverse.example.com"</span>;
    };
  };
};
</code></pre><p>Please refer to the <a class="link" href="https://docs.akkoma.dev/stable/configuration/cheatsheet/" target="_top">configuration cheat sheet</a>
for additional configuration options.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-user-management" class="title" style="clear: both">User management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-user-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>After the Akkoma service is running, the administration utility can be used to
<a class="link" href="https://docs.akkoma.dev/stable/administration/CLI_tasks/user/" target="_top">manage users</a>. In particular an
administrative user can be created with</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pleroma_ctl user new &lt;nickname&gt; &lt;email&gt; --admin --moderator --password &lt;password&gt;</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-proxy-configuration" class="title" style="clear: both">Proxy configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-proxy-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Although it is possible to expose Akkoma directly, it is common practice to operate it behind an
HTTP reverse proxy such as nginx.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
};

services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-attr">clientMaxBodySize</span> = <span class="hljs-string">"16m"</span>;
  <span class="hljs-attr">recommendedTlsSettings</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedOptimisation</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedGzipSettings</span> = <span class="hljs-literal">true</span>;
};
</code></pre><p>Please refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/#module-security-acme" title="SSL/TLS Certificates with ACME"><em>SSL/TLS Certificates with ACME</em></a> for details on how to provision an SSL/TLS certificate.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-media-proxy" class="title">Media proxy   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-media-proxy" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Without the media proxy function, Akkoma does not store any remote media like pictures or video
locally, and clients have to fetch them directly from the source server.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># Enable nginx slice module distributed with Tengine</span>
services.nginx.<span class="hljs-attr">package</span> = pkgs.tengine;

<span class="hljs-comment"># Enable media proxy</span>
services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">":media_proxy"</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>;
  proxy_opts.<span class="hljs-attr">redirect_on_failure</span> = <span class="hljs-literal">true</span>;
};

<span class="hljs-comment"># Adjust the persistent cache size as needed:</span>
<span class="hljs-comment">#  Assuming an average object size of 128 KiB, around 1 MiB</span>
<span class="hljs-comment">#  of memory is required for the key zone per GiB of cache.</span>
<span class="hljs-comment"># Ensure that the cache directory exists and is writable by nginx.</span>
services.nginx.<span class="hljs-attr">commonHttpConfig</span> = <span class="hljs-string">''
  proxy_cache_path /var/cache/nginx/cache/akkoma-media-cache
    levels= keys_zone=akkoma_media_cache:16m max_size=16g
    inactive=1y use_temp_path=off;
''</span>;

services.akkoma.<span class="hljs-attr">nginx</span> = {
  locations.<span class="hljs-string">"/proxy"</span> = {
    <span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://unix:/run/akkoma/socket"</span>;

    <span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
      proxy_cache akkoma_media_cache;

      # Cache objects in slices of 1 MiB
      slice 1m;
      proxy_cache_key $host$uri$is_args$args$slice_range;
      proxy_set_header Range $slice_range;

      # Decouple proxy and upstream responses
      proxy_buffering on;
      proxy_cache_lock on;
      proxy_ignore_client_abort on;

      # Default cache times for various responses
      proxy_cache_valid 200 1y;
      proxy_cache_valid 206 301 304 1h;

      # Allow serving of stale items
      proxy_cache_use_stale error timeout invalid_header updating;
    ''</span>;
  };
};
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="modules-services-akkoma-prefetch-remote-media" class="title">Prefetch remote media   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-prefetch-remote-media" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>The following example enables the <code class="literal">MediaProxyWarmingPolicy</code> MRF policy which automatically
fetches all media associated with a post through the media proxy, as soon as the post is
received by the instance.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">":mrf"</span>.<span class="hljs-attr">policies</span> =
  <span class="hljs-built_in">map</span> (pkgs.formats.elixirConf { }).lib.mkRaw [
    <span class="hljs-string">"Pleroma.Web.ActivityPub.MRF.MediaProxyWarmingPolicy"</span>
];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="modules-services-akkoma-media-previews" class="title">Media previews   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-media-previews" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Akkoma can generate previews for media.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">":media_preview_proxy"</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">thumbnail_max_width</span> = <span class="hljs-number">1920</span>;
  <span class="hljs-attr">thumbnail_max_height</span> = <span class="hljs-number">1080</span>;
};
</code></pre>
</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-frontend-management" class="title" style="clear: both">Frontend management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-frontend-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Akkoma will be deployed with the <code class="literal">akkoma-fe</code> and <code class="literal">admin-fe</code> frontends by default. These can be
modified by setting
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.akkoma.frontends" target="_top"><code class="option">services.akkoma.frontends</code></a>.</p><p>The following example overrides the primary frontend’s default configuration using a custom
derivation.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.frontends.primary.<span class="hljs-attr">package</span> = pkgs.runCommand <span class="hljs-string">"akkoma-fe"</span> {
  <span class="hljs-attr">config</span> = <span class="hljs-built_in">builtins</span>.toJSON {
    <span class="hljs-attr">expertLevel</span> = <span class="hljs-number">1</span>;
    <span class="hljs-attr">collapseMessageWithSubject</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-attr">stopGifs</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-attr">replyVisibility</span> = <span class="hljs-string">"following"</span>;
    <span class="hljs-attr">webPushHideIfCW</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hideScopeNotice</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">renderMisskeyMarkdown</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-attr">hideSiteFavicon</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">postContentType</span> = <span class="hljs-string">"text/markdown"</span>;
    <span class="hljs-attr">showNavShortcuts</span> = <span class="hljs-literal">false</span>;
  };
  <span class="hljs-attr">nativeBuildInputs</span> = <span class="hljs-keyword">with</span> pkgs; [ jq xorg.lndir ];
  <span class="hljs-attr">passAsFile</span> = [ <span class="hljs-string">"config"</span> ];
} <span class="hljs-string">''
  mkdir $out
  lndir <span class="hljs-subst">${pkgs.akkoma-frontends.akkoma-fe}</span> $out

  rm $out/static/config.json
  jq -s add <span class="hljs-subst">${pkgs.akkoma-frontends.akkoma-fe}</span>/static/config.json <span class="hljs-subst">${config}</span> \
    &gt;$out/static/config.json
''</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-federation-policies" class="title" style="clear: both">Federation policies   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-federation-policies" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Akkoma comes with a number of modules to police federation with other ActivityPub instances.
The most valuable for typical users is the
<a class="link" href="https://docs.akkoma.dev/stable/configuration/cheatsheet/#mrf_simple" target="_top"><code class="literal">:mrf_simple</code></a> module
which allows limiting federation based on instance hostnames.</p><p>This configuration snippet provides an example on how these can be used. Choosing an adequate
federation policy is not trivial and entails finding a balance between connectivity to the rest
of the fediverse and providing a pleasant experience to the users of an instance.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.config.<span class="hljs-string">":pleroma"</span> = <span class="hljs-keyword">with</span> (pkgs.formats.elixirConf { }).lib; {
  <span class="hljs-string">":mrf"</span>.<span class="hljs-attr">policies</span> = <span class="hljs-built_in">map</span> mkRaw [
    <span class="hljs-string">"Pleroma.Web.ActivityPub.MRF.SimplePolicy"</span>
  ];

  <span class="hljs-string">":mrf_simple"</span> = {
    <span class="hljs-comment"># Tag all media as sensitive</span>
    <span class="hljs-attr">media_nsfw</span> = mkMap {
      <span class="hljs-string">"nsfw.weird.kinky"</span> = <span class="hljs-string">"Untagged NSFW content"</span>;
    };

    <span class="hljs-comment"># Reject all activities except deletes</span>
    <span class="hljs-attr">reject</span> = mkMap {
      <span class="hljs-string">"kiwifarms.cc"</span> = <span class="hljs-string">"Persistent harassment of users, no moderation"</span>;
    };

    <span class="hljs-comment"># Force posts to be visible by followers only</span>
    <span class="hljs-attr">followers_only</span> = mkMap {
      <span class="hljs-string">"beta.birdsite.live"</span> = <span class="hljs-string">"Avoid polluting timelines with Twitter posts"</span>;
    };
  };
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-upload-filters" class="title" style="clear: both">Upload filters   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-upload-filters" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This example strips GPS and location metadata from uploads, deduplicates them and anonymises the
the file name.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">"Pleroma.Upload"</span>.<span class="hljs-attr">filters</span> =
  <span class="hljs-built_in">map</span> (pkgs.formats.elixirConf { }).lib.mkRaw [
    <span class="hljs-string">"Pleroma.Upload.Filter.Exiftool"</span>
    <span class="hljs-string">"Pleroma.Upload.Filter.Dedupe"</span>
    <span class="hljs-string">"Pleroma.Upload.Filter.AnonymizeFilename"</span>
  ];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-migration-pleroma" class="title" style="clear: both">Migration from Pleroma   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-migration-pleroma" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Pleroma instances can be migrated to Akkoma either by copying the database and upload data or by
pointing Akkoma to the existing data. The necessary database migrations are run automatically
during startup of the service.</p><p>The configuration has to be copy‐edited manually.</p><p>Depending on the size of the database, the initial migration may take a long time and exceed the
startup timeout of the system manager. To work around this issue one may adjust the startup timeout
<code class="option">systemd.services.akkoma.serviceConfig.TimeoutStartSec</code> or simply run the migrations
manually:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">pleroma_ctl migrate
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-migration-pleroma-copy" class="title">Copying data   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-migration-pleroma-copy" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Copying the Pleroma data instead of re‐using it in place may permit easier reversion to Pleroma,
but allows the two data sets to diverge.</p><p>First disable Pleroma and then copy its database and upload data:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">Create a copy of the database</span>
nix-shell -p postgresql --run 'createdb -T pleroma akkoma'
<span class="hljs-meta prompt_">
# </span><span class="language-bash">Copy upload data</span>
mkdir /var/lib/akkoma
cp -R --reflink=auto /var/lib/pleroma/uploads /var/lib/akkoma/
</code></pre><p>After the data has been copied, enable the Akkoma service and verify that the migration has been
successful. If no longer required, the original data may then be deleted:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">Delete original database</span>
nix-shell -p postgresql --run 'dropdb pleroma'
<span class="hljs-meta prompt_">
# </span><span class="language-bash">Delete original Pleroma state</span>
rm -r /var/lib/pleroma
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-migration-pleroma-reuse" class="title">Re‐using data   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-migration-pleroma-reuse" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>To re‐use the Pleroma data in place, disable Pleroma and enable Akkoma, pointing it to the
Pleroma database and upload directory.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># Adjust these settings according to the database name and upload directory path used by Pleroma</span>
services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">"Pleroma.Repo"</span>.<span class="hljs-attr">database</span> = <span class="hljs-string">"pleroma"</span>;
services.akkoma.config.<span class="hljs-string">":pleroma"</span>.<span class="hljs-string">":instance"</span>.<span class="hljs-attr">upload_dir</span> = <span class="hljs-string">"/var/lib/pleroma/uploads"</span>;
</code></pre><p>Please keep in mind that after the Akkoma service has been started, any migrations applied by
Akkoma have to be rolled back before the database can be used again with Pleroma. This can be
achieved through <code class="literal">pleroma_ctl ecto.rollback</code>. Refer to the
<a class="link" href="https://hexdocs.pm/ecto_sql/Mix.Tasks.Ecto.Rollback.html" target="_top">Ecto SQL documentation</a> for
details.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-akkoma-advanced-deployment" class="title" style="clear: both">Advanced deployment options   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-advanced-deployment" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-confinement" class="title">Confinement   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-confinement" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The Akkoma systemd service may be confined to a chroot with</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.systemd.akkoma.confinement.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>Confinement of services is not generally supported in NixOS and therefore disabled by default.
Depending on the Akkoma configuration, the default confinement settings may be insufficient and
lead to subtle errors at run time, requiring adjustment:</p><p>Use
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services._name_.confinement.packages" target="_top"><code class="option">services.systemd.akkoma.confinement.packages</code></a>
to make packages available in the chroot.</p><p><code class="option">services.systemd.akkoma.serviceConfig.BindPaths</code> and
<code class="option">services.systemd.akkoma.serviceConfig.BindReadOnlyPaths</code> permit access to outside paths
through bind mounts. Refer to
<a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#BindPaths=" target="_top"><code class="literal">BindPaths=</code></a>
of <a class="link" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html" target="_top"><span class="citerefentry"><span class="refentrytitle">systemd.exec</span>(5)</span></a> for details.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="modules-services-akkoma-distributed-deployment" class="title">Distributed deployment   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-akkoma-distributed-deployment" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Being an Elixir application, Akkoma can be deployed in a distributed fashion.</p><p>This requires setting
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.akkoma.dist.address" target="_top"><code class="option">services.akkoma.dist.address</code></a> and
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.akkoma.dist.cookie" target="_top"><code class="option">services.akkoma.dist.cookie</code></a>. The
specifics depend strongly on the deployment environment. For more information please check the
relevant <a class="link" href="https://www.erlang.org/doc/reference_manual/distributed.html" target="_top">Erlang documentation</a>.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch" class="title">Meilisearch   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-usage">Usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-defaults">Defaults</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-missing">Missing</a> </span></dt> </dl></div><p>Meilisearch is a lightweight, fast and powerful search engine. Think elastic search with a much smaller footprint.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>the minimum to start meilisearch is</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.meilisearch.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>this will start the http server included with meilisearch on port 7700.</p><p>test with <code class="literal">curl -X GET 'http://localhost:7700/health'</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-usage" class="title" style="clear: both">Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>you first need to add documents to an index before you can search for documents.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-meilisearch-quickstart-add" class="title">Add a documents to the <code class="literal">movies</code> index   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-quickstart-add" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><code class="literal">curl -X POST 'http://127.0.0.1:7700/indexes/movies/documents' --data '[{"id": "123", "title": "Superman"}, {"id": 234, "title": "Batman"}]'</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-meilisearch-quickstart-search" class="title">Search documents in the <code class="literal">movies</code> index   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-quickstart-search" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><code class="literal">curl 'http://127.0.0.1:7700/indexes/movies/search' --data '{ "q": "botman" }'</code> (note the typo is intentional and there to demonstrate the typo tolerant capabilities)</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-defaults" class="title" style="clear: both">Defaults   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-defaults" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The default nixos package doesn’t come with the <a class="link" href="https://docs.meilisearch.com/learn/getting_started/quick_start.html#search" target="_top">dashboard</a>, since the dashboard features makes some assets downloads at compile time.</p></li><li class="listitem"><p>Anonymized Analytics sent to meilisearch are disabled by default.</p></li><li class="listitem"><p>Default deployment is development mode. It doesn’t require a secret master key. All routes are not protected and accessible.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-meilisearch-missing" class="title" style="clear: both">Missing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-meilisearch-missing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the snapshot feature is not yet configurable from the module, it’s just a matter of adding the relevant environment variables.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-yggdrasil" class="title">Yggdrasil   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration">Configuration</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/networking/yggdrasil/default.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://yggdrasil-network.github.io/" target="_top">https://yggdrasil-network.github.io/</a></p><p>Yggdrasil is an early-stage implementation of a fully end-to-end encrypted,
self-arranging IPv6 network.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-networking-yggdrasil-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-simple" class="title">Simple ephemeral node   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-simple" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>An annotated example of a simple configuration:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">yggdrasil</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">persistentKeys</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-comment"># The NixOS module will generate new keys and a new IPv6 address each time</span>
      <span class="hljs-comment"># it is started if persistentKeys is not enabled.</span>

    <span class="hljs-attr">settings</span> = {
      <span class="hljs-attr">Peers</span> = [
        <span class="hljs-comment"># Yggdrasil will automatically connect and "peer" with other nodes it</span>
        <span class="hljs-comment"># discovers via link-local multicast announcements. Unless this is the</span>
        <span class="hljs-comment"># case (it probably isn't) a node needs peers within the existing</span>
        <span class="hljs-comment"># network that it can tunnel to.</span>
        <span class="hljs-string">"tcp://1.2.3.4:1024"</span>
        <span class="hljs-string">"tcp://1.2.3.5:1024"</span>
        <span class="hljs-comment"># Public peers can be found at</span>
        <span class="hljs-comment"># https://github.com/yggdrasil-network/public-peers</span>
      ];
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-prefix" class="title">Persistent node with prefix   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-prefix" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>A node with a fixed address that announces a prefix:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">address</span> = <span class="hljs-string">"210:5217:69c0:9afc:1b95:b9f:8718:c3d2"</span>;
  <span class="hljs-attr">prefix</span> = <span class="hljs-string">"310:5217:69c0:9afc"</span>;
  <span class="hljs-comment"># taken from the output of "yggdrasilctl getself".</span>
<span class="hljs-keyword">in</span> {

  services.<span class="hljs-attr">yggdrasil</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">persistentKeys</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment"># Maintain a fixed public key and IPv6 address.</span>
    <span class="hljs-attr">settings</span> = {
      <span class="hljs-attr">Peers</span> = [ <span class="hljs-string">"tcp://1.2.3.4:1024"</span> <span class="hljs-string">"tcp://1.2.3.5:1024"</span> ];
      <span class="hljs-attr">NodeInfo</span> = {
        <span class="hljs-comment"># This information is visible to the network.</span>
        <span class="hljs-attr">name</span> = config.networking.hostName;
        <span class="hljs-attr">location</span> = <span class="hljs-string">"The North Pole"</span>;
      };
    };
  };

  boot.kernel.sysctl.<span class="hljs-string">"net.ipv6.conf.all.forwarding"</span> = <span class="hljs-number">1</span>;
    <span class="hljs-comment"># Forward traffic under the prefix.</span>

  networking.interfaces.${eth0}.ipv6.<span class="hljs-attr">addresses</span> = [{
    <span class="hljs-comment"># Set a 300::/8 address on the local physical device.</span>
    <span class="hljs-attr">address</span> = prefix + <span class="hljs-string">"::1"</span>;
    <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">64</span>;
  }];

  services.<span class="hljs-attr">radvd</span> = {
    <span class="hljs-comment"># Announce the 300::/8 prefix to eth0.</span>
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">config</span> = <span class="hljs-string">''
      interface eth0
      {
        AdvSendAdvert on;
        prefix <span class="hljs-subst">${prefix}</span>::/64 {
          AdvOnLink on;
          AdvAutonomous on;
        };
        route 200::/8 {};
      };
    ''</span>;
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-networking-yggdrasil-configuration-container" class="title">Yggdrasil attached Container   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-networking-yggdrasil-configuration-container" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>A NixOS container attached to the Yggdrasil network via a node running on the
host:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">yggPrefix64</span> = <span class="hljs-string">"310:5217:69c0:9afc"</span>;
    <span class="hljs-comment"># Again, taken from the output of "yggdrasilctl getself".</span>
<span class="hljs-keyword">in</span>
{
  boot.kernel.sysctl.<span class="hljs-string">"net.ipv6.conf.all.forwarding"</span> = <span class="hljs-number">1</span>;
  <span class="hljs-comment"># Enable IPv6 forwarding.</span>

  <span class="hljs-attr">networking</span> = {
    bridges.br0.<span class="hljs-attr">interfaces</span> = [ ];
    <span class="hljs-comment"># A bridge only to containers…</span>

    interfaces.<span class="hljs-attr">br0</span> = {
      <span class="hljs-comment"># … configured with a prefix address.</span>
      ipv6.<span class="hljs-attr">addresses</span> = [{
        <span class="hljs-attr">address</span> = <span class="hljs-string">"<span class="hljs-subst">${yggPrefix64}</span>::1"</span>;
        <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">64</span>;
      }];
    };
  };

  containers.<span class="hljs-attr">foo</span> = {
    <span class="hljs-attr">autoStart</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">privateNetwork</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hostBridge</span> = <span class="hljs-string">"br0"</span>;
    <span class="hljs-comment"># Attach the container to the bridge only.</span>
    <span class="hljs-attr">config</span> = { config, pkgs, ... }: {
      networking.interfaces.eth0.<span class="hljs-attr">ipv6</span> = {
        <span class="hljs-attr">addresses</span> = [{
          <span class="hljs-comment"># Configure a prefix address.</span>
          <span class="hljs-attr">address</span> = <span class="hljs-string">"<span class="hljs-subst">${yggPrefix64}</span>::2"</span>;
          <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">64</span>;
        }];
        <span class="hljs-attr">routes</span> = [{
          <span class="hljs-comment"># Configure the prefix route.</span>
          <span class="hljs-attr">address</span> = <span class="hljs-string">"200::"</span>;
          <span class="hljs-attr">prefixLength</span> = <span class="hljs-number">7</span>;
          <span class="hljs-attr">via</span> = <span class="hljs-string">"<span class="hljs-subst">${yggPrefix64}</span>::1"</span>;
        }];
      };

      services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> ];
    };
  };

}
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody" class="title">Prosody   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prosody" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prosody-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prosody-letsencrypt">Let’s Encrypt Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://prosody.im/" target="_top">Prosody</a> is an open-source, modern XMPP server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prosody-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A common struggle for most XMPP newcomers is to find the right set
of XMPP Extensions (XEPs) to setup. Forget to activate a few of
those and your XMPP experience might turn into a nightmare!</p><p>The XMPP community tackles this problem by creating a meta-XEP
listing a decent set of XEPs you should implement. This meta-XEP
is issued every year, the 2020 edition being
<a class="link" href="https://xmpp.org/extensions/xep-0423.html" target="_top">XEP-0423</a>.</p><p>The NixOS Prosody module will implement most of these recommendend XEPs out of
the box. That being said, two components still require some
manual configuration: the
<a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top">Multi User Chat (MUC)</a>
and the <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top">HTTP File Upload</a> ones.
You’ll need to create a DNS subdomain for each of those. The current convention is to name your
MUC endpoint <code class="literal">conference.example.org</code> and your HTTP upload domain <code class="literal">upload.example.org</code>.</p><p>A good configuration to start with, including a
<a class="link" href="https://xmpp.org/extensions/xep-0045.html" target="_top">Multi User Chat (MUC)</a>
endpoint as well as a <a class="link" href="https://xmpp.org/extensions/xep-0363.html" target="_top">HTTP File Upload</a>
endpoint will look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">prosody</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">admins</span> = [ <span class="hljs-string">"root@example.org"</span> ];
  ssl.<span class="hljs-attr">cert</span> = <span class="hljs-string">"/var/lib/acme/example.org/fullchain.pem"</span>;
  ssl.<span class="hljs-attr">key</span> = <span class="hljs-string">"/var/lib/acme/example.org/key.pem"</span>;
  virtualHosts.<span class="hljs-string">"example.org"</span> = {
      <span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">domain</span> = <span class="hljs-string">"example.org"</span>;
      ssl.<span class="hljs-attr">cert</span> = <span class="hljs-string">"/var/lib/acme/example.org/fullchain.pem"</span>;
      ssl.<span class="hljs-attr">key</span> = <span class="hljs-string">"/var/lib/acme/example.org/key.pem"</span>;
  };
  <span class="hljs-attr">muc</span> = [ {
      <span class="hljs-attr">domain</span> = <span class="hljs-string">"conference.example.org"</span>;
  } ];
  <span class="hljs-attr">uploadHttp</span> = {
      <span class="hljs-attr">domain</span> = <span class="hljs-string">"upload.example.org"</span>;
  };
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prosody-letsencrypt" class="title" style="clear: both">Let’s Encrypt Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prosody-letsencrypt" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>As you can see in the code snippet from the
<a class="link" href="https://nixos.org/manual/nixos/stable/#module-services-prosody-basic-usage" title="Basic usage">previous section</a>,
you’ll need a single TLS certificate covering your main endpoint,
the MUC one as well as the HTTP Upload one. We can generate such a
certificate by leveraging the ACME
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.certs._name_.extraDomainNames">extraDomainNames</a> module option.</p><p>Provided the setup detailed in the previous section, you’ll need the following acme configuration to generate
a TLS certificate for the three endponits:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">security.<span class="hljs-attr">acme</span> = {
  <span class="hljs-attr">email</span> = <span class="hljs-string">"root@example.org"</span>;
  <span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">certs</span> = {
    <span class="hljs-string">"example.org"</span> = {
      <span class="hljs-attr">webroot</span> = <span class="hljs-string">"/var/www/example.org"</span>;
      <span class="hljs-attr">email</span> = <span class="hljs-string">"root@example.org"</span>;
      <span class="hljs-attr">extraDomainNames</span> = [ <span class="hljs-string">"conference.example.org"</span> <span class="hljs-string">"upload.example.org"</span> ];
    };
  };
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma" class="title">Pleroma   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-generate-config">Generating the Pleroma config</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-initialize-db">Initializing the database</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-enable">Enabling the Pleroma service locally</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-admin-user">Creating the admin user</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-nginx">Configuring Nginx</a> </span></dt> </dl></div><p><a class="link" href="https://pleroma.social/" target="_top">Pleroma</a> is a lightweight activity pub server.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-generate-config" class="title" style="clear: both">Generating the Pleroma config   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-generate-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The <code class="literal">pleroma_ctl</code> CLI utility will prompt you some questions and it will generate an initial config file. This is an example of usage</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> tmp-pleroma</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> tmp-pleroma</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell -p pleroma-otp</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">pleroma_ctl instance gen --output config.exs --output-psql setup.psql</span>
</code></pre><p>The <code class="literal">config.exs</code> file can be further customized following the instructions on the <a class="link" href="https://docs-develop.pleroma.social/backend/configuration/cheatsheet/" target="_top">upstream documentation</a>. Many refinements can be applied also after the service is running.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-initialize-db" class="title" style="clear: both">Initializing the database   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-initialize-db" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>First, the Postgresql service must be enabled in the NixOS configuration</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">services.postgresql = {
  <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
  package = pkgs.postgresql_13;
};
</code></pre><p>and activated with the usual</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-rebuild switch</span>
</code></pre><p>Then you can create and seed the database, using the <code class="literal">setup.psql</code> file that you generated in the previous section, by running</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -u postgres psql -f setup.psql</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-enable" class="title" style="clear: both">Enabling the Pleroma service locally   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-enable" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In this section we will enable the Pleroma service only locally, so its configurations can be improved incrementally.</p><p>This is an example of configuration, where <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.pleroma.configs"><code class="option">services.pleroma.configs</code></a> option contains the content of the file <code class="literal">config.exs</code>, generated <a class="link" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-generate-config" title="Generating the Pleroma config">in the first section</a>, but with the secrets (database password, endpoint secret key, salts, etc.) removed. Removing secrets is important, because otherwise they will be stored publicly in the Nix store.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">services.pleroma = {
  <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
  secretConfigFile = <span class="hljs-string">"/var/lib/pleroma/secrets.exs"</span>;
  configs = [
    <span class="hljs-string">''</span>
    import Config

    config :pleroma, Pleroma.Web.Endpoint,
      url: [host: <span class="hljs-string">"pleroma.example.net"</span>, scheme: <span class="hljs-string">"https"</span>, port: 443],
      http: [ip: {127, 0, 0, 1}, port: 4000]

    config :pleroma, :instance,
      name: <span class="hljs-string">"Test"</span>,
      email: <span class="hljs-string">"admin@example.net"</span>,
      notify_email: <span class="hljs-string">"admin@example.net"</span>,
      <span class="hljs-built_in">limit</span>: 5000,
      registrations_open: <span class="hljs-literal">true</span>

    config :pleroma, :media_proxy,
      enabled: <span class="hljs-literal">false</span>,
      redirect_on_failure: <span class="hljs-literal">true</span>

    config :pleroma, Pleroma.Repo,
      adapter: Ecto.Adapters.Postgres,
      username: <span class="hljs-string">"pleroma"</span>,
      database: <span class="hljs-string">"pleroma"</span>,
      hostname: <span class="hljs-string">"localhost"</span>

    <span class="hljs-comment"># Configure web push notifications</span>
    config :web_push_encryption, :vapid_details,
      subject: <span class="hljs-string">"mailto:admin@example.net"</span>

    <span class="hljs-comment"># ... TO CONTINUE ...</span>
    <span class="hljs-string">''</span>
  ];
};
</code></pre><p>Secrets must be moved into a file pointed by <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.pleroma.secretConfigFile"><code class="option">services.pleroma.secretConfigFile</code></a>, in our case <code class="literal">/var/lib/pleroma/secrets.exs</code>. This file can be created copying the previously generated <code class="literal">config.exs</code> file and then removing all the settings, except the secrets. This is an example</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># Pleroma instance passwords</span>

<span class="hljs-built_in">import</span> Config

config :pleroma, Pleroma.Web.Endpoint,
   secret_key_base: <span class="hljs-string">"&lt;the secret generated by pleroma_ctl&gt;"</span>,
   signing_salt: <span class="hljs-string">"&lt;the secret generated by pleroma_ctl&gt;"</span>

config :pleroma, Pleroma.Repo,
  password: <span class="hljs-string">"&lt;the secret generated by pleroma_ctl&gt;"</span>

<span class="hljs-comment"># Configure web push notifications</span>
config :web_push_encryption, :vapid_details,
  public_key: <span class="hljs-string">"&lt;the secret generated by pleroma_ctl&gt;"</span>,
  private_key: <span class="hljs-string">"&lt;the secret generated by pleroma_ctl&gt;"</span>

<span class="hljs-comment"># ... TO CONTINUE ...</span>
</code></pre><p>Note that the lines of the same configuration group are comma separated (i.e. all the lines end with a comma, except the last one), so when the lines with passwords are added or removed, commas must be adjusted accordingly.</p><p>The service can be enabled with the usual</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-rebuild switch</span>
</code></pre><p>The service is accessible only from the local <code class="literal">127.0.0.1:4000</code> port. It can be tested using a port forwarding like this</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh -L 4000:localhost:4000 myuser@example.net</span>
</code></pre><p>and then accessing <a class="link" href="http://localhost:4000/" target="_top">http://localhost:4000</a> from a web browser.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-admin-user" class="title" style="clear: both">Creating the admin user   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-admin-user" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>After Pleroma service is running, all <a class="link" href="https://docs-develop.pleroma.social/" target="_top">Pleroma administration utilities</a> can be used. In particular an admin user can be created with</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">pleroma_ctl user new &lt;nickname&gt; &lt;email&gt;  --admin --moderator --password &lt;password&gt;</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-pleroma-nginx" class="title" style="clear: both">Configuring Nginx   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-pleroma-nginx" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In this configuration, Pleroma is listening only on the local port 4000. Nginx can be configured as a Reverse Proxy, for forwarding requests from public ports to the Pleroma service. This is an example of configuration, using
<a class="link" href="https://letsencrypt.org/" target="_top">Let’s Encrypt</a> for the TLS certificates</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">security.acme = {
  email = <span class="hljs-string">"root@example.net"</span>;
  acceptTerms = <span class="hljs-literal">true</span>;
};

services.nginx = {
  <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
  addSSL = <span class="hljs-literal">true</span>;

  recommendedTlsSettings = <span class="hljs-literal">true</span>;
  recommendedOptimisation = <span class="hljs-literal">true</span>;
  recommendedGzipSettings = <span class="hljs-literal">true</span>;

  recommendedProxySettings = <span class="hljs-literal">false</span>;
  <span class="hljs-comment"># NOTE: if enabled, the NixOS proxy optimizations will override the Pleroma</span>
  <span class="hljs-comment"># specific settings, and they will enter in conflict.</span>

  virtualHosts = {
    <span class="hljs-string">"pleroma.example.net"</span> = {
      http2 = <span class="hljs-literal">true</span>;
      enableACME = <span class="hljs-literal">true</span>;
      forceSSL = <span class="hljs-literal">true</span>;

      locations.<span class="hljs-string">"/"</span> = {
        proxyPass = <span class="hljs-string">"http://127.0.0.1:4000"</span>;

        extraConfig = <span class="hljs-string">''</span>
          etag on;
          gzip on;

          add_header <span class="hljs-string">'Access-Control-Allow-Origin'</span> <span class="hljs-string">'*'</span> always;
          add_header <span class="hljs-string">'Access-Control-Allow-Methods'</span> <span class="hljs-string">'POST, PUT, DELETE, GET, PATCH, OPTIONS'</span> always;
          add_header <span class="hljs-string">'Access-Control-Allow-Headers'</span> <span class="hljs-string">'Authorization, Content-Type, Idempotency-Key'</span> always;
          add_header <span class="hljs-string">'Access-Control-Expose-Headers'</span> <span class="hljs-string">'Link, X-RateLimit-Reset, X-RateLimit-Limit, X-RateLimit-Remaining, X-Request-Id'</span> always;
          <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_method</span> = OPTIONS) {
            <span class="hljs-built_in">return</span> 204;
          }
          add_header X-XSS-Protection <span class="hljs-string">"1; mode=block"</span>;
          add_header X-Permitted-Cross-Domain-Policies none;
          add_header X-Frame-Options DENY;
          add_header X-Content-Type-Options nosniff;
          add_header Referrer-Policy same-origin;
          add_header X-Download-Options noopen;
          proxy_http_version 1.1;
          proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;
          proxy_set_header Connection <span class="hljs-string">"upgrade"</span>;
          proxy_set_header Host <span class="hljs-variable">$host</span>;

          client_max_body_size 16m;
          <span class="hljs-comment"># NOTE: increase if users need to upload very big files</span>
        <span class="hljs-string">''</span>;
      };
    };
  };
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto" class="title">Mosquitto   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-config">Configuration</a> </span></dt> </dl></div><p>Mosquitto is a MQTT broker often used for IoT or home automation data transport.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration for Mosquitto is</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">mosquitto</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">listeners</span> = [ {
    <span class="hljs-attr">acl</span> = [ <span class="hljs-string">"pattern readwrite #"</span> ];
    <span class="hljs-attr">omitPasswordAuth</span> = <span class="hljs-literal">true</span>;
    settings.<span class="hljs-attr">allow_anonymous</span> = <span class="hljs-literal">true</span>;
  } ];
};
</code></pre><p>This will start a broker on port 1883, listening on all interfaces of the machine, allowing
read/write access to all topics to any user without password requirements.</p><p>User authentication can be configured with the <code class="literal">users</code> key of listeners. A config that gives
full read access to a user <code class="literal">monitor</code> and restricted write access to a user <code class="literal">service</code> could look
like</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">mosquitto</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">listeners</span> = [ {
    <span class="hljs-attr">users</span> = {
      <span class="hljs-attr">monitor</span> = {
        <span class="hljs-attr">acl</span> = [ <span class="hljs-string">"read #"</span> ];
        <span class="hljs-attr">password</span> = <span class="hljs-string">"monitor"</span>;
      };
      <span class="hljs-attr">service</span> = {
        <span class="hljs-attr">acl</span> = [ <span class="hljs-string">"write service/#"</span> ];
        <span class="hljs-attr">password</span> = <span class="hljs-string">"service"</span>;
      };
    };
  } ];
};
</code></pre><p>TLS authentication is configured by setting TLS-related options of the listener:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">mosquitto</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">listeners</span> = [ {
    <span class="hljs-attr">port</span> = <span class="hljs-number">8883</span>; <span class="hljs-comment"># port change is not required, but helpful to avoid mistakes</span>
    <span class="hljs-comment"># ...</span>
    <span class="hljs-attr">settings</span> = {
      <span class="hljs-attr">cafile</span> = <span class="hljs-string">"/path/to/mqtt.ca.pem"</span>;
      <span class="hljs-attr">certfile</span> = <span class="hljs-string">"/path/to/mqtt.pem"</span>;
      <span class="hljs-attr">keyfile</span> = <span class="hljs-string">"/path/to/mqtt.key"</span>;
    };
  } ];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mosquitto-config" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The Mosquitto configuration has four distinct types of settings:
the global settings of the daemon, listeners, plugins, and bridges.
Bridges and listeners are part of the global configuration, plugins are part of listeners.
Users of the broker are configured as parts of listeners rather than globally, allowing
configurations in which a given user is only allowed to log in to the broker using specific
listeners (eg to configure an admin user with full access to all topics, but restricted to
localhost).</p><p>Almost all options of Mosquitto are available for configuration at their appropriate levels, some
as NixOS options written in camel case, the remainders under <code class="literal">settings</code> with their exact names in
the Mosquitto config file. The exceptions are <code class="literal">acl_file</code> (which is always set according to the
<code class="literal">acl</code> attributes of a listener and its users) and <code class="literal">per_listener_settings</code> (which is always set to
<code class="literal">true</code>).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mosquitto-config-passwords" class="title">Password authentication   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-config-passwords" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Mosquitto can be run in two modes, with a password file or without. Each listener has its own
password file, and different listeners may use different password files. Password file generation
can be disabled by setting <code class="literal">omitPasswordAuth = true</code> for a listener; in this case it is necessary
to either set <code class="literal">settings.allow_anonymous = true</code> to allow all logins, or to configure other
authentication methods like TLS client certificates with <code class="literal">settings.use_identity_as_username = true</code>.</p><p>The default is to generate a password file for each listener from the users configured to that
listener. Users with no configured password will not be added to the password file and thus
will not be able to use the broker.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mosquitto-config-acl" class="title">ACL format   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mosquitto-config-acl" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Every listener has a Mosquitto <code class="literal">acl_file</code> attached to it. This ACL is configured via two
attributes of the config:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the <code class="literal">acl</code> attribute of the listener configures pattern ACL entries and topic ACL entries
for anonymous users. Each entry must be prefixed with <code class="literal">pattern</code> or <code class="literal">topic</code> to distinguish
between these two cases.</p></li><li class="listitem"><p>the <code class="literal">acl</code> attribute of every user configures in the listener configured the ACL for that
given user. Only topic ACLs are supported by Mosquitto in this setting, so no prefix is
required or allowed.</p></li></ul></div><p>The default ACL for a listener is empty, disallowing all accesses from all clients. To configure
a completely open ACL, set <code class="literal">acl = [ "pattern readwrite #" ]</code> in the listener.</p>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver" class="title">Firefox Sync server   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver-quickstart">Quickstart</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver-configuration">More detailed setup</a> </span></dt> </dl></div><p>A storage server for Firefox Sync that you can easily host yourself.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The absolute minimal configuration for the sync server looks like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.mysql.<span class="hljs-attr">package</span> = pkgs.mariadb;

services.<span class="hljs-attr">firefox-syncserver</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">secrets</span> = <span class="hljs-built_in">builtins</span>.toFile <span class="hljs-string">"sync-secrets"</span> <span class="hljs-string">''
    SYNC_MASTER_SECRET=this-secret-is-actually-leaked-to-/nix/store
  ''</span>;
  <span class="hljs-attr">singleNode</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">hostname</span> = <span class="hljs-string">"localhost"</span>;
    <span class="hljs-attr">url</span> = <span class="hljs-string">"http://localhost:5000"</span>;
  };
};
</code></pre><p>This will start a sync server that is only accessible locally. Once the services is
running you can navigate to <code class="literal">about:config</code> in your Firefox profile and set
<code class="literal">identity.sync.tokenserver.uri</code> to <code class="literal">http://localhost:5000/1.0/sync/1.5</code>. Your browser
will now use your local sync server for data storage.</p><div class="warning"><h3 class="title">Warning</h3><p>This configuration should never be used in production. It is not encrypted and
stores its secrets in a world-readable location.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-firefox-syncserver-configuration" class="title" style="clear: both">More detailed setup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-firefox-syncserver-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The <code class="literal">firefox-syncserver</code> service provides a number of options to make setting up
small deployment easier. These are grouped under the <code class="literal">singleNode</code> element of the
option tree and allow simple configuration of the most important parameters.</p><p>Single node setup is split into two kinds of options: those that affect the sync
server itself, and those that affect its surroundings. Options that affect the
sync server are <code class="literal">capacity</code>, which configures how many accounts may be active on
this instance, and <code class="literal">url</code>, which holds the URL under which the sync server can be
accessed. The <code class="literal">url</code> can be configured automatically when using nginx.</p><p>Options that affect the surroundings of the sync server are <code class="literal">enableNginx</code>,
<code class="literal">enableTLS</code> and <code class="literal">hostname</code>. If <code class="literal">enableNginx</code> is set the sync server module will
automatically add an nginx virtual host to the system using <code class="literal">hostname</code> as the
domain and set <code class="literal">url</code> accordingly. If <code class="literal">enableTLS</code> is set the module will also
enable ACME certificates on the new virtual host and force all connections to
be made via TLS.</p><p>For actual deployment it is also recommended to store the <code class="literal">secrets</code> file in a
secure location.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-litestream" class="title">Litestream   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-litestream" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-litestream-configuration">Configuration</a> </span></dt> </dl></div><p><a class="link" href="https://litestream.io/" target="_top">Litestream</a> is a standalone streaming
replication tool for SQLite.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-litestream-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-litestream-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Litestream service is managed by a dedicated user named <code class="literal">litestream</code>
which needs permission to the database file. Here’s an example config which gives
required permissions to access <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.grafana.settings.database.path">grafana database</a>:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ pkgs, ... }:
{
  users.users.litestream.extraGroups = [ <span class="hljs-string">"grafana"</span> ];

  systemd.services.grafana.serviceConfig.ExecStartPost = <span class="hljs-string">"+"</span> + pkgs.writeShellScript <span class="hljs-string">"grant-grafana-permissions"</span> <span class="hljs-string">''</span>
    <span class="hljs-built_in">timeout</span>=10

    <span class="hljs-keyword">while</span> [ ! -f /var/lib/grafana/data/grafana.db ];
    <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$timeout</span>"</span> == 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"ERROR: Timeout while waiting for /var/lib/grafana/data/grafana.db."</span>
        <span class="hljs-built_in">exit</span> 1
      <span class="hljs-keyword">fi</span>

      <span class="hljs-built_in">sleep</span> 1

      ((timeout--))
    <span class="hljs-keyword">done</span>

    find /var/lib/grafana -<span class="hljs-built_in">type</span> d -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">chmod</span> -v 775 {} \;
    find /var/lib/grafana -<span class="hljs-built_in">type</span> f -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">chmod</span> -v 660 {} \;
  <span class="hljs-string">''</span>;

  services.litestream = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;

    environmentFile = <span class="hljs-string">"/run/secrets/litestream"</span>;

    settings = {
      dbs = [
        {
          path = <span class="hljs-string">"/var/lib/grafana/data/grafana.db"</span>;
          replicas = [{
            url = <span class="hljs-string">"s3://mybkt.litestream.io/grafana"</span>;
          }];
        }
      ];
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters" class="title">Prometheus exporters   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-new-exporter">Adding a new exporter</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-update-exporter-module">Updating an exporter module</a> </span></dt> </dl></div><p>Prometheus exporters provide metrics for the
<a class="link" href="https://prometheus.io/" target="_top">prometheus monitoring system</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>One of the most common exporters is the
<a class="link" href="https://github.com/prometheus/node_exporter" target="_top">node exporter</a>,
it provides hardware and OS metrics from the host it’s
running on. The exporter could be configured as follows:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">  services.prometheus.exporters.<span class="hljs-attr">node</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">9100</span>;
    <span class="hljs-attr">enabledCollectors</span> = [
      <span class="hljs-string">"logind"</span>
      <span class="hljs-string">"systemd"</span>
    ];
    <span class="hljs-attr">disabledCollectors</span> = [
      <span class="hljs-string">"textfile"</span>
    ];
    <span class="hljs-attr">openFirewall</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">firewallFilter</span> = <span class="hljs-string">"-i br0 -p tcp -m tcp --dport 9100"</span>;
  };
</code></pre><p>It should now serve all metrics from the collectors that are explicitly
enabled and the ones that are
<a class="link" href="https://github.com/prometheus/node_exporter#enabled-by-default" target="_top">enabled by default</a>,
via http under <code class="literal">/metrics</code>. In this
example the firewall should just allow incoming connections to the
exporter’s port on the bridge interface <code class="literal">br0</code> (this would
have to be configured separately of course). For more information about
configuration see <code class="literal">man configuration.nix</code> or search through
the <a class="link" href="https://nixos.org/nixos/options.html#prometheus.exporters" target="_top">available options</a>.</p><p>Prometheus can now be configured to consume the metrics produced by the exporter:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">    services.<span class="hljs-attr">prometheus</span> = {
      <span class="hljs-comment"># ...</span>

      <span class="hljs-attr">scrapeConfigs</span> = [
        {
          <span class="hljs-attr">job_name</span> = <span class="hljs-string">"node"</span>;
          <span class="hljs-attr">static_configs</span> = [{
            <span class="hljs-attr">targets</span> = [ <span class="hljs-string">"localhost:<span class="hljs-subst">${<span class="hljs-built_in">toString</span> config.services.prometheus.exporters.node.port}</span>"</span> ];
          }];
        }
      ];

      <span class="hljs-comment"># ...</span>
    }
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-new-exporter" class="title" style="clear: both">Adding a new exporter   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-new-exporter" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To add a new exporter, it has to be packaged first (see
<code class="literal">nixpkgs/pkgs/servers/monitoring/prometheus/</code> for
examples), then a module can be added. The postfix exporter is used in this
example:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Some default options for all exporters are provided by
<code class="literal">nixpkgs/nixos/modules/services/monitoring/prometheus/exporters.nix</code>:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p><code class="literal">enable</code></p></li><li class="listitem"><p><code class="literal">port</code></p></li><li class="listitem"><p><code class="literal">listenAddress</code></p></li><li class="listitem"><p><code class="literal">extraFlags</code></p></li><li class="listitem"><p><code class="literal">openFirewall</code></p></li><li class="listitem"><p><code class="literal">firewallFilter</code></p></li><li class="listitem"><p><code class="literal">user</code></p></li><li class="listitem"><p><code class="literal">group</code></p></li></ul></div></li><li class="listitem"><p>As there is already a package available, the module can now be added. This
is accomplished by adding a new file to the
<code class="literal">nixos/modules/services/monitoring/prometheus/exporters/</code>
directory, which will be called postfix.nix and contains all exporter
specific options and configuration:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># nixpkgs/nixos/modules/services/prometheus/exporters/postfix.nix</span>
{ config, lib, pkgs, options }:

<span class="hljs-keyword">with</span> lib;

<span class="hljs-keyword">let</span>
  <span class="hljs-comment"># for convenience we define cfg here</span>
  <span class="hljs-attr">cfg</span> = config.services.prometheus.exporters.postfix;
<span class="hljs-keyword">in</span>
{
  <span class="hljs-attr">port</span> = <span class="hljs-number">9154</span>; <span class="hljs-comment"># The postfix exporter listens on this port by default</span>

  <span class="hljs-comment"># `extraOpts` is an attribute set which contains additional options</span>
  <span class="hljs-comment"># (and optional overrides for default options).</span>
  <span class="hljs-comment"># Note that this attribute is optional.</span>
  <span class="hljs-attr">extraOpts</span> = {
    <span class="hljs-attr">telemetryPath</span> = mkOption {
      <span class="hljs-attr">type</span> = types.str;
      <span class="hljs-attr">default</span> = <span class="hljs-string">"/metrics"</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Path under which to expose metrics.
      ''</span>;
    };
    <span class="hljs-attr">logfilePath</span> = mkOption {
      <span class="hljs-attr">type</span> = types.path;
      <span class="hljs-attr">default</span> = /var/log/postfix_exporter_input.log;
      <span class="hljs-attr">example</span> = /var/log/mail.log;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Path where Postfix writes log entries.
        This file will be truncated by this exporter!
      ''</span>;
    };
    <span class="hljs-attr">showqPath</span> = mkOption {
      <span class="hljs-attr">type</span> = types.path;
      <span class="hljs-attr">default</span> = /var/spool/postfix/public/showq;
      <span class="hljs-attr">example</span> = /var/lib/postfix/queue/public/showq;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Path at which Postfix places its showq socket.
      ''</span>;
    };
  };

  <span class="hljs-comment"># `serviceOpts` is an attribute set which contains configuration</span>
  <span class="hljs-comment"># for the exporter's systemd service. One of</span>
  <span class="hljs-comment"># `serviceOpts.script` and `serviceOpts.serviceConfig.ExecStart`</span>
  <span class="hljs-comment"># has to be specified here. This will be merged with the default</span>
  <span class="hljs-comment"># service configuration.</span>
  <span class="hljs-comment"># Note that by default 'DynamicUser' is 'true'.</span>
  <span class="hljs-attr">serviceOpts</span> = {
    <span class="hljs-attr">serviceConfig</span> = {
      <span class="hljs-attr">DynamicUser</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-attr">ExecStart</span> = <span class="hljs-string">''
        <span class="hljs-subst">${pkgs.prometheus-postfix-exporter}</span>/bin/postfix_exporter \
          --web.listen-address <span class="hljs-subst">${cfg.listenAddress}</span>:<span class="hljs-subst">${<span class="hljs-built_in">toString</span> cfg.port}</span> \
          --web.telemetry-path <span class="hljs-subst">${cfg.telemetryPath}</span> \
          <span class="hljs-subst">${concatStringsSep <span class="hljs-string">" \\\n  "</span> cfg.extraFlags}</span>
      ''</span>;
    };
  };
}
</code></pre></li><li class="listitem"><p>This should already be enough for the postfix exporter. Additionally one
could now add assertions and conditional default values. This can be done
in the ‘meta-module’ that combines all exporter definitions and generates
the submodules:
<code class="literal">nixpkgs/nixos/modules/services/prometheus/exporters.nix</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-prometheus-exporters-update-exporter-module" class="title" style="clear: both">Updating an exporter module   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-prometheus-exporters-update-exporter-module" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Should an exporter option change at some point, it is possible to add
information about the change to the exporter definition similar to
<code class="literal">nixpkgs/nixos/modules/rename.nix</code>:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ config, lib, pkgs, options }:

with lib;

<span class="hljs-built_in">let</span>
  cfg = config.services.prometheus.exporters.nginx;
<span class="hljs-keyword">in</span>
{
  port = 9113;
  extraOpts = {
    <span class="hljs-comment"># additional module options</span>
    <span class="hljs-comment"># ...</span>
  };
  serviceOpts = {
    <span class="hljs-comment"># service configuration</span>
    <span class="hljs-comment"># ...</span>
  };
  imports = [
    <span class="hljs-comment"># 'services.prometheus.exporters.nginx.telemetryEndpoint' -&gt; 'services.prometheus.exporters.nginx.telemetryPath'</span>
    (mkRenamedOptionModule [ <span class="hljs-string">"telemetryEndpoint"</span> ] [ <span class="hljs-string">"telemetryPath"</span> ])

    <span class="hljs-comment"># removed option 'services.prometheus.exporters.nginx.insecure'</span>
    (mkRemovedOptionModule [ <span class="hljs-string">"insecure"</span> ] <span class="hljs-string">''</span>
      This option was replaced by <span class="hljs-string">'prometheus.exporters.nginx.sslVerify'</span> <span class="hljs-built_in">which</span> defaults to <span class="hljs-literal">true</span>.
    <span class="hljs-string">''</span>)
    ({ options.warnings = options.warnings; })
  ];
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc" class="title">parsedmarc   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-local-mail">Local mail</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-grafana-geoip">Grafana and GeoIP</a> </span></dt> </dl></div><p><a class="link" href="https://domainaware.github.io/parsedmarc/" target="_top">parsedmarc</a> is a service
which parses incoming <a class="link" href="https://dmarc.org/" target="_top">DMARC</a> reports and stores
or sends them to a downstream service for further analysis. In
combination with Elasticsearch, Grafana and the included Grafana
dashboard, it provides a handy overview of DMARC reports over time.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A very minimal setup which reads incoming reports from an external
email address and saves them to a local Elasticsearch instance looks
like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">parsedmarc</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  settings.<span class="hljs-attr">imap</span> = {
    <span class="hljs-attr">host</span> = <span class="hljs-string">"imap.example.com"</span>;
    <span class="hljs-attr">user</span> = <span class="hljs-string">"alice@example.com"</span>;
    <span class="hljs-attr">password</span> = <span class="hljs-string">"/path/to/imap_password_file"</span>;
  };
  provision.<span class="hljs-attr">geoIp</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment"># Not recommended!</span>
};
</code></pre><p>Note that GeoIP provisioning is disabled in the example for
simplicity, but should be turned on for fully functional reports.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-local-mail" class="title" style="clear: both">Local mail   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-local-mail" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Instead of watching an external inbox, a local inbox can be
automatically provisioned. The recipient’s name is by default set to
<code class="literal">dmarc</code>, but can be configured in
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.parsedmarc.provision.localMail.recipientName" target="_top">services.parsedmarc.provision.localMail.recipientName</a>. You
need to add an MX record pointing to the host. More concretely: for
the example to work, an MX record needs to be set up for
<code class="literal">monitoring.example.com</code> and the complete email address that should be
configured in the domain’s dmarc policy is
<code class="literal">dmarc@monitoring.example.com</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">parsedmarc</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">provision</span> = {
    <span class="hljs-attr">localMail</span> = {
      <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">hostname</span> = monitoring.example.com;
    };
    <span class="hljs-attr">geoIp</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment"># Not recommended!</span>
  };
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-parsedmarc-grafana-geoip" class="title" style="clear: both">Grafana and GeoIP   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-parsedmarc-grafana-geoip" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The reports can be visualized and summarized with parsedmarc’s
official Grafana dashboard. For all views to work, and for the data to
be complete, GeoIP databases are also required. The following example
shows a basic deployment where the provisioned Elasticsearch instance
is automatically added as a Grafana datasource, and the dashboard is
added to Grafana as well.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">parsedmarc</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">provision</span> = {
    <span class="hljs-attr">localMail</span> = {
      <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">hostname</span> = url;
    };
    <span class="hljs-attr">grafana</span> = {
      <span class="hljs-attr">datasource</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">dashboard</span> = <span class="hljs-literal">true</span>;
    };
  };
};

<span class="hljs-comment"># Not required, but recommended for full functionality</span>
services.<span class="hljs-attr">geoipupdate</span> = {
  <span class="hljs-attr">settings</span> = {
    <span class="hljs-attr">AccountID</span> = <span class="hljs-number">000000</span>;
    <span class="hljs-attr">LicenseKey</span> = <span class="hljs-string">"/path/to/license_key_file"</span>;
  };
};

services.<span class="hljs-attr">grafana</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">addr</span> = <span class="hljs-string">"0.0.0.0"</span>;
  <span class="hljs-attr">domain</span> = url;
  <span class="hljs-attr">rootUrl</span> = <span class="hljs-string">"https://"</span> + url;
  <span class="hljs-attr">protocol</span> = <span class="hljs-string">"socket"</span>;
  <span class="hljs-attr">security</span> = {
    <span class="hljs-attr">adminUser</span> = <span class="hljs-string">"admin"</span>;
    <span class="hljs-attr">adminPasswordFile</span> = <span class="hljs-string">"/path/to/admin_password_file"</span>;
    <span class="hljs-attr">secretKeyFile</span> = <span class="hljs-string">"/path/to/secret_key_file"</span>;
  };
};

services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedTlsSettings</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedOptimisation</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedGzipSettings</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedProxySettings</span> = <span class="hljs-literal">true</span>;
  upstreams.grafana.servers.<span class="hljs-string">"unix:/<span class="hljs-subst">${config.services.grafana.socket}</span>"</span> = {};
  virtualHosts.${url} = {
    <span class="hljs-attr">root</span> = config.services.grafana.staticRootPath;
    <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
    locations.<span class="hljs-string">"/"</span>.<span class="hljs-attr">tryFiles</span> = <span class="hljs-string">"$uri @grafana"</span>;
    locations.<span class="hljs-string">"@grafana"</span>.<span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://grafana"</span>;
  };
};
users.users.nginx.<span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">"grafana"</span> ];
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-ocsinventory-agent" class="title">OCS Inventory Agent   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-ocsinventory-agent" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-ocsinventory-agent-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://ocsinventory-ng.org/" target="_top">OCS Inventory NG</a> or Open Computers and Software inventory
is an application designed to help IT administrator to keep track of the hardware and software
configurations of computers that are installed on their network.</p><p>OCS Inventory collects information about the hardware and software of networked machines
through the <span class="strong"><strong>OCS Inventory Agent</strong></span> program.</p><p>This NixOS module enables you to install and configure this agent so that it sends information from your computer to the OCS Inventory server.</p><p>For more technical information about OCS Inventory Agent, refer to <a class="link" href="https://wiki.ocsinventory-ng.org/03.Basic-documentation/Setting-up-the-UNIX-agent-manually-on-client-computers/" target="_top">the Wiki documentation</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-ocsinventory-agent-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-ocsinventory-agent-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">ocsinventory-agent</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">settings</span> = {
      <span class="hljs-attr">server</span> = <span class="hljs-string">"https://ocsinventory.localhost:8080/ocsinventory"</span>;
      <span class="hljs-attr">tag</span> = <span class="hljs-string">"01234567890123"</span>;
    };
  };
}
</code></pre><p>This configuration will periodically run the ocsinventory-agent SystemD service.</p><p>The OCS Inventory Agent will inventory the computer and then sends the results to the specified OCS Inventory Server.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-goss" class="title">Goss   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-goss" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-goss-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://goss.rocks/" target="_top">goss</a> is a YAML based serverspec alternative tool
for validating a server’s configuration.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-goss-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-goss-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A minimal configuration looks like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.<span class="hljs-attr">goss</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-attr">environment</span> = {
      <span class="hljs-attr">GOSS_FMT</span> = <span class="hljs-string">"json"</span>;
      <span class="hljs-attr">GOSS_LOGLEVEL</span> = <span class="hljs-string">"TRACE"</span>;
    };

    <span class="hljs-attr">settings</span> = {
      addr.<span class="hljs-string">"tcp://localhost:8080"</span> = {
        <span class="hljs-attr">reachable</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">local-address</span> = <span class="hljs-string">"127.0.0.1"</span>;
      };
      command.<span class="hljs-string">"check-goss-version"</span> = {
        <span class="hljs-attr">exec</span> = <span class="hljs-string">"<span class="hljs-subst">${lib.getExe pkgs.goss}</span> --version"</span>;
        <span class="hljs-attr">exit-status</span> = <span class="hljs-number">0</span>;
      };
      dns.localhost.<span class="hljs-attr">resolvable</span> = <span class="hljs-literal">true</span>;
      file.<span class="hljs-string">"/nix"</span> = {
        <span class="hljs-attr">filetype</span> = <span class="hljs-string">"directory"</span>;
        <span class="hljs-attr">exists</span> = <span class="hljs-literal">true</span>;
      };
      group.root.<span class="hljs-attr">exists</span> = <span class="hljs-literal">true</span>;
      kernel-param.<span class="hljs-string">"kernel.ostype"</span>.<span class="hljs-attr">value</span> = <span class="hljs-string">"Linux"</span>;
      service.<span class="hljs-attr">goss</span> = {
        <span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">running</span> = <span class="hljs-literal">true</span>;
      };
      user.root.<span class="hljs-attr">exists</span> = <span class="hljs-literal">true</span>;
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-certspotter" class="title">Cert Spotter   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-certspotter" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-service-configuration">Service Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-operation">Operation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-hooks">Hooks</a> </span></dt> </dl></div><p>Cert Spotter is a tool for monitoring <a class="link" href="https://en.wikipedia.org/wiki/Certificate_Transparency" target="_top">Certificate Transparency</a>
logs.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-service-configuration" class="title" style="clear: both">Service Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-service-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A basic config that notifies you of all certificate changes for your
domain would look as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">certspotter</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment"># replace example.org with your domain name</span>
  <span class="hljs-attr">watchlist</span> = [ <span class="hljs-string">".example.org"</span> ];
  <span class="hljs-attr">emailRecipients</span> = [ <span class="hljs-string">"webmaster@example.org"</span> ];
};

<span class="hljs-comment"># Configure an SMTP client</span>
programs.msmtp.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
<span class="hljs-comment"># Or you can use any other module that provides sendmail, like</span>
<span class="hljs-comment"># services.nullmailer, services.opensmtpd, services.postfix</span>
</code></pre><p>In this case, the leading dot in <code class="literal">".example.org"</code> means that Cert
Spotter should monitor not only <code class="literal">example.org</code>, but also all of its
subdomains.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-operation" class="title" style="clear: both">Operation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-operation" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><span class="strong"><strong>By default, NixOS configures Cert Spotter to skip all certificates
issued before its first launch</strong></span>, because checking the entire
Certificate Transparency logs requires downloading tens of terabytes of
data. If you want to check the <span class="emphasis"><em>entire</em></span> logs for previously issued
certificates, you have to set <code class="literal">services.certspotter.startAtEnd</code> to
<code class="literal">false</code> and remove all previously saved log state in
<code class="literal">/var/lib/certspotter/logs</code>. The downloaded logs aren’t saved, so if you
add a new domain to the watchlist and want Cert Spotter to go through
the logs again, you will have to remove <code class="literal">/var/lib/certspotter/logs</code>
again.</p><p>After catching up with the logs, Cert Spotter will start monitoring live
logs. As of October 2023, it uses around <span class="strong"><strong>20 Mbps</strong></span> of traffic on
average.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="modules-services-certspotter-hooks" class="title" style="clear: both">Hooks   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#modules-services-certspotter-hooks" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Cert Spotter supports running custom hooks instead of (or in addition
to) sending emails. Hooks are shell scripts that will be passed certain
environment variables.</p><p>To see hook documentation, see Cert Spotter’s man pages:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">nix-shell -p certspotter --run 'man 8 certspotter-script'
</code></pre><p>For example, you can remove <code class="literal">emailRecipients</code> and send email
notifications manually using the following hook:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.certspotter.<span class="hljs-attr">hooks</span> = [
  (pkgs.writeShellScript <span class="hljs-string">"certspotter-hook"</span> <span class="hljs-string">''
    function print_email() {
      echo "Subject: [certspotter] $SUMMARY"
      echo "Mime-Version: 1.0"
      echo "Content-Type: text/plain; charset=US-ASCII"
      echo
      cat "$TEXT_FILENAME"
    }
    print_email | <span class="hljs-subst">${config.services.certspotter.sendmailPath}</span> -i webmaster@example.org
  ''</span>)
];
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat" class="title">WeeChat   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-weechat" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-weechat-basic-usage">Basic Usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-weechat-reattach">Re-attaching to WeeChat</a> </span></dt> </dl></div><p><a class="link" href="https://weechat.org/" target="_top">WeeChat</a> is a fast and
extensible IRC client.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-weechat-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, the module creates a
<a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_top"><code class="literal">systemd</code></a>
unit which runs the chat client in a detached
<a class="link" href="https://www.gnu.org/software/screen/" target="_top"><code class="literal">screen</code></a>
session.</p><p>This can be done by enabling the <code class="literal">weechat</code> service:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ ... }:

{
  services.weechat.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>The service is managed by a dedicated user named <code class="literal">weechat</code>
in the state directory <code class="literal">/var/lib/weechat</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-weechat-reattach" class="title" style="clear: both">Re-attaching to WeeChat   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-weechat-reattach" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>WeeChat runs in a screen session owned by a dedicated user. To explicitly
allow your another user to attach to this session, the
<code class="literal">screenrc</code> needs to be tweaked by adding
<a class="link" href="https://www.gnu.org/software/screen/manual/html_node/Multiuser.html#Multiuser" target="_top">multiuser</a>
support:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{
  programs.screen.screenrc = <span class="hljs-string">''</span>
    multiuser on
    acladd normal_user
  <span class="hljs-string">''</span>;
}
</code></pre><p>Now, the session can be re-attached like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">screen -x weechat/weechat-screen
</code></pre><p><span class="emphasis"><em>The session name can be changed using <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.weechat.sessionName" target="_top">services.weechat.sessionName.</a></em></span></p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver" class="title">Taskserver   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-taskserver" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-nixos-taskserver-tool">The nixos-taskserver tool</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-declarative-ca-management">Declarative/automatic CA management</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-manual-ca-management">Manual CA management</a> </span></dt> </dl></div><p>Taskserver is the server component of
<a class="link" href="https://taskwarrior.org/" target="_top">Taskwarrior</a>, a free and
open source todo list application.</p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://taskwarrior.org/docs/#taskd" target="_top">https://taskwarrior.org/docs/#taskd</a></p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Taskserver does all of its authentication via TLS using client certificates,
so you either need to roll your own CA or purchase a certificate from a
known CA, which allows creation of client certificates. These certificates
are usually advertised as “server certificates”.</p><p>So in order to make it easier to handle your own CA, there is a helper tool
called <span class="command"><strong>nixos-taskserver</strong></span> which manages the custom CA along
with Taskserver organisations, users and groups.</p><p>While the client certificates in Taskserver only authenticate whether a user
is allowed to connect, every user has its own UUID which identifies it as an
entity.</p><p>With <span class="command"><strong>nixos-taskserver</strong></span> the client certificate is created
along with the UUID of the user, so it handles all of the credentials needed
in order to setup the Taskwarrior client to work with a Taskserver.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-nixos-taskserver-tool" class="title" style="clear: both">The nixos-taskserver tool   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-nixos-taskserver-tool" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Because Taskserver by default only provides scripts to setup users
imperatively, the <span class="command"><strong>nixos-taskserver</strong></span> tool is used for
addition and deletion of organisations along with users and groups defined
by <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.taskserver.organisations"><code class="option">services.taskserver.organisations</code></a> and as well for
imperative set up.</p><p>The tool is designed to not interfere if the command is used to manually set
up some organisations, users or groups.</p><p>For example if you add a new organisation using <span class="command"><strong>nixos-taskserver org add foo</strong></span>, the organisation is not modified and deleted no
matter what you define in
<code class="option">services.taskserver.organisations</code>, even if you’re adding
the same organisation in that option.</p><p>The tool is modelled to imitate the official <span class="command"><strong>taskd</strong></span>
command, documentation for each subcommand can be shown by using the
<code class="option">--help</code> switch.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-declarative-ca-management" class="title" style="clear: both">Declarative/automatic CA management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-declarative-ca-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Everything is done according to what you specify in the module options,
however in order to set up a Taskwarrior client for synchronisation with a
Taskserver instance, you have to transfer the keys and certificates to the
client machine.</p><p>This is done using <span class="command"><strong>nixos-taskserver user export $orgname $username</strong></span> which is printing a shell script fragment to stdout
which can either be used verbatim or adjusted to import the user on the
client machine.</p><p>For example, let’s say you have the following configuration:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">{
  services.taskserver.enable = true;
  services.taskserver.fqdn = "server";
  services.taskserver.listenHost = "::";
  services.taskserver.organisations.my-company.users = [ "alice" ];
}
</code></pre><p>This creates an organisation called <code class="literal">my-company</code> with the
user <code class="literal">alice</code>.</p><p>Now in order to import the <code class="literal">alice</code> user to another machine
<code class="literal">alicebox</code>, all we need to do is something like this:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">ssh server nixos-taskserver user <span class="hljs-built_in">export</span> my-company alice | sh</span>
</code></pre><p>Of course, if no SSH daemon is available on the server you can also copy
&amp; paste it directly into a shell.</p><p>After this step the user should be set up and you can start synchronising
your tasks for the first time with <span class="command"><strong>task sync init</strong></span> on
<code class="literal">alicebox</code>.</p><p>Subsequent synchronisation requests merely require the command <span class="command"><strong>task sync</strong></span> after that stage.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-taskserver-manual-ca-management" class="title" style="clear: both">Manual CA management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-taskserver-manual-ca-management" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If you set any options within
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.taskserver.pki.manual.ca.cert">service.taskserver.pki.manual</a>.*,
<span class="command"><strong>nixos-taskserver</strong></span> won’t issue certificates, but you can
still use it for adding or removing user accounts.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut" class="title">Sourcehut   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-basic-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-configuration">Configuration</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-httpd">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)</a> </span></dt> </dl></div><p><a class="link" href="https://sr.ht.com/" target="_top">Sourcehut</a> is an open-source,
self-hostable software development platform. The server setup can be automated using
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.sourcehut.enable">services.sourcehut</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-basic-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Sourcehut is a Python and Go based set of applications.
This NixOS module also provides basic configuration integrating Sourcehut into locally running
<code class="literal">services.nginx</code>, <code class="literal">services.redis.servers.sourcehut</code>, <code class="literal">services.postfix</code>
and <code class="literal">services.postgresql</code> services.</p><p>A very basic configuration may look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ pkgs, ... }:
<span class="hljs-keyword">let</span>
  <span class="hljs-attr">fqdn</span> =
    <span class="hljs-keyword">let</span>
      <span class="hljs-attr">join</span> = hostName: domain: hostName + optionalString (domain != <span class="hljs-literal">null</span>) <span class="hljs-string">".<span class="hljs-subst">${domain}</span>"</span>;
    <span class="hljs-keyword">in</span> join config.networking.hostName config.networking.domain;
<span class="hljs-keyword">in</span> {

  <span class="hljs-attr">networking</span> = {
    <span class="hljs-attr">hostName</span> = <span class="hljs-string">"srht"</span>;
    <span class="hljs-attr">domain</span> = <span class="hljs-string">"tld"</span>;
    firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">22</span> <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
  };

  services.<span class="hljs-attr">sourcehut</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    git.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    man.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    meta.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    nginx.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    postfix.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    postgresql.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    redis.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">settings</span> = {
        <span class="hljs-string">"sr.ht"</span> = {
          <span class="hljs-attr">environment</span> = <span class="hljs-string">"production"</span>;
          <span class="hljs-attr">global-domain</span> = fqdn;
          <span class="hljs-attr">origin</span> = <span class="hljs-string">"https://<span class="hljs-subst">${fqdn}</span>"</span>;
          <span class="hljs-comment"># Produce keys with srht-keygen from sourcehut.coresrht.</span>
          <span class="hljs-attr">network-key</span> = <span class="hljs-string">"/run/keys/path/to/network-key"</span>;
          <span class="hljs-attr">service-key</span> = <span class="hljs-string">"/run/keys/path/to/service-key"</span>;
        };
        webhooks.<span class="hljs-attr">private-key=</span> <span class="hljs-string">"/run/keys/path/to/webhook-key"</span>;
    };
  };

  security.acme.certs.<span class="hljs-string">"<span class="hljs-subst">${fqdn}</span>"</span>.<span class="hljs-attr">extraDomainNames</span> = [
    <span class="hljs-string">"meta.<span class="hljs-subst">${fqdn}</span>"</span>
    <span class="hljs-string">"man.<span class="hljs-subst">${fqdn}</span>"</span>
    <span class="hljs-string">"git.<span class="hljs-subst">${fqdn}</span>"</span>
  ];

  services.<span class="hljs-attr">nginx</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment"># only recommendedProxySettings are strictly required, but the rest make sense as well.</span>
    <span class="hljs-attr">recommendedTlsSettings</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedOptimisation</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedGzipSettings</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedProxySettings</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-comment"># Settings to setup what certificates are used for which endpoint.</span>
    <span class="hljs-attr">virtualHosts</span> = {
      <span class="hljs-string">"<span class="hljs-subst">${fqdn}</span>"</span>.<span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-string">"meta.<span class="hljs-subst">${fqdn}</span>"</span>.<span class="hljs-attr">useACMEHost</span> = fqdn:
      <span class="hljs-string">"man.<span class="hljs-subst">${fqdn}</span>"</span>.<span class="hljs-attr">useACMEHost</span> = fqdn:
      <span class="hljs-string">"git.<span class="hljs-subst">${fqdn}</span>"</span>.<span class="hljs-attr">useACMEHost</span> = fqdn:
    };
  };
}
</code></pre><p>The <code class="literal">hostName</code> option is used internally to configure the nginx
reverse-proxy. The <code class="literal">settings</code> attribute set is
used by the configuration generator and the result is placed in <code class="literal">/etc/sr.ht/config.ini</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-configuration" class="title" style="clear: both">Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>All configuration parameters are also stored in
<code class="literal">/etc/sr.ht/config.ini</code> which is generated by
the module and linked from the store to ensure that all values from <code class="literal">config.ini</code>
can be modified by the module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-sourcehut-httpd" class="title" style="clear: both">Using an alternative webserver as reverse-proxy (e.g. <code class="literal">httpd</code>)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-sourcehut-httpd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, <code class="literal">nginx</code> is used as reverse-proxy for <code class="literal">sourcehut</code>.
However, it’s possible to use e.g. <code class="literal">httpd</code> by explicitly disabling
<code class="literal">nginx</code> using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.nginx.enable"><code class="option">services.nginx.enable</code></a> and fixing the
<code class="literal">settings</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab" class="title">GitLab   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-prerequisites">Prerequisites</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-maintenance">Maintenance</a> </span></dt> </dl></div><p>GitLab is a feature-rich git hosting service.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-prerequisites" class="title" style="clear: both">Prerequisites   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-prerequisites" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The <code class="literal">gitlab</code> service exposes only an Unix socket at
<code class="literal">/run/gitlab/gitlab-workhorse.socket</code>. You need to
configure a webserver to proxy HTTP requests to the socket.</p><p>For instance, the following configuration could be used to use nginx as
frontend proxy:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedGzipSettings</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedOptimisation</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedProxySettings</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">recommendedTlsSettings</span> = <span class="hljs-literal">true</span>;
  virtualHosts.<span class="hljs-string">"git.example.com"</span> = {
    <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
    locations.<span class="hljs-string">"/"</span>.<span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://unix:/run/gitlab/gitlab-workhorse.socket"</span>;
  };
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-configuring" class="title" style="clear: both">Configuring   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>GitLab depends on both PostgreSQL and Redis and will automatically enable
both services. In the case of PostgreSQL, a database and a role will be
created.</p><p>The default state dir is <code class="literal">/var/gitlab/state</code>. This is where
all data like the repositories and uploads will be stored.</p><p>A basic configuration with some custom settings could look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">gitlab</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">databasePasswordFile</span> = <span class="hljs-string">"/var/keys/gitlab/db_password"</span>;
  <span class="hljs-attr">initialRootPasswordFile</span> = <span class="hljs-string">"/var/keys/gitlab/root_password"</span>;
  <span class="hljs-attr">https</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">host</span> = <span class="hljs-string">"git.example.com"</span>;
  <span class="hljs-attr">port</span> = <span class="hljs-number">443</span>;
  <span class="hljs-attr">user</span> = <span class="hljs-string">"git"</span>;
  <span class="hljs-attr">group</span> = <span class="hljs-string">"git"</span>;
  <span class="hljs-attr">smtp</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">address</span> = <span class="hljs-string">"localhost"</span>;
    <span class="hljs-attr">port</span> = <span class="hljs-number">25</span>;
  };
  <span class="hljs-attr">secrets</span> = {
    <span class="hljs-attr">dbFile</span> = <span class="hljs-string">"/var/keys/gitlab/db"</span>;
    <span class="hljs-attr">secretFile</span> = <span class="hljs-string">"/var/keys/gitlab/secret"</span>;
    <span class="hljs-attr">otpFile</span> = <span class="hljs-string">"/var/keys/gitlab/otp"</span>;
    <span class="hljs-attr">jwsFile</span> = <span class="hljs-string">"/var/keys/gitlab/jws"</span>;
  };
  <span class="hljs-attr">extraConfig</span> = {
    <span class="hljs-attr">gitlab</span> = {
      <span class="hljs-attr">email_from</span> = <span class="hljs-string">"gitlab-no-reply@example.com"</span>;
      <span class="hljs-attr">email_display_name</span> = <span class="hljs-string">"Example GitLab"</span>;
      <span class="hljs-attr">email_reply_to</span> = <span class="hljs-string">"gitlab-no-reply@example.com"</span>;
      <span class="hljs-attr">default_projects_features</span> = { <span class="hljs-attr">builds</span> = <span class="hljs-literal">false</span>; };
    };
  };
};
</code></pre><p>If you’re setting up a new GitLab instance, generate new
secrets. You for instance use
<code class="literal">tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c 128 &gt; /var/keys/gitlab/db</code> to
generate a new db secret. Make sure the files can be read by, and
only by, the user specified by
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.gitlab.user">services.gitlab.user</a>. GitLab
encrypts sensitive data stored in the database. If you’re restoring
an existing GitLab instance, you must specify the secrets secret
from <code class="literal">config/secrets.yml</code> located in your GitLab
state folder.</p><p>When <code class="literal">incoming_mail.enabled</code> is set to <code class="literal">true</code>
in <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.gitlab.extraConfig">extraConfig</a> an additional
service called <code class="literal">gitlab-mailroom</code> is enabled for fetching incoming mail.</p><p>Refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">Appendix&nbsp;A</a> for all available configuration
options for the <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.gitlab.enable">services.gitlab</a> module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-gitlab-maintenance" class="title" style="clear: both">Maintenance   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-maintenance" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-gitlab-maintenance-backups" class="title">Backups   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-maintenance-backups" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Backups can be configured with the options in
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.gitlab.backup.keepTime">services.gitlab.backup</a>. Use
the <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.gitlab.backup.startAt">services.gitlab.backup.startAt</a>
option to configure regular backups.</p><p>To run a manual backup, start the <code class="literal">gitlab-backup</code> service:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl start gitlab-backup.service</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-gitlab-maintenance-rake" class="title">Rake tasks   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-gitlab-maintenance-rake" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>You can run GitLab’s rake tasks with <code class="literal">gitlab-rake</code>
which will be available on the system when GitLab is enabled. You
will have to run the command as the user that you configured to run
GitLab with.</p><p>A list of all available rake tasks can be obtained by running:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -u git -H gitlab-rake -T</span>
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-forgejo" class="title">Forgejo   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-forgejo" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-forgejo-migration-gitea">Migration from Gitea</a> </span></dt> </dl></div><p>Forgejo is a soft-fork of gitea, with strong community focus, as well
as on self-hosting and federation. <a class="link" href="https://codeberg.org/" target="_top">Codeberg</a> is
deployed from it.</p><p>See <a class="link" href="https://forgejo.org/docs/latest/" target="_top">upstream docs</a>.</p><p>The method of choice for running forgejo is using <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.forgejo.enable"><code class="literal">services.forgejo</code></a>.</p><div class="warning"><h3 class="title">Warning</h3><p>Running forgejo using <code class="literal">services.gitea.package = pkgs.forgejo</code> is no longer
recommended.
If you experience issues with your instance using <code class="literal">services.gitea</code>,
<span class="strong"><strong>DO NOT</strong></span> report them to the <code class="literal">services.gitea</code> module maintainers.
<span class="strong"><strong>DO</strong></span> report them to the <code class="literal">services.forgejo</code> module maintainers instead.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-forgejo-migration-gitea" class="title" style="clear: both">Migration from Gitea   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-forgejo-migration-gitea" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>Migrating is, while not strictly necessary at this point, highly recommended.
Both modules and projects are likely to diverge further with each release.
Which might lead to an even more involved migration.</p></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-forgejo-migration-gitea-default" class="title">Full-Migration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-forgejo-migration-gitea-default" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>This will migrate the state directory (data), rename and chown the database and
delete the gitea user.</p><div class="note"><h3 class="title">Note</h3><p>This will also change the git remote ssh-url user from <code class="literal">gitea@</code> to <code class="literal">forgejo@</code>,
when using the host’s openssh server (default) instead of the integrated one.</p></div><p>Instructions for PostgreSQL (default). Adapt accordingly for other databases:</p><pre><code class="programlisting sh hljs language-bash" data-highlighted="yes">systemctl stop gitea
<span class="hljs-built_in">mv</span> /var/lib/gitea /var/lib/forgejo
runuser -u postgres -- psql -c <span class="hljs-string">'
  ALTER USER gitea RENAME TO forgejo;
  ALTER DATABASE gitea RENAME TO forgejo;
'</span>
nixos-rebuild switch
systemctl stop forgejo
<span class="hljs-built_in">chown</span> -R forgejo:forgejo /var/lib/forgejo
systemctl restart forgejo
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-forgejo-migration-gitea-impersonate" class="title">Alternatively, keeping the gitea user   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-forgejo-migration-gitea-impersonate" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Alternatively, instead of renaming the database, copying the state folder and
changing the user, the forgejo module can be set up to re-use the old storage
locations and database, instead of having to copy or rename them.
Make sure to disable <code class="literal">services.gitea</code>, when doing this.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.gitea.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;

services.<span class="hljs-attr">forgejo</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">user</span> = <span class="hljs-string">"gitea"</span>;
  <span class="hljs-attr">group</span> = <span class="hljs-string">"gitea"</span>;
  <span class="hljs-attr">stateDir</span> = <span class="hljs-string">"/var/lib/gitea"</span>;
  database.<span class="hljs-attr">name</span> = <span class="hljs-string">"gitea"</span>;
  database.<span class="hljs-attr">user</span> = <span class="hljs-string">"gitea"</span>;
};

users.users.<span class="hljs-attr">gitea</span> = {
  <span class="hljs-attr">home</span> = <span class="hljs-string">"/var/lib/gitea"</span>;
  <span class="hljs-attr">useDefaultShell</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">group</span> = <span class="hljs-string">"gitea"</span>;
  <span class="hljs-attr">isSystemUser</span> = <span class="hljs-literal">true</span>;
};

users.groups.<span class="hljs-attr">gitea</span> = {};
</code></pre>
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka" class="title">Apache Kafka   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-basic-usage">Basic Usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-kraft">KRaft</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-migrating-to-settings">Migrating to settings</a> </span></dt> </dl></div><p><a class="link" href="https://kafka.apache.org/" target="_top">Apache Kafka</a> is an open-source distributed event
streaming platform</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The Apache Kafka service is configured almost exclusively through its
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.settings">settings</a> option, with each attribute
corresponding to the <a class="link" href="https://kafka.apache.org/documentation/#configuration" target="_top">upstream configuration
manual</a> broker settings.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-kraft" class="title" style="clear: both">KRaft   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-kraft" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Unlike in Zookeeper mode, Kafka in
<a class="link" href="https://kafka.apache.org/documentation/#kraft" target="_top">KRaft</a> mode requires each log
dir to be “formatted” (which means a cluster-specific a metadata file must
exist in each log dir)</p><p>The upstream intention is for users to execute the <a class="link" href="https://kafka.apache.org/documentation/#kraft_storage" target="_top">storage
tool</a> to achieve this,
but this module contains a few extra options to automate this:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.clusterId"><code class="option">services.apache-kafka.clusterId</code></a></p></li><li class="listitem"><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.formatLogDirs"><code class="option">services.apache-kafka.formatLogDirs</code></a></p></li><li class="listitem"><p><a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.formatLogDirsIgnoreFormatted"><code class="option">services.apache-kafka.formatLogDirsIgnoreFormatted</code></a></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-apache-kafka-migrating-to-settings" class="title" style="clear: both">Migrating to settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-apache-kafka-migrating-to-settings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Migrating a cluster to the new <code class="literal">settings</code>-based changes requires adapting removed options to the corresponding upstream settings.</p><p>This means that the upstream <a class="link" href="https://kafka.apache.org/documentation/#brokerconfigs" target="_top">Broker Configs documentation</a> should be followed closely.</p><p>Note that dotted options in the upstream docs do <span class="emphasis"><em>not</em></span> correspond to nested Nix attrsets, but instead as quoted top level <code class="literal">settings</code> attributes, as in <code class="literal">services.apache-kafka.settings."broker.id"</code>, <span class="emphasis"><em>NOT</em></span> <code class="literal">services.apache-kafka.settings.broker.id</code>.</p><p>Care should be taken, especially when migrating clusters from the old module, to ensure that the same intended configuration is reproduced faithfully via <code class="literal">settings</code>.</p><p>To assist in the comparison, the final config can be inspected by building the config file itself, ie. with: <code class="literal">nix-build &lt;nixpkgs/nixos&gt; -A config.services.apache-kafka.configFiles.serverProperties</code>.</p><p>Notable changes to be aware of include:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.extraProperties</code> and <code class="literal">services.apache-kafka.serverProperties</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using arbitrary properties using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.settings"><code class="option">services.apache-kafka.settings</code></a></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs" target="_top">Upstream docs</a></p></li><li class="listitem"><p>The intention is for all broker properties to be fully representable via <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.settings"><code class="option">services.apache-kafka.settings</code></a>.</p></li><li class="listitem"><p>If this is not the case, please do consider raising an issue.</p></li><li class="listitem"><p>Until it can be remedied, you <span class="emphasis"><em>can</em></span> bail out by using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.apache-kafka.configFiles.serverProperties"><code class="option">services.apache-kafka.configFiles.serverProperties</code></a> to the path of a fully rendered properties file.</p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.hostname</code> and <code class="literal">services.apache-kafka.port</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings.listeners</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_listeners" target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.logDirs</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings."log.dirs"</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_log.dirs" target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.brokerId</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings."broker.id"</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_broker.id" target="_top">Upstream docs</a></p></li></ul></div></li><li class="listitem"><p>Removal of <code class="literal">services.apache-kafka.zookeeper</code></p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>Translate using: <code class="literal">services.apache-kafka.settings."zookeeper.connect"</code></p></li><li class="listitem"><p><a class="link" href="https://kafka.apache.org/documentation.html#brokerconfigs_zookeeper.connect" target="_top">Upstream docs</a></p></li></ul></div></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix" class="title">Matrix   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matrix" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matrix-synapse">Synapse Homeserver</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matrix-register-users">Registering Matrix users</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-matrix-element-web">Element (formerly known as Riot) Web Client</a> </span></dt> </dl></div><p><a class="link" href="https://matrix.org/" target="_top">Matrix</a> is an open standard for
interoperable, decentralised, real-time communication over IP. It can be used
to power Instant Messaging, VoIP/WebRTC signalling, Internet of Things
communication - or anywhere you need a standard HTTP API for publishing and
subscribing to data whilst tracking the conversation history.</p><p>This chapter will show you how to set up your own, self-hosted Matrix
homeserver using the Synapse reference homeserver, and how to serve your own
copy of the Element web client. See the
<a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top">Try Matrix Now!</a>
overview page for links to Element Apps for Android and iOS,
desktop clients, as well as bridges to other networks and other projects
around Matrix.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-synapse" class="title" style="clear: both">Synapse Homeserver   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matrix-synapse" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://github.com/element-hq/synapse" target="_top">Synapse</a> is
the reference homeserver implementation of Matrix from the core development
team at matrix.org. The following configuration example will set up a
synapse server for the <code class="literal">example.org</code> domain, served from
the host <code class="literal">myhostname.example.org</code>. For more information,
please refer to the
<a class="link" href="https://element-hq.github.io/synapse/latest/setup/installation.html" target="_top">installation instructions of Synapse</a> .</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ pkgs, lib, config, ... }:
<span class="hljs-keyword">let</span>
  <span class="hljs-attr">fqdn</span> = <span class="hljs-string">"<span class="hljs-subst">${config.networking.hostName}</span>.<span class="hljs-subst">${config.networking.domain}</span>"</span>;
  <span class="hljs-attr">baseUrl</span> = <span class="hljs-string">"https://<span class="hljs-subst">${fqdn}</span>"</span>;
  clientConfig.<span class="hljs-string">"m.homeserver"</span>.<span class="hljs-attr">base_url</span> = baseUrl;
  serverConfig.<span class="hljs-string">"m.server"</span> = <span class="hljs-string">"<span class="hljs-subst">${fqdn}</span>:443"</span>;
  <span class="hljs-attr">mkWellKnown</span> = data: <span class="hljs-string">''
    default_type application/json;
    add_header Access-Control-Allow-Origin *;
    return 200 '<span class="hljs-subst">${<span class="hljs-built_in">builtins</span>.toJSON data}</span>';
  ''</span>;
<span class="hljs-keyword">in</span> {
  networking.<span class="hljs-attr">hostName</span> = <span class="hljs-string">"myhostname"</span>;
  networking.<span class="hljs-attr">domain</span> = <span class="hljs-string">"example.org"</span>;
  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];

  services.postgresql.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  services.postgresql.<span class="hljs-attr">initialScript</span> = pkgs.writeText <span class="hljs-string">"synapse-init.sql"</span> <span class="hljs-string">''
    CREATE ROLE "matrix-synapse" WITH LOGIN PASSWORD 'synapse';
    CREATE DATABASE "matrix-synapse" WITH OWNER "matrix-synapse"
      TEMPLATE template0
      LC_COLLATE = "C"
      LC_CTYPE = "C";
  ''</span>;

  services.<span class="hljs-attr">nginx</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedTlsSettings</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedOptimisation</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedGzipSettings</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">recommendedProxySettings</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">virtualHosts</span> = {
      <span class="hljs-comment"># If the A and AAAA DNS records on example.org do not point on the same host as the</span>
      <span class="hljs-comment"># records for myhostname.example.org, you can easily move the /.well-known</span>
      <span class="hljs-comment"># virtualHost section of the code to the host that is serving example.org, while</span>
      <span class="hljs-comment"># the rest stays on myhostname.example.org with no other changes required.</span>
      <span class="hljs-comment"># This pattern also allows to seamlessly move the homeserver from</span>
      <span class="hljs-comment"># myhostname.example.org to myotherhost.example.org by only changing the</span>
      <span class="hljs-comment"># /.well-known redirection target.</span>
      <span class="hljs-string">"<span class="hljs-subst">${config.networking.domain}</span>"</span> = {
        <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-comment"># This section is not needed if the server_name of matrix-synapse is equal to</span>
        <span class="hljs-comment"># the domain (i.e. example.org from @foo:example.org) and the federation port</span>
        <span class="hljs-comment"># is 8448.</span>
        <span class="hljs-comment"># Further reference can be found in the docs about delegation under</span>
        <span class="hljs-comment"># https://element-hq.github.io/synapse/latest/delegate.html</span>
        locations.<span class="hljs-string">"= /.well-known/matrix/server"</span>.<span class="hljs-attr">extraConfig</span> = mkWellKnown serverConfig;
        <span class="hljs-comment"># This is usually needed for homeserver discovery (from e.g. other Matrix clients).</span>
        <span class="hljs-comment"># Further reference can be found in the upstream docs at</span>
        <span class="hljs-comment"># https://spec.matrix.org/latest/client-server-api/#getwell-knownmatrixclient</span>
        locations.<span class="hljs-string">"= /.well-known/matrix/client"</span>.<span class="hljs-attr">extraConfig</span> = mkWellKnown clientConfig;
      };
      <span class="hljs-string">"<span class="hljs-subst">${fqdn}</span>"</span> = {
        <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-comment"># It's also possible to do a redirect here or something else, this vhost is not</span>
        <span class="hljs-comment"># needed for Matrix. It's recommended though to *not put* element</span>
        <span class="hljs-comment"># here, see also the section about Element.</span>
        locations.<span class="hljs-string">"/"</span>.<span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
          return 404;
        ''</span>;
        <span class="hljs-comment"># Forward all Matrix API calls to the synapse Matrix homeserver. A trailing slash</span>
        <span class="hljs-comment"># *must not* be used here.</span>
        locations.<span class="hljs-string">"/_matrix"</span>.<span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://[::1]:8008"</span>;
        <span class="hljs-comment"># Forward requests for e.g. SSO and password-resets.</span>
        locations.<span class="hljs-string">"/_synapse/client"</span>.<span class="hljs-attr">proxyPass</span> = <span class="hljs-string">"http://[::1]:8008"</span>;
      };
    };
  };

  services.<span class="hljs-attr">matrix-synapse</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    settings.<span class="hljs-attr">server_name</span> = config.networking.domain;
    <span class="hljs-comment"># The public base URL value must match the `base_url` value set in `clientConfig` above.</span>
    <span class="hljs-comment"># The default value here is based on `server_name`, so if your `server_name` is different</span>
    <span class="hljs-comment"># from the value of `fqdn` above, you will likely run into some mismatched domain names</span>
    <span class="hljs-comment"># in client applications.</span>
    settings.<span class="hljs-attr">public_baseurl</span> = baseUrl;
    settings.<span class="hljs-attr">listeners</span> = [
      { <span class="hljs-attr">port</span> = <span class="hljs-number">8008</span>;
        <span class="hljs-attr">bind_addresses</span> = [ <span class="hljs-string">"::1"</span> ];
        <span class="hljs-attr">type</span> = <span class="hljs-string">"http"</span>;
        <span class="hljs-attr">tls</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-attr">x_forwarded</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-attr">resources</span> = [ {
          <span class="hljs-attr">names</span> = [ <span class="hljs-string">"client"</span> <span class="hljs-string">"federation"</span> ];
          <span class="hljs-attr">compress</span> = <span class="hljs-literal">true</span>;
        } ];
      }
    ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-register-users" class="title" style="clear: both">Registering Matrix users   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matrix-register-users" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If you want to run a server with public registration by anybody, you can
then enable <code class="literal">services.matrix-synapse.settings.enable_registration = true;</code>.
Otherwise, or you can generate a registration secret with
<span class="command"><strong>pwgen -s 64 1</strong></span> and set it with
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.matrix-synapse.settings.registration_shared_secret"><code class="option">services.matrix-synapse.settings.registration_shared_secret</code></a>.
To create a new user or admin, run the following after you have set the secret
and have rebuilt NixOS:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell -p matrix-synapse</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">register_new_matrix_user -k your-registration-shared-secret http://localhost:8008</span>
New user localpart: your-username
Password:
Confirm password:
Make admin [no]:
Success!
</code></pre><p>In the example, this would create a user with the Matrix Identifier
<code class="literal">@your-username:example.org</code>.</p><div class="warning"><h3 class="title">Warning</h3><p>When using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.matrix-synapse.settings.registration_shared_secret"><code class="option">services.matrix-synapse.settings.registration_shared_secret</code></a>, the secret
will end up in the world-readable store. Instead it’s recommended to deploy the secret
in an additional file like this:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Create a file with the following contents:</p><pre><code class="programlisting hljs language-undefined" data-highlighted="yes">registration_shared_secret: your-very-secret-secret
</code></pre></li><li class="listitem"><p>Deploy the file with a secret-manager such as
<a class="link" href="https://nixops.readthedocs.io/en/latest/overview.html#managing-keys" target="_top"><code class="option">deployment.keys</code></a>
from <span class="citerefentry"><span class="refentrytitle">nixops</span>(1)</span> or <a class="link" href="https://github.com/Mic92/sops-nix/" target="_top">sops-nix</a> to
e.g. <code class="filename">/run/secrets/matrix-shared-secret</code> and ensure that it’s readable
by <code class="literal">matrix-synapse</code>.</p></li><li class="listitem"><p>Include the file like this in your configuration:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.matrix-synapse.<span class="hljs-attr">extraConfigFiles</span> = [
    <span class="hljs-string">"/run/secrets/matrix-shared-secret"</span>
  ];
}
</code></pre></li></ul></div></div><div class="note"><h3 class="title">Note</h3><p>It’s also possible to user alternative authentication mechanism such as
<a class="link" href="https://github.com/matrix-org/matrix-synapse-ldap3" target="_top">LDAP (via <code class="literal">matrix-synapse-ldap3</code>)</a>
or <a class="link" href="https://element-hq.github.io/synapse/latest/openid.html" target="_top">OpenID</a>.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-matrix-element-web" class="title" style="clear: both">Element (formerly known as Riot) Web Client   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-matrix-element-web" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://github.com/vector-im/riot-web/" target="_top">Element Web</a> is
the reference web client for Matrix and developed by the core team at
matrix.org. Element was formerly known as Riot.im, see the
<a class="link" href="https://element.io/blog/welcome-to-element/" target="_top">Element introductory blog post</a>
for more information. The following snippet can be optionally added to the code before
to complete the synapse installation with a web client served at
<code class="literal">https://element.myhostname.example.org</code> and
<code class="literal">https://element.example.org</code>. Alternatively, you can use the hosted
copy at <a class="link" href="https://app.element.io/" target="_top">https://app.element.io/</a>,
or use other web clients or native client applications. Due to the
<code class="literal">/.well-known</code> urls set up done above, many clients should
fill in the required connection details automatically when you enter your
Matrix Identifier. See
<a class="link" href="https://matrix.org/docs/projects/try-matrix-now.html" target="_top">Try Matrix Now!</a>
for a list of existing clients and their supported featureset.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.nginx.virtualHosts.<span class="hljs-string">"element.<span class="hljs-subst">${fqdn}</span>"</span> = {
    <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">serverAliases</span> = [
      <span class="hljs-string">"element.<span class="hljs-subst">${config.networking.domain}</span>"</span>
    ];

    <span class="hljs-attr">root</span> = pkgs.element-web.override {
      <span class="hljs-attr">conf</span> = {
        <span class="hljs-attr">default_server_config</span> = clientConfig; <span class="hljs-comment"># see `clientConfig` from the snippet above.</span>
      };
    };
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The Element developers do not recommend running Element and your Matrix
homeserver on the same fully-qualified domain name for security reasons. In
the example, this means that you should not reuse the
<code class="literal">myhostname.example.org</code> virtualHost to also serve Element,
but instead serve it on a different subdomain, like
<code class="literal">element.example.org</code> in the example. See the
<a class="link" href="https://github.com/vector-im/element-web/tree/v1.10.0#important-security-notes" target="_top">Element Important Security Notes</a>
for more information on this subject.</p></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir" class="title">Mjolnir (Matrix Moderation Tool)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir-setup">Mjolnir Setup</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir-matrix-synapse-antispam">Synapse Antispam Module</a> </span></dt> </dl></div><p>This chapter will show you how to set up your own, self-hosted
<a class="link" href="https://github.com/matrix-org/mjolnir" target="_top">Mjolnir</a> instance.</p><p>As an all-in-one moderation tool, it can protect your server from
malicious invites, spam messages, and whatever else you don’t want.
In addition to server-level protection, Mjolnir is great for communities
wanting to protect their rooms without having to use their personal
accounts for moderation.</p><p>The bot by default includes support for bans, redactions, anti-spam,
server ACLs, room directory changes, room alias transfers, account
deactivation, room shutdown, and more.</p><p>See the <a class="link" href="https://github.com/matrix-org/mjolnir#readme" target="_top">README</a>
page and the <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/docs/moderators.md" target="_top">Moderator’s guide</a>
for additional instructions on how to setup and use Mjolnir.</p><p>For <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.mjolnir.settings">additional settings</a>
see <a class="link" href="https://github.com/matrix-org/mjolnir/blob/main/config/default.yaml" target="_top">the default configuration</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir-setup" class="title" style="clear: both">Mjolnir Setup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir-setup" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>First create a new Room which will be used as a management room for Mjolnir. In
this room, Mjolnir will log possible errors and debugging information. You’ll
need to set this Room-ID in <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.mjolnir.managementRoom">services.mjolnir.managementRoom</a>.</p><p>Next, create a new user for Mjolnir on your homeserver, if not present already.</p><p>The Mjolnir Matrix user expects to be free of any rate limiting.
See <a class="link" href="https://github.com/matrix-org/synapse/issues/6286" target="_top">Synapse #6286</a>
for an example on how to achieve this.</p><p>If you want Mjolnir to be able to deactivate users, move room aliases, shutdown rooms, etc.
you’ll need to make the Mjolnir user a Matrix server admin.</p><p>Now invite the Mjolnir user to the management room.</p><p>It is recommended to use <a class="link" href="https://github.com/matrix-org/pantalaimon" target="_top">Pantalaimon</a>,
so your management room can be encrypted. This also applies if you are looking to moderate an encrypted room.</p><p>To enable the Pantalaimon E2E Proxy for mjolnir, enable
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.mjolnir.pantalaimon.enable">services.mjolnir.pantalaimon</a>. This will
autoconfigure a new Pantalaimon instance, which will connect to the homeserver
set in <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.mjolnir.homeserverUrl">services.mjolnir.homeserverUrl</a> and Mjolnir itself
will be configured to connect to the new Pantalaimon instance.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{
  services.mjolnir = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    homeserverUrl = <span class="hljs-string">"https://matrix.domain.tld"</span>;
    pantalaimon = {
       <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
       username = <span class="hljs-string">"mjolnir"</span>;
       passwordFile = <span class="hljs-string">"/run/secrets/mjolnir-password"</span>;
    };
    protectedRooms = [
      <span class="hljs-string">"https://matrix.to/#/!xxx:domain.tld"</span>
    ];
    managementRoom = <span class="hljs-string">"!yyy:domain.tld"</span>;
  };
}
</code></pre><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-mjolnir-setup-ems" class="title">Element Matrix Services (EMS)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir-setup-ems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If you are using a managed <a class="link" href="https://ems.element.io/" target="_top">“Element Matrix Services (EMS)”</a>
server, you will need to consent to the terms and conditions. Upon startup, an error
log entry with a URL to the consent page will be generated.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mjolnir-matrix-synapse-antispam" class="title" style="clear: both">Synapse Antispam Module   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mjolnir-matrix-synapse-antispam" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A Synapse module is also available to apply the same rulesets the bot
uses across an entire homeserver.</p><p>To use the Antispam Module, add <code class="literal">matrix-synapse-plugins.matrix-synapse-mjolnir-antispam</code>
to the Synapse plugin list and enable the <code class="literal">mjolnir.Module</code> module.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{
  services.matrix-synapse = {
    plugins = with pkgs; [
      matrix-synapse-plugins.matrix-synapse-mjolnir-antispam
    ];
    extraConfig = <span class="hljs-string">''</span>
      modules:
        - module: mjolnir.Module
          config:
            <span class="hljs-comment"># Prevent servers/users in the ban lists from inviting users on this</span>
            <span class="hljs-comment"># server to rooms. Default true.</span>
            block_invites: <span class="hljs-literal">true</span>
            <span class="hljs-comment"># Flag messages sent by servers/users in the ban lists as spam. Currently</span>
            <span class="hljs-comment"># this means that spammy messages will appear as empty to users. Default</span>
            <span class="hljs-comment"># false.</span>
            block_messages: <span class="hljs-literal">false</span>
            <span class="hljs-comment"># Remove users from the user directory search by filtering matrix IDs and</span>
            <span class="hljs-comment"># display names by the entries in the user ban list. Default false.</span>
            block_usernames: <span class="hljs-literal">false</span>
            <span class="hljs-comment"># The room IDs of the ban lists to honour. Unlike other parts of Mjolnir,</span>
            <span class="hljs-comment"># this list cannot be room aliases or permalinks. This server is expected</span>
            <span class="hljs-comment"># to already be joined to the room - Mjolnir will not automatically join</span>
            <span class="hljs-comment"># these rooms.</span>
            ban_lists:
              - <span class="hljs-string">"!roomid:example.org"</span>
    <span class="hljs-string">''</span>;
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman" class="title">Mailman   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mailman" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mailman-basic-usage">Basic usage with Postfix</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-mailman-other-mtas">Using with other MTAs</a> </span></dt> </dl></div><p><a class="link" href="https://www.list.org/" target="_top">Mailman</a> is free
software for managing electronic mail discussion and e-newsletter
lists. Mailman and its web interface can be configured using the
corresponding NixOS module. Note that this service is best used with
an existing, securely configured Postfix setup, as it does not automatically configure this.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman-basic-usage" class="title" style="clear: both">Basic usage with Postfix   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mailman-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>For a basic configuration with Postfix as the MTA, the following settings are suggested:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ config, ... }: {
  services.<span class="hljs-attr">postfix</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">relayDomains</span> = [<span class="hljs-string">"hash:/var/lib/mailman/data/postfix_domains"</span>];
    <span class="hljs-attr">sslCert</span> = config.security.acme.certs.<span class="hljs-string">"lists.example.org"</span>.directory + <span class="hljs-string">"/full.pem"</span>;
    <span class="hljs-attr">sslKey</span> = config.security.acme.certs.<span class="hljs-string">"lists.example.org"</span>.directory + <span class="hljs-string">"/key.pem"</span>;
    <span class="hljs-attr">config</span> = {
      <span class="hljs-attr">transport_maps</span> = [<span class="hljs-string">"hash:/var/lib/mailman/data/postfix_lmtp"</span>];
      <span class="hljs-attr">local_recipient_maps</span> = [<span class="hljs-string">"hash:/var/lib/mailman/data/postfix_lmtp"</span>];
    };
  };
  services.<span class="hljs-attr">mailman</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    serve.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    hyperkitty.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">webHosts</span> = [<span class="hljs-string">"lists.example.org"</span>];
    <span class="hljs-attr">siteOwner</span> = <span class="hljs-string">"mailman@example.org"</span>;
  };
  services.nginx.virtualHosts.<span class="hljs-string">"lists.example.org"</span>.<span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
  networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">25</span> <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
}
</code></pre><p>DNS records will also be required:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">AAAA</code> and <code class="literal">A</code> records pointing to the host in question, in order for browsers to be able to discover the address of the web server;</p></li><li class="listitem"><p>An <code class="literal">MX</code> record pointing to a domain name at which the host is reachable, in order for other mail servers to be able to deliver emails to the mailing lists it hosts.</p></li></ul></div><p>After this has been done and appropriate DNS records have been
set up, the Postorius mailing list manager and the Hyperkitty
archive browser will be available at
https://lists.example.org/. Note that this setup is not
sufficient to deliver emails to most email providers nor to
avoid spam – a number of additional measures for authenticating
incoming and outgoing mails, such as SPF, DMARC and DKIM are
necessary, but outside the scope of the Mailman module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-mailman-other-mtas" class="title" style="clear: both">Using with other MTAs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-mailman-other-mtas" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Mailman also supports other MTA, though with a little bit more configuration. For example, to use Mailman with Exim, you can use the following settings:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ config, ... }: {
  <span class="hljs-attr">services</span> = {
    <span class="hljs-attr">mailman</span> = {
      <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">siteOwner</span> = <span class="hljs-string">"mailman@example.org"</span>;
      <span class="hljs-attr">enablePostfix</span> = <span class="hljs-literal">false</span>;
      settings.<span class="hljs-attr">mta</span> = {
        <span class="hljs-attr">incoming</span> = <span class="hljs-string">"mailman.mta.exim4.LMTP"</span>;
        <span class="hljs-attr">outgoing</span> = <span class="hljs-string">"mailman.mta.deliver.deliver"</span>;
        <span class="hljs-attr">lmtp_host</span> = <span class="hljs-string">"localhost"</span>;
        <span class="hljs-attr">lmtp_port</span> = <span class="hljs-string">"8024"</span>;
        <span class="hljs-attr">smtp_host</span> = <span class="hljs-string">"localhost"</span>;
        <span class="hljs-attr">smtp_port</span> = <span class="hljs-string">"25"</span>;
        <span class="hljs-attr">configuration</span> = <span class="hljs-string">"python:mailman.config.exim4"</span>;
      };
    };
    <span class="hljs-attr">exim</span> = {
      <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-comment"># You can configure Exim in a separate file to reduce configuration.nix clutter</span>
      <span class="hljs-attr">config</span> = <span class="hljs-built_in">builtins</span>.readFile ./exim.conf;
    };
  };
}
</code></pre><p>The exim config needs some special additions to work with Mailman. Currently
NixOS can’t manage Exim config with such granularity. Please refer to
<a class="link" href="https://mailman.readthedocs.io/en/latest/src/mailman/docs/mta.html" target="_top">Mailman documentation</a>
for more info on configuring Mailman for working with Exim.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="trezor" class="title">Trezor   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#trezor" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Trezor is an open-source cryptocurrency hardware wallet and security token
allowing secure storage of private keys.</p><p>It offers advanced features such U2F two-factor authorization, SSH login
through
<a class="link" href="https://wiki.trezor.io/Apps:SSH_agent" target="_top">Trezor SSH agent</a>,
<a class="link" href="https://wiki.trezor.io/GPG" target="_top">GPG</a> and a
<a class="link" href="https://wiki.trezor.io/Trezor_Password_Manager" target="_top">password manager</a>.
For more information, guides and documentation, see <a class="link" href="https://wiki.trezor.io/" target="_top">https://wiki.trezor.io</a>.</p><p>To enable Trezor support, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.trezord.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>This will add all necessary udev rules and start Trezor Bridge.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs" class="title">Emacs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-installing">Installing Emacs</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-running">Running Emacs as a Service</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-emacs-configuring">Configuring Emacs</a> </span></dt> </dl></div><p><a class="link" href="https://www.gnu.org/software/emacs/" target="_top">Emacs</a> is an
extensible, customizable, self-documenting real-time display editor — and
more. At its core is an interpreter for Emacs Lisp, a dialect of the Lisp
programming language with extensions to support text editing.</p><p>Emacs runs within a graphical desktop environment using the X Window System,
but works equally well on a text terminal. Under
macOS, a “Mac port” edition is available, which
uses Apple’s native GUI frameworks.</p><p>Nixpkgs provides a superior environment for
running Emacs. It’s simple to create custom builds
by overriding the default packages. Chaotic collections of Emacs Lisp code
and extensions can be brought under control using declarative package
management. NixOS even provides a
<span class="command"><strong>systemd</strong></span> user service for automatically starting the Emacs
daemon.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-installing" class="title" style="clear: both">Installing Emacs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-installing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Emacs can be installed in the normal way for Nix (see
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-package-management" title="Package Management"><em>Package Management</em></a>). In addition, a NixOS
<span class="emphasis"><em>service</em></span> can be enabled.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-releases" class="title">The Different Releases of Emacs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-releases" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Nixpkgs defines several basic Emacs packages.
The following are attributes belonging to the <code class="varname">pkgs</code> set:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="varname">emacs</code></span></dt><dd><p>The latest stable version of Emacs using the <a class="link" href="http://www.gtk.org/" target="_top">GTK 2</a>
widget toolkit.</p></dd><dt><span class="term"><code class="varname">emacs-nox</code></span></dt><dd><p>Emacs built without any dependency on X11 libraries.</p></dd><dt><span class="term"><code class="varname">emacsMacport</code></span></dt><dd><p>Emacs with the “Mac port” patches, providing a more native look and
feel under macOS.</p></dd></dl></div><p>If those aren’t suitable, then the following imitation Emacs editors are
also available in Nixpkgs:
<a class="link" href="https://www.gnu.org/software/zile/" target="_top">Zile</a>,
<a class="link" href="http://homepage.boetes.org/software/mg/" target="_top">mg</a>,
<a class="link" href="http://yi-editor.github.io/" target="_top">Yi</a>,
<a class="link" href="https://joe-editor.sourceforge.io/" target="_top">jmacs</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-adding-packages" class="title">Adding Packages to Emacs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-adding-packages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Emacs includes an entire ecosystem of functionality beyond text editing,
including a project planner, mail and news reader, debugger interface,
calendar, and more.</p><p>Most extensions are gotten with the Emacs packaging system
(<code class="filename">package.el</code>) from
<a class="link" href="https://elpa.gnu.org/" target="_top">Emacs Lisp Package Archive (ELPA)</a>,
<a class="link" href="https://melpa.org/" target="_top">MELPA</a>,
<a class="link" href="https://stable.melpa.org/" target="_top">MELPA Stable</a>, and
<a class="link" href="http://orgmode.org/elpa.html" target="_top">Org ELPA</a>. Nixpkgs is
regularly updated to mirror all these archives.</p><p>Under NixOS, you can continue to use
<code class="literal">package-list-packages</code> and
<code class="literal">package-install</code> to install packages. You can also
declare the set of Emacs packages you need using the derivations from
Nixpkgs. The rest of this section discusses declarative installation of
Emacs packages through nixpkgs.</p><p>The first step to declare the list of packages you want in your Emacs
installation is to create a dedicated derivation. This can be done in a
dedicated <code class="filename">emacs.nix</code> file such as:</p><div class="example"><span id="ex-emacsNix"></span><p class="title"><strong>Example&nbsp;5.&nbsp;Nix expression to build Emacs with packages (<code class="literal">emacs.nix</code>)</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment">/*
This is a nix expression to build Emacs and some Emacs packages I like
from source on any distribution where Nix is installed. This will install
all the dependencies from the nixpkgs repository and build the binary files
without interfering with the host distribution.

To build the project, type the following from the current directory:

$ nix-build emacs.nix

To run the newly compiled executable:

$ ./result/bin/emacs
*/</span>

<span class="hljs-comment"># The first non-comment line in this file indicates that</span>
<span class="hljs-comment"># the whole file represents a function.</span>
{ pkgs ? <span class="hljs-built_in">import</span> &lt;nixpkgs&gt; {} }:

<span class="hljs-keyword">let</span>
  <span class="hljs-comment"># The let expression below defines a myEmacs binding pointing to the</span>
  <span class="hljs-comment"># current stable version of Emacs. This binding is here to separate</span>
  <span class="hljs-comment"># the choice of the Emacs binary from the specification of the</span>
  <span class="hljs-comment"># required packages.</span>
  <span class="hljs-attr">myEmacs</span> = pkgs.emacs;
  <span class="hljs-comment"># This generates an emacsWithPackages function. It takes a single</span>
  <span class="hljs-comment"># argument: a function from a package set to a list of packages</span>
  <span class="hljs-comment"># (the packages that will be available in Emacs).</span>
  <span class="hljs-attr">emacsWithPackages</span> = (pkgs.emacsPackagesFor myEmacs).emacsWithPackages;
<span class="hljs-keyword">in</span>
  <span class="hljs-comment"># The rest of the file specifies the list of packages to install. In the</span>
  <span class="hljs-comment"># example, two packages (magit and zerodark-theme) are taken from</span>
  <span class="hljs-comment"># MELPA stable.</span>
  emacsWithPackages (epkgs: (<span class="hljs-keyword">with</span> epkgs.melpaStablePackages; [
    magit          <span class="hljs-comment"># ; Integrate git &lt;C-x g&gt;</span>
    zerodark-theme <span class="hljs-comment"># ; Nicolas' theme</span>
  ])
  <span class="hljs-comment"># Two packages (undo-tree and zoom-frm) are taken from MELPA.</span>
  ++ (<span class="hljs-keyword">with</span> epkgs.melpaPackages; [
    undo-tree      <span class="hljs-comment"># ; &lt;C-x u&gt; to show the undo tree</span>
    zoom-frm       <span class="hljs-comment"># ; increase/decrease font size for all buffers %lt;C-x C-+&gt;</span>
  ])
  <span class="hljs-comment"># Three packages are taken from GNU ELPA.</span>
  ++ (<span class="hljs-keyword">with</span> epkgs.elpaPackages; [
    auctex         <span class="hljs-comment"># ; LaTeX mode</span>
    beacon         <span class="hljs-comment"># ; highlight my cursor when scrolling</span>
    nameless       <span class="hljs-comment"># ; hide current package name everywhere in elisp code</span>
  ])
  <span class="hljs-comment"># notmuch is taken from a nixpkgs derivation which contains an Emacs mode.</span>
  ++ [
    pkgs.notmuch   <span class="hljs-comment"># From main packages set</span>
  ])
</code></pre></div></div><br class="example-break"><p>The result of this configuration will be an <span class="command"><strong>emacs</strong></span>
command which launches Emacs with all of your chosen packages in the
<code class="varname">load-path</code>.</p><p>You can check that it works by executing this in a terminal:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build emacs.nix</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./result/bin/emacs -q</span>
</code></pre><p>and then typing <code class="literal">M-x package-initialize</code>. Check that you
can use all the packages you want in this Emacs instance. For example, try
switching to the zerodark theme through <code class="literal">M-x load-theme &lt;RET&gt; zerodark &lt;RET&gt; y</code>.</p><div class="tip"><h3 class="title">Tip</h3><p>A few popular extensions worth checking out are: auctex, company,
edit-server, flycheck, helm, iedit, magit, multiple-cursors, projectile,
and yasnippet.</p></div><p>The list of available packages in the various ELPA repositories can be seen
with the following commands:</p><div class="example"><span id="module-services-emacs-querying-packages"></span><p class="title"><strong>Example&nbsp;6.&nbsp;Querying Emacs packages</strong></p><div class="example-contents"><pre><code class="programlisting hljs language-bash" data-highlighted="yes">nix-env -f <span class="hljs-string">"&lt;nixpkgs&gt;"</span> -qaP -A emacs.pkgs.elpaPackages
nix-env -f <span class="hljs-string">"&lt;nixpkgs&gt;"</span> -qaP -A emacs.pkgs.melpaPackages
nix-env -f <span class="hljs-string">"&lt;nixpkgs&gt;"</span> -qaP -A emacs.pkgs.melpaStablePackages
nix-env -f <span class="hljs-string">"&lt;nixpkgs&gt;"</span> -qaP -A emacs.pkgs.orgPackages
</code></pre></div></div><br class="example-break"><p>If you are on NixOS, you can install this particular Emacs for all users by
adding it to the list of system packages (see
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-declarative-package-mgmt" title="Declarative Package Management">the section called “Declarative Package Management”</a>). Simply modify your file
<code class="filename">configuration.nix</code> to make it contain:</p><div class="example"><span id="module-services-emacs-configuration-nix"></span><p class="title"><strong>Example&nbsp;7.&nbsp;Custom Emacs in <code class="literal">configuration.nix</code></strong></p><div class="example-contents"><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
 environment.<span class="hljs-attr">systemPackages</span> = [
   <span class="hljs-comment"># [...]</span>
   (<span class="hljs-built_in">import</span> /path/to/emacs.nix { <span class="hljs-keyword">inherit</span> pkgs; })
  ];
}
</code></pre></div></div><br class="example-break"><p>In this case, the next <span class="command"><strong>nixos-rebuild switch</strong></span> will take
care of adding your <span class="command"><strong>emacs</strong></span> to the <code class="varname">PATH</code>
environment variable (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-changing-config" title="Changing the Configuration"><em>Changing the Configuration</em></a>).</p><p>If you are not on NixOS or want to install this particular Emacs only for
yourself, you can do so by adding it to your
<code class="filename">~/.config/nixpkgs/config.nix</code> (see
<a class="link" href="https://nixos.org/nixpkgs/manual/#sec-modify-via-packageOverrides" target="_top">Nixpkgs manual</a>):</p><div class="example"><span id="module-services-emacs-config-nix"></span><p class="title"><strong>Example&nbsp;8.&nbsp;Custom Emacs in <code class="literal">~/.config/nixpkgs/config.nix</code></strong></p><div class="example-contents"><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">packageOverrides</span> = super: <span class="hljs-keyword">let</span> <span class="hljs-attr">self</span> = super.pkgs; <span class="hljs-keyword">in</span> {
    <span class="hljs-attr">myemacs</span> = <span class="hljs-built_in">import</span> /path/to/emacs.nix { <span class="hljs-attr">pkgs</span> = self; };
  };
}
</code></pre></div></div><br class="example-break"><p>In this case, the next <code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA myemacs</code> will take care of adding your emacs to the
<code class="varname">PATH</code> environment variable.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-advanced" class="title">Advanced Emacs Configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-advanced" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If you want, you can tweak the Emacs package itself from your
<code class="filename">emacs.nix</code>. For example, if you want to have a
GTK 3-based Emacs instead of the default GTK 2-based binary and remove the
automatically generated <code class="filename">emacs.desktop</code> (useful if you
only use <span class="command"><strong>emacsclient</strong></span>), you can change your file
<code class="filename">emacs.nix</code> in this way:</p><div class="example"><span id="ex-emacsGtk3Nix"></span><p class="title"><strong>Example&nbsp;9.&nbsp;Custom Emacs build</strong></p><div class="example-contents"><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ pkgs ? import &lt;nixpkgs&gt; {} }:
<span class="hljs-built_in">let</span>
  myEmacs = (pkgs.emacs.override {
    <span class="hljs-comment"># Use gtk3 instead of the default gtk2</span>
    withGTK3 = <span class="hljs-literal">true</span>;
    withGTK2 = <span class="hljs-literal">false</span>;
  }).overrideAttrs (attrs: {
    <span class="hljs-comment"># I don't want emacs.desktop file because I only use</span>
    <span class="hljs-comment"># emacsclient.</span>
    postInstall = (attrs.postInstall or <span class="hljs-string">""</span>) + <span class="hljs-string">''</span>
      <span class="hljs-built_in">rm</span> <span class="hljs-variable">$out</span>/share/applications/emacs.desktop
    <span class="hljs-string">''</span>;
  });
<span class="hljs-keyword">in</span> [...]
</code></pre></div></div><br class="example-break"><p>After building this file as shown in <a class="xref" href="https://nixos.org/manual/nixos/stable/#ex-emacsNix" title="Example 5. Nix expression to build Emacs with packages (emacs.nix)">Example&nbsp;5</a>, you
will get an GTK 3-based Emacs binary pre-loaded with your favorite packages.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-running" class="title" style="clear: both">Running Emacs as a Service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-running" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS provides an optional
<span class="command"><strong>systemd</strong></span> service which launches
<a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html" target="_top">Emacs daemon</a>
with the user’s login session.</p><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/editors/emacs.nix</code></p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-enabling" class="title">Enabling the Service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-enabling" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>To install and enable the <span class="command"><strong>systemd</strong></span> user service for Emacs
daemon, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.emacs.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.emacs.<span class="hljs-attr">package</span> = <span class="hljs-built_in">import</span> /home/cassou/.emacs.d { <span class="hljs-attr">pkgs</span> = pkgs; };
</code></pre><p>The <code class="varname">services.emacs.package</code> option allows a custom
derivation to be used, for example, one created by
<code class="literal">emacsWithPackages</code>.</p><p>Ensure that the Emacs server is enabled for your user’s Emacs
configuration, either by customizing the <code class="varname">server-mode</code>
variable, or by adding <code class="literal">(server-start)</code> to
<code class="filename">~/.emacs.d/init.el</code>.</p><p>To start the daemon, execute the following:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-rebuild switch  <span class="hljs-comment"># to activate the new configuration.nix</span></span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user daemon-reload        <span class="hljs-comment"># to force systemd reload</span></span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user start emacs.service  <span class="hljs-comment"># to start the Emacs daemon</span></span>
</code></pre><p>The server should now be ready to serve Emacs clients.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-starting-client" class="title">Starting the client   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-starting-client" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Ensure that the Emacs server is enabled, either by customizing the
<code class="varname">server-mode</code> variable, or by adding
<code class="literal">(server-start)</code> to <code class="filename">~/.emacs</code>.</p><p>To connect to the Emacs daemon, run one of the following:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">emacsclient FILENAME
emacsclient --create-frame  <span class="hljs-comment"># opens a new frame (window)</span>
emacsclient --create-frame --tty  <span class="hljs-comment"># opens a new frame on the current terminal</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-editor-variable" class="title">Configuring the <code class="varname">EDITOR</code> variable   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-editor-variable" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.emacs.defaultEditor"><code class="option">services.emacs.defaultEditor</code></a> is
<code class="literal">true</code>, the <code class="varname">EDITOR</code> variable will be set
to a wrapper script which launches <span class="command"><strong>emacsclient</strong></span>.</p><p>Any setting of <code class="varname">EDITOR</code> in the shell config files will
override <code class="varname">services.emacs.defaultEditor</code>. To make sure
<code class="varname">EDITOR</code> refers to the Emacs wrapper script, remove any
existing <code class="varname">EDITOR</code> assignment from
<code class="filename">.profile</code>, <code class="filename">.bashrc</code>,
<code class="filename">.zshenv</code> or any other shell config file.</p><p>If you have formed certain bad habits when editing files, these can be
corrected with a shell alias to the wrapper script:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes"><span class="hljs-built_in">alias</span> vi=<span class="hljs-variable">$EDITOR</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-per-user" class="title">Per-User Enabling of the Service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-per-user" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>In general, <span class="command"><strong>systemd</strong></span> user services are globally enabled
by symlinks in <code class="filename">/etc/systemd/user</code>. In the case where
Emacs daemon is not wanted for all users, it is possible to install the
service but not globally enable it:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.emacs.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
services.emacs.<span class="hljs-attr">install</span> = <span class="hljs-literal">true</span>;
</code></pre><p>To enable the <span class="command"><strong>systemd</strong></span> user service for just the
currently logged in user, run:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">systemctl --user <span class="hljs-built_in">enable</span> emacs
</code></pre><p>This will add the symlink
<code class="filename">~/.config/systemd/user/emacs.service</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-emacs-configuring" class="title" style="clear: both">Configuring Emacs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If you want to only use extension packages from Nixpkgs, you can add
<code class="literal">(setq package-archives nil)</code> to your init file.</p><p>After the declarative Emacs package configuration has been tested,
previously downloaded packages can be cleaned up by removing
<code class="filename">~/.emacs.d/elpa</code> (do make a backup first, in case you
forgot a package).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-major-mode" class="title">A Major Mode for Nix Expressions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-major-mode" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Of interest may be <code class="varname">melpaPackages.nix-mode</code>, which
provides syntax highlighting for the Nix language. This is particularly
convenient if you regularly edit Nix files.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-emacs-man-pages" class="title">Accessing man pages   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-emacs-man-pages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>You can use <code class="literal">woman</code> to get completion of all available
man pages. For example, type <code class="literal">M-x woman &lt;RET&gt; nixos-rebuild &lt;RET&gt;.</code></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-emacs-docbook-xml" class="title">Editing DocBook 5 XML Documents   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-emacs-docbook-xml" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Emacs includes
<a class="link" href="https://www.gnu.org/software/emacs/manual/html_node/nxml-mode/Introduction.html" target="_top">nXML</a>,
a major-mode for validating and editing XML documents. When editing DocBook
5.0 documents, such as <a class="link" href="https://nixos.org/manual/nixos/stable/" title="NixOS Manual">this one</a>,
nXML needs to be configured with the relevant schema, which is not
included.</p><p>To install the DocBook 5.0 schemas, either add
<code class="varname">pkgs.docbook5</code> to <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>
(<a class="link" href="https://nixos.org/manual/nixos/stable/#sec-declarative-package-mgmt" title="Declarative Package Management">NixOS</a>), or run
<code class="literal">nix-env -f '&lt;nixpkgs&gt;' -iA docbook5</code>
(<a class="link" href="https://nixos.org/manual/nixos/stable/#sec-ad-hoc-packages" title="Ad-Hoc Package Management">Nix</a>).</p><p>Then customize the variable <code class="varname">rng-schema-locating-files</code> to
include <code class="filename">~/.emacs.d/schemas.xml</code> and put the following
text into that file:</p><div class="example"><span id="ex-emacs-docbook-xml"></span><p class="title"><strong>Example&nbsp;10.&nbsp;nXML Schema Configuration (<code class="literal">~/.emacs.d/schemas.xml</code>)</strong></p><div class="example-contents"><pre><code class="programlisting xml hljs language-shell" data-highlighted="yes">&lt;?xml version="1.0"?&gt;
&lt;!--
  To let emacs find this file, evaluate:
  (add-to-list 'rng-schema-locating-files "~/.emacs.d/schemas.xml")
<span class="hljs-meta prompt_">--&gt;</span><span class="language-bash">
&lt;locatingRules xmlns=<span class="hljs-string">"http://thaiopensource.com/ns/locating-rules/1.0"</span>&gt;</span>
  &lt;!--
    Use this variation if pkgs.docbook5 is added to environment.systemPackages
<span class="hljs-meta prompt_">  --&gt;</span><span class="language-bash">
  &lt;namespace ns=<span class="hljs-string">"http://docbook.org/ns/docbook"</span></span>
             uri="/run/current-system/sw/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;
  &lt;!--
    Use this variation if installing schema with "nix-env -iA pkgs.docbook5".
  &lt;namespace ns="http://docbook.org/ns/docbook"
             uri="../.nix-profile/share/xml/docbook-5.0/rng/docbookxi.rnc"/&gt;
<span class="hljs-meta prompt_">  --&gt;</span><span class="language-bash">
&lt;/locatingRules&gt;</span>
</code></pre></div></div><br class="example-break">
</div>

</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-livebook" class="title">Livebook   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-livebook" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-livebook-basic-usage">Basic Usage</a> </span></dt> </dl></div><p><a class="link" href="https://livebook.dev/" target="_top">Livebook</a> is a web application for writing
interactive and collaborative code notebooks.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-livebook-basic-usage" class="title" style="clear: both">Basic Usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-livebook-basic-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Enabling the <code class="literal">livebook</code> service creates a user
<a class="link" href="https://www.freedesktop.org/wiki/Software/systemd/" target="_top"><code class="literal">systemd</code></a> unit
which runs the server.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ ... }:

{
  services.livebook = {
    enableUserService = <span class="hljs-literal">true</span>;
    port = 20123;
    <span class="hljs-comment"># See note below about security</span>
    environmentFile = pkgs.writeText <span class="hljs-string">"livebook.env"</span> <span class="hljs-string">''</span>
      LIVEBOOK_PASSWORD = <span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>;
    <span class="hljs-string">''</span>;
  };
}
</code></pre><div class="note"><h3 class="title">Note</h3><p>The Livebook server has the ability to run any command as the user it
is running under, so securing access to it with a password is highly
recommended.</p><p>Putting the password in the Nix configuration like above is an easy
way to get started but it is not recommended in the real world because
the <code class="literal">livebook.env</code> file will be added to the world-readable Nix store.
A better approach would be to put the password in some secure
user-readable location and set <code class="literal">environmentFile = /home/user/secure/livebook.env</code>.</p></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-blackfire" class="title">Blackfire profiler   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-blackfire" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/development/blackfire.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://blackfire.io/docs/introduction" target="_top">https://blackfire.io/docs/introduction</a></p><p><a class="link" href="https://blackfire.io/" target="_top">Blackfire</a> is a proprietary tool for profiling applications. There are several languages supported by the product but currently only PHP support is packaged in Nixpkgs. The back-end consists of a module that is loaded into the language runtime (called <span class="emphasis"><em>probe</em></span>) and a service (<span class="emphasis"><em>agent</em></span>) that the probe connects to and that sends the profiles to the server.</p><p>To use it, you will need to enable the agent and the probe on your server. The exact method will depend on the way you use PHP but here is an example of NixOS configuration for PHP-FPM:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">php</span> = pkgs.php.withExtensions ({ enabled, all }: enabled ++ (<span class="hljs-keyword">with</span> all; [
    blackfire
  ]));
<span class="hljs-keyword">in</span> {
  <span class="hljs-comment"># Enable the probe extension for PHP-FPM.</span>
  services.<span class="hljs-attr">phpfpm</span> = {
    <span class="hljs-attr">phpPackage</span> = php;
  };

  <span class="hljs-comment"># Enable and configure the agent.</span>
  services.<span class="hljs-attr">blackfire-agent</span> = {
    <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">settings</span> = {
      <span class="hljs-comment"># You will need to get credentials at https://blackfire.io/my/settings/credentials</span>
      <span class="hljs-comment"># You can also use other options described in https://blackfire.io/docs/up-and-running/configuration/agent</span>
      <span class="hljs-attr">server-id</span> = <span class="hljs-string">"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"</span>;
      <span class="hljs-attr">server-token</span> = <span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>;
    };
  };

  <span class="hljs-comment"># Make the agent run on start-up.</span>
  <span class="hljs-comment"># (WantedBy= from the upstream unit not respected: https://github.com/NixOS/nixpkgs/issues/81138)</span>
  <span class="hljs-comment"># Alternately, you can start it manually with `systemctl start blackfire-agent`.</span>
  systemd.services.blackfire-agent.<span class="hljs-attr">wantedBy</span> = [ <span class="hljs-string">"phpfpm-foo.service"</span> ];
}
</code></pre><p>On your developer machine, you will also want to install <a class="link" href="https://blackfire.io/docs/up-and-running/installation#install-a-profiling-client" target="_top">the client</a> (see <code class="literal">blackfire</code> package) or the browser extension to actually trigger the profiling.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-flatpak" class="title">Flatpak   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-flatpak" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/desktop/flatpak.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top">https://github.com/flatpak/flatpak/wiki</a></p><p>Flatpak is a system for building, distributing, and running sandboxed desktop
applications on Linux.</p><p>To enable Flatpak, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">  services.flatpak.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>For the sandboxed apps to work correctly, desktop integration portals need to
be installed. If you run GNOME, this will be handled automatically for you;
in other cases, you will need to add something like the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">  xdg.portal.<span class="hljs-attr">extraPortals</span> = [ pkgs.xdg-desktop-portal-gtk ];
  xdg.portal.config.common.<span class="hljs-attr">default</span> = <span class="hljs-string">"gtk"</span>;
</code></pre><p>Then, you will need to add a repository, for example,
<a class="link" href="https://github.com/flatpak/flatpak/wiki" target="_top">Flathub</a>,
either using the following commands:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak update</span>
</code></pre><p>or by opening the
<a class="link" href="https://flathub.org/repo/flathub.flatpakrepo" target="_top">repository file</a> in GNOME Software.</p><p>Finally, you can search and install programs:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak search bustle</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak install flathub org.freedesktop.Bustle</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">flatpak run org.freedesktop.Bustle</span>
</code></pre><p>Again, GNOME Software offers graphical interface for these tasks.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-postgresql" class="title">PostgreSQL   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-postgresql" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing">Initializing</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-upgrading">Upgrading</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-options">Options</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-plugins">Plugins</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-postgres-jit">JIT (Just-In-Time compilation)</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/postgresql.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://www.postgresql.org/docs/" target="_top">https://www.postgresql.org/docs/</a></p><p>PostgreSQL is an advanced, free relational database.
</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-configuring" class="title" style="clear: both">Configuring   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To enable PostgreSQL, add the following to your <code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.postgresql.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.postgresql.<span class="hljs-attr">package</span> = pkgs.postgresql_15;
</code></pre><p>Note that you are required to specify the desired version of PostgreSQL (e.g. <code class="literal">pkgs.postgresql_15</code>). Since upgrading your PostgreSQL version requires a database dump and reload (see below), NixOS cannot provide a default value for <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a> such as the most recent release of PostgreSQL.</p><p>By default, PostgreSQL stores its databases in <code class="filename">/var/lib/postgresql/$psqlSchema</code>. You can override this using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a>, e.g.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.postgresql.<span class="hljs-attr">dataDir</span> = <span class="hljs-string">"/data/postgresql"</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-initializing" class="title" style="clear: both">Initializing   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>As of NixOS 23.11,
<code class="literal">services.postgresql.ensureUsers.*.ensurePermissions</code> has been
deprecated, after a change to default permissions in PostgreSQL 15
invalidated most of its previous use cases:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>In psql &lt; 15, <code class="literal">ALL PRIVILEGES</code> used to include <code class="literal">CREATE TABLE</code>, where
in psql &gt;= 15 that would be a separate permission</p></li><li class="listitem"><p>psql &gt;= 15 instead gives only the database owner create permissions</p></li><li class="listitem"><p>Even on psql &lt; 15 (or databases migrated to &gt;= 15), it is
recommended to manually assign permissions along these lines</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: circle;"><li class="listitem"><p>https://www.postgresql.org/docs/release/15.0/</p></li><li class="listitem"><p>https://www.postgresql.org/docs/15/ddl-schemas.html#DDL-SCHEMAS-PRIV</p></li></ul></div></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-postgres-initializing-ownership" class="title">Assigning ownership   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-ownership" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Usually, the database owner should be a database user of the same
name. This can be done with
<code class="literal">services.postgresql.ensureUsers.*.ensureDBOwnership = true;</code>.</p><p>If the database user name equals the connecting system user name,
postgres by default will accept a passwordless connection via unix
domain socket. This makes it possible to run many postgres-backed
services without creating any database secrets at all</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-postgres-initializing-extra-permissions" class="title">Assigning extra permissions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>For many cases, it will be enough to have the database user be the
owner. Until <code class="literal">services.postgresql.ensureUsers.*.ensurePermissions</code> has
been re-thought, if more users need access to the database, please use
one of the following approaches:</p><p><span class="strong"><strong>WARNING:</strong></span> <code class="literal">services.postgresql.initialScript</code> is not recommended
for <code class="literal">ensurePermissions</code> replacement, as that is <span class="emphasis"><em>only run on first
start of PostgreSQL</em></span>.</p><p><span class="strong"><strong>NOTE:</strong></span> all of these methods may be obsoleted, when <code class="literal">ensure*</code> is
reworked, but it is expected that they will stay viable for running
database migrations.</p><p><span class="strong"><strong>NOTE:</strong></span> please make sure that any added migrations are idempotent (re-runnable).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-postgres-initializing-extra-permissions-superuser" class="title">as superuser   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-superuser" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p><span class="strong"><strong>Advantage:</strong></span> compatible with postgres &lt; 15, because it’s run
as the database superuser <code class="literal">postgres</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-superuser-post-start" class="title">in database <code class="literal">postStart</code>   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-superuser-post-start" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h5>  </div> </div></div><p><span class="strong"><strong>Disadvantage:</strong></span> need to take care of ordering yourself. In this
example, <code class="literal">mkAfter</code> ensures that permissions are assigned after any
databases from <code class="literal">ensureDatabases</code> and <code class="literal">extraUser1</code> from <code class="literal">ensureUsers</code>
are already created.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">    systemd.services.postgresql.<span class="hljs-attr">postStart</span> = lib.mkAfter <span class="hljs-string">''
      $PSQL service1 -c 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO "extraUser1"'
      $PSQL service1 -c 'GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO "extraUser1"'
      # ....
    ''</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-superuser-oneshot" class="title">in intermediate oneshot service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-superuser-oneshot" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h5>  </div> </div></div><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">    systemd.services.<span class="hljs-string">"migrate-service1-db1"</span> = {
      serviceConfig.<span class="hljs-attr">Type</span> = <span class="hljs-string">"oneshot"</span>;
      <span class="hljs-attr">requiredBy</span> = <span class="hljs-string">"service1.service"</span>;
      <span class="hljs-attr">before</span> = <span class="hljs-string">"service1.service"</span>;
      <span class="hljs-attr">after</span> = <span class="hljs-string">"postgresql.service"</span>;
      serviceConfig.<span class="hljs-attr">User</span> = <span class="hljs-string">"postgres"</span>;
      environment.<span class="hljs-attr">PSQL</span> = <span class="hljs-string">"psql --port=<span class="hljs-subst">${<span class="hljs-built_in">toString</span> services.postgresql.port}</span>"</span>;
      <span class="hljs-attr">path</span> = [ postgresql ];
      <span class="hljs-attr">script</span> = <span class="hljs-string">''
        $PSQL service1 -c 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO "extraUser1"'
        $PSQL service1 -c 'GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO "extraUser1"'
        # ....
      ''</span>;
    };
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="module-services-postgres-initializing-extra-permissions-service-user" class="title">as service user   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-service-user" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p><span class="strong"><strong>Advantage:</strong></span> re-uses systemd’s dependency ordering;</p><p><span class="strong"><strong>Disadvantage:</strong></span> relies on service user having grant permission. To be combined with <code class="literal">ensureDBOwnership</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-service-user-pre-start" class="title">in service <code class="literal">preStart</code>   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-service-user-pre-start" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h5>  </div> </div></div><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">    environment.<span class="hljs-attr">PSQL</span> = <span class="hljs-string">"psql --port=<span class="hljs-subst">${<span class="hljs-built_in">toString</span> services.postgresql.port}</span>"</span>;
    <span class="hljs-attr">path</span> = [ postgresql ];
    systemd.services.<span class="hljs-string">"service1"</span>.<span class="hljs-attr">preStart</span> = <span class="hljs-string">''
      $PSQL -c 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO "extraUser1"'
      $PSQL -c 'GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO "extraUser1"'
      # ....
    ''</span>;
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h5 id="module-services-postgres-initializing-extra-permissions-service-user-oneshot" class="title">in intermediate oneshot service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-initializing-extra-permissions-service-user-oneshot" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h5>  </div> </div></div><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">    systemd.services.<span class="hljs-string">"migrate-service1-db1"</span> = {
      serviceConfig.<span class="hljs-attr">Type</span> = <span class="hljs-string">"oneshot"</span>;
      <span class="hljs-attr">requiredBy</span> = <span class="hljs-string">"service1.service"</span>;
      <span class="hljs-attr">before</span> = <span class="hljs-string">"service1.service"</span>;
      <span class="hljs-attr">after</span> = <span class="hljs-string">"postgresql.service"</span>;
      serviceConfig.<span class="hljs-attr">User</span> = <span class="hljs-string">"service1"</span>;
      environment.<span class="hljs-attr">PSQL</span> = <span class="hljs-string">"psql --port=<span class="hljs-subst">${<span class="hljs-built_in">toString</span> services.postgresql.port}</span>"</span>;
      <span class="hljs-attr">path</span> = [ postgresql ];
      <span class="hljs-attr">script</span> = <span class="hljs-string">''
        $PSQL -c 'GRANT SELECT ON ALL TABLES IN SCHEMA public TO "extraUser1"'
        $PSQL -c 'GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO "extraUser1"'
        # ....
      ''</span>;
    };
</code></pre>
</div>

</div>

</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-upgrading" class="title" style="clear: both">Upgrading   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-upgrading" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="note"><h3 class="title">Note</h3><p>The steps below demonstrate how to upgrade from an older version to <code class="literal">pkgs.postgresql_13</code>.
These instructions are also applicable to other versions.</p></div><p>Major PostgreSQL upgrades require a downtime and a few imperative steps to be called. This is the case because
each major version has some internal changes in the databases’ state during major releases. Because of that,
NixOS places the state into <code class="filename">/var/lib/postgresql/&amp;lt;version&amp;gt;</code> where each <code class="literal">version</code>
can be obtained like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">$ nix-instantiate --<span class="hljs-built_in">eval</span> -A postgresql_13.psqlSchema
<span class="hljs-string">"13"</span>
</code></pre><p>For an upgrade, a script like this can be used to simplify the process:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ config, pkgs, ... }:
{
  environment.systemPackages = [
    (<span class="hljs-built_in">let</span>
      <span class="hljs-comment"># XXX specify the postgresql package you'd like to upgrade to.</span>
      <span class="hljs-comment"># Do not forget to list the extensions you need.</span>
      newPostgres = pkgs.postgresql_13.withPackages (pp: [
        <span class="hljs-comment"># pp.plv8</span>
      ]);
    <span class="hljs-keyword">in</span> pkgs.writeScriptBin <span class="hljs-string">"upgrade-pg-cluster"</span> <span class="hljs-string">''</span>
      <span class="hljs-built_in">set</span> -eux
      <span class="hljs-comment"># XXX it's perhaps advisable to stop all services that depend on postgresql</span>
      systemctl stop postgresql

      <span class="hljs-built_in">export</span> NEWDATA=<span class="hljs-string">"/var/lib/postgresql/<span class="hljs-variable">${newPostgres.psqlSchema}</span>"</span>

      <span class="hljs-built_in">export</span> NEWBIN=<span class="hljs-string">"<span class="hljs-variable">${newPostgres}</span>/bin"</span>

      <span class="hljs-built_in">export</span> OLDDATA=<span class="hljs-string">"<span class="hljs-variable">${config.services.postgresql.dataDir}</span>"</span>
      <span class="hljs-built_in">export</span> OLDBIN=<span class="hljs-string">"<span class="hljs-variable">${config.services.postgresql.package}</span>/bin"</span>

      install -d -m 0700 -o postgres -g postgres <span class="hljs-string">"<span class="hljs-variable">$NEWDATA</span>"</span>
      <span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$NEWDATA</span>"</span>
      sudo -u postgres <span class="hljs-variable">$NEWBIN</span>/initdb -D <span class="hljs-string">"<span class="hljs-variable">$NEWDATA</span>"</span>

      sudo -u postgres <span class="hljs-variable">$NEWBIN</span>/pg_upgrade \
        --old-datadir <span class="hljs-string">"<span class="hljs-variable">$OLDDATA</span>"</span> --new-datadir <span class="hljs-string">"<span class="hljs-variable">$NEWDATA</span>"</span> \
        --old-bindir <span class="hljs-variable">$OLDBIN</span> --new-bindir <span class="hljs-variable">$NEWBIN</span> \
        <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
    <span class="hljs-string">''</span>)
  ];
}
</code></pre><p>The upgrade process is:</p><div class="orderedlist"><ol class="orderedlist " type="1"><li class="listitem"><p>Rebuild nixos configuration with the configuration above added to your <code class="filename">configuration.nix</code>. Alternatively, add that into separate file and reference it in <code class="literal">imports</code> list.</p></li><li class="listitem"><p>Login as root (<code class="literal">sudo su -</code>)</p></li><li class="listitem"><p>Run <code class="literal">upgrade-pg-cluster</code>. It will stop old postgresql, initialize a new one and migrate the old one to the new one. You may supply arguments like <code class="literal">--jobs 4</code> and <code class="literal">--link</code> to speedup migration process. See <a class="link" href="https://www.postgresql.org/docs/current/pgupgrade.html" target="_top">https://www.postgresql.org/docs/current/pgupgrade.html</a> for details.</p></li><li class="listitem"><p>Change postgresql package in NixOS configuration to the one you were upgrading to via <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.package"><code class="option">services.postgresql.package</code></a>. Rebuild NixOS. This should start new postgres using upgraded data directory and all services you stopped during the upgrade.</p></li><li class="listitem"><p>After the upgrade it’s advisable to analyze the new cluster.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>For PostgreSQL ≥ 14, use the <code class="literal">vacuumdb</code> command printed by the upgrades script.</p></li><li class="listitem"><p>For PostgreSQL &lt; 14, run (as <code class="literal">su -l postgres</code> in the <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.dataDir"><code class="option">services.postgresql.dataDir</code></a>, in this example <code class="filename">/var/lib/postgresql/13</code>):</p><pre><code class="programlisting hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./analyze_new_cluster.sh</span>
</code></pre></li></ul></div><div class="warning"><h3 class="title">Warning</h3><p>The next step removes the old state-directory!</p></div><pre><code class="programlisting hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./delete_old_cluster.sh</span>
</code></pre></li></ol></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-options" class="title" style="clear: both">Options   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-options" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A complete list of options for the PostgreSQL module may be found <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.enable">here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-plugins" class="title" style="clear: both">Plugins   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-plugins" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Plugins collection for each PostgreSQL version can be accessed with <code class="literal">.pkgs</code>. For example, for <code class="literal">pkgs.postgresql_15</code> package, its plugin collection is accessed by <code class="literal">pkgs.postgresql_15.pkgs</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix repl <span class="hljs-string">'&lt;nixpkgs&gt;'</span></span>

Loading '&lt;nixpkgs&gt;'...
Added 10574 variables.
<span class="hljs-meta prompt_">
nix-repl&gt; </span><span class="language-bash">postgresql_15.pkgs.&lt;TAB&gt;&lt;TAB&gt;</span>
postgresql_15.pkgs.cstore_fdw        postgresql_15.pkgs.pg_repack
postgresql_15.pkgs.pg_auto_failover  postgresql_15.pkgs.pg_safeupdate
postgresql_15.pkgs.pg_bigm           postgresql_15.pkgs.pg_similarity
postgresql_15.pkgs.pg_cron           postgresql_15.pkgs.pg_topn
postgresql_15.pkgs.pg_hll            postgresql_15.pkgs.pgjwt
postgresql_15.pkgs.pg_partman        postgresql_15.pkgs.pgroonga
...
</code></pre><p>To add plugins via NixOS configuration, set <code class="literal">services.postgresql.extraPlugins</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.postgresql.<span class="hljs-attr">package</span> = pkgs.postgresql_12;
services.postgresql.<span class="hljs-attr">extraPlugins</span> = <span class="hljs-keyword">with</span> pkgs.postgresql_12.pkgs; [
  pg_repack
  postgis
];
</code></pre><p>You can build custom PostgreSQL-with-plugins (to be used outside of NixOS) using function <code class="literal">.withPackages</code>. For example, creating a custom PostgreSQL package in an overlay can look like:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">self: super: {
  <span class="hljs-attr">postgresql_custom</span> = self.postgresql_12.withPackages (ps: [
    ps.pg_repack
    ps.postgis
  ]);
}
</code></pre><p>Here’s a recipe on how to override a particular plugin through an overlay:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">self: super: {
  <span class="hljs-attr">postgresql_15</span> = super.postgresql_15.override { <span class="hljs-attr">this</span> = self.postgresql_15; } // {
    <span class="hljs-attr">pkgs</span> = super.postgresql_15.pkgs // {
      <span class="hljs-attr">pg_repack</span> = super.postgresql_15.pkgs.pg_repack.overrideAttrs (_: {
        <span class="hljs-attr">name</span> = <span class="hljs-string">"pg_repack-v20181024"</span>;
        <span class="hljs-attr">src</span> = self.fetchzip {
          <span class="hljs-attr">url</span> = <span class="hljs-string">"https://github.com/reorg/pg_repack/archive/923fa2f3c709a506e111cc963034bf2fd127aa00.tar.gz"</span>;
          <span class="hljs-attr">sha256</span> = <span class="hljs-string">"17k6hq9xaax87yz79j773qyigm4fwk8z4zh5cyp6z0sxnwfqxxw5"</span>;
        };
      });
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-postgres-jit" class="title" style="clear: both">JIT (Just-In-Time compilation)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-postgres-jit" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><a class="link" href="https://www.postgresql.org/docs/current/jit-reason.html" target="_top">JIT</a>-support in the PostgreSQL package
is disabled by default because of the ~300MiB closure-size increase from the LLVM dependency. It
can be optionally enabled in PostgreSQL with the following config option:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  services.postgresql.<span class="hljs-attr">enableJIT</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>This makes sure that the <a class="link" href="https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-JIT" target="_top"><code class="literal">jit</code></a>-setting
is set to <code class="literal">on</code> and a PostgreSQL package with JIT enabled is used. Further tweaking of the JIT compiler, e.g. setting a different
query cost threshold via <a class="link" href="https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-JIT-ABOVE-COST" target="_top"><code class="literal">jit_above_cost</code></a>
can be done manually via <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.settings"><code class="literal">services.postgresql.settings</code></a>.</p><p>The attribute-names of JIT-enabled PostgreSQL packages are suffixed with <code class="literal">_jit</code>, i.e. for each <code class="literal">pkgs.postgresql</code>
(and <code class="literal">pkgs.postgresql_&lt;major&gt;</code>) in <code class="literal">nixpkgs</code> there’s also a <code class="literal">pkgs.postgresql_jit</code> (and <code class="literal">pkgs.postgresql_&lt;major&gt;_jit</code>).
Alternatively, a JIT-enabled variant can be derived from a given <code class="literal">postgresql</code> package via <code class="literal">postgresql.withJIT</code>.
This is also useful if it’s not clear which attribute from <code class="literal">nixpkgs</code> was originally used (e.g. when working with
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.postgresql.package"><code class="literal">config.services.postgresql.package</code></a> or if the package was modified via an
overlay) since all modifications are propagated to <code class="literal">withJIT</code>. I.e.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">with</span> <span class="hljs-built_in">import</span> &lt;nixpkgs&gt; {
  <span class="hljs-attr">overlays</span> = [
    (self: super: {
      <span class="hljs-attr">postgresql</span> = super.postgresql.overrideAttrs (_: { <span class="hljs-attr">pname</span> = <span class="hljs-string">"foobar"</span>; });
    })
  ];
};
postgresql.withJIT.pname
</code></pre><p>evaluates to <code class="literal">"foobar"</code>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb" class="title">FoundationDB   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-configuring">Configuring and basic setup</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-scaling">Scaling processes and backup agents</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-clustering">Clustering</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-connectivity">Client connectivity</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-authorization">Client authorization and TLS</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-disaster-recovery">Backups and Disaster Recovery</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-limitations">Known limitations</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-options">Options</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-full-docs">Full documentation</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/databases/foundationdb.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://apple.github.io/foundationdb/" target="_top">https://apple.github.io/foundationdb/</a></p><p><span class="emphasis"><em>Maintainer:</em></span> Austin Seipp</p><p><span class="emphasis"><em>Available version(s):</em></span> 7.1.x</p><p>FoundationDB (or “FDB”) is an open source, distributed, transactional
key-value store.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-configuring" class="title" style="clear: both">Configuring and basic setup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To enable FoundationDB, add the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.foundationdb.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
services.foundationdb.<span class="hljs-attr">package</span> = pkgs.foundationdb71; <span class="hljs-comment"># FoundationDB 7.1.x</span>
</code></pre><p>The <code class="option">services.foundationdb.package</code> option is required, and
must always be specified. Due to the fact FoundationDB network protocols and
on-disk storage formats may change between (major) versions, and upgrades
must be explicitly handled by the user, you must always manually specify
this yourself so that the NixOS module will use the proper version. Note
that minor, bugfix releases are always compatible.</p><p>After running <span class="command"><strong>nixos-rebuild</strong></span>, you can verify whether
FoundationDB is running by executing <span class="command"><strong>fdbcli</strong></span> (which is
added to <code class="option">environment.systemPackages</code>):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -u foundationdb fdbcli</span>
Using cluster file `/etc/foundationdb/fdb.cluster'.

The database is available.

Welcome to the fdbcli. For help, type `help'.
<span class="hljs-meta prompt_">fdb&gt; </span><span class="language-bash">status</span>

Using cluster file `/etc/foundationdb/fdb.cluster'.

Configuration:
  Redundancy mode        - single
  Storage engine         - memory
  Coordinators           - 1

Cluster:
  FoundationDB processes - 1
  Machines               - 1
  Memory availability    - 5.4 GB per process on machine with least available
  Fault Tolerance        - 0 machines
  Server time            - 04/20/18 15:21:14

...
<span class="hljs-meta prompt_">
fdb&gt;</span><span class="language-bash">
</span></code></pre><p>You can also write programs using the available client libraries. For
example, the following Python program can be run in order to grab the
cluster status, as a quick example. (This example uses
<span class="command"><strong>nix-shell</strong></span> shebang support to automatically supply the
necessary Python modules).</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">a@link&gt; </span><span class="language-bash"><span class="hljs-built_in">cat</span> fdb-status.py</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">! /usr/bin/env nix-shell</span>
<span class="hljs-meta prompt_">#</span><span class="language-bash">! nix-shell -i python -p python pythonPackages.foundationdb71</span>

import fdb
import json

def main():
    fdb.api_version(520)
    db = fdb.open()

    @fdb.transactional
    def get_status(tr):
        return str(tr['\xff\xff/status/json'])

    obj = json.loads(get_status(db))
    print('FoundationDB available: %s' % obj['client']['database_status']['available'])

if __name__ == "__main__":
    main()
<span class="hljs-meta prompt_">a@link&gt; </span><span class="language-bash"><span class="hljs-built_in">chmod</span> +x fdb-status.py</span>
<span class="hljs-meta prompt_">a@link&gt; </span><span class="language-bash">./fdb-status.py</span>
FoundationDB available: True
<span class="hljs-meta prompt_">a@link&gt;</span><span class="language-bash">
</span></code></pre><p>FoundationDB is run under the <span class="command"><strong>foundationdb</strong></span> user and group
by default, but this may be changed in the NixOS configuration. The systemd
unit <span class="command"><strong>foundationdb.service</strong></span> controls the
<span class="command"><strong>fdbmonitor</strong></span> process.</p><p>By default, the NixOS module for FoundationDB creates a single SSD-storage
based database for development and basic usage. This storage engine is
designed for SSDs and will perform poorly on HDDs; however it can handle far
more data than the alternative “memory” engine and is a better default
choice for most deployments. (Note that you can change the storage backend
on-the-fly for a given FoundationDB cluster using
<span class="command"><strong>fdbcli</strong></span>.)</p><p>Furthermore, only 1 server process and 1 backup agent are started in the
default configuration. See below for more on scaling to increase this.</p><p>FoundationDB stores all data for all server processes under
<code class="filename">/var/lib/foundationdb</code>. You can override this using
<code class="option">services.foundationdb.dataDir</code>, e.g.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.foundationdb.<span class="hljs-attr">dataDir</span> = <span class="hljs-string">"/data/fdb"</span>;
</code></pre><p>Similarly, logs are stored under <code class="filename">/var/log/foundationdb</code>
by default, and there is a corresponding
<code class="option">services.foundationdb.logDir</code> as well.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-scaling" class="title" style="clear: both">Scaling processes and backup agents   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-scaling" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Scaling the number of server processes is quite easy; simply specify
<code class="option">services.foundationdb.serverProcesses</code> to be the number of
FoundationDB worker processes that should be started on the machine.</p><p>FoundationDB worker processes typically require 4GB of RAM per-process at
minimum for good performance, so this option is set to 1 by default since
the maximum amount of RAM is unknown. You’re advised to abide by this
restriction, so pick a number of processes so that each has 4GB or more.</p><p>A similar option exists in order to scale backup agent processes,
<code class="option">services.foundationdb.backupProcesses</code>. Backup agents are
not as performance/RAM sensitive, so feel free to experiment with the number
of available backup processes.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-clustering" class="title" style="clear: both">Clustering   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-clustering" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>FoundationDB on NixOS works similarly to other Linux systems, so this
section will be brief. Please refer to the full FoundationDB documentation
for more on clustering.</p><p>FoundationDB organizes clusters using a set of
<span class="emphasis"><em>coordinators</em></span>, which are just specially-designated
worker processes. By default, every installation of FoundationDB on NixOS
will start as its own individual cluster, with a single coordinator: the
first worker process on <span class="command"><strong>localhost</strong></span>.</p><p>Coordinators are specified globally using the
<span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file, which all servers and
client applications will use to find and join coordinators. Note that this
file <span class="emphasis"><em>can not</em></span> be managed by NixOS so easily:
FoundationDB is designed so that it will rewrite the file at runtime for all
clients and nodes when cluster coordinators change, with clients
transparently handling this without intervention. It is fundamentally a
mutable file, and you should not try to manage it in any way in NixOS.</p><p>When dealing with a cluster, there are two main things you want to do:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Add a node to the cluster for storage/compute.</p></li><li class="listitem"><p>Promote an ordinary worker to a coordinator.</p></li></ul></div><p>A node must already be a member of the cluster in order to properly be
promoted to a coordinator, so you must always add it first if you wish to
promote it.</p><p>To add a machine to a FoundationDB cluster:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Choose one of the servers to start as the initial coordinator.</p></li><li class="listitem"><p>Copy the <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> file from this
server to all the other servers. Restart FoundationDB on all of these
other servers, so they join the cluster.</p></li><li class="listitem"><p>All of these servers are now connected and working together in the
cluster, under the chosen coordinator.</p></li></ul></div><p>At this point, you can add as many nodes as you want by just repeating the
above steps. By default there will still be a single coordinator: you can
use <span class="command"><strong>fdbcli</strong></span> to change this and add new coordinators.</p><p>As a convenience, FoundationDB can automatically assign coordinators based
on the redundancy mode you wish to achieve for the cluster. Once all the
nodes have been joined, simply set the replication policy, and then issue
the <span class="command"><strong>coordinators auto</strong></span> command</p><p>For example, assuming we have 3 nodes available, we can enable double
redundancy mode, then auto-select coordinators. For double redundancy, 3
coordinators is ideal: therefore FoundationDB will make
<span class="emphasis"><em>every</em></span> node a coordinator automatically:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">fdbcli&gt; </span><span class="language-bash">configure double ssd</span>
<span class="hljs-meta prompt_">fdbcli&gt; </span><span class="language-bash">coordinators auto</span>
</code></pre><p>This will transparently update all the servers within seconds, and
appropriately rewrite the <span class="command"><strong>fdb.cluster</strong></span> file, as well as
informing all client processes to do the same.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-connectivity" class="title" style="clear: both">Client connectivity   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-connectivity" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, all clients must use the current <span class="command"><strong>fdb.cluster</strong></span>
file to access a given FoundationDB cluster. This file is located by default
in <span class="command"><strong>/etc/foundationdb/fdb.cluster</strong></span> on all machines with the
FoundationDB service enabled, so you may copy the active one from your
cluster to a new node in order to connect, if it is not part of the cluster.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-authorization" class="title" style="clear: both">Client authorization and TLS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-authorization" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, any user who can connect to a FoundationDB process with the
correct cluster configuration can access anything. FoundationDB uses a
pluggable design to transport security, and out of the box it supports a
LibreSSL-based plugin for TLS support. This plugin not only does in-flight
encryption, but also performs client authorization based on the given
endpoint’s certificate chain. For example, a FoundationDB server may be
configured to only accept client connections over TLS, where the client TLS
certificate is from organization <span class="emphasis"><em>Acme Co</em></span> in the
<span class="emphasis"><em>Research and Development</em></span> unit.</p><p>Configuring TLS with FoundationDB is done using the
<code class="option">services.foundationdb.tls</code> options in order to control the
peer verification string, as well as the certificate and its private key.</p><p>Note that the certificate and its private key must be accessible to the
FoundationDB user account that the server runs under. These files are also
NOT managed by NixOS, as putting them into the store may reveal private
information.</p><p>After you have a key and certificate file in place, it is not enough to
simply set the NixOS module options – you must also configure the
<span class="command"><strong>fdb.cluster</strong></span> file to specify that a given set of
coordinators use TLS. This is as simple as adding the suffix
<span class="command"><strong>:tls</strong></span> to your cluster coordinator configuration, after the
port number. For example, assuming you have a coordinator on localhost with
the default configuration, simply specifying:</p><pre><code class="programlisting hljs language-undefined" data-highlighted="yes">XXXXXX:XXXXXX@127.0.0.1:4500:tls
</code></pre><p>will configure all clients and server processes to use TLS from now on.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-disaster-recovery" class="title" style="clear: both">Backups and Disaster Recovery   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-disaster-recovery" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The usual rules for doing FoundationDB backups apply on NixOS as written in
the FoundationDB manual. However, one important difference is the security
profile for NixOS: by default, the <span class="command"><strong>foundationdb</strong></span> systemd
unit uses <span class="emphasis"><em>Linux namespaces</em></span> to restrict write access to
the system, except for the log directory, data directory, and the
<span class="command"><strong>/etc/foundationdb/</strong></span> directory. This is enforced by default
and cannot be disabled.</p><p>However, a side effect of this is that the <span class="command"><strong>fdbbackup</strong></span>
command doesn’t work properly for local filesystem backups: FoundationDB
uses a server process alongside the database processes to perform backups
and copy the backups to the filesystem. As a result, this process is put
under the restricted namespaces above: the backup process can only write to
a limited number of paths.</p><p>In order to allow flexible backup locations on local disks, the FoundationDB
NixOS module supports a
<code class="option">services.foundationdb.extraReadWritePaths</code> option. This
option takes a list of paths, and adds them to the systemd unit, allowing
the processes inside the service to write (and read) the specified
directories.</p><p>For example, to create backups in <span class="command"><strong>/opt/fdb-backups</strong></span>, first
set up the paths in the module options:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.foundationdb.<span class="hljs-attr">extraReadWritePaths</span> = [ <span class="hljs-string">"/opt/fdb-backups"</span> ];
</code></pre><p>Restart the FoundationDB service, and it will now be able to write to this
directory (even if it does not yet exist.) Note: this path
<span class="emphasis"><em>must</em></span> exist before restarting the unit. Otherwise,
systemd will not include it in the private FoundationDB namespace (and it
will not add it dynamically at runtime).</p><p>You can now perform a backup:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -u foundationdb fdbbackup start  -t default -d file:///opt/fdb-backups</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">sudo -u foundationdb fdbbackup status -t default</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-limitations" class="title" style="clear: both">Known limitations   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-limitations" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The FoundationDB setup for NixOS should currently be considered beta.
FoundationDB is not new software, but the NixOS compilation and integration
has only undergone fairly basic testing of all the available functionality.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>There is no way to specify individual parameters for individual
<span class="command"><strong>fdbserver</strong></span> processes. Currently, all server processes
inherit all the global <span class="command"><strong>fdbmonitor</strong></span> settings.</p></li><li class="listitem"><p>Ruby bindings are not currently installed.</p></li><li class="listitem"><p>Go bindings are not currently installed.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-options" class="title" style="clear: both">Options   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-options" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS’s FoundationDB module allows you to configure all of the most relevant
configuration options for <span class="command"><strong>fdbmonitor</strong></span>, matching it quite
closely. A complete list of options for the FoundationDB module may be found
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.foundationdb.enable">here</a>. You should
also read the FoundationDB documentation as well.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-foundationdb-full-docs" class="title" style="clear: both">Full documentation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-foundationdb-full-docs" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>FoundationDB is a complex piece of software, and requires careful
administration to properly use. Full documentation for administration can be
found here: <a class="link" href="https://apple.github.io/foundationdb/" target="_top">https://apple.github.io/foundationdb/</a>.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-borgbase" class="title">BorgBackup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-borgbase" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-backup-borgbackup-configuring">Configuring</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-local-directory">Basic usage for a local backup</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#opt-services-backup-create-server">Create a borg backup server</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-remote-server">Backup to the borg repository server</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-borgbase">Backup to a hosting service</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-vorta">Vorta backup client for the desktop</a> </span></dt> </dl></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/services/backup/borgbackup.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://borgbackup.readthedocs.io/" target="_top">https://borgbackup.readthedocs.io/</a></p><p><a class="link" href="https://www.borgbackup.org/" target="_top">BorgBackup</a> (short: Borg)
is a deduplicating backup program. Optionally, it supports compression and
authenticated encryption.</p><p>The main goal of Borg is to provide an efficient and secure way to backup
data. The data deduplication technique used makes Borg suitable for daily
backups since only changes are stored. The authenticated encryption technique
makes it suitable for backups to not fully trusted targets.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-backup-borgbackup-configuring" class="title" style="clear: both">Configuring   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-backup-borgbackup-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A complete list of options for the Borgbase module may be found
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.borgbackup.jobs">here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-local-directory" class="title" style="clear: both">Basic usage for a local backup   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-local-directory" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A very basic configuration for backing up to a locally accessible directory is:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
    opt.services.borgbackup.<span class="hljs-attr">jobs</span> = {
      { <span class="hljs-attr">rootBackup</span> = {
          <span class="hljs-attr">paths</span> = <span class="hljs-string">"/"</span>;
          <span class="hljs-attr">exclude</span> = [ <span class="hljs-string">"/nix"</span> <span class="hljs-string">"/path/to/local/repo"</span> ];
          <span class="hljs-attr">repo</span> = <span class="hljs-string">"/path/to/local/repo"</span>;
          <span class="hljs-attr">doInit</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-attr">encryption</span> = {
            <span class="hljs-attr">mode</span> = <span class="hljs-string">"repokey"</span>;
            <span class="hljs-attr">passphrase</span> = <span class="hljs-string">"secret"</span>;
          };
          <span class="hljs-attr">compression</span> = <span class="hljs-string">"auto,lzma"</span>;
          <span class="hljs-attr">startAt</span> = <span class="hljs-string">"weekly"</span>;
        };
      }
    };
}
</code></pre><div class="warning"><h3 class="title">Warning</h3><p>If you do not want the passphrase to be stored in the world-readable
Nix store, use passCommand. You find an example below.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-create-server" class="title" style="clear: both">Create a borg backup server   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#opt-services-backup-create-server" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You should use a different SSH key for each repository you write to,
because the specified keys are restricted to running borg serve and can only
access this single repository. You need the output of the generate pub file.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">sudo ssh-keygen -N <span class="hljs-string">''</span> -t ed25519 -f /run/keys/id_ed25519_my_borg_repo</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cat</span> /run/keys/id_ed25519_my_borg_repo</span>
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos
</code></pre><p>Add the following snippet to your NixOS configuration:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.borgbackup.<span class="hljs-attr">repos</span> = {
    <span class="hljs-attr">my_borg_repo</span> = {
      <span class="hljs-attr">authorizedKeys</span> = [
        <span class="hljs-string">"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAID78zmOyA+5uPG4Ot0hfAy+sLDPU1L4AiIoRYEIVbbQ/ root@nixos"</span>
      ] ;
      <span class="hljs-attr">path</span> = <span class="hljs-string">"/var/lib/my_borg_repo"</span> ;
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-remote-server" class="title" style="clear: both">Backup to the borg repository server   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-remote-server" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The following NixOS snippet creates an hourly backup to the service
(on the host nixos) as created in the section above. We assume
that you have stored a secret passphrasse in the file
<code class="filename">/run/keys/borgbackup_passphrase</code>, which should be only
accessible by root</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  services.borgbackup.<span class="hljs-attr">jobs</span> = {
    <span class="hljs-attr">backupToLocalServer</span> = {
      <span class="hljs-attr">paths</span> = [ <span class="hljs-string">"/etc/nixos"</span> ];
      <span class="hljs-attr">doInit</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">repo</span> =  <span class="hljs-string">"borg@nixos:."</span> ;
      <span class="hljs-attr">encryption</span> = {
        <span class="hljs-attr">mode</span> = <span class="hljs-string">"repokey-blake2"</span>;
        <span class="hljs-attr">passCommand</span> = <span class="hljs-string">"cat /run/keys/borgbackup_passphrase"</span>;
      };
      <span class="hljs-attr">environment</span> = { <span class="hljs-attr">BORG_RSH</span> = <span class="hljs-string">"ssh -i /run/keys/id_ed25519_my_borg_repo"</span>; };
      <span class="hljs-attr">compression</span> = <span class="hljs-string">"auto,lzma"</span>;
      <span class="hljs-attr">startAt</span> = <span class="hljs-string">"hourly"</span>;
    };
  };
};
</code></pre><p>The following few commands (run as root) let you test your backup.</p><pre><code class="programlisting hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">nixos-rebuild switch</span>
...restarting the following units: polkit.service
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">systemctl restart borgbackup-job-backupToLocalServer</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-built_in">sleep</span> 10</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">systemctl restart borgbackup-job-backupToLocalServer</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash"><span class="hljs-built_in">export</span> BORG_PASSPHRASE=topSecrect</span>
<span class="hljs-meta prompt_">&gt; </span><span class="language-bash">borg list --rsh=<span class="hljs-string">'ssh -i /run/keys/id_ed25519_my_borg_repo'</span> borg@nixos:.</span>
nixos-backupToLocalServer-2020-03-30T21:46:17 Mon, 2020-03-30 21:46:19 [84feb97710954931ca384182f5f3cb90665f35cef214760abd7350fb064786ac]
nixos-backupToLocalServer-2020-03-30T21:46:30 Mon, 2020-03-30 21:46:32 [e77321694ecd160ca2228611747c6ad1be177d6e0d894538898de7a2621b6e68]
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-borgbase" class="title" style="clear: both">Backup to a hosting service   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-borgbase" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Several companies offer <a class="link" href="https://www.borgbackup.org/support/commercial.html" target="_top">(paid) hosting services</a>
for Borg repositories.</p><p>To backup your home directory to borgbase you have to:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Generate a SSH key without a password, to access the remote server. E.g.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">sudo ssh-keygen -N <span class="hljs-string">''</span> -t ed25519 -f /run/keys/id_ed25519_borgbase
</code></pre></li><li class="listitem"><p>Create the repository on the server by following the instructions for your
hosting server.</p></li><li class="listitem"><p>Initialize the repository on the server. Eg.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">sudo borg init <span class="hljs-attr">--encryption=repokey-blake2</span>  \
    --rsh <span class="hljs-string">"ssh -i /run/keys/id_ed25519_borgbase"</span> \
    zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo
</code></pre></li><li class="listitem"><p>Add it to your NixOS configuration, e.g.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
    services.borgbackup.<span class="hljs-attr">jobs</span> = {
    <span class="hljs-attr">my_Remote_Backup</span> = {
        <span class="hljs-attr">paths</span> = [ <span class="hljs-string">"/"</span> ];
        <span class="hljs-attr">exclude</span> = [ <span class="hljs-string">"/nix"</span> <span class="hljs-string">"'**/.cache'"</span> ];
        <span class="hljs-attr">repo</span> =  <span class="hljs-string">"zzz2aaaaa@zzz2aaaaa.repo.borgbase.com:repo"</span>;
          <span class="hljs-attr">encryption</span> = {
          <span class="hljs-attr">mode</span> = <span class="hljs-string">"repokey-blake2"</span>;
          <span class="hljs-attr">passCommand</span> = <span class="hljs-string">"cat /run/keys/borgbackup_passphrase"</span>;
        };
        <span class="hljs-attr">environment</span> = { <span class="hljs-attr">BORG_RSH</span> = <span class="hljs-string">"ssh -i /run/keys/id_ed25519_borgbase"</span>; };
        <span class="hljs-attr">compression</span> = <span class="hljs-string">"auto,lzma"</span>;
        <span class="hljs-attr">startAt</span> = <span class="hljs-string">"daily"</span>;
    };
  };
}}
</code></pre></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="opt-services-backup-borgbackup-vorta" class="title" style="clear: both">Vorta backup client for the desktop   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#opt-services-backup-borgbackup-vorta" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Vorta is a backup client for macOS and Linux desktops. It integrates the
mighty BorgBackup with your desktop environment to protect your data from
disk failure, ransomware and theft.</p><p>It can be installed in NixOS e.g. by adding <code class="literal">pkgs.vorta</code>
to <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-environment.systemPackages"><code class="option">environment.systemPackages</code></a>.</p><p>Details about using Vorta can be found under
<a class="link" href="https://vorta.borgbase.com/usage" target="_top">https://vorta.borgbase.com</a> .</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-castopod" class="title">Castopod   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-castopod" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-castopod-quickstart">Quickstart</a> </span></dt> </dl></div><p>Castopod is an open-source hosting platform made for podcasters who want to engage and interact with their audience.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-castopod-quickstart" class="title" style="clear: both">Quickstart   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-castopod-quickstart" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Use the following configuration to start a public instance of Castopod on <code class="literal">castopod.example.com</code> domain:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.firewall.<span class="hljs-attr">allowedTCPPorts</span> = [ <span class="hljs-number">80</span> <span class="hljs-number">443</span> ];
services.<span class="hljs-attr">castopod</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  database.<span class="hljs-attr">createLocally</span> = <span class="hljs-literal">true</span>;
  nginx.<span class="hljs-attr">virtualHost</span> = {
    <span class="hljs-attr">serverName</span> = <span class="hljs-string">"castopod.example.com"</span>;
    <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
  };
};
</code></pre><p>Go to <code class="literal">https://castopod.example.com/cp-install</code> to create superadmin account after applying the above configuration.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme" class="title">SSL/TLS Certificates with ACME   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-prerequisites">Prerequisites</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-nginx">Using ACME certificates in Nginx</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-httpd">Using ACME certificates in Apache/httpd</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-configuring">Manual configuration of HTTP-01 validation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-config-dns">Configuring ACME for DNS validation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-config-dns-with-vhosts">Using DNS validation with web server virtual hosts</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-root-owned">Using ACME with services demanding root owned certificates</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-regenerate">Regenerating certificates</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-security-acme-fix-jws">Fixing JWS Verification error</a> </span></dt> </dl></div><p>NixOS supports automatic domain validation &amp; certificate retrieval and
renewal using the ACME protocol. Any provider can be used, but by default
NixOS uses Let’s Encrypt. The alternative ACME client
<a class="link" href="https://go-acme.github.io/lego/" target="_top">lego</a> is used under
the hood.</p><p>Automatic cert validation and configuration for Apache and Nginx virtual
hosts is included in NixOS, however if you would like to generate a wildcard
cert or you are not using a web server you will have to configure DNS
based validation.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-prerequisites" class="title" style="clear: both">Prerequisites   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-prerequisites" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To use the ACME module, you must accept the provider’s terms of service
by setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.acceptTerms"><code class="option">security.acme.acceptTerms</code></a>
to <code class="literal">true</code>. The Let’s Encrypt ToS can be found
<a class="link" href="https://letsencrypt.org/repository/" target="_top">here</a>.</p><p>You must also set an email address to be used when creating accounts with
Let’s Encrypt. You can set this for all certs with
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.defaults.email"><code class="option">security.acme.defaults.email</code></a>
and/or on a per-cert basis with
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.certs._name_.email"><code class="option">security.acme.certs.&lt;name&gt;.email</code></a>.
This address is only used for registration and renewal reminders,
and cannot be used to administer the certificates in any way.</p><p>Alternatively, you can use a different ACME server by changing the
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.defaults.server"><code class="option">security.acme.defaults.server</code></a> option
to a provider of your choosing, or just change the server for one cert with
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.certs._name_.server"><code class="option">security.acme.certs.&lt;name&gt;.server</code></a>.</p><p>You will need an HTTP server or DNS server for verification. For HTTP,
the server must have a webroot defined that can serve
<code class="filename">.well-known/acme-challenge</code>. This directory must be
writeable by the user that will run the ACME client. For DNS, you must
set up credentials with your provider/server for use with lego.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-nginx" class="title" style="clear: both">Using ACME certificates in Nginx   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-nginx" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>NixOS supports fetching ACME certificates for you by setting
<code class="literal">enableACME = true;</code> in a virtualHost config. We first create self-signed
placeholder certificates in place of the real ACME certs. The placeholder
certs are overwritten when the ACME certs arrive. For
<code class="literal">foo.example.com</code> the config would look like this:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
security.acme.defaults.<span class="hljs-attr">email</span> = <span class="hljs-string">"admin+acme@example.com"</span>;
services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">virtualHosts</span> = {
    <span class="hljs-string">"foo.example.com"</span> = {
      <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-comment"># All serverAliases will be added as extra domain names on the certificate.</span>
      <span class="hljs-attr">serverAliases</span> = [ <span class="hljs-string">"bar.example.com"</span> ];
      locations.<span class="hljs-string">"/"</span> = {
        <span class="hljs-attr">root</span> = <span class="hljs-string">"/var/www"</span>;
      };
    };

    <span class="hljs-comment"># We can also add a different vhost and reuse the same certificate</span>
    <span class="hljs-comment"># but we have to append extraDomainNames manually beforehand:</span>
    <span class="hljs-comment"># security.acme.certs."foo.example.com".extraDomainNames = [ "baz.example.com" ];</span>
    <span class="hljs-string">"baz.example.com"</span> = {
      <span class="hljs-attr">forceSSL</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">useACMEHost</span> = <span class="hljs-string">"foo.example.com"</span>;
      locations.<span class="hljs-string">"/"</span> = {
        <span class="hljs-attr">root</span> = <span class="hljs-string">"/var/www"</span>;
      };
    };
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-httpd" class="title" style="clear: both">Using ACME certificates in Apache/httpd   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-httpd" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Using ACME certificates with Apache virtual hosts is identical
to using them with Nginx. The attribute names are all the same, just replace
“nginx” with “httpd” where appropriate.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-configuring" class="title" style="clear: both">Manual configuration of HTTP-01 validation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-configuring" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>First off you will need to set up a virtual host to serve the challenges.
This example uses a vhost called <code class="literal">certs.example.com</code>, with
the intent that you will generate certs for all your vhosts and redirect
everyone to HTTPS.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
security.acme.defaults.<span class="hljs-attr">email</span> = <span class="hljs-string">"admin+acme@example.com"</span>;

<span class="hljs-comment"># /var/lib/acme/.challenges must be writable by the ACME user</span>
<span class="hljs-comment"># and readable by the Nginx user. The easiest way to achieve</span>
<span class="hljs-comment"># this is to add the Nginx user to the ACME group.</span>
users.users.nginx.<span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">"acme"</span> ];

services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">virtualHosts</span> = {
    <span class="hljs-string">"acmechallenge.example.com"</span> = {
      <span class="hljs-comment"># Catchall vhost, will redirect users to HTTPS for all vhosts</span>
      <span class="hljs-attr">serverAliases</span> = [ <span class="hljs-string">"*.example.com"</span> ];
      locations.<span class="hljs-string">"/.well-known/acme-challenge"</span> = {
        <span class="hljs-attr">root</span> = <span class="hljs-string">"/var/lib/acme/.challenges"</span>;
      };
      locations.<span class="hljs-string">"/"</span> = {
        <span class="hljs-attr">return</span> = <span class="hljs-string">"301 https://$host$request_uri"</span>;
      };
    };
  };
}
<span class="hljs-comment"># Alternative config for Apache</span>
users.users.wwwrun.<span class="hljs-attr">extraGroups</span> = [ <span class="hljs-string">"acme"</span> ];
services.<span class="hljs-attr">httpd</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">virtualHosts</span> = {
    <span class="hljs-string">"acmechallenge.example.com"</span> = {
      <span class="hljs-comment"># Catchall vhost, will redirect users to HTTPS for all vhosts</span>
      <span class="hljs-attr">serverAliases</span> = [ <span class="hljs-string">"*.example.com"</span> ];
      <span class="hljs-comment"># /var/lib/acme/.challenges must be writable by the ACME user and readable by the Apache user.</span>
      <span class="hljs-comment"># By default, this is the case.</span>
      <span class="hljs-attr">documentRoot</span> = <span class="hljs-string">"/var/lib/acme/.challenges"</span>;
      <span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
        RewriteEngine On
        RewriteCond %{HTTPS} off
        RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge [NC]
        RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R=301]
      ''</span>;
    };
  };
}
</code></pre><p>Now you need to configure ACME to generate a certificate.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">security.acme.certs.<span class="hljs-string">"foo.example.com"</span> = {
  <span class="hljs-attr">webroot</span> = <span class="hljs-string">"/var/lib/acme/.challenges"</span>;
  <span class="hljs-attr">email</span> = <span class="hljs-string">"foo@example.com"</span>;
  <span class="hljs-comment"># Ensure that the web server you use can read the generated certs</span>
  <span class="hljs-comment"># Take a look at the group option for the web server you choose.</span>
  <span class="hljs-attr">group</span> = <span class="hljs-string">"nginx"</span>;
  <span class="hljs-comment"># Since we have a wildcard vhost to handle port 80,</span>
  <span class="hljs-comment"># we can generate certs for anything!</span>
  <span class="hljs-comment"># Just make sure your DNS resolves them.</span>
  <span class="hljs-attr">extraDomainNames</span> = [ <span class="hljs-string">"mail.example.com"</span> ];
};
</code></pre><p>The private key <code class="filename">key.pem</code> and certificate
<code class="filename">fullchain.pem</code> will be put into
<code class="filename">/var/lib/acme/foo.example.com</code>.</p><p>Refer to <a class="xref" href="https://nixos.org/manual/nixos/stable/options" title="Appendix A. Configuration Options">Appendix&nbsp;A</a> for all available configuration
options for the <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.certs">security.acme</a>
module.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-config-dns" class="title" style="clear: both">Configuring ACME for DNS validation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-config-dns" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This is useful if you want to generate a wildcard certificate, since
ACME servers will only hand out wildcard certs over DNS validation.
There are a number of supported DNS providers and servers you can utilise,
see the <a class="link" href="https://go-acme.github.io/lego/dns/" target="_top">lego docs</a>
for provider/server specific configuration values. For the sake of these
docs, we will provide a fully self-hosted example using bind.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">bind</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">extraConfig</span> = <span class="hljs-string">''
    include "/var/lib/secrets/dnskeys.conf";
  ''</span>;
  <span class="hljs-attr">zones</span> = [
    <span class="hljs-keyword">rec</span> {
      <span class="hljs-attr">name</span> = <span class="hljs-string">"example.com"</span>;
      <span class="hljs-attr">file</span> = <span class="hljs-string">"/var/db/bind/<span class="hljs-subst">${name}</span>"</span>;
      <span class="hljs-attr">master</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">extraConfig</span> = <span class="hljs-string">"allow-update { key rfc2136key.example.com.; };"</span>;
    }
  ];
}

<span class="hljs-comment"># Now we can configure ACME</span>
security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
security.acme.defaults.<span class="hljs-attr">email</span> = <span class="hljs-string">"admin+acme@example.com"</span>;
security.acme.certs.<span class="hljs-string">"example.com"</span> = {
  <span class="hljs-attr">domain</span> = <span class="hljs-string">"*.example.com"</span>;
  <span class="hljs-attr">dnsProvider</span> = <span class="hljs-string">"rfc2136"</span>;
  <span class="hljs-attr">environmentFile</span> = <span class="hljs-string">"/var/lib/secrets/certs.secret"</span>;
  <span class="hljs-comment"># We don't need to wait for propagation since this is a local DNS server</span>
  <span class="hljs-attr">dnsPropagationCheck</span> = <span class="hljs-literal">false</span>;
};
</code></pre><p>The <code class="filename">dnskeys.conf</code> and <code class="filename">certs.secret</code>
must be kept secure and thus you should not keep their contents in your
Nix config. Instead, generate them one time with a systemd service:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">systemd.services.dns-rfc2136-conf = {
  requiredBy = [<span class="hljs-string">"acme-example.com.service"</span> <span class="hljs-string">"bind.service"</span>];
  before = [<span class="hljs-string">"acme-example.com.service"</span> <span class="hljs-string">"bind.service"</span>];
  unitConfig = {
    ConditionPathExists = <span class="hljs-string">"!/var/lib/secrets/dnskeys.conf"</span>;
  };
  serviceConfig = {
    Type = <span class="hljs-string">"oneshot"</span>;
    UMask = 0077;
  };
  path = [ pkgs.bind ];
  script = <span class="hljs-string">''</span>
    <span class="hljs-built_in">mkdir</span> -p /var/lib/secrets
    <span class="hljs-built_in">chmod</span> 755 /var/lib/secrets
    tsig-keygen rfc2136key.example.com &gt; /var/lib/secrets/dnskeys.conf
    <span class="hljs-built_in">chown</span> named:root /var/lib/secrets/dnskeys.conf
    <span class="hljs-built_in">chmod</span> 400 /var/lib/secrets/dnskeys.conf

    <span class="hljs-comment"># extract secret value from the dnskeys.conf</span>
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> x y; <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$x</span>"</span> = <span class="hljs-string">"secret"</span> ]; <span class="hljs-keyword">then</span> secret=<span class="hljs-string">"''<span class="hljs-variable">${y:1:''<span class="hljs-variable">${#y}</span>-3}</span>"</span>; <span class="hljs-keyword">fi</span>; <span class="hljs-keyword">done</span> &lt; /var/lib/secrets/dnskeys.conf

    <span class="hljs-built_in">cat</span> &gt; /var/lib/secrets/certs.secret &lt;&lt; <span class="hljs-string">EOF
    RFC2136_NAMESERVER='127.0.0.1:53'
    RFC2136_TSIG_ALGORITHM='hmac-sha256.'
    RFC2136_TSIG_KEY='rfc2136key.example.com'
    RFC2136_TSIG_SECRET='$secret'
    EOF</span>
    <span class="hljs-built_in">chmod</span> 400 /var/lib/secrets/certs.secret
  <span class="hljs-string">''</span>;
};
</code></pre><p>Now you’re all set to generate certs! You should monitor the first invocation
by running <code class="literal">systemctl start acme-example.com.service &amp; journalctl -fu acme-example.com.service</code> and watching its log output.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-config-dns-with-vhosts" class="title" style="clear: both">Using DNS validation with web server virtual hosts   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-config-dns-with-vhosts" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>It is possible to use DNS-01 validation with all certificates,
including those automatically configured via the Nginx/Apache
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.nginx.virtualHosts._name_.enableACME"><code class="literal">enableACME</code></a>
option. This configuration pattern is fully
supported and part of the module’s test suite for Nginx + Apache.</p><p>You must follow the guide above on configuring DNS-01 validation
first, however instead of setting the options for one certificate
(e.g. <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.certs._name_.dnsProvider"><code class="option">security.acme.certs.&lt;name&gt;.dnsProvider</code></a>)
you will set them as defaults
(e.g. <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.acme.defaults.dnsProvider"><code class="option">security.acme.defaults.dnsProvider</code></a>).</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># Configure ACME appropriately</span>
security.acme.<span class="hljs-attr">acceptTerms</span> = <span class="hljs-literal">true</span>;
security.acme.defaults.<span class="hljs-attr">email</span> = <span class="hljs-string">"admin+acme@example.com"</span>;
security.acme.<span class="hljs-attr">defaults</span> = {
  <span class="hljs-attr">dnsProvider</span> = <span class="hljs-string">"rfc2136"</span>;
  <span class="hljs-attr">environmentFile</span> = <span class="hljs-string">"/var/lib/secrets/certs.secret"</span>;
  <span class="hljs-comment"># We don't need to wait for propagation since this is a local DNS server</span>
  <span class="hljs-attr">dnsPropagationCheck</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-comment"># For each virtual host you would like to use DNS-01 validation with,</span>
<span class="hljs-comment"># set acmeRoot = null</span>
services.<span class="hljs-attr">nginx</span> = {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">virtualHosts</span> = {
    <span class="hljs-string">"foo.example.com"</span> = {
      <span class="hljs-attr">enableACME</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">acmeRoot</span> = <span class="hljs-literal">null</span>;
    };
  };
}
</code></pre><p>And that’s it! Next time your configuration is rebuilt, or when
you add a new virtualHost, it will be DNS-01 validated.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-root-owned" class="title" style="clear: both">Using ACME with services demanding root owned certificates   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-root-owned" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Some services refuse to start if the configured certificate files
are not owned by root. PostgreSQL and OpenSMTPD are examples of these.
There is no way to change the user the ACME module uses (it will always be
<code class="literal">acme</code>), however you can use systemd’s
<code class="literal">LoadCredential</code> feature to resolve this elegantly.
Below is an example configuration for OpenSMTPD, but this pattern
can be applied to any service.</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># Configure ACME however you like (DNS or HTTP validation), adding</span>
<span class="hljs-comment"># the following configuration for the relevant certificate.</span>
<span class="hljs-comment"># Note: You cannot use `systemctl reload` here as that would mean</span>
<span class="hljs-comment"># the LoadCredential configuration below would be skipped and</span>
<span class="hljs-comment"># the service would continue to use old certificates.</span>
security.acme.certs.<span class="hljs-string">"mail.example.com"</span>.<span class="hljs-attr">postRun</span> = <span class="hljs-string">''
  systemctl restart opensmtpd
''</span>;

<span class="hljs-comment"># Now you must augment OpenSMTPD's systemd service to load</span>
<span class="hljs-comment"># the certificate files.</span>
systemd.services.opensmtpd.<span class="hljs-attr">requires</span> = [<span class="hljs-string">"acme-finished-mail.example.com.target"</span>];
systemd.services.opensmtpd.serviceConfig.<span class="hljs-attr">LoadCredential</span> = <span class="hljs-keyword">let</span>
  <span class="hljs-attr">certDir</span> = config.security.acme.certs.<span class="hljs-string">"mail.example.com"</span>.directory;
<span class="hljs-keyword">in</span> [
  <span class="hljs-string">"cert.pem:<span class="hljs-subst">${certDir}</span>/cert.pem"</span>
  <span class="hljs-string">"key.pem:<span class="hljs-subst">${certDir}</span>/key.pem"</span>
];

<span class="hljs-comment"># Finally, configure OpenSMTPD to use these certs.</span>
services.<span class="hljs-attr">opensmtpd</span> = <span class="hljs-keyword">let</span>
  <span class="hljs-attr">credsDir</span> = <span class="hljs-string">"/run/credentials/opensmtpd.service"</span>;
<span class="hljs-keyword">in</span> {
  <span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">setSendmail</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">serverConfiguration</span> = <span class="hljs-string">''
    pki mail.example.com cert "<span class="hljs-subst">${credsDir}</span>/cert.pem"
    pki mail.example.com key "<span class="hljs-subst">${credsDir}</span>/key.pem"
    listen on localhost tls pki mail.example.com
    action act1 relay host smtp://127.0.0.1:10027
    match for local action act1
  ''</span>;
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-regenerate" class="title" style="clear: both">Regenerating certificates   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-regenerate" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Should you need to regenerate a particular certificate in a hurry, such
as when a vulnerability is found in Let’s Encrypt, there is now a convenient
mechanism for doing so. Running
<code class="literal">systemctl clean --what=state acme-example.com.service</code>
will remove all certificate files and the account data for the given domain,
allowing you to then <code class="literal">systemctl start acme-example.com.service</code>
to generate fresh ones.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-security-acme-fix-jws" class="title" style="clear: both">Fixing JWS Verification error   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-security-acme-fix-jws" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>It is possible that your account credentials file may become corrupt and need
to be regenerated. In this scenario lego will produce the error <code class="literal">JWS verification error</code>.
The solution is to simply delete the associated accounts file and
re-run the affected service(s).</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes"><span class="hljs-comment"># Find the accounts folder for the certificate</span>
systemctl <span class="hljs-built_in">cat</span> acme-example.com.service | grep -Po <span class="hljs-string">'accounts/[^:]*'</span>
<span class="hljs-built_in">export</span> accountdir=<span class="hljs-string">"<span class="hljs-subst">$(!!)</span>"</span>
<span class="hljs-comment"># Move this folder to some place else</span>
<span class="hljs-built_in">mv</span> /var/lib/acme/.lego/<span class="hljs-variable">$accountdir</span>{,.bak}
<span class="hljs-comment"># Recreate the folder using systemd-tmpfiles</span>
systemd-tmpfiles --create
<span class="hljs-comment"># Get a new account and reissue certificates</span>
<span class="hljs-comment"># Note: Do this for all certs that share the same account email address</span>
systemctl start acme-example.com.service
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-zsh-ohmyzsh" class="title">Oh my ZSH   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-zsh-ohmyzsh" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-usage">Basic usage</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-additions">Custom additions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-environments">Custom environments</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-packaging-customizations">Package your own customizations</a> </span></dt> </dl></div><p><a class="link" href="https://ohmyz.sh/" target="_top"><code class="literal">oh-my-zsh</code></a> is a framework to manage your <a class="link" href="https://www.zsh.org/" target="_top">ZSH</a>
configuration including completion scripts for several CLI tools or custom
prompt themes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-usage" class="title" style="clear: both">Basic usage   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-usage" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The module uses the <code class="literal">oh-my-zsh</code> package with all available
features. The initial setup using Nix expressions is fairly similar to the
configuration format of <code class="literal">oh-my-zsh</code>.</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{
  programs.zsh.ohMyZsh = {
    <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
    plugins = [ <span class="hljs-string">"git"</span> <span class="hljs-string">"python"</span> <span class="hljs-string">"man"</span> ];
    theme = <span class="hljs-string">"agnoster"</span>;
  };
}
</code></pre><p>For a detailed explanation of these arguments please refer to the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki" target="_top"><code class="literal">oh-my-zsh</code> docs</a>.</p><p>The expression generates the needed configuration and writes it into your
<code class="literal">/etc/zshrc</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-additions" class="title" style="clear: both">Custom additions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-additions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Sometimes third-party or custom scripts such as a modified theme may be
needed. <code class="literal">oh-my-zsh</code> provides the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/wiki/Customization#overriding-internals" target="_top"><code class="literal">ZSH_CUSTOM</code></a>
environment variable for this which points to a directory with additional
scripts.</p><p>The module can do this as well:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{
  programs.zsh.ohMyZsh.<span class="hljs-attr">custom</span> = <span class="hljs-string">"~/path/to/custom/scripts"</span>;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-environments" class="title" style="clear: both">Custom environments   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-environments" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>There are several extensions for <code class="literal">oh-my-zsh</code> packaged in
<code class="literal">nixpkgs</code>. One of them is
<a class="link" href="https://github.com/spwhitt/nix-zsh-completions" target="_top">nix-zsh-completions</a>
which bundles completion scripts and a plugin for <code class="literal">oh-my-zsh</code>.</p><p>Rather than using a single mutable path for <code class="literal">ZSH_CUSTOM</code>,
it’s also possible to generate this path from a list of Nix packages:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">{ pkgs, ... }:
{
  programs.zsh.ohMyZsh.<span class="hljs-attr">customPkgs</span> = [
    pkgs.nix-zsh-completions
    <span class="hljs-comment"># and even more...</span>
  ];
}
</code></pre><p>Internally a single store path will be created using
<code class="literal">buildEnv</code>. Please refer to the docs of
<a class="link" href="https://nixos.org/nixpkgs/manual/#sec-building-environment" target="_top"><code class="literal">buildEnv</code></a>
for further reference.</p><p><span class="emphasis"><em>Please keep in mind that this is not compatible with
<code class="literal">programs.zsh.ohMyZsh.custom</code> as it requires an immutable
store path while <code class="literal">custom</code> shall remain mutable! An
evaluation failure will be thrown if both <code class="literal">custom</code> and
<code class="literal">customPkgs</code> are set.</em></span></p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-oh-my-zsh-packaging-customizations" class="title" style="clear: both">Package your own customizations   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-oh-my-zsh-packaging-customizations" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If third-party customizations (e.g. new themes) are supposed to be added to
<code class="literal">oh-my-zsh</code> there are several pitfalls to keep in mind:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>To comply with the default structure of <code class="literal">ZSH</code> the entire
output needs to be written to <code class="literal">$out/share/zsh.</code></p></li><li class="listitem"><p>Completion scripts are supposed to be stored at
<code class="literal">$out/share/zsh/site-functions</code>. This directory is part of the
<a class="link" href="https://zsh.sourceforge.io/Doc/Release/Functions.html" target="_top"><code class="literal">fpath</code></a>
and the package should be compatible with pure <code class="literal">ZSH</code>
setups. The module will automatically link the contents of
<code class="literal">site-functions</code> to completions directory in the proper
store path.</p></li><li class="listitem"><p>The <code class="literal">plugins</code> directory needs the structure
<code class="literal">pluginname/pluginname.plugin.zsh</code> as structured in the
<a class="link" href="https://github.com/robbyrussell/oh-my-zsh/tree/91b771914bc7c43dd7c7a43b586c5de2c225ceb7/plugins" target="_top">upstream repo.</a></p></li></ul></div><p>A derivation for <code class="literal">oh-my-zsh</code> may look like this:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">{ stdenv, fetchFromGitHub }:

stdenv.mkDerivation rec {
  name = <span class="hljs-string">"exemplary-zsh-customization-<span class="hljs-variable">${version}</span>"</span>;
  version = <span class="hljs-string">"1.0.0"</span>;
  src = fetchFromGitHub {
    <span class="hljs-comment"># path to the upstream repository</span>
  };

  dontBuild = <span class="hljs-literal">true</span>;
  installPhase = <span class="hljs-string">''</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$out</span>/share/zsh/site-functions
    <span class="hljs-built_in">cp</span> {themes,plugins} <span class="hljs-variable">$out</span>/share/zsh
    <span class="hljs-built_in">cp</span> completions <span class="hljs-variable">$out</span>/share/zsh/site-functions
  <span class="hljs-string">''</span>;
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-program-plotinus" class="title">Plotinus   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-program-plotinus" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p><span class="emphasis"><em>Source:</em></span> <code class="filename">modules/programs/plotinus.nix</code></p><p><span class="emphasis"><em>Upstream documentation:</em></span> <a class="link" href="https://github.com/p-e-w/plotinus" target="_top">https://github.com/p-e-w/plotinus</a></p><p>Plotinus is a searchable command palette in every modern GTK application.</p><p>When in a GTK 3 application and Plotinus is enabled, you can press
<code class="literal">Ctrl+Shift+P</code> to open the command palette. The command
palette provides a searchable list of of all menu items in the application.</p><p>To enable Plotinus, add the following to your
<code class="filename">configuration.nix</code>:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">programs.plotinus.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-programs-digitalbitbox" class="title">Digital Bitbox   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-programs-digitalbitbox" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-package">Package</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-hardware-module">Hardware</a> </span></dt> </dl></div><p>Digital Bitbox is a hardware wallet and second-factor authenticator.</p><p>The <code class="literal">digitalbitbox</code> programs module may be installed by setting
<code class="literal">programs.digitalbitbox</code> to <code class="literal">true</code> in a manner similar to</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">programs.digitalbitbox.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>and bundles the <code class="literal">digitalbitbox</code> package (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-package" title="Package">the section called “Package”</a>),
which contains the <code class="literal">dbb-app</code> and <code class="literal">dbb-cli</code> binaries, along with the hardware
module (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-hardware-module" title="Hardware">the section called “Hardware”</a>) which sets up the necessary
udev rules to access the device.</p><p>Enabling the digitalbitbox module is pretty much the easiest way to get a
Digital Bitbox device working on your system.</p><p>For more information, see <a class="link" href="https://digitalbitbox.com/start_linux" target="_top">https://digitalbitbox.com/start_linux</a>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-digitalbitbox-package" class="title" style="clear: both">Package   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-package" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The binaries, <code class="literal">dbb-app</code> (a GUI tool) and <code class="literal">dbb-cli</code> (a CLI tool), are available
through the <code class="literal">digitalbitbox</code> package which could be installed as follows:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">environment.<span class="hljs-attr">systemPackages</span> = [
  pkgs.digitalbitbox
];
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-digitalbitbox-hardware-module" class="title" style="clear: both">Hardware   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-digitalbitbox-hardware-module" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The digitalbitbox hardware package enables the udev rules for Digital Bitbox
devices and may be installed as follows:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">hardware.digitalbitbox.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
</code></pre><p>In order to alter the udev rules, one may provide different values for the
<code class="literal">udevRule51</code> and <code class="literal">udevRule52</code> attributes by means of overriding as follows:</p><pre><code class="programlisting hljs language-bash" data-highlighted="yes">programs.digitalbitbox = {
  <span class="hljs-built_in">enable</span> = <span class="hljs-literal">true</span>;
  package = pkgs.digitalbitbox.override {
    udevRule51 = <span class="hljs-string">"something else"</span>;
  };
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods" class="title">Input Methods   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-ibus">IBus</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-fcitx">Fcitx5</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-nabi">Nabi</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-uim">Uim</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-hime">Hime</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-kime">Kime</a> </span></dt> </dl></div><p>Input methods are an operating system component that allows any data, such as
keyboard strokes or mouse movements, to be received as input. In this way
users can enter characters and symbols not found on their input devices.
Using an input method is obligatory for any language that has more graphemes
than there are keys on the keyboard.</p><p>The following input methods are available in NixOS:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>IBus: The intelligent input bus.</p></li><li class="listitem"><p>Fcitx5: The next generation of fcitx, addons (including engines, dictionaries, skins) can be added using <code class="literal">i18n.inputMethod.fcitx5.addons</code>.</p></li><li class="listitem"><p>Nabi: A Korean input method based on XIM.</p></li><li class="listitem"><p>Uim: The universal input method, is a library with a XIM bridge.</p></li><li class="listitem"><p>Hime: An extremely easy-to-use input method framework.</p></li><li class="listitem"><p>Kime: Korean IME</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-ibus" class="title" style="clear: both">IBus   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-ibus" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>IBus is an Intelligent Input Bus. It provides full featured and user
friendly input method user interface.</p><p>The following snippet can be used to configure IBus:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"ibus"</span>;
  ibus.<span class="hljs-attr">engines</span> = <span class="hljs-keyword">with</span> pkgs.ibus-engines; [ anthy hangul mozc ];
};
</code></pre><p><code class="literal">i18n.inputMethod.ibus.engines</code> is optional and can be used
to add extra IBus engines.</p><p>Available extra IBus engines are:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Anthy (<code class="literal">ibus-engines.anthy</code>): Anthy is a system for
Japanese input method. It converts Hiragana text to Kana Kanji mixed text.</p></li><li class="listitem"><p>Hangul (<code class="literal">ibus-engines.hangul</code>): Korean input method.</p></li><li class="listitem"><p>m17n (<code class="literal">ibus-engines.m17n</code>): m17n is an input method that
uses input methods and corresponding icons in the m17n database.</p></li><li class="listitem"><p>mozc (<code class="literal">ibus-engines.mozc</code>): A Japanese input method from
Google.</p></li><li class="listitem"><p>Table (<code class="literal">ibus-engines.table</code>): An input method that load
tables of input methods.</p></li><li class="listitem"><p>table-others (<code class="literal">ibus-engines.table-others</code>): Various
table-based input methods. To use this, and any other table-based input
methods, it must appear in the list of engines along with
<code class="literal">table</code>. For example:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">ibus.<span class="hljs-attr">engines</span> = <span class="hljs-keyword">with</span> pkgs.ibus-engines; [ table table-others ];
</code></pre></li></ul></div><p>To use any input method, the package must be added in the configuration, as
shown above, and also (after running <code class="literal">nixos-rebuild</code>) the
input method must be added from IBus’ preference dialog.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="module-services-input-methods-troubleshooting" class="title">Troubleshooting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-troubleshooting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If IBus works in some applications but not others, a likely cause of this
is that IBus is depending on a different version of <code class="literal">glib</code>
to what the applications are depending on. This can be checked by running
<code class="literal">nix-store -q --requisites &lt;path&gt; | grep glib</code>,
where <code class="literal">&lt;path&gt;</code> is the path of either IBus or an
application in the Nix store. The <code class="literal">glib</code> packages must
match exactly. If they do not, uninstalling and reinstalling the
application is a likely fix.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-fcitx" class="title" style="clear: both">Fcitx5   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-fcitx" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Fcitx5 is an input method framework with extension support. It has three
built-in Input Method Engine, Pinyin, QuWei and Table-based input methods.</p><p>The following snippet can be used to configure Fcitx:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"fcitx5"</span>;
  fcitx5.<span class="hljs-attr">addons</span> = <span class="hljs-keyword">with</span> pkgs; [ fcitx5-mozc fcitx5-hangul fcitx5-m17n ];
};
</code></pre><p><code class="literal">i18n.inputMethod.fcitx5.addons</code> is optional and can be
used to add extra Fcitx5 addons.</p><p>Available extra Fcitx5 addons are:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Anthy (<code class="literal">fcitx5-anthy</code>): Anthy is a system for
Japanese input method. It converts Hiragana text to Kana Kanji mixed text.</p></li><li class="listitem"><p>Chewing (<code class="literal">fcitx5-chewing</code>): Chewing is an
intelligent Zhuyin input method. It is one of the most popular input
methods among Traditional Chinese Unix users.</p></li><li class="listitem"><p>Hangul (<code class="literal">fcitx5-hangul</code>): Korean input method.</p></li><li class="listitem"><p>Unikey (<code class="literal">fcitx5-unikey</code>): Vietnamese input method.</p></li><li class="listitem"><p>m17n (<code class="literal">fcitx5-m17n</code>): m17n is an input method that
uses input methods and corresponding icons in the m17n database.</p></li><li class="listitem"><p>mozc (<code class="literal">fcitx5-mozc</code>): A Japanese input method from
Google.</p></li><li class="listitem"><p>table-others (<code class="literal">fcitx5-table-other</code>): Various
table-based input methods.</p></li><li class="listitem"><p>chinese-addons (<code class="literal">fcitx5-chinese-addons</code>): Various chinese input methods.</p></li><li class="listitem"><p>rime (<code class="literal">fcitx5-rime</code>): RIME support for fcitx5.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-nabi" class="title" style="clear: both">Nabi   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-nabi" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Nabi is an easy to use Korean X input method. It allows you to enter
phonetic Korean characters (hangul) and pictographic Korean characters
(hanja).</p><p>The following snippet can be used to configure Nabi:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"nabi"</span>;
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-uim" class="title" style="clear: both">Uim   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-uim" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Uim (short for “universal input method”) is a multilingual input method
framework. Applications can use it through so-called bridges.</p><p>The following snippet can be used to configure uim:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"uim"</span>;
};
</code></pre><p>Note: The <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-i18n.inputMethod.uim.toolbar"><code class="option">i18n.inputMethod.uim.toolbar</code></a> option can be
used to choose uim toolbar.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-hime" class="title" style="clear: both">Hime   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-hime" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Hime is an extremely easy-to-use input method framework. It is lightweight,
stable, powerful and supports many commonly used input methods, including
Cangjie, Zhuyin, Dayi, Rank, Shrimp, Greek, Korean Pinyin, Latin Alphabet,
etc…</p><p>The following snippet can be used to configure Hime:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"hime"</span>;
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="module-services-input-methods-kime" class="title" style="clear: both">Kime   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#module-services-input-methods-kime" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Kime is Korean IME. it’s built with Rust language and let you get simple, safe, fast Korean typing</p><p>The following snippet can be used to configure Kime:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">i18n.<span class="hljs-attr">inputMethod</span> = {
  <span class="hljs-attr">enabled</span> = <span class="hljs-string">"kime"</span>;
};
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-profiles" class="title">Profiles   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-profiles" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-all-hardware">All Hardware</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-base">Base</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-clone-config">Clone Config</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-demo">Demo</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-docker-container">Docker Container</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-graphical">Graphical</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-hardened">Hardened</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-headless">Headless</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-installation-device">Installation Device</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-minimal">Minimal</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-profile-qemu-guest">QEMU Guest</a> </span></dt> </dl></div><p>In some cases, it may be desirable to take advantage of commonly-used,
predefined configurations provided by nixpkgs, but different from those
that come as default. This is a role fulfilled by NixOS’s Profiles,
which come as files living in <code class="literal">&lt;nixpkgs/nixos/modules/profiles&gt;</code>. That
is to say, expected usage is to add them to the imports list of your
<code class="literal">/etc/configuration.nix</code> as such:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">imports</span> = [
  &lt;nixpkgs/nixos/modules/profiles/profile-name.nix&gt;
];
</code></pre><p>Even if some of these profiles seem only useful in the context of
install media, many are actually intended to be used in real installs.</p><p>What follows is a brief explanation on the purpose and use-case for each
profile. Detailing each option configured by each one is out of scope.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-all-hardware" class="title" style="clear: both">All Hardware   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-all-hardware" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Enables all hardware supported by NixOS: i.e., all firmware is included, and
all devices from which one may boot are enabled in the initrd. Its primary
use is in the NixOS installation CDs.</p><p>The enabled kernel modules include support for SATA and PATA, SCSI
(partially), USB, Firewire (untested), Virtio (QEMU, KVM, etc.), VMware, and
Hyper-V. Additionally, <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-hardware.enableAllFirmware"><code class="option">hardware.enableAllFirmware</code></a> is
enabled, and the firmware for the ZyDAS ZD1211 chipset is specifically
installed.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-base" class="title" style="clear: both">Base   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-base" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Defines the software packages included in the “minimal” installation CD. It
installs several utilities useful in a simple recovery or install media, such
as a text-mode web browser, and tools for manipulating block devices,
networking, hardware diagnostics, and filesystems (with their respective
kernel modules).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-clone-config" class="title" style="clear: both">Clone Config   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-clone-config" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This profile is used in installer images. It provides an editable
configuration.nix that imports all the modules that were also used when
creating the image in the first place. As a result it allows users to edit
and rebuild the live-system.</p><p>On images where the installation media also becomes an installation target,
copying over <code class="literal">configuration.nix</code> should be disabled by
setting <code class="literal">installer.cloneConfig</code> to <code class="literal">false</code>.
For example, this is done in <code class="literal">sd-image-aarch64-installer.nix</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-demo" class="title" style="clear: both">Demo   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-demo" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This profile just enables a <code class="literal">demo</code> user, with password <code class="literal">demo</code>, uid <code class="literal">1000</code>, <code class="literal">wheel</code> group and
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.displayManager.autoLogin">autologin in the SDDM display manager</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-docker-container" class="title" style="clear: both">Docker Container   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-docker-container" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This is the profile from which the Docker images are generated. It prepares a
working system by importing the <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-profile-minimal" title="Minimal">Minimal</a> and
<a class="link" href="https://nixos.org/manual/nixos/stable/#sec-profile-clone-config" title="Clone Config">Clone Config</a> profiles, and
setting appropriate configuration options that are useful inside a container
context, like <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-boot.isContainer"><code class="option">boot.isContainer</code></a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-graphical" class="title" style="clear: both">Graphical   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-graphical" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Defines a NixOS configuration with the Plasma 5 desktop. It’s used by the
graphical installation CD.</p><p>It sets <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.enable"><code class="option">services.xserver.enable</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.displayManager.sddm.enable"><code class="option">services.xserver.displayManager.sddm.enable</code></a>,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.desktopManager.plasma5.enable"><code class="option">services.xserver.desktopManager.plasma5.enable</code></a>,
and <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.xserver.libinput.enable"><code class="option">services.xserver.libinput.enable</code></a> to true. It also
includes glxinfo and firefox in the system packages list.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-hardened" class="title" style="clear: both">Hardened   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-hardened" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A profile with most (vanilla) hardening options enabled by default,
potentially at the cost of stability, features and performance.</p><p>This includes a hardened kernel, and limiting the system information
available to processes through the <code class="literal">/sys</code> and
<code class="literal">/proc</code> filesystems. It also disables the User Namespaces
feature of the kernel, which stops Nix from being able to build anything
(this particular setting can be overridden via
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-security.allowUserNamespaces"><code class="option">security.allowUserNamespaces</code></a>). See the
<a class="link" href="https://github.com/nixos/nixpkgs/tree/master/nixos/modules/profiles/hardened.nix" target="_top">profile source</a>
for further detail on which settings are altered.</p><div class="warning"><h3 class="title">Warning</h3><p>This profile enables options that are known to affect system
stability. If you experience any stability issues when using the
profile, try disabling it. If you report an issue and use this
profile, always mention that you do.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-headless" class="title" style="clear: both">Headless   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-headless" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Common configuration for headless machines (e.g., Amazon EC2 instances).</p><p>Disables <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-sound.enable">sound</a>,
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.vesa">vesa</a>, serial consoles,
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.enableEmergencyMode">emergency mode</a>,
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.grub.splashImage">grub splash images</a>
and configures the kernel to reboot automatically on panic.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-installation-device" class="title" style="clear: both">Installation Device   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-installation-device" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Provides a basic configuration for installation devices like CDs.
This enables redistributable firmware, includes the
<a class="link" href="https://nixos.org/manual/nixos/stable/#sec-profile-clone-config" title="Clone Config">Clone Config profile</a>
and a copy of the Nixpkgs channel, so <code class="literal">nixos-install</code>
works out of the box.</p><p>Documentation for <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-documentation.enable">Nixpkgs</a>
and <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-documentation.nixos.enable">NixOS</a> are
forcefully enabled (to override the
<a class="link" href="https://nixos.org/manual/nixos/stable/#sec-profile-minimal" title="Minimal">Minimal profile</a> preference); the
NixOS manual is shown automatically on TTY 8, udisks is disabled.
Autologin is enabled as <code class="literal">nixos</code> user, while passwordless
login as both <code class="literal">root</code> and <code class="literal">nixos</code> is possible.
Passwordless <code class="literal">sudo</code> is enabled too.
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-networking.wireless.enable">wpa_supplicant</a> is
enabled, but configured to not autostart.</p><p>It is explained how to login, start the ssh server, and if available,
how to start the display manager.</p><p>Several settings are tweaked so that the installer has a better chance of
succeeding under low-memory environments.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-minimal" class="title" style="clear: both">Minimal   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-minimal" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This profile defines a small NixOS configuration. It does not contain any
graphical stuff. It’s a very short file that enables
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-environment.noXlibs">noXlibs</a>, sets
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-i18n.supportedLocales"><code class="option">i18n.supportedLocales</code></a> to
only support the user-selected locale,
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-documentation.enable">disables packages’ documentation</a>,
and <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-sound.enable">disables sound</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-profile-qemu-guest" class="title" style="clear: both">QEMU Guest   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-profile-qemu-guest" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>This profile contains common configuration for virtual machines running under
QEMU (using virtio).</p><p>It makes virtio modules available on the initrd and sets the system time from
the hardware clock to work around a bug in qemu-kvm.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-kubernetes" class="title">Kubernetes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-kubernetes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The NixOS Kubernetes module is a collective term for a handful of
individual submodules implementing the Kubernetes cluster components.</p><p>There are generally two ways of enabling Kubernetes on NixOS. One way is
to enable and configure cluster components appropriately by hand:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.<span class="hljs-attr">kubernetes</span> = {
  apiserver.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  controllerManager.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  scheduler.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  addonManager.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  proxy.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  flannel.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
};
</code></pre><p>Another way is to assign cluster roles (“master” and/or “node”) to
the host. This enables apiserver, controllerManager, scheduler,
addonManager, kube-proxy and etcd:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.kubernetes.<span class="hljs-attr">roles</span> = [ <span class="hljs-string">"master"</span> ];
</code></pre><p>While this will enable the kubelet and kube-proxy only:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.kubernetes.<span class="hljs-attr">roles</span> = [ <span class="hljs-string">"node"</span> ];
</code></pre><p>Assigning both the master and node roles is usable if you want a single
node Kubernetes cluster for dev or testing purposes:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.kubernetes.<span class="hljs-attr">roles</span> = [ <span class="hljs-string">"master"</span> <span class="hljs-string">"node"</span> ];
</code></pre><p>Note: Assigning either role will also default both
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.flannel.enable"><code class="option">services.kubernetes.flannel.enable</code></a>
and <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a>
to true. This sets up flannel as CNI and activates automatic PKI bootstrapping.</p><div class="note"><h3 class="title">Note</h3><p>As of NixOS 19.03, it is mandatory to configure:
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.masterAddress"><code class="option">services.kubernetes.masterAddress</code></a>.
The masterAddress must be resolveable and routeable by all cluster nodes.
In single node clusters, this can be set to <code class="literal">localhost</code>.</p></div><p>Role-based access control (RBAC) authorization mode is enabled by
default. This means that anonymous requests to the apiserver secure port
will expectedly cause a permission denied error. All cluster components
must therefore be configured with x509 certificates for two-way tls
communication. The x509 certificate subject section determines the roles
and permissions granted by the apiserver to perform clusterwide or
namespaced operations. See also: <a class="link" href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_top"> Using RBAC
Authorization</a>.</p><p>The NixOS kubernetes module provides an option for automatic certificate
bootstrapping and configuration,
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a>.
The PKI bootstrapping process involves setting up a certificate authority (CA)
daemon (cfssl) on the kubernetes master node. cfssl generates a CA-cert
for the cluster, and uses the CA-cert for signing subordinate certs issued
to each of the cluster components. Subsequently, the certmgr daemon monitors
active certificates and renews them when needed. For single node Kubernetes
clusters, setting <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a>
= true is sufficient and no further action is required. For joining extra node
machines to an existing cluster on the other hand, establishing initial
trust is mandatory.</p><p>To add new nodes to the cluster: On any (non-master) cluster node where
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.easyCerts"><code class="option">services.kubernetes.easyCerts</code></a>
is enabled, the helper script <code class="literal">nixos-kubernetes-node-join</code> is available on PATH.
Given a token on stdin, it will copy the token to the kubernetes secrets directory
and restart the certmgr service. As requested certificates are issued, the
script will restart kubernetes cluster components as needed for them to
pick up new keypairs.</p><div class="note"><h3 class="title">Note</h3><p>Multi-master (HA) clusters are not supported by the easyCerts module.</p></div><p>In order to interact with an RBAC-enabled cluster as an administrator,
one needs to have cluster-admin privileges. By default, when easyCerts
is enabled, a cluster-admin kubeconfig file is generated and linked into
<code class="literal">/etc/kubernetes/cluster-admin.kubeconfig</code> as determined by
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-services.kubernetes.pki.etcClusterAdminKubeconfig"><code class="option">services.kubernetes.pki.etcClusterAdminKubeconfig</code></a>.
<code class="literal">export KUBECONFIG=/etc/kubernetes/cluster-admin.kubeconfig</code> will make
kubectl use this kubeconfig to access and authenticate the cluster. The
cluster-admin kubeconfig references an auto-generated keypair owned by
root. Thus, only root on the kubernetes master may obtain cluster-admin
rights by means of this file.</p>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-running" class="title">Administration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-running" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><div class="partintro"><p>This chapter describes various aspects of managing a running NixOS system, such as how to use the <span class="command"><strong>systemd</strong></span> service manager.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-systemctl">Service Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-rebooting">Rebooting and Shutting Down</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-user-sessions">User Sessions</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-cgroups">Control Groups</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-logging">Logging</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-nix-gc">Cleaning the Nix Store</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-containers">Container Management</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-troubleshooting">Troubleshooting</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-systemctl" class="title">Service Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-systemctl" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-general">Interacting with a running systemd</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-nixos">systemd in NixOS</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-template-units">Template units</a> </span></dt> </dl></div><p>In NixOS, all system services are started and monitored using the
systemd program. systemd is the “init” process of the system (i.e. PID
1), the parent of all other processes. It manages a set of so-called
“units”, which can be things like system services (programs), but also
mount points, swap files, devices, targets (groups of units) and more.
Units can have complex dependencies; for instance, one unit can require
that another unit must be successfully started before the first unit can
be started. When the system boots, it starts a unit named
<code class="literal">default.target</code>; the dependencies of this unit cause all system
services to be started, file systems to be mounted, swap files to be
activated, and so on.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-general" class="title" style="clear: both">Interacting with a running systemd   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-general" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The command <code class="literal">systemctl</code> is the main way to interact with <code class="literal">systemd</code>. The
following paragraphs demonstrate ways to interact with any OS running
systemd as init system. NixOS is of no exception. The <a class="link" href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-nixos" title="systemd in NixOS">next section
</a> explains NixOS specific things worth
knowing.</p><p>Without any arguments, <code class="literal">systemctl</code> the status of active units:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl</span>
-.mount          loaded active mounted   /
swapfile.swap    loaded active active    /swapfile
sshd.service     loaded active running   SSH Daemon
graphical.target loaded active active    Graphical Interface
...
</code></pre><p>You can ask for detailed status information about a unit, for instance,
the PostgreSQL database service:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl status postgresql.service</span>
postgresql.service - PostgreSQL Server
          Loaded: loaded (/nix/store/pn3q73mvh75gsrl8w7fdlfk3fq5qm5mw-unit/postgresql.service)
          Active: active (running) since Mon, 2013-01-07 15:55:57 CET; 9h ago
        Main PID: 2390 (postgres)
          CGroup: name=systemd:/system/postgresql.service
                  ├─2390 postgres
                  ├─2418 postgres: writer process
                  ├─2419 postgres: wal writer process
                  ├─2420 postgres: autovacuum launcher process
                  ├─2421 postgres: stats collector process
                  └─2498 postgres: zabbix zabbix [local] idle

Jan 07 15:55:55 hagbard postgres[2394]: [1-1] LOG:  database system was shut down at 2013-01-07 15:55:05 CET
Jan 07 15:55:57 hagbard postgres[2390]: [1-1] LOG:  database system is ready to accept connections
Jan 07 15:55:57 hagbard postgres[2420]: [1-1] LOG:  autovacuum launcher started
Jan 07 15:55:57 hagbard systemd[1]: Started PostgreSQL Server.
</code></pre><p>Note that this shows the status of the unit (active and running), all
the processes belonging to the service, as well as the most recent log
messages from the service.</p><p>Units can be stopped, started or restarted:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl stop postgresql.service</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start postgresql.service</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl restart postgresql.service</span>
</code></pre><p>These operations are synchronous: they wait until the service has
finished starting or stopping (or has failed). Starting a unit will
cause the dependencies of that unit to be started as well (if
necessary).</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-nixos" class="title" style="clear: both">systemd in NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-nixos" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Packages in Nixpkgs sometimes provide systemd units with them, usually
in e.g <code class="literal">#pkg-out#/lib/systemd/</code>. Putting such a package in
<code class="literal">environment.systemPackages</code> doesn’t make the service available to
users or the system.</p><p>In order to enable a systemd <span class="emphasis"><em>system</em></span> service with provided upstream
package, use (e.g):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">systemd.<span class="hljs-attr">packages</span> = [ pkgs.packagekit ];
</code></pre><p>Usually NixOS modules written by the community do the above, plus take
care of other details. If a module was written for a service you are
interested in, you’d probably need only to use
<code class="literal">services.#name#.enable = true;</code>. These services are defined in
Nixpkgs’ <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules" target="_top"> <code class="literal">nixos/modules/</code> directory
</a>. In case
the service is simple enough, the above method should work, and start
the service on boot.</p><p><span class="emphasis"><em>User</em></span> systemd services on the other hand, should be treated
differently. Given a package that has a systemd unit file at
<code class="literal">#pkg-out#/lib/systemd/user/</code>, using <a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.packages"><code class="option">systemd.packages</code></a> will
make you able to start the service via <code class="literal">systemctl --user start</code>, but it
won’t start automatically on login. However, You can imperatively
enable it by adding the package’s attribute to
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.packages"><code class="option">systemd.packages</code></a> and then do this (e.g):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">mkdir</span> -p ~/.config/systemd/user/default.target.wants</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ln</span> -s /run/current-system/sw/lib/systemd/user/syncthing.service ~/.config/systemd/user/default.target.wants/</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user daemon-reload</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">systemctl --user <span class="hljs-built_in">enable</span> syncthing.service</span>
</code></pre><p>If you are interested in a timer file, use <code class="literal">timers.target.wants</code> instead
of <code class="literal">default.target.wants</code> in the 1st and 2nd command.</p><p>Using <code class="literal">systemctl --user enable syncthing.service</code> instead of the above,
will work, but it’ll use the absolute path of <code class="literal">syncthing.service</code> for
the symlink, and this path is in <code class="literal">/nix/store/.../lib/systemd/user/</code>.
Hence <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-nix-gc" title="Cleaning the Nix Store">garbage collection</a> will remove that file and you
will wind up with a broken symlink in your systemd configuration, which
in turn will not make the service / timer start on login.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-systemd-template-units" class="title" style="clear: both">Template units   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sect-nixos-systemd-template-units" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>systemd supports templated units where a base unit can be started multiple
times with a different parameter. The syntax to accomplish this is
<code class="literal">service-name@instance-name.service</code>. Units get the instance name passed to
them (see <code class="literal">systemd.unit(5)</code>). NixOS has support for these kinds of units and
for template-specific overrides. A service needs to be defined twice, once
for the base unit and once for the instance. All instances must include
<code class="literal">overrideStrategy = "asDropin"</code> for the change detection to work. This
example illustrates this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  systemd.<span class="hljs-attr">services</span> = {
    <span class="hljs-string">"base-unit@"</span>.<span class="hljs-attr">serviceConfig</span> = {
      <span class="hljs-attr">ExecStart</span> = <span class="hljs-string">"..."</span>;
      <span class="hljs-attr">User</span> = <span class="hljs-string">"..."</span>;
    };
    <span class="hljs-string">"base-unit@instance-a"</span> = {
      <span class="hljs-attr">overrideStrategy</span> = <span class="hljs-string">"asDropin"</span>; <span class="hljs-comment"># needed for templates to work</span>
      <span class="hljs-attr">wantedBy</span> = [ <span class="hljs-string">"multi-user.target"</span> ]; <span class="hljs-comment"># causes NixOS to manage the instance</span>
    };
    <span class="hljs-string">"base-unit@instance-b"</span> = {
      <span class="hljs-attr">overrideStrategy</span> = <span class="hljs-string">"asDropin"</span>; <span class="hljs-comment"># needed for templates to work</span>
      <span class="hljs-attr">wantedBy</span> = [ <span class="hljs-string">"multi-user.target"</span> ]; <span class="hljs-comment"># causes NixOS to manage the instance</span>
      serviceConfig.<span class="hljs-attr">User</span> = <span class="hljs-string">"root"</span>; <span class="hljs-comment"># also override something for this specific instance</span>
    };
  };
}
</code></pre>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rebooting" class="title">Rebooting and Shutting Down   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-rebooting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The system can be shut down (and automatically powered off) by doing:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">shutdown</span>
</code></pre><p>This is equivalent to running <code class="literal">systemctl poweroff</code>.</p><p>To reboot the system, run</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">reboot</span>
</code></pre><p>which is equivalent to <code class="literal">systemctl reboot</code>. Alternatively, you can
quickly reboot the system using <code class="literal">kexec</code>, which bypasses the BIOS by
directly loading the new kernel into memory:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl kexec</span>
</code></pre><p>The machine can be suspended to RAM (if supported) using <code class="literal">systemctl suspend</code>,
and suspended to disk using <code class="literal">systemctl hibernate</code>.</p><p>These commands can be run by any user who is logged in locally, i.e. on
a virtual console or in X11; otherwise, the user is asked for
authentication.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-user-sessions" class="title">User Sessions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-user-sessions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Systemd keeps track of all users who are logged into the system (e.g. on
a virtual console or remotely via SSH). The command <code class="literal">loginctl</code> allows
querying and manipulating user sessions. For instance, to list all user
sessions:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">loginctl</span>
   SESSION        UID USER             SEAT
        c1        500 eelco            seat0
        c3          0 root             seat0
        c4        500 alice
</code></pre><p>This shows that two users are logged in locally, while another is logged
in remotely. (“Seats” are essentially the combinations of displays and
input devices attached to the system; usually, there is only one seat.)
To get information about a session:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">loginctl session-status c3</span>
c3 - root (0)
           Since: Tue, 2013-01-08 01:17:56 CET; 4min 42s ago
          Leader: 2536 (login)
            Seat: seat0; vc3
             TTY: /dev/tty3
         Service: login; type tty; class user
           State: online
          CGroup: name=systemd:/user/root/c3
                  ├─ 2536 /nix/store/10mn4xip9n7y9bxqwnsx7xwx2v2g34xn-shadow-4.1.5.1/bin/login --
                  ├─10339 -bash
                  └─10355 w3m nixos.org
</code></pre><p>This shows that the user is logged in on virtual console 3. It also
lists the processes belonging to this session. Since systemd keeps track
of this, you can terminate a session in a way that ensures that all the
session’s processes are gone:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">loginctl terminate-session c3</span>
</code></pre>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-cgroups" class="title">Control Groups   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-cgroups" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To keep track of the processes in a running system, systemd uses
<span class="emphasis"><em>control groups</em></span> (cgroups). A control group is a set of processes used
to allocate resources such as CPU, memory or I/O bandwidth. There can be
multiple control group hierarchies, allowing each kind of resource to be
managed independently.</p><p>The command <code class="literal">systemd-cgls</code> lists all control groups in the <code class="literal">systemd</code>
hierarchy, which is what systemd uses to keep track of the processes
belonging to each service or user session:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">systemd-cgls</span>
├─user
│ └─eelco
│   └─c1
│     ├─ 2567 -:0
│     ├─ 2682 kdeinit4: kdeinit4 Running...
│     ├─ ...
│     └─10851 sh -c less -R
└─system
  ├─httpd.service
  │ ├─2444 httpd -f /nix/store/3pyacby5cpr55a03qwbnndizpciwq161-httpd.conf -DNO_DETACH
  │ └─...
  ├─dhcpcd.service
  │ └─2376 dhcpcd --config /nix/store/f8dif8dsi2yaa70n03xir8r653776ka6-dhcpcd.conf
  └─ ...
</code></pre><p>Similarly, <code class="literal">systemd-cgls cpu</code> shows the cgroups in the CPU hierarchy,
which allows per-cgroup CPU scheduling priorities. By default, every
systemd service gets its own CPU cgroup, while all user sessions are in
the top-level CPU cgroup. This ensures, for instance, that a thousand
run-away processes in the <code class="literal">httpd.service</code> cgroup cannot starve the CPU
for one process in the <code class="literal">postgresql.service</code> cgroup. (By contrast, it
they were in the same cgroup, then the PostgreSQL process would get
1/1001 of the cgroup’s CPU time.) You can limit a service’s CPU share in
<code class="literal">configuration.nix</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">systemd.services.httpd.serviceConfig.<span class="hljs-attr">CPUShares</span> = <span class="hljs-number">512</span>;
</code></pre><p>By default, every cgroup has 1024 CPU shares, so this will halve the CPU
allocation of the <code class="literal">httpd.service</code> cgroup.</p><p>There also is a <code class="literal">memory</code> hierarchy that controls memory allocation
limits; by default, all processes are in the top-level cgroup, so any
service or session can exhaust all available memory. Per-cgroup memory
limits can be specified in <code class="literal">configuration.nix</code>; for instance, to limit
<code class="literal">httpd.service</code> to 512 MiB of RAM (excluding swap):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">systemd.services.httpd.serviceConfig.<span class="hljs-attr">MemoryLimit</span> = <span class="hljs-string">"512M"</span>;
</code></pre><p>The command <code class="literal">systemd-cgtop</code> shows a continuously updated list of all
cgroups with their CPU and memory usage.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-logging" class="title">Logging   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-logging" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>System-wide logging is provided by systemd’s <span class="emphasis"><em>journal</em></span>, which subsumes
traditional logging daemons such as syslogd and klogd. Log entries are
kept in binary files in <code class="literal">/var/log/journal/</code>. The command <code class="literal">journalctl</code>
allows you to see the contents of the journal. For example,</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">journalctl -b</span>
</code></pre><p>shows all journal entries since the last reboot. (The output of
<code class="literal">journalctl</code> is piped into <code class="literal">less</code> by default.) You can use various
options and match operators to restrict output to messages of interest.
For instance, to get all messages from PostgreSQL:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">journalctl -u postgresql.service</span>
-- Logs begin at Mon, 2013-01-07 13:28:01 CET, end at Tue, 2013-01-08 01:09:57 CET. --
...
Jan 07 15:44:14 hagbard postgres[2681]: [2-1] LOG:  database system is shut down
-- Reboot --
Jan 07 15:45:10 hagbard postgres[2532]: [1-1] LOG:  database system was shut down at 2013-01-07 15:44:14 CET
Jan 07 15:45:13 hagbard postgres[2500]: [1-1] LOG:  database system is ready to accept connections
</code></pre><p>Or to get all messages since the last reboot that have at least a
“critical” severity level:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">journalctl -b -p crit</span>
Dec 17 21:08:06 mandark sudo[3673]: pam_unix(sudo:auth): auth could not identify password for [alice]
Dec 29 01:30:22 mandark kernel[6131]: [1053513.909444] CPU6: Core temperature above threshold, cpu clock throttled (total events = 1)
</code></pre><p>The system journal is readable by root and by users in the <code class="literal">wheel</code> and
<code class="literal">systemd-journal</code> groups. All users have a private journal that can be
read using <code class="literal">journalctl</code>.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-gc" class="title">Cleaning the Nix Store   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nix-gc" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sect-nixos-gc-boot-entries">NixOS Boot Entries</a> </span></dt> </dl></div><p>Nix has a purely functional model, meaning that packages are never
upgraded in place. Instead new versions of packages end up in a
different location in the Nix store (<code class="literal">/nix/store</code>). You should
periodically run Nix’s <span class="emphasis"><em>garbage collector</em></span> to remove old, unreferenced
packages. This is easy:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-collect-garbage</span>
</code></pre><p>Alternatively, you can use a systemd unit that does the same in the
background:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start nix-gc.service</span>
</code></pre><p>You can tell NixOS in <code class="literal">configuration.nix</code> to run this unit automatically
at certain points in time, for instance, every night at 03:15:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">nix.gc.<span class="hljs-attr">automatic</span> = <span class="hljs-literal">true</span>;
nix.gc.<span class="hljs-attr">dates</span> = <span class="hljs-string">"03:15"</span>;
</code></pre><p>The commands above do not remove garbage collector roots, such as old
system configurations. Thus they do not remove the ability to roll back
to previous configurations. The following command deletes old roots,
removing the ability to roll back to them:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-collect-garbage -d</span>
</code></pre><p>You can also do this for specific profiles, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-env -p /nix/var/nix/profiles/per-user/eelco/profile --delete-generations old</span>
</code></pre><p>Note that NixOS system configurations are stored in the profile
<code class="literal">/nix/var/nix/profiles/system</code>.</p><p>Another way to reclaim disk space (often as much as 40% of the size of
the Nix store) is to run Nix’s store optimiser, which seeks out
identical files in the store and replaces them with hard links to a
single copy.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-store --optimise</span>
</code></pre><p>Since this command needs to read the entire Nix store, it can take quite
a while to finish.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sect-nixos-gc-boot-entries" class="title" style="clear: both">NixOS Boot Entries   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sect-nixos-gc-boot-entries" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If your <code class="literal">/boot</code> partition runs out of space, after clearing old profiles
you must rebuild your system with <code class="literal">nixos-rebuild boot</code> or <code class="literal">nixos-rebuild switch</code> to update the <code class="literal">/boot</code> partition and clear space.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-containers" class="title">Container Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-containers" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-imperative-containers">Imperative Container Management</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-declarative-containers">Declarative Container Specification</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-container-networking">Container Networking</a> </span></dt> </dl></div><p>NixOS allows you to easily run other NixOS instances as <span class="emphasis"><em>containers</em></span>.
Containers are a light-weight approach to virtualisation that runs
software in the container at the same speed as in the host system. NixOS
containers share the Nix store of the host, making container creation
very efficient.</p><div class="warning"><h3 class="title">Warning</h3><p>Currently, NixOS containers are not perfectly isolated from the host
system. This means that a user with root access to the container can do
things that affect the host. So you should not give container root
access to untrusted users.</p></div><p>NixOS containers can be created in two ways: imperatively, using the
command <code class="literal">nixos-container</code>, and declaratively, by specifying them in your
<code class="literal">configuration.nix</code>. The declarative approach implies that containers
get upgraded along with your host system when you run <code class="literal">nixos-rebuild</code>,
which is often not what you want. By contrast, in the imperative
approach, containers are configured and updated independently from the
host system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-imperative-containers" class="title" style="clear: both">Imperative Container Management   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-imperative-containers" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>We’ll cover imperative container management using <code class="literal">nixos-container</code>
first. Be aware that container management is currently only possible as
<code class="literal">root</code>.</p><p>You create a container with identifier <code class="literal">foo</code> as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container create foo</span>
</code></pre><p>This creates the container’s root directory in <code class="literal">/var/lib/nixos-containers/foo</code>
and a small configuration file in <code class="literal">/etc/nixos-containers/foo.conf</code>. It also
builds the container’s initial system configuration and stores it in
<code class="literal">/nix/var/nix/profiles/per-container/foo/system</code>. You can modify the
initial configuration of the container on the command line. For
instance, to create a container that has <code class="literal">sshd</code> running, with the given
public key for <code class="literal">root</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container create foo --config <span class="hljs-string">'</span></span>
  services.openssh.enable = true;
  users.users.root.openssh.authorizedKeys.keys = ["ssh-dss AAAAB3N…"];
'
</code></pre><p>By default the next free address in the <code class="literal">10.233.0.0/16</code> subnet will be
chosen as container IP. This behavior can be altered by setting
<code class="literal">--host-address</code> and <code class="literal">--local-address</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container create <span class="hljs-built_in">test</span> --config-file test-container.nix \
    --local-address 10.235.1.2 --host-address 10.235.1.1</span>
</code></pre><p>Creating a container does not start it. To start the container, run:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container start foo</span>
</code></pre><p>This command will return as soon as the container has booted and has
reached <code class="literal">multi-user.target</code>. On the host, the container runs within a
systemd unit called <code class="literal">container@container-name.service</code>. Thus, if
something went wrong, you can get status info using <code class="literal">systemctl</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl status container@foo</span>
</code></pre><p>If the container has started successfully, you can log in as root using
the <code class="literal">root-login</code> operation:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container root-login foo</span>
[root@foo:~]#
</code></pre><p>Note that only root on the host can do this (since there is no
authentication). You can also get a regular login prompt using the
<code class="literal">login</code> operation, which is available to all users on the host:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container login foo</span>
foo login: alice
Password: ***
</code></pre><p>With <code class="literal">nixos-container run</code>, you can execute arbitrary commands in the
container:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container run foo -- <span class="hljs-built_in">uname</span> -a</span>
Linux foo 3.4.82 #1-NixOS SMP Thu Mar 20 14:44:05 UTC 2014 x86_64 GNU/Linux
</code></pre><p>There are several ways to change the configuration of the container.
First, on the host, you can edit
<code class="literal">/var/lib/container/name/etc/nixos/configuration.nix</code>, and run</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container update foo</span>
</code></pre><p>This will build and activate the new configuration. You can also specify
a new configuration on the command line:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container update foo --config <span class="hljs-string">'</span></span>
  services.httpd.enable = true;
  services.httpd.adminAddr = "foo@example.org";
  networking.firewall.allowedTCPPorts = [ 80 ];
'
<span class="hljs-meta prompt_">
# </span><span class="language-bash"><span class="hljs-string">curl http://$(nixos-container show-ip foo)/</span></span>
&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;…
</code></pre><p>However, note that this will overwrite the container’s
<code class="literal">/etc/nixos/configuration.nix</code>.</p><p>Alternatively, you can change the configuration from within the
container itself by running <code class="literal">nixos-rebuild switch</code> inside the container.
Note that the container by default does not have a copy of the NixOS
channel, so you should run <code class="literal">nix-channel --update</code> first.</p><p>Containers can be stopped and started using <code class="literal">nixos-container   stop</code> and <code class="literal">nixos-container start</code>, respectively, or by using
<code class="literal">systemctl</code> on the container’s service unit. To destroy a container,
including its file system, do</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container destroy foo</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-declarative-containers" class="title" style="clear: both">Declarative Container Specification   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-declarative-containers" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can also specify containers and their configuration in the host’s
<code class="literal">configuration.nix</code>. For example, the following specifies that there
shall be a container named <code class="literal">database</code> running PostgreSQL:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">containers.<span class="hljs-attr">database</span> =
  { <span class="hljs-attr">config</span> =
      { config, pkgs, ... }:
      { services.postgresql.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
      services.postgresql.<span class="hljs-attr">package</span> = pkgs.postgresql_14;
      };
  };
</code></pre><p>If you run <code class="literal">nixos-rebuild switch</code>, the container will be built. If the
container was already running, it will be updated in place, without
rebooting. The container can be configured to start automatically by
setting <code class="literal">containers.database.autoStart = true</code> in its configuration.</p><p>By default, declarative containers share the network namespace of the
host, meaning that they can listen on (privileged) ports. However, they
cannot change the network configuration. You can give a container its
own network as follows:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">containers.<span class="hljs-attr">database</span> = {
  <span class="hljs-attr">privateNetwork</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">hostAddress</span> = <span class="hljs-string">"192.168.100.10"</span>;
  <span class="hljs-attr">localAddress</span> = <span class="hljs-string">"192.168.100.11"</span>;
};
</code></pre><p>This gives the container a private virtual Ethernet interface with IP
address <code class="literal">192.168.100.11</code>, which is hooked up to a virtual Ethernet
interface on the host with IP address <code class="literal">192.168.100.10</code>. (See the next
section for details on container networking.)</p><p>To disable the container, just remove it from <code class="literal">configuration.nix</code> and
run <code class="literal">nixos-rebuild   switch</code>. Note that this will not delete the root directory of the
container in <code class="literal">/var/lib/nixos-containers</code>. Containers can be destroyed using
the imperative method: <code class="literal">nixos-container destroy foo</code>.</p><p>Declarative containers can be started and stopped using the
corresponding systemd service, e.g.
<code class="literal">systemctl start container@database</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-container-networking" class="title" style="clear: both">Container Networking   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-container-networking" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>When you create a container using <code class="literal">nixos-container create</code>, it gets it
own private IPv4 address in the range <code class="literal">10.233.0.0/16</code>. You can get the
container’s IPv4 address as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-container show-ip foo</span>
10.233.4.2
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">ping -c1 10.233.4.2</span>
64 bytes from 10.233.4.2: icmp_seq=1 ttl=64 time=0.106 ms
</code></pre><p>Networking is implemented using a pair of virtual Ethernet devices. The
network interface in the container is called <code class="literal">eth0</code>, while the matching
interface in the host is called <code class="literal">ve-container-name</code> (e.g., <code class="literal">ve-foo</code>).
The container has its own network namespace and the <code class="literal">CAP_NET_ADMIN</code>
capability, so it can perform arbitrary network configuration such as
setting up firewall rules, without affecting or having access to the
host’s network.</p><p>By default, containers cannot talk to the outside network. If you want
that, you should set up Network Address Translation (NAT) rules on the
host to rewrite container traffic to use your external IP address. This
can be accomplished using the following configuration on the host:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.nat.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
networking.nat.<span class="hljs-attr">internalInterfaces</span> = [<span class="hljs-string">"ve-+"</span>];
networking.nat.<span class="hljs-attr">externalInterface</span> = <span class="hljs-string">"eth0"</span>;
</code></pre><p>where <code class="literal">eth0</code> should be replaced with the desired external interface.
Note that <code class="literal">ve-+</code> is a wildcard that matches all container interfaces.</p><p>If you are using Network Manager, you need to explicitly prevent it from
managing container interfaces:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">networking.networkmanager.<span class="hljs-attr">unmanaged</span> = [ <span class="hljs-string">"interface-name:ve-*"</span> ];
</code></pre><p>You may need to restart your system for the changes to take effect.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-troubleshooting" class="title">Troubleshooting   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-troubleshooting" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-boot-problems">Boot Problems</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-maintenance-mode">Maintenance Mode</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-rollback">Rolling Back Configuration Changes</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-nix-store-corruption">Nix Store Corruption</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-nix-network-issues">Network Problems</a> </span></dt> </dl></div><p>This chapter describes solutions to common problems you might encounter
when you manage your NixOS system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-boot-problems" class="title" style="clear: both">Boot Problems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-boot-problems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>If NixOS fails to boot, there are a number of kernel command line parameters that may help you to identify or fix the issue. You can add these parameters in the GRUB boot menu by pressing “e” to modify the selected boot entry and editing the line starting with <code class="literal">linux</code>. The following are some useful kernel command line parameters that are recognised by the NixOS boot scripts or by systemd:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">boot.shell_on_fail</code></span></dt><dd><p>Allows the user to start a root shell if something goes wrong in stage 1 of the boot process (the initial ramdisk). This is disabled by default because there is no authentication for the root shell.</p></dd><dt><span class="term"><code class="literal">boot.debug1</code></span></dt><dd><p>Start an interactive shell in stage 1 before anything useful has been done. That is, no modules have been loaded and no file systems have been mounted, except for <code class="literal">/proc</code> and <code class="literal">/sys</code>.</p></dd><dt><span class="term"><code class="literal">boot.debug1devices</code></span></dt><dd><p>Like <code class="literal">boot.debug1</code>, but runs stage1 until kernel modules are loaded and device nodes are created. This may help with e.g. making the keyboard work.</p></dd><dt><span class="term"><code class="literal">boot.debug1mounts</code></span></dt><dd><p>Like <code class="literal">boot.debug1</code> or <code class="literal">boot.debug1devices</code>, but runs stage1 until all filesystems that are mounted during initrd are mounted (see <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-fileSystems._name_.neededForBoot">neededForBoot</a>). As a motivating example, this could be useful if you’ve forgotten to set <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-fileSystems._name_.neededForBoot">neededForBoot</a> on a file system.</p></dd><dt><span class="term"><code class="literal">boot.trace</code></span></dt><dd><p>Print every shell command executed by the stage 1 and 2 boot scripts.</p></dd><dt><span class="term"><code class="literal">single</code></span></dt><dd><p>Boot into rescue mode (a.k.a. single user mode). This will cause systemd to start nothing but the unit <code class="literal">rescue.target</code>, which runs <code class="literal">sulogin</code> to prompt for the root password and start a root login shell. Exiting the shell causes the system to continue with the normal boot process.</p></dd><dt><span class="term"><code class="literal">systemd.log_level=debug</code> <code class="literal">systemd.log_target=console</code></span></dt><dd><p>Make systemd very verbose and send log messages to the console instead of the journal. For more parameters recognised by systemd, see systemd(1).</p></dd></dl></div><p>In addition, these arguments are recognised by the live image only:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">live.nixos.passwd=password</code></span></dt><dd><p>Set the password for the <code class="literal">nixos</code> live user. This can be used for SSH access if there are issues using the terminal.</p></dd></dl></div><p>Notice that for <code class="literal">boot.shell_on_fail</code>, <code class="literal">boot.debug1</code>, <code class="literal">boot.debug1devices</code>, and <code class="literal">boot.debug1mounts</code>, if you did <span class="strong"><strong>not</strong></span> select “start the new shell as pid 1”, and you <code class="literal">exit</code> from the new shell, boot will proceed normally from the point where it failed, as if you’d chosen “ignore the error and continue”.</p><p>If no login prompts or X11 login screens appear (e.g. due to hanging dependencies), you can press Alt+ArrowUp. If you’re lucky, this will start rescue mode (described above). (Also note that since most units have a 90-second timeout before systemd gives up on them, the <code class="literal">agetty</code> login prompts should appear eventually unless something is very wrong.)</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-maintenance-mode" class="title" style="clear: both">Maintenance Mode   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-maintenance-mode" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can enter rescue mode by running:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl rescue</span>
</code></pre><p>This will eventually give you a single-user root shell. Systemd will
stop (almost) all system services. To get out of maintenance mode, just
exit from the rescue shell.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-rollback" class="title" style="clear: both">Rolling Back Configuration Changes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-rollback" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>After running <code class="literal">nixos-rebuild</code> to switch to a new configuration, you may
find that the new configuration doesn’t work very well. In that case,
there are several ways to return to a previous configuration.</p><p>First, the GRUB boot manager allows you to boot into any previous
configuration that hasn’t been garbage-collected. These configurations
can be found under the GRUB submenu “NixOS - All configurations”. This
is especially useful if the new configuration fails to boot. After the
system has booted, you can make the selected configuration the default
for subsequent boots:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">/run/current-system/bin/switch-to-configuration boot</span>
</code></pre><p>Second, you can switch to the previous configuration in a running
system:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch --rollback</span>
</code></pre><p>This is equivalent to running:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">/nix/var/nix/profiles/system-N-<span class="hljs-built_in">link</span>/bin/switch-to-configuration switch</span>
</code></pre><p>where <code class="literal">N</code> is the number of the NixOS system configuration. To get a
list of the available configurations, do:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ls</span> -l /nix/var/nix/profiles/system-*-<span class="hljs-built_in">link</span></span>
...
lrwxrwxrwx 1 root root 78 Aug 12 13:54 /nix/var/nix/profiles/system-268-link -&gt; /nix/store/202b...-nixos-13.07pre4932_5a676e4-4be1055
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-store-corruption" class="title" style="clear: both">Nix Store Corruption   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nix-store-corruption" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>After a system crash, it’s possible for files in the Nix store to become
corrupted. (For instance, the Ext4 file system has the tendency to
replace un-synced files with zero bytes.) NixOS tries hard to prevent
this from happening: it performs a <code class="literal">sync</code> before switching to a new
configuration, and Nix’s database is fully transactional. If corruption
still occurs, you may be able to fix it automatically.</p><p>If the corruption is in a path in the closure of the NixOS system
configuration, you can fix it by doing</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch --repair</span>
</code></pre><p>This will cause Nix to check every path in the closure, and if its
cryptographic hash differs from the hash recorded in Nix’s database, the
path is rebuilt or redownloaded.</p><p>You can also scan the entire Nix store for corrupt paths:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nix-store --verify --check-contents --repair</span>
</code></pre><p>Any corrupt paths will be redownloaded if they’re available in a binary
cache; otherwise, they cannot be repaired.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nix-network-issues" class="title" style="clear: both">Network Problems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nix-network-issues" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Nix uses a so-called <span class="emphasis"><em>binary cache</em></span> to optimise building a package from
source into downloading it as a pre-built binary. That is, whenever a
command like <code class="literal">nixos-rebuild</code> needs a path in the Nix store, Nix will try
to download that path from the Internet rather than build it from
source. The default binary cache is <code class="literal">https://cache.nixos.org/</code>. If this
cache is unreachable, Nix operations may take a long time due to HTTP
connection timeouts. You can disable the use of the binary cache by
adding <code class="literal">--option use-binary-caches false</code>, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch --option use-binary-caches <span class="hljs-literal">false</span></span>
</code></pre><p>If you have an alternative binary cache at your disposal, you can use it
instead:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch --option binary-caches http://my-cache.example.org/</span>
</code></pre>
</div>
</div>
</div><div class="part"> <div class="titlepage">  <div>   <div>    <h1 id="ch-development" class="title">Development   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-development" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><div class="partintro"><p>This chapter describes how you can modify and extend NixOS.</p><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-getting-sources">Getting the Sources</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-modules">Writing NixOS Modules</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-building-parts">Building Specific Parts of NixOS</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec">Experimental feature: Bootspec</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-switching-systems">What happens during a system switch?</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-documentation">Writing NixOS Documentation</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests">NixOS Tests</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#chap-developing-the-test-driver">Developing the NixOS Test Driver</a> </span></dt><dt> <span class="chapter">  <a href="https://nixos.org/manual/nixos/stable/#ch-testing-installer">Testing the Installer</a> </span></dt> </dl></div></div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-getting-sources" class="title">Getting the Sources   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-getting-sources" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>By default, NixOS’s <code class="literal">nixos-rebuild</code> command uses the NixOS and Nixpkgs
sources provided by the <code class="literal">nixos</code> channel (kept in
<code class="literal">/nix/var/nix/profiles/per-user/root/channels/nixos</code>). To modify NixOS,
however, you should check out the latest sources from Git. This is as
follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">clone</span> https://github.com/NixOS/nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">git remote update origin</span>
</code></pre><p>This will check out the latest Nixpkgs sources to <code class="literal">./nixpkgs</code> the NixOS
sources to <code class="literal">./nixpkgs/nixos</code>. (The NixOS source tree lives in a
subdirectory of the Nixpkgs repository.) The <code class="literal">nixpkgs</code> repository has
branches that correspond to each Nixpkgs/NixOS channel (see
<a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-upgrading" title="Upgrading NixOS"><em>Upgrading NixOS</em></a> for more information about channels). Thus, the
Git branch <code class="literal">origin/nixos-17.03</code> will contain the latest built and tested
version available in the <code class="literal">nixos-17.03</code> channel.</p><p>It’s often inconvenient to develop directly on the master branch, since
if somebody has just committed (say) a change to GCC, then the binary
cache may not have caught up yet and you’ll have to rebuild everything
from source. So you may want to create a local branch based on your
current NixOS version:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nixos-version</span>
17.09pre104379.6e0b727 (Hummingbird)
<span class="hljs-meta prompt_">
$ </span><span class="language-bash">git checkout -b <span class="hljs-built_in">local</span> 6e0b727</span>
</code></pre><p>Or, to base your local branch on the latest version available in a NixOS
channel:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git remote update origin</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">git checkout -b <span class="hljs-built_in">local</span> origin/nixos-17.03</span>
</code></pre><p>(Replace <code class="literal">nixos-17.03</code> with the name of the channel you want to use.)
You can use <code class="literal">git merge</code> or <code class="literal">git   rebase</code> to keep your local branch in sync with the channel, e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git remote update origin</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">git merge origin/nixos-17.03</span>
</code></pre><p>You can use <code class="literal">git cherry-pick</code> to copy commits from your local branch to
the upstream branch.</p><p>If you want to rebuild your system using your (modified) sources, you
need to tell <code class="literal">nixos-rebuild</code> about them using the <code class="literal">-I</code> flag:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-rebuild switch -I nixpkgs=/my/sources/nixpkgs</span>
</code></pre><p>If you want <code class="literal">nix-env</code> to use the expressions in <code class="literal">/my/sources</code>, use
<code class="literal">nix-env -f   /my/sources/nixpkgs</code>, or change the default by adding a symlink in
<code class="literal">~/.nix-defexpr</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">ln</span> -s /my/sources/nixpkgs ~/.nix-defexpr/nixpkgs</span>
</code></pre><p>You may want to delete the symlink <code class="literal">~/.nix-defexpr/channels_root</code> to
prevent root’s NixOS channel from clashing with your own tree (this may
break the command-not-found utility though). If you want to go back to
the default state, you may just remove the <code class="literal">~/.nix-defexpr</code> directory
completely, log out and log in again and it should have been recreated
with a link to the root channels.</p>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-modules" class="title">Writing NixOS Modules   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-modules" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-option-declarations">Option Declarations</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-option-types">Options Types</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-option-definitions">Option Definitions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-assertions">Warnings and Assertions</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-meta-attributes">Meta Attributes</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-importing-modules">Importing Modules</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-replace-modules">Replace Modules</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-freeform-modules">Freeform modules</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-settings-options">Options for Program Settings</a> </span></dt> </dl></div><p>NixOS has a modular system for declarative configuration. This system
combines multiple <span class="emphasis"><em>modules</em></span> to produce the full system configuration.
One of the modules that constitute the configuration is
<code class="literal">/etc/nixos/configuration.nix</code>. Most of the others live in the
<a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/modules" target="_top"><code class="literal">nixos/modules</code></a>
subdirectory of the Nixpkgs tree.</p><p>Each NixOS module is a file that handles one logical aspect of the
configuration, such as a specific kind of hardware, a service, or
network settings. A module configuration does not have to handle
everything from scratch; it can use the functionality provided by other
modules for its implementation. Thus a module can <span class="emphasis"><em>declare</em></span> options that
can be used by other modules, and conversely can <span class="emphasis"><em>define</em></span> options
provided by other modules in its own implementation. For example, the
module
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/security/pam.nix" target="_top"><code class="literal">pam.nix</code></a>
declares the option <code class="literal">security.pam.services</code> that allows other modules (e.g.
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/networking/ssh/sshd.nix" target="_top"><code class="literal">sshd.nix</code></a>)
to define PAM services; and it defines the option <code class="literal">environment.etc</code> (declared by
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/system/etc/etc.nix" target="_top"><code class="literal">etc.nix</code></a>)
to cause files to be created in <code class="literal">/etc/pam.d</code>.</p><p>In <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-configuration-syntax" title="Configuration Syntax"><em>Configuration Syntax</em></a>, we saw the following structure of
NixOS modules:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{ option definitions
}
</code></pre><p>This is actually an <span class="emphasis"><em>abbreviated</em></span> form of module that only defines
options, but does not declare any. The structure of full NixOS modules
is shown in <a class="link" href="https://nixos.org/manual/nixos/stable/#ex-module-syntax" title="Example 11. Structure of NixOS Modules">Example: Structure of NixOS Modules</a>.</p><div class="example"><span id="ex-module-syntax"></span><p class="title"><strong>Example&nbsp;11.&nbsp;Structure of NixOS Modules</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, pkgs, ... }:

{
  <span class="hljs-attr">imports</span> =
    [ paths of other modules
    ];

  <span class="hljs-attr">options</span> = {
    option declarations
  };

  <span class="hljs-attr">config</span> = {
    option definitions
  };
}
</code></pre></div></div><br class="example-break"><p>The meaning of each part is as follows.</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The first line makes the current Nix expression a function. The variable
<code class="literal">pkgs</code> contains Nixpkgs (by default, it takes the <code class="literal">nixpkgs</code> entry of
<code class="literal">NIX_PATH</code>, see the <a class="link" href="https://nixos.org/manual/nix/stable/#sec-common-env" target="_top">Nix manual</a>
for further details), while <code class="literal">config</code> contains the full system
configuration. This line can be omitted if there is no reference to
<code class="literal">pkgs</code> and <code class="literal">config</code> inside the module.</p></li><li class="listitem"><p>This <code class="literal">imports</code> list enumerates the paths to other NixOS modules that
should be included in the evaluation of the system configuration. A
default set of modules is defined in the file <code class="literal">modules/module-list.nix</code>.
These don’t need to be added in the import list.</p></li><li class="listitem"><p>The attribute <code class="literal">options</code> is a nested set of <span class="emphasis"><em>option declarations</em></span>
(described below).</p></li><li class="listitem"><p>The attribute <code class="literal">config</code> is a nested set of <span class="emphasis"><em>option definitions</em></span> (also
described below).</p></li></ul></div><p><a class="link" href="https://nixos.org/manual/nixos/stable/#locate-example" title="Example 12. NixOS Module for the “locate” Service">Example: NixOS Module for the “locate” Service</a>
shows a module that handles the regular update of the “locate” database,
an index of all files in the file system. This module declares two
options that can be defined by other modules (typically the user’s
<code class="literal">configuration.nix</code>): <code class="literal">services.locate.enable</code> (whether the database should
be updated) and <code class="literal">services.locate.interval</code> (when the update should be done).
It implements its functionality by defining two options declared by other
modules: <code class="literal">systemd.services</code> (the set of all systemd services) and
<code class="literal">systemd.timers</code> (the list of commands to be executed periodically by
<code class="literal">systemd</code>).</p><p>Care must be taken when writing systemd services using <code class="literal">Exec*</code> directives. By
default systemd performs substitution on <code class="literal">%&lt;char&gt;</code> specifiers in these
directives, expands environment variables from <code class="literal">$FOO</code> and <code class="literal">${FOO}</code>, splits
arguments on whitespace, and splits commands on <code class="literal">;</code>. All of these must be escaped
to avoid unexpected substitution or splitting when interpolating into an <code class="literal">Exec*</code>
directive, e.g. when using an <code class="literal">extraArgs</code> option to pass additional arguments to
the service. The functions <code class="literal">utils.escapeSystemdExecArg</code> and
<code class="literal">utils.escapeSystemdExecArgs</code> are provided for this, see <a class="link" href="https://nixos.org/manual/nixos/stable/#exec-escaping-example" title="Example 13. Escaping in Exec directives">Example: Escaping in
Exec directives</a> for an example. When using these
functions system environment substitution should <span class="emphasis"><em>not</em></span> be disabled explicitly.</p><div class="example"><span id="locate-example"></span><p class="title"><strong>Example&nbsp;12.&nbsp;NixOS Module for the “locate” Service</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, ... }:

<span class="hljs-keyword">with</span> lib;

<span class="hljs-keyword">let</span>
  <span class="hljs-attr">cfg</span> = config.services.locate;
<span class="hljs-keyword">in</span> {
  options.services.<span class="hljs-attr">locate</span> = {
    <span class="hljs-attr">enable</span> = mkOption {
      <span class="hljs-attr">type</span> = types.bool;
      <span class="hljs-attr">default</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        If enabled, NixOS will periodically update the database of
        files used by the locate command.
      ''</span>;
    };

    <span class="hljs-attr">interval</span> = mkOption {
      <span class="hljs-attr">type</span> = types.str;
      <span class="hljs-attr">default</span> = <span class="hljs-string">"02:15"</span>;
      <span class="hljs-attr">example</span> = <span class="hljs-string">"hourly"</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Update the locate database at this interval. Updates by
        default at 2:15 AM every day.

        The format is described in
        systemd.time(7).
      ''</span>;
    };

    <span class="hljs-comment"># Other options omitted for documentation</span>
  };

  <span class="hljs-attr">config</span> = {
    systemd.services.<span class="hljs-attr">update-locatedb</span> =
      { <span class="hljs-attr">description</span> = <span class="hljs-string">"Update Locate Database"</span>;
        <span class="hljs-attr">path</span>  = [ pkgs.su ];
        <span class="hljs-attr">script</span> =
          <span class="hljs-string">''
            mkdir -m 0755 -p $(dirname <span class="hljs-subst">${<span class="hljs-built_in">toString</span> cfg.output}</span>)
            exec updatedb \
              --localuser=<span class="hljs-subst">${cfg.localuser}</span> \
              <span class="hljs-subst">${optionalString (!cfg.includeStore) <span class="hljs-string">"--prunepaths='/nix/store'"</span>}</span> \
              --output=<span class="hljs-subst">${<span class="hljs-built_in">toString</span> cfg.output}</span> <span class="hljs-subst">${concatStringsSep <span class="hljs-string">" "</span> cfg.extraFlags}</span>
          ''</span>;
      };

    systemd.timers.<span class="hljs-attr">update-locatedb</span> = mkIf cfg.enable
      { <span class="hljs-attr">description</span> = <span class="hljs-string">"Update timer for locate database"</span>;
        <span class="hljs-attr">partOf</span>      = [ <span class="hljs-string">"update-locatedb.service"</span> ];
        <span class="hljs-attr">wantedBy</span>    = [ <span class="hljs-string">"timers.target"</span> ];
        timerConfig.<span class="hljs-attr">OnCalendar</span> = cfg.interval;
      };
  };
}
</code></pre></div></div><br class="example-break"><div class="example"><span id="exec-escaping-example"></span><p class="title"><strong>Example&nbsp;13.&nbsp;Escaping in Exec directives</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, utils, ... }:

<span class="hljs-keyword">with</span> lib;

<span class="hljs-keyword">let</span>
  <span class="hljs-attr">cfg</span> = config.services.echo;
  <span class="hljs-attr">echoAll</span> = pkgs.writeScript <span class="hljs-string">"echo-all"</span> <span class="hljs-string">''
    #! <span class="hljs-subst">${pkgs.runtimeShell}</span>
    for s in "$@"; do
      printf '%s\n' "$s"
    done
  ''</span>;
  <span class="hljs-attr">args</span> = [ <span class="hljs-string">"a%Nything"</span> <span class="hljs-string">"lang=\<span class="hljs-subst">${LANG}</span>"</span> <span class="hljs-string">";"</span> <span class="hljs-string">"/bin/sh -c date"</span> ];
<span class="hljs-keyword">in</span> {
  systemd.services.<span class="hljs-attr">echo</span> =
    { <span class="hljs-attr">description</span> = <span class="hljs-string">"Echo to the journal"</span>;
      <span class="hljs-attr">wantedBy</span> = [ <span class="hljs-string">"multi-user.target"</span> ];
      serviceConfig.<span class="hljs-attr">Type</span> = <span class="hljs-string">"oneshot"</span>;
      serviceConfig.<span class="hljs-attr">ExecStart</span> = <span class="hljs-string">''
        <span class="hljs-subst">${echoAll}</span> <span class="hljs-subst">${utils.escapeSystemdExecArgs args}</span>
      ''</span>;
    };
}
</code></pre></div></div><br class="example-break"><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-declarations" class="title" style="clear: both">Option Declarations   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-declarations" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>An option declaration specifies the name, type and description of a
NixOS configuration option. It is invalid to define an option that
hasn’t been declared in any module. An option declaration generally
looks like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">options</span> = {
  <span class="hljs-attr">name</span> = mkOption {
    <span class="hljs-attr">type</span> = type specification;
    <span class="hljs-attr">default</span> = default value;
    <span class="hljs-attr">example</span> = example value;
    <span class="hljs-attr">description</span> = lib.mdDoc <span class="hljs-string">"Description for use in the NixOS manual."</span>;
  };
};
</code></pre><p>The attribute names within the <code class="literal">name</code> attribute path must be camel
cased in general but should, as an exception, match the <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-package-naming" target="_top"> package
attribute name</a>
when referencing a Nixpkgs package. For example, the option
<code class="literal">services.nix-serve.bindAddress</code> references the <code class="literal">nix-serve</code> Nixpkgs
package.</p><p>The function <code class="literal">mkOption</code> accepts the following arguments.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>The type of the option (see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-option-types" title="Options Types">the section called “Options Types”</a>). This
argument is mandatory for nixpkgs modules. Setting this is highly
recommended for the sake of documentation and type checking. In case it is
not set, a fallback type with unspecified behavior is used.</p></dd><dt><span class="term"><code class="literal">default</code></span></dt><dd><p>The default value used if no value is defined by any module. A
default is not required; but if a default is not given, then users
of the module will have to define the value of the option, otherwise
an error will be thrown.</p></dd><dt><span class="term"><code class="literal">defaultText</code></span></dt><dd><p>A textual representation of the default value to be rendered verbatim in
the manual. Useful if the default value is a complex expression or depends
on other values or packages.
Use <code class="literal">lib.literalExpression</code> for a Nix expression, <code class="literal">lib.literalMD</code> for
a plain English description in <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-contributing-markup" target="_top">Nixpkgs-flavored Markdown</a> format.</p></dd><dt><span class="term"><code class="literal">example</code></span></dt><dd><p>An example value that will be shown in the NixOS manual.
You can use <code class="literal">lib.literalExpression</code> and <code class="literal">lib.literalMD</code> in the same way
as in <code class="literal">defaultText</code>.</p></dd><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>A textual description of the option, in <a class="link" href="https://nixos.org/nixpkgs/manual/#sec-contributing-markup" target="_top">Nixpkgs-flavored Markdown</a> format, that will be
included in the NixOS manual. During the migration process from DocBook
it is necessary to mark descriptions written in CommonMark with <code class="literal">lib.mdDoc</code>.
The description may still be written in DocBook (without any marker), but this
is discouraged and will be deprecated in the future.</p></dd></dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-declarations-util" class="title">Utility functions for common option patterns   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-declarations-util" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-declarations-util-mkEnableOption" class="title"><code class="literal">mkEnableOption</code>   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-declarations-util-mkEnableOption" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Creates an Option attribute set for a boolean value option i.e an
option to be toggled on or off.</p><p>This function takes a single string argument, the name of the thing to be toggled.</p><p>The option’s description is “Whether to enable &lt;name&gt;.”.</p><p>For example:</p><div class="example"><span id="ex-options-declarations-util-mkEnableOption-magic"></span><p class="title"><strong>Example&nbsp;14.&nbsp;<code class="literal">mkEnableOption</code> usage</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">lib.mkEnableOption (lib.mdDoc <span class="hljs-string">"magic"</span>)
<span class="hljs-comment"># is like</span>
lib.mkOption {
  <span class="hljs-attr">type</span> = lib.types.bool;
  <span class="hljs-attr">default</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">example</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">description</span> = lib.mdDoc <span class="hljs-string">"Whether to enable magic."</span>;
}
</code></pre></div></div><br class="example-break">
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-declarations-util-mkPackageOption" class="title"><code class="literal">mkPackageOption</code>   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-declarations-util-mkPackageOption" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Usage:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">mkPackageOption pkgs <span class="hljs-string">"name"</span> { <span class="hljs-attr">default</span> = [ <span class="hljs-string">"path"</span> <span class="hljs-string">"in"</span> <span class="hljs-string">"pkgs"</span> ]; <span class="hljs-attr">example</span> = <span class="hljs-string">"literal example"</span>; }
</code></pre><p>Creates an Option attribute set for an option that specifies the package a module should use for some purpose.</p><p><span class="strong"><strong>Note</strong></span>: You shouldn’t necessarily make package options for all of your modules. You can always overwrite a specific package throughout nixpkgs by using <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-overlays" target="_top">nixpkgs overlays</a>.</p><p>The package is specified in the third argument under <code class="literal">default</code> as a list of strings
representing its attribute path in nixpkgs (or another package set).
Because of this, you need to pass nixpkgs itself (or a subset) as the first argument.</p><p>The second argument may be either a string or a list of strings.
It provides the display name of the package in the description of the generated option
(using only the last element if the passed value is a list)
and serves as the fallback value for the <code class="literal">default</code> argument.</p><p>To include extra information in the description, pass <code class="literal">extraDescription</code> to
append arbitrary text to the generated description.
You can also pass an <code class="literal">example</code> value, either a literal string or an attribute path.</p><p>The default argument can be omitted if the provided name is
an attribute of pkgs (if name is a string) or a
valid attribute path in pkgs (if name is a list).</p><p>If you wish to explicitly provide no default, pass <code class="literal">null</code> as <code class="literal">default</code>.</p><p><span id="ex-options-declarations-util-mkPackageOption"></span>
Examples:</p><div class="example"><span id="ex-options-declarations-util-mkPackageOption-hello"></span><p class="title"><strong>Example&nbsp;15.&nbsp;Simple <code class="literal">mkPackageOption</code> usage</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">lib.mkPackageOption pkgs <span class="hljs-string">"hello"</span> { }
<span class="hljs-comment"># is like</span>
lib.mkOption {
  <span class="hljs-attr">type</span> = lib.types.package;
  <span class="hljs-attr">default</span> = pkgs.hello;
  <span class="hljs-attr">defaultText</span> = lib.literalExpression <span class="hljs-string">"pkgs.hello"</span>;
  <span class="hljs-attr">description</span> = lib.mdDoc <span class="hljs-string">"The hello package to use."</span>;
}
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-options-declarations-util-mkPackageOption-ghc"></span><p class="title"><strong>Example&nbsp;16.&nbsp;<code class="literal">mkPackageOption</code> with explicit default and example</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">lib.mkPackageOption pkgs <span class="hljs-string">"GHC"</span> {
  <span class="hljs-attr">default</span> = [ <span class="hljs-string">"ghc"</span> ];
  <span class="hljs-attr">example</span> = <span class="hljs-string">"pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])"</span>;
}
<span class="hljs-comment"># is like</span>
lib.mkOption {
  <span class="hljs-attr">type</span> = lib.types.package;
  <span class="hljs-attr">default</span> = pkgs.ghc;
  <span class="hljs-attr">defaultText</span> = lib.literalExpression <span class="hljs-string">"pkgs.ghc"</span>;
  <span class="hljs-attr">example</span> = lib.literalExpression <span class="hljs-string">"pkgs.haskell.packages.ghc92.ghc.withPackages (hkgs: [ hkgs.primes ])"</span>;
  <span class="hljs-attr">description</span> = lib.mdDoc <span class="hljs-string">"The GHC package to use."</span>;
}
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-options-declarations-util-mkPackageOption-extraDescription"></span><p class="title"><strong>Example&nbsp;17.&nbsp;<code class="literal">mkPackageOption</code> with additional description text</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">mkPackageOption pkgs [ <span class="hljs-string">"python39Packages"</span> <span class="hljs-string">"pytorch"</span> ] {
  <span class="hljs-attr">extraDescription</span> = <span class="hljs-string">"This is an example and doesn't actually do anything."</span>;
}
<span class="hljs-comment"># is like</span>
lib.mkOption {
  <span class="hljs-attr">type</span> = lib.types.package;
  <span class="hljs-attr">default</span> = pkgs.python39Packages.pytorch;
  <span class="hljs-attr">defaultText</span> = lib.literalExpression <span class="hljs-string">"pkgs.python39Packages.pytorch"</span>;
  <span class="hljs-attr">description</span> = <span class="hljs-string">"The pytorch package to use. This is an example and doesn't actually do anything."</span>;
}
</code></pre></div></div><br class="example-break">
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-declarations-eot" class="title">Extensible Option Types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-declarations-eot" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Extensible option types is a feature that allow to extend certain types
declaration through multiple module files. This feature only work with a
restricted set of types, namely <code class="literal">enum</code> and <code class="literal">submodules</code> and any composed
forms of them.</p><p>Extensible option types can be used for <code class="literal">enum</code> options that affects
multiple modules, or as an alternative to related <code class="literal">enable</code> options.</p><p>As an example, we will take the case of display managers. There is a
central display manager module for generic display manager options and a
module file per display manager backend (sddm, gdm …).</p><p>There are two approaches we could take with this module structure:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Configuring the display managers independently by adding an enable
option to every display manager module backend. (NixOS)</p></li><li class="listitem"><p>Configuring the display managers in the central module by adding
an option to select which display manager backend to use.</p></li></ul></div><p>Both approaches have problems.</p><p>Making backends independent can quickly become hard to manage. For
display managers, there can only be one enabled at a time, but the
type system cannot enforce this restriction as there is no relation
between each backend’s <code class="literal">enable</code> option. As a result, this restriction
has to be done explicitly by adding assertions in each display manager
backend module.</p><p>On the other hand, managing the display manager backends in the
central module will require changing the central module option every
time a new backend is added or removed.</p><p>By using extensible option types, it is possible to create a placeholder
option in the central module
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-service" title="Example 18. Extensible type placeholder in the service module">Example: Extensible type placeholder in the service module</a>),
and to extend it in each backend module
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-backend-gdm" title="Example 19. Extending services.xserver.displayManager.enable in the gdm module">Example: Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</a>,
<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-option-declaration-eot-backend-sddm" title="Example 20. Extending services.xserver.displayManager.enable in the sddm module">Example: Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</a>).</p><p>As a result, <code class="literal">displayManager.enable</code> option values can be added without
changing the main service module file and the type system automatically
enforces that there can only be a single display manager enabled.</p><div class="example"><span id="ex-option-declaration-eot-service"></span><p class="title"><strong>Example&nbsp;18.&nbsp;Extensible type placeholder in the service module</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.<span class="hljs-attr">enable</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"Display manager to use"</span>;
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; nullOr (enum [ ]);
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-option-declaration-eot-backend-gdm"></span><p class="title"><strong>Example&nbsp;19.&nbsp;Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">gdm</code> module</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.<span class="hljs-attr">enable</span> = mkOption {
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; nullOr (enum [ <span class="hljs-string">"gdm"</span> ]);
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-option-declaration-eot-backend-sddm"></span><p class="title"><strong>Example&nbsp;20.&nbsp;Extending <code class="literal">services.xserver.displayManager.enable</code> in the <code class="literal">sddm</code> module</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.xserver.displayManager.<span class="hljs-attr">enable</span> = mkOption {
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; nullOr (enum [ <span class="hljs-string">"sddm"</span> ]);
};
</code></pre></div></div><br class="example-break"><p>The placeholder declaration is a standard <code class="literal">mkOption</code> declaration, but it
is important that extensible option declarations only use the <code class="literal">type</code>
argument.</p><p>Extensible option types work with any of the composed variants of <code class="literal">enum</code>
such as <code class="literal">with types; nullOr (enum [ "foo" "bar" ])</code> or <code class="literal">with types; listOf (enum [ "foo" "bar" ])</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-types" class="title" style="clear: both">Options Types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Option types are a way to put constraints on the values a module option
can take. Types are also responsible of how values are merged in case of
multiple value definitions.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-basic" class="title">Basic types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-basic" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Basic types are the simplest available types in the module system. Basic
types include multiple string types that mainly differ in how definition
merging is handled.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.bool</code></span></dt><dd><p>A boolean, its values can be <code class="literal">true</code> or <code class="literal">false</code>.
All definitions must have the same value, after priorities. An error is thrown in case of a conflict.</p></dd><dt><span class="term"><code class="literal">types.boolByOr</code></span></dt><dd><p>A boolean, its values can be <code class="literal">true</code> or <code class="literal">false</code>.
The result is <code class="literal">true</code> if <span class="emphasis"><em>any</em></span> of multiple definitions is <code class="literal">true</code>.
In other words, definitions are merged with the logical <span class="emphasis"><em>OR</em></span> operator.</p></dd><dt><span class="term"><code class="literal">types.path</code></span></dt><dd><p>A filesystem path is anything that starts with a slash when
coerced to a string. Even if derivations can be considered as
paths, the more specific <code class="literal">types.package</code> should be preferred.</p></dd><dt><span class="term"><code class="literal">types.pathInStore</code></span></dt><dd><p>A path that is contained in the Nix store. This can be a top-level store
path like <code class="literal">pkgs.hello</code> or a descendant like <code class="literal">"${pkgs.hello}/bin/hello"</code>.</p></dd><dt><span class="term"><code class="literal">types.package</code></span></dt><dd><p>A top-level store path. This can be an attribute set pointing
to a store path, like a derivation or a flake input.</p></dd><dt><span class="term"><code class="literal">types.enum</code> <span class="emphasis"><em><code class="literal">l</code></em></span></span></dt><dd><p>One element of the list <span class="emphasis"><em><code class="literal">l</code></em></span>, e.g. <code class="literal">types.enum [ "left" "right" ]</code>.
Multiple definitions cannot be merged.</p></dd><dt><span class="term"><code class="literal">types.anything</code></span></dt><dd><p>A type that accepts any value and recursively merges attribute sets
together. This type is recommended when the option type is unknown.</p><div class="example"><span id="ex-types-anything"></span><p class="title"><strong>Example&nbsp;21.&nbsp;<code class="literal">types.anything</code></strong></p><div class="example-contents"><p>Two definitions of this type like</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">str</span> = lib.mkDefault <span class="hljs-string">"foo"</span>;
  pkg.<span class="hljs-attr">hello</span> = pkgs.hello;
  fun.<span class="hljs-attr">fun</span> = x: x + <span class="hljs-number">1</span>;
}
</code></pre><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">str</span> = lib.mkIf <span class="hljs-literal">true</span> <span class="hljs-string">"bar"</span>;
  pkg.<span class="hljs-attr">gcc</span> = pkgs.gcc;
  fun.<span class="hljs-attr">fun</span> = lib.mkForce (x: x + <span class="hljs-number">2</span>);
}
</code></pre><p>will get merged to</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">str</span> = <span class="hljs-string">"bar"</span>;
  pkg.<span class="hljs-attr">gcc</span> = pkgs.gcc;
  pkg.<span class="hljs-attr">hello</span> = pkgs.hello;
  fun.<span class="hljs-attr">fun</span> = x: x + <span class="hljs-number">2</span>;
}
</code></pre></div></div><br class="example-break"></dd><dt><span class="term"><code class="literal">types.raw</code></span></dt><dd><p>A type which doesn’t do any checking, merging or nested evaluation. It
accepts a single arbitrary value that is not recursed into, making it
useful for values coming from outside the module system, such as package
sets or arbitrary data. Options of this type are still evaluated according
to priorities and conditionals, so <code class="literal">mkForce</code>, <code class="literal">mkIf</code> and co. still work on
the option value itself, but not for any value nested within it. This type
should only be used when checking, merging and nested evaluation are not
desirable.</p></dd><dt><span class="term"><code class="literal">types.optionType</code></span></dt><dd><p>The type of an option’s type. Its merging operation ensures that nested
options have the correct file location annotated, and that if possible,
multiple option definitions are correctly merged together. The main use
case is as the type of the <code class="literal">_module.freeformType</code> option.</p></dd><dt><span class="term"><code class="literal">types.attrs</code></span></dt><dd><p>A free-form attribute set.</p><div class="warning"><h3 class="title">Warning</h3><p>This type will be deprecated in the future because it doesn’t
recurse into attribute sets, silently drops earlier attribute
definitions, and doesn’t discharge <code class="literal">lib.mkDefault</code>, <code class="literal">lib.mkIf</code>
and co. For allowing arbitrary attribute sets, prefer
<code class="literal">types.attrsOf types.anything</code> instead which doesn’t have these
problems.</p></div></dd><dt><span class="term"><code class="literal">types.pkgs</code></span></dt><dd><p>A type for the top level Nixpkgs package set.</p></dd></dl></div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-types-numeric" class="title">Numeric types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-numeric" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.int</code></span></dt><dd><p>A signed integer.</p></dd><dt><span class="term"><code class="literal">types.ints.{s8, s16, s32}</code></span></dt><dd><p>Signed integers with a fixed length (8, 16 or 32 bits). They go from
−2^n/2 to
2^n/2−1 respectively (e.g. <code class="literal">−128</code> to
<code class="literal">127</code> for 8 bits).</p></dd><dt><span class="term"><code class="literal">types.ints.unsigned</code></span></dt><dd><p>An unsigned integer (that is &gt;= 0).</p></dd><dt><span class="term"><code class="literal">types.ints.{u8, u16, u32}</code></span></dt><dd><p>Unsigned integers with a fixed length (8, 16 or 32 bits). They go
from 0 to 2^n−1 respectively (e.g. <code class="literal">0</code>
to <code class="literal">255</code> for 8 bits).</p></dd><dt><span class="term"><code class="literal">types.ints.between</code> <span class="emphasis"><em><code class="literal">lowest highest</code></em></span></span></dt><dd><p>An integer between <span class="emphasis"><em><code class="literal">lowest</code></em></span> and <span class="emphasis"><em><code class="literal">highest</code></em></span> (both inclusive).</p></dd><dt><span class="term"><code class="literal">types.ints.positive</code></span></dt><dd><p>A positive integer (that is &gt; 0).</p></dd><dt><span class="term"><code class="literal">types.port</code></span></dt><dd><p>A port number. This type is an alias to
<code class="literal">types.ints.u16</code>.</p></dd><dt><span class="term"><code class="literal">types.float</code></span></dt><dd><p>A floating point number.</p><div class="warning"><h3 class="title">Warning</h3><p>Converting a floating point number to a string with <code class="literal">toString</code> or <code class="literal">toJSON</code>
may result in <a class="link" href="https://github.com/NixOS/nix/issues/5733" target="_top">precision loss</a>.</p></div></dd><dt><span class="term"><code class="literal">types.number</code></span></dt><dd><p>Either a signed integer or a floating point number. No implicit conversion
is done between the two types, and multiple equal definitions will only be
merged if they have the same type.</p></dd><dt><span class="term"><code class="literal">types.numbers.between</code> <span class="emphasis"><em><code class="literal">lowest highest</code></em></span></span></dt><dd><p>An integer or floating point number between <span class="emphasis"><em><code class="literal">lowest</code></em></span> and <span class="emphasis"><em><code class="literal">highest</code></em></span> (both inclusive).</p></dd><dt><span class="term"><code class="literal">types.numbers.nonnegative</code></span></dt><dd><p>A nonnegative integer or floating point number (that is &gt;= 0).</p></dd><dt><span class="term"><code class="literal">types.numbers.positive</code></span></dt><dd><p>A positive integer or floating point number (that is &gt; 0).</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-option-types-string" class="title">String types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-string" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.str</code></span></dt><dd><p>A string. Multiple definitions cannot be merged.</p></dd><dt><span class="term"><code class="literal">types.separatedString</code> <span class="emphasis"><em><code class="literal">sep</code></em></span></span></dt><dd><p>A string. Multiple definitions are concatenated with <span class="emphasis"><em><code class="literal">sep</code></em></span>, e.g.
<code class="literal">types.separatedString "|"</code>.</p></dd><dt><span class="term"><code class="literal">types.lines</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a new line
<code class="literal">"\n"</code>.</p></dd><dt><span class="term"><code class="literal">types.commas</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a comma <code class="literal">","</code>.</p></dd><dt><span class="term"><code class="literal">types.envVar</code></span></dt><dd><p>A string. Multiple definitions are concatenated with a colon <code class="literal">":"</code>.</p></dd><dt><span class="term"><code class="literal">types.strMatching</code></span></dt><dd><p>A string matching a specific regular expression. Multiple
definitions cannot be merged. The regular expression is processed
using <code class="literal">builtins.match</code>.</p></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-submodule" class="title">Submodule types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-submodule" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Submodules are detailed in <a class="link" href="https://nixos.org/manual/nixos/stable/#section-option-types-submodule" title="Submodule">Submodule</a>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.submodule</code> <span class="emphasis"><em><code class="literal">o</code></em></span></span></dt><dd><p>A set of sub options <span class="emphasis"><em><code class="literal">o</code></em></span>. <span class="emphasis"><em><code class="literal">o</code></em></span> can be an attribute set, a function
returning an attribute set, or a path to a file containing such a
value. Submodules are used in composed types to create modular
options. This is equivalent to
<code class="literal">types.submoduleWith { modules = toList o; shorthandOnlyDefinesConfig = true; }</code>.</p></dd><dt><span class="term"><code class="literal">types.submoduleWith</code> { <span class="emphasis"><em><code class="literal">modules</code></em></span>, <span class="emphasis"><em><code class="literal">specialArgs</code></em></span> ? {}, <span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span> ? false }</span></dt><dd><p>Like <code class="literal">types.submodule</code>, but more flexible and with better defaults.
It has parameters</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><span class="emphasis"><em><code class="literal">modules</code></em></span> A list of modules to use by default for this
submodule type. This gets combined with all option definitions
to build the final list of modules that will be included.</p><div class="note"><h3 class="title">Note</h3><p>Only options defined with this argument are included in rendered
documentation.</p></div></li><li class="listitem"><p><span class="emphasis"><em><code class="literal">specialArgs</code></em></span> An attribute set of extra arguments to be passed
to the module functions. The option <code class="literal">_module.args</code> should be
used instead for most arguments since it allows overriding.
<span class="emphasis"><em><code class="literal">specialArgs</code></em></span> should only be used for arguments that can’t go
through the module fixed-point, because of infinite recursion or
other problems. An example is overriding the <code class="literal">lib</code> argument,
because <code class="literal">lib</code> itself is used to define <code class="literal">_module.args</code>, which
makes using <code class="literal">_module.args</code> to define it impossible.</p></li><li class="listitem"><p><span class="emphasis"><em><code class="literal">shorthandOnlyDefinesConfig</code></em></span> Whether definitions of this type
should default to the <code class="literal">config</code> section of a module (see
<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-module-syntax" title="Example 11. Structure of NixOS Modules">Example: Structure of NixOS Modules</a>)
if it is an attribute set. Enabling this only has a benefit
when the submodule defines an option named <code class="literal">config</code> or <code class="literal">options</code>.
In such a case it would allow the option to be set with
<code class="literal">the-submodule.config = "value"</code> instead of requiring
<code class="literal">the-submodule.config.config = "value"</code>. This is because
only when modules <span class="emphasis"><em>don’t</em></span> set the <code class="literal">config</code> or <code class="literal">options</code>
keys, all keys are interpreted as option definitions in the
<code class="literal">config</code> section. Enabling this option implicitly puts all
attributes in the <code class="literal">config</code> section.</p><p>With this option enabled, defining a non-<code class="literal">config</code> section
requires using a function:
<code class="literal">the-submodule = { ... }: { options = { ... }; }</code>.</p></li></ul></div></dd><dt><span class="term"><code class="literal">types.deferredModule</code></span></dt><dd><p>Whereas <code class="literal">submodule</code> represents an option tree, <code class="literal">deferredModule</code> represents
a module value, such as a module file or a configuration.</p><p>It can be set multiple times.</p><p>Module authors can use its value in <code class="literal">imports</code>, in <code class="literal">submoduleWith</code>’s <code class="literal">modules</code>
or in <code class="literal">evalModules</code>’ <code class="literal">modules</code> parameter, among other places.</p><p>Note that <code class="literal">imports</code> must be evaluated before the module fixpoint. Because
of this, deferred modules can only be imported into “other” fixpoints, such
as submodules.</p><p>One use case for this type is the type of a “default” module that allow the
user to affect all submodules in an <code class="literal">attrsOf submodule</code> at once. This is
more convenient and discoverable than expecting the module user to
type-merge with the <code class="literal">attrsOf submodule</code> option.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-composed" class="title">Composed types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-composed" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Composed types are types that take a type as parameter. <code class="literal">listOf    int</code> and <code class="literal">either int str</code> are examples of composed types.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">types.listOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>A list of <span class="emphasis"><em><code class="literal">t</code></em></span> type, e.g. <code class="literal">types.listOf         int</code>. Multiple definitions are merged with list concatenation.</p></dd><dt><span class="term"><code class="literal">types.attrsOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>An attribute set of where all the values are of <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
definitions result in the joined attribute set.</p><div class="note"><h3 class="title">Note</h3><p>This type is <span class="emphasis"><em>strict</em></span> in its values, which in turn means attributes
cannot depend on other attributes. See <code class="literal">          types.lazyAttrsOf</code> for a lazy version.</p></div></dd><dt><span class="term"><code class="literal">types.lazyAttrsOf</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>An attribute set of where all the values are of <span class="emphasis"><em><code class="literal">t</code></em></span> type. Multiple
definitions result in the joined attribute set. This is the lazy
version of <code class="literal">types.attrsOf         </code>, allowing attributes to depend on each other.</p><div class="warning"><h3 class="title">Warning</h3><p>This version does not fully support conditional definitions! With an
option <code class="literal">foo</code> of this type and a definition
<code class="literal">foo.attr = lib.mkIf false 10</code>, evaluating <code class="literal">foo ? attr</code> will return
<code class="literal">true</code> even though it should be false. Accessing the value will then
throw an error. For types <span class="emphasis"><em><code class="literal">t</code></em></span> that have an <code class="literal">emptyValue</code> defined,
that value will be returned instead of throwing an error. So if the
type of <code class="literal">foo.attr</code> was <code class="literal">lazyAttrsOf (nullOr int)</code>, <code class="literal">null</code> would be
returned instead for the same <code class="literal">mkIf false</code> definition.</p></div></dd><dt><span class="term"><code class="literal">types.nullOr</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p><code class="literal">null</code> or type <span class="emphasis"><em><code class="literal">t</code></em></span>. Multiple definitions are merged according to
type <span class="emphasis"><em><code class="literal">t</code></em></span>.</p></dd><dt><span class="term"><code class="literal">types.uniq</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span> cannot be merged. It is used to ensure option
definitions are declared only once.</p></dd><dt><span class="term"><code class="literal">types.unique</code> <code class="literal">{ message = m }</code> <span class="emphasis"><em><code class="literal">t</code></em></span></span></dt><dd><p>Ensures that type <span class="emphasis"><em><code class="literal">t</code></em></span> cannot be merged. Prints the message <span class="emphasis"><em><code class="literal">m</code></em></span>, after
the line <code class="literal">The option &lt;option path&gt; is defined multiple times.</code> and before
a list of definition locations.</p></dd><dt><span class="term"><code class="literal">types.either</code> <span class="emphasis"><em><code class="literal">t1 t2</code></em></span></span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type <span class="emphasis"><em><code class="literal">t2</code></em></span>, e.g. <code class="literal">with types; either int str</code>.
Multiple definitions cannot be merged.</p></dd><dt><span class="term"><code class="literal">types.oneOf</code> [ <span class="emphasis"><em><code class="literal">t1 t2</code></em></span> … ]</span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">t1</code></em></span> or type <span class="emphasis"><em><code class="literal">t2</code></em></span> and so forth, e.g.
<code class="literal">with types; oneOf [ int str bool ]</code>. Multiple definitions cannot be
merged.</p></dd><dt><span class="term"><code class="literal">types.coercedTo</code> <span class="emphasis"><em><code class="literal">from f to</code></em></span></span></dt><dd><p>Type <span class="emphasis"><em><code class="literal">to</code></em></span> or type <span class="emphasis"><em><code class="literal">from</code></em></span> which will be coerced to type <span class="emphasis"><em><code class="literal">to</code></em></span> using
function <span class="emphasis"><em><code class="literal">f</code></em></span> which takes an argument of type <span class="emphasis"><em><code class="literal">from</code></em></span> and return a
value of type <span class="emphasis"><em><code class="literal">to</code></em></span>. Can be used to preserve backwards compatibility
of an option if its type was changed.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="section-option-types-submodule" class="title">Submodule   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#section-option-types-submodule" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p><code class="literal">submodule</code> is a very powerful type that defines a set of sub-options
that are handled like a separate module.</p><p>It takes a parameter <span class="emphasis"><em><code class="literal">o</code></em></span>, that should be a set, or a function returning
a set with an <code class="literal">options</code> key defining the sub-options. Submodule option
definitions are type-checked accordingly to the <code class="literal">options</code> declarations.
Of course, you can nest submodule option definitions for even higher
modularity.</p><p>The option set can be defined directly
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-direct" title="Example 22. Directly defined submodule">Example: Directly defined submodule</a>) or as reference
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-reference" title="Example 23. Submodule defined as a reference">Example: Submodule defined as a reference</a>).</p><p>Note that even if your submodule’s options all have a default value,
you will still need to provide a default value (e.g. an empty attribute set)
if you want to allow users to leave it undefined.</p><div class="example"><span id="ex-submodule-direct"></span><p class="title"><strong>Example&nbsp;22.&nbsp;Directly defined submodule</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">options.<span class="hljs-attr">mod</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"submodule example"</span>;
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; submodule {
    <span class="hljs-attr">options</span> = {
      <span class="hljs-attr">foo</span> = mkOption {
        <span class="hljs-attr">type</span> = int;
      };
      <span class="hljs-attr">bar</span> = mkOption {
        <span class="hljs-attr">type</span> = str;
      };
    };
  };
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-submodule-reference"></span><p class="title"><strong>Example&nbsp;23.&nbsp;Submodule defined as a reference</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span>
  <span class="hljs-attr">modOptions</span> = {
    <span class="hljs-attr">options</span> = {
      <span class="hljs-attr">foo</span> = mkOption {
        <span class="hljs-attr">type</span> = int;
      };
      <span class="hljs-attr">bar</span> = mkOption {
        <span class="hljs-attr">type</span> = int;
      };
    };
  };
<span class="hljs-keyword">in</span>
options.<span class="hljs-attr">mod</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"submodule example"</span>;
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; submodule modOptions;
};
</code></pre></div></div><br class="example-break"><p>The <code class="literal">submodule</code> type is especially interesting when used with composed
types like <code class="literal">attrsOf</code> or <code class="literal">listOf</code>. When composed with <code class="literal">listOf</code>
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-listof-declaration" title="Example 24. Declaration of a list of submodules">Example: Declaration of a list of submodules</a>), <code class="literal">submodule</code> allows
multiple definitions of the submodule option set
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-listof-definition" title="Example 25. Definition of a list of submodules">Example: Definition of a list of submodules</a>).</p><div class="example"><span id="ex-submodule-listof-declaration"></span><p class="title"><strong>Example&nbsp;24.&nbsp;Declaration of a list of submodules</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">options.<span class="hljs-attr">mod</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"submodule example"</span>;
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; listOf (submodule {
    <span class="hljs-attr">options</span> = {
      <span class="hljs-attr">foo</span> = mkOption {
        <span class="hljs-attr">type</span> = int;
      };
      <span class="hljs-attr">bar</span> = mkOption {
        <span class="hljs-attr">type</span> = str;
      };
    };
  });
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-submodule-listof-definition"></span><p class="title"><strong>Example&nbsp;25.&nbsp;Definition of a list of submodules</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">config.<span class="hljs-attr">mod</span> = [
  { <span class="hljs-attr">foo</span> = <span class="hljs-number">1</span>; <span class="hljs-attr">bar</span> = <span class="hljs-string">"one"</span>; }
  { <span class="hljs-attr">foo</span> = <span class="hljs-number">2</span>; <span class="hljs-attr">bar</span> = <span class="hljs-string">"two"</span>; }
];
</code></pre></div></div><br class="example-break"><p>When composed with <code class="literal">attrsOf</code>
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-attrsof-declaration" title="Example 26. Declaration of attribute sets of submodules">Example: Declaration of attribute sets of submodules</a>), <code class="literal">submodule</code> allows
multiple named definitions of the submodule option set
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-submodule-attrsof-definition" title="Example 27. Definition of attribute sets of submodules">Example: Definition of attribute sets of submodules</a>).</p><div class="example"><span id="ex-submodule-attrsof-declaration"></span><p class="title"><strong>Example&nbsp;26.&nbsp;Declaration of attribute sets of submodules</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">options.<span class="hljs-attr">mod</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"submodule example"</span>;
  <span class="hljs-attr">type</span> = <span class="hljs-keyword">with</span> types; attrsOf (submodule {
    <span class="hljs-attr">options</span> = {
      <span class="hljs-attr">foo</span> = mkOption {
        <span class="hljs-attr">type</span> = int;
      };
      <span class="hljs-attr">bar</span> = mkOption {
        <span class="hljs-attr">type</span> = str;
      };
    };
  });
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-submodule-attrsof-definition"></span><p class="title"><strong>Example&nbsp;27.&nbsp;Definition of attribute sets of submodules</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">config.mod.<span class="hljs-attr">one</span> = { <span class="hljs-attr">foo</span> = <span class="hljs-number">1</span>; <span class="hljs-attr">bar</span> = <span class="hljs-string">"one"</span>; };
config.mod.<span class="hljs-attr">two</span> = { <span class="hljs-attr">foo</span> = <span class="hljs-number">2</span>; <span class="hljs-attr">bar</span> = <span class="hljs-string">"two"</span>; };
</code></pre></div></div><br class="example-break">
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-extending" class="title">Extending types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-extending" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Types are mainly characterized by their <code class="literal">check</code> and <code class="literal">merge</code> functions.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">check</code></span></dt><dd><p>The function to type check the value. Takes a value as parameter and
return a boolean. It is possible to extend a type check with the
<code class="literal">addCheck</code> function (<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-extending-type-check-1" title="Example 28. Adding a type check">Example: Adding a type check</a>),
or to fully override the check function
(<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-extending-type-check-2" title="Example 29. Overriding a type check">Example: Overriding a type check</a>).</p><div class="example"><span id="ex-extending-type-check-1"></span><p class="title"><strong>Example&nbsp;28.&nbsp;Adding a type check</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">byte</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"An integer between 0 and 255."</span>;
  <span class="hljs-attr">type</span> = types.addCheck types.int (x: x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt;= <span class="hljs-number">255</span>);
};
</code></pre></div></div><br class="example-break"><div class="example"><span id="ex-extending-type-check-2"></span><p class="title"><strong>Example&nbsp;29.&nbsp;Overriding a type check</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">nixThings</span> = mkOption {
  <span class="hljs-attr">description</span> = <span class="hljs-string">"words that start with 'nix'"</span>;
  <span class="hljs-attr">type</span> = types.str // {
    <span class="hljs-attr">check</span> = (x: lib.hasPrefix <span class="hljs-string">"nix"</span> x)
  };
};
</code></pre></div></div><br class="example-break"></dd><dt><span class="term"><code class="literal">merge</code></span></dt><dd><p>Function to merge the options values when multiple values are set.
The function takes two parameters, <code class="literal">loc</code> the option path as a list
of strings, and <code class="literal">defs</code> the list of defined values as a list. It is
possible to override a type merge function for custom needs.</p></dd></dl></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-types-custom" class="title">Custom types   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-types-custom" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Custom types can be created with the <code class="literal">mkOptionType</code> function. As type
creation includes some more complex topics such as submodule handling,
it is recommended to get familiar with <code class="literal">types.nix</code> code before creating
a new type.</p><p>The only required parameter is <code class="literal">name</code>.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">name</code></span></dt><dd><p>A string representation of the type function name.</p></dd><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>Description of the type used in documentation. Give information of
the type and any of its arguments.</p></dd><dt><span class="term"><code class="literal">check</code></span></dt><dd><p>A function to type check the definition value. Takes the definition
value as a parameter and returns a boolean indicating the type check
result, <code class="literal">true</code> for success and <code class="literal">false</code> for failure.</p></dd><dt><span class="term"><code class="literal">merge</code></span></dt><dd><p>A function to merge multiple definitions values. Takes two
parameters:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">loc</code></em></span></span></dt><dd><p>The option path as a list of strings, e.g. <code class="literal">["boot" "loader            "grub" "enable"]</code>.</p></dd><dt><span class="term"><span class="emphasis"><em><code class="literal">defs</code></em></span></span></dt><dd><p>The list of sets of defined <code class="literal">value</code> and <code class="literal">file</code> where the value
was defined, e.g. <code class="literal">[ {            file = "/foo.nix"; value = 1; } { file = "/bar.nix"; value = 2 }            ]</code>. The <code class="literal">merge</code> function should return the merged value
or throw an error in case the values are impossible or not meant
to be merged.</p></dd></dl></div></dd><dt><span class="term"><code class="literal">getSubOptions</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function generate sub-options documentation. It takes the current
option prefix as a list and return the set of sub-options. Usually
defined in a recursive manner by adding a term to the prefix, e.g.
<code class="literal">prefix:         elemType.getSubOptions (prefix ++         ["prefix"])</code> where <span class="emphasis"><em><code class="literal">"prefix"</code></em></span> is the newly added prefix.</p></dd><dt><span class="term"><code class="literal">getSubModules</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function should return the type parameters submodules. If the type
parameter is called <code class="literal">elemType</code>, the function should just recursively
look into submodules by returning <code class="literal">elemType.getSubModules;</code>.</p></dd><dt><span class="term"><code class="literal">substSubModules</code></span></dt><dd><p>For composed types that can take a submodule as type parameter, this
function can be used to substitute the parameter of a submodule
type. It takes a module as parameter and return the type with the
submodule options substituted. It is usually defined as a type
function call with a recursive call to <code class="literal">substSubModules</code>, e.g for a
type <code class="literal">composedType</code> that take an <code class="literal">elemtype</code> type parameter, this
function should be defined as <code class="literal">m:         composedType (elemType.substSubModules m)</code>.</p></dd><dt><span class="term"><code class="literal">typeMerge</code></span></dt><dd><p>A function to merge multiple type declarations. Takes the type to
merge <code class="literal">functor</code> as parameter. A <code class="literal">null</code> return value means that type
cannot be merged.</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em><code class="literal">f</code></em></span></span></dt><dd><p>The type to merge <code class="literal">functor</code>.</p></dd></dl></div><p>Note: There is a generic <code class="literal">defaultTypeMerge</code> that work with most of
value and composed types.</p></dd><dt><span class="term"><code class="literal">functor</code></span></dt><dd><p>An attribute set representing the type. It is used for type
operations and has the following keys:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>The type function.</p></dd><dt><span class="term"><code class="literal">wrapped</code></span></dt><dd><p>Holds the type parameter for composed types.</p></dd><dt><span class="term"><code class="literal">payload</code></span></dt><dd><p>Holds the value parameter for value types. The types that have a
<code class="literal">payload</code> are the <code class="literal">enum</code>, <code class="literal">separatedString</code> and <code class="literal">submodule</code>
types.</p></dd><dt><span class="term"><code class="literal">binOp</code></span></dt><dd><p>A binary operation that can merge the payloads of two same
types. Defined as a function that take two payloads as
parameters and return the payloads merged.</p></dd></dl></div></dd></dl></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-option-definitions" class="title" style="clear: both">Option Definitions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Option definitions are generally straight-forward bindings of values to
option names, like</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = {
  services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
};
</code></pre><p>However, sometimes you need to wrap an option definition or set of
option definitions in a <span class="emphasis"><em>property</em></span> to achieve certain effects:</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-delaying-conditionals" class="title">Delaying Conditionals   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-delaying-conditionals" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If a set of option definitions is conditional on the value of another
option, you may need to use <code class="literal">mkIf</code>. Consider, for instance:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = <span class="hljs-keyword">if</span> config.services.httpd.enable <span class="hljs-keyword">then</span> {
  environment.<span class="hljs-attr">systemPackages</span> = [ ... ];
  ...
} <span class="hljs-keyword">else</span> {};
</code></pre><p>This definition will cause Nix to fail with an “infinite recursion”
error. Why? Because the value of <code class="literal">config.services.httpd.enable</code> depends
on the value being constructed here. After all, you could also write the
clearly circular and contradictory:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = <span class="hljs-keyword">if</span> config.services.httpd.enable <span class="hljs-keyword">then</span> {
  services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> {
  services.httpd.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
};
</code></pre><p>The solution is to write:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = mkIf config.services.httpd.enable {
  environment.<span class="hljs-attr">systemPackages</span> = [ ... ];
  ...
};
</code></pre><p>The special function <code class="literal">mkIf</code> causes the evaluation of the conditional to
be “pushed down” into the individual definitions, as if you had written:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = {
  environment.<span class="hljs-attr">systemPackages</span> = <span class="hljs-keyword">if</span> config.services.httpd.enable <span class="hljs-keyword">then</span> [ ... ] <span class="hljs-keyword">else</span> [];
  ...
};
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-setting-priorities" class="title">Setting Priorities   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-setting-priorities" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>A module can override the definitions of an option in other modules by
setting an <span class="emphasis"><em>override priority</em></span>. All option definitions that do not have the lowest
priority value are discarded. By default, option definitions have
priority 100 and option defaults have priority 1500.
You can specify an explicit priority by using <code class="literal">mkOverride</code>, e.g.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">services.openssh.<span class="hljs-attr">enable</span> = mkOverride <span class="hljs-number">10</span> <span class="hljs-literal">false</span>;
</code></pre><p>This definition causes all other definitions with priorities above 10 to
be discarded. The function <code class="literal">mkForce</code> is equal to <code class="literal">mkOverride 50</code>, and
<code class="literal">mkDefault</code> is equal to <code class="literal">mkOverride 1000</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-ordering" class="title">Ordering Definitions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-ordering" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>It is also possible to influence the order in which the definitions for an option are
merged by setting an <span class="emphasis"><em>order priority</em></span> with <code class="literal">mkOrder</code>. The default order priority is 1000.
The functions <code class="literal">mkBefore</code> and <code class="literal">mkAfter</code> are equal to <code class="literal">mkOrder 500</code> and <code class="literal">mkOrder 1500</code>, respectively.
As an example,</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">hardware.<span class="hljs-attr">firmware</span> = mkBefore [ myFirmware ];
</code></pre><p>This definition ensures that <code class="literal">myFirmware</code> comes before other unordered
definitions in the final list value of <code class="literal">hardware.firmware</code>.</p><p>Note that this is different from <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-setting-priorities" title="Setting Priorities">override priorities</a>:
setting an order does not affect whether the definition is included or not.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-option-definitions-merging" class="title">Merging Configurations   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-option-definitions-merging" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>In conjunction with <code class="literal">mkIf</code>, it is sometimes useful for a module to
return multiple sets of option definitions, to be merged together as if
they were declared in separate modules. This can be done using
<code class="literal">mkMerge</code>:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">config</span> = mkMerge
  [ <span class="hljs-comment"># Unconditional stuff.</span>
    { environment.<span class="hljs-attr">systemPackages</span> = [ ... ];
    }
    <span class="hljs-comment"># Conditional stuff.</span>
    (mkIf config.services.bla.enable {
      environment.<span class="hljs-attr">systemPackages</span> = [ ... ];
    })
  ];
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-assertions" class="title" style="clear: both">Warnings and Assertions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-assertions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>When configuration problems are detectable in a module, it is a good idea to write an assertion or warning. Doing so provides clear feedback to the user and prevents errors after the build.</p><p>Although Nix has the <code class="literal">abort</code> and <code class="literal">builtins.trace</code> <a class="link" href="https://nixos.org/nix/manual/#ssec-builtins" target="_top">functions</a> to perform such tasks, they are not ideally suited for NixOS modules. Instead of these functions, you can declare your warnings and assertions using the NixOS module system.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-assertions-warnings" class="title">Warnings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-assertions-warnings" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>This is an example of using <code class="literal">warnings</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, ... }:
{
  <span class="hljs-attr">config</span> = lib.mkIf config.services.foo.enable {
    <span class="hljs-attr">warnings</span> =
      <span class="hljs-keyword">if</span> config.services.foo.bar
      <span class="hljs-keyword">then</span> [ <span class="hljs-string">''You have enabled the bar feature of the foo service.
               This is known to cause some specific problems in certain situations.
               ''</span> ]
      <span class="hljs-keyword">else</span> [];
  }
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-assertions-assetions" class="title">Assertions   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-assertions-assetions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>This example, extracted from the <a class="link" href="https://github.com/NixOS/nixpkgs/blob/release-17.09/nixos/modules/services/logging/syslogd.nix" target="_top"><code class="literal">syslogd</code> module</a> shows how to use <code class="literal">assertions</code>. Since there can only be one active syslog daemon at a time, an assertion is useful to prevent such a broken system from being built.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, ... }:
{
  <span class="hljs-attr">config</span> = lib.mkIf config.services.syslogd.enable {
    <span class="hljs-attr">assertions</span> =
      [ { <span class="hljs-attr">assertion</span> = !config.services.rsyslogd.enable;
          <span class="hljs-attr">message</span> = <span class="hljs-string">"rsyslogd conflicts with syslogd"</span>;
        }
      ];
  }
}
</code></pre>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-meta-attributes" class="title" style="clear: both">Meta Attributes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-meta-attributes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Like Nix packages, NixOS modules can declare meta-attributes to provide
extra information. Module meta attributes are defined in the <code class="literal">meta.nix</code>
special module.</p><p><code class="literal">meta</code> is a top level attribute like <code class="literal">options</code> and <code class="literal">config</code>. Available
meta-attributes are <code class="literal">maintainers</code>, <code class="literal">doc</code>, and <code class="literal">buildDocsInSandbox</code>.</p><p>Each of the meta-attributes must be defined at most once per module
file.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, ... }:
{
  <span class="hljs-attr">options</span> = {
    ...
  };

  <span class="hljs-attr">config</span> = {
    ...
  };

  <span class="hljs-attr">meta</span> = {
    <span class="hljs-attr">maintainers</span> = <span class="hljs-keyword">with</span> lib.maintainers; [ ericsagnes ];
    <span class="hljs-attr">doc</span> = ./default.md;
    <span class="hljs-attr">buildDocsInSandbox</span> = <span class="hljs-literal">true</span>;
  };
}
</code></pre><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p><code class="literal">maintainers</code> contains a list of the module maintainers.</p></li><li class="listitem"><p><code class="literal">doc</code> points to a valid <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-markup" target="_top">Nixpkgs-flavored CommonMark</a> file containing the module
documentation. Its contents is automatically added to
<a class="xref" href="https://nixos.org/manual/nixos/stable/#ch-configuration" title="Configuration">Configuration</a>. Changes to a module documentation have to
be checked to not break building the NixOS manual:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build nixos/release.nix -A manual.x86_64-linux</span>
</code></pre></li><li class="listitem"><p><code class="literal">buildDocsInSandbox</code> indicates whether the option documentation for the
module can be built in a derivation sandbox. This option is currently only
honored for modules shipped by nixpkgs. User modules and modules taken from
<code class="literal">NIXOS_EXTRA_MODULE_PATH</code> are always built outside of the sandbox, as has
been the case in previous releases.</p><p>Building NixOS option documentation in a sandbox allows caching of the built
documentation, which greatly decreases the amount of time needed to evaluate
a system configuration that has NixOS documentation enabled. The sandbox also
restricts which attributes may be referenced by documentation attributes
(such as option descriptions) to the <code class="literal">options</code> and <code class="literal">lib</code> module arguments and
the <code class="literal">pkgs.formats</code> attribute of the <code class="literal">pkgs</code> argument, <code class="literal">config</code> and the rest of
<code class="literal">pkgs</code> are disallowed and will cause doc build failures when used. This
restriction is necessary because we cannot reproduce the full nixpkgs
instantiation with configuration and overlays from a system configuration
inside the sandbox. The <code class="literal">options</code> argument only includes options of modules
that are also built inside the sandbox, referencing an option of a module
that isn’t built in the sandbox is also forbidden.</p><p>The default is <code class="literal">true</code> and should usually not be changed; set it to <code class="literal">false</code>
only if the module requires access to <code class="literal">pkgs</code> in its documentation (e.g.
because it loads information from a linked package to build an option type)
or if its documentation depends on other modules that also aren’t sandboxed
(e.g. by using types defined in the other module).</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-importing-modules" class="title" style="clear: both">Importing Modules   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-importing-modules" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Sometimes NixOS modules need to be used in configuration but exist
outside of Nixpkgs. These modules can be imported:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, ... }:

{
  <span class="hljs-attr">imports</span> =
    [ <span class="hljs-comment"># Use a locally-available module definition in</span>
      <span class="hljs-comment"># ./example-module/default.nix</span>
        ./example-module
    ];

  services.exampleModule.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>The environment variable <code class="literal">NIXOS_EXTRA_MODULE_PATH</code> is an absolute path
to a NixOS module that is included alongside the Nixpkgs NixOS modules.
Like any NixOS module, this module can import additional modules:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># ./module-list/default.nix</span>
[
  ./example-module1
  ./example-module2
]
</code></pre><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># ./extra-module/default.nix</span>
{ <span class="hljs-attr">imports</span> = <span class="hljs-built_in">import</span> ./module-list.nix; }
</code></pre><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># NIXOS_EXTRA_MODULE_PATH=/absolute/path/to/extra-module</span>
{ config, lib, pkgs, ... }:

{
  <span class="hljs-comment"># No `imports` needed</span>

  services.exampleModule1.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-replace-modules" class="title" style="clear: both">Replace Modules   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-replace-modules" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Modules that are imported can also be disabled. The option declarations,
config implementation and the imports of a disabled module will be
ignored, allowing another to take its place. This can be used to
import a set of modules from another channel while keeping the rest of
the system on a stable release.</p><p><code class="literal">disabledModules</code> is a top level attribute like <code class="literal">imports</code>, <code class="literal">options</code> and
<code class="literal">config</code>. It contains a list of modules that will be disabled. This can
either be:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>the full path to the module,</p></li><li class="listitem"><p>or a string with the filename relative to the modules path (eg. &lt;nixpkgs/nixos/modules&gt; for nixos),</p></li><li class="listitem"><p>or an attribute set containing a specific <code class="literal">key</code> attribute.</p></li></ul></div><p>The latter allows some modules to be disabled, despite them being distributed
via attributes instead of file paths. The <code class="literal">key</code> should be globally unique, so
it is recommended to include a file path in it, or rely on a framework to do it
for you.</p><p>This example will replace the existing postgresql module with the
version defined in the nixos-unstable channel while keeping the rest of
the modules and packages from the original nixos channel. This only
overrides the module definition, this won’t use postgresql from
nixos-unstable unless explicitly configured to do so.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, ... }:

{
  <span class="hljs-attr">disabledModules</span> = [ <span class="hljs-string">"services/databases/postgresql.nix"</span> ];

  <span class="hljs-attr">imports</span> =
    [ <span class="hljs-comment"># Use postgresql service from nixos-unstable channel.</span>
      <span class="hljs-comment"># sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos-unstable</span>
      &lt;nixos-unstable/nixos/modules/services/databases/postgresql.nix&gt;
    ];

  services.postgresql.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
}
</code></pre><p>This example shows how to define a custom module as a replacement for an
existing module. Importing this module will disable the original module
without having to know its implementation details.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, pkgs, ... }:

<span class="hljs-keyword">with</span> lib;

<span class="hljs-keyword">let</span>
  <span class="hljs-attr">cfg</span> = config.programs.man;
<span class="hljs-keyword">in</span>

{
  <span class="hljs-attr">disabledModules</span> = [ <span class="hljs-string">"services/programs/man.nix"</span> ];

  <span class="hljs-attr">options</span> = {
    programs.man.<span class="hljs-attr">enable</span> = mkOption {
      <span class="hljs-attr">type</span> = types.bool;
      <span class="hljs-attr">default</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">"Whether to enable manual pages."</span>;
    };
  };

  <span class="hljs-attr">config</span> = mkIf cfg.enabled {
    <span class="hljs-attr">warnings</span> = [ <span class="hljs-string">"disabled manpages for production deployments."</span> ];
  };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-freeform-modules" class="title" style="clear: both">Freeform modules   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-freeform-modules" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Freeform modules allow you to define values for option paths that have
not been declared explicitly. This can be used to add attribute-specific
types to what would otherwise have to be <code class="literal">attrsOf</code> options in order to
accept all attribute names.</p><p>This feature can be enabled by using the attribute <code class="literal">freeformType</code> to
define a freeform type. By doing this, all assignments without an
associated option will be merged using the freeform type and combined
into the resulting <code class="literal">config</code> set. Since this feature nullifies name
checking for entire option trees, it is only recommended for use in
submodules.</p><div class="example"><span id="ex-freeform-module"></span><p class="title"><strong>Example&nbsp;30.&nbsp;Freeform submodule</strong></p><div class="example-contents"><p>The following shows a submodule assigning a freeform type that allows
arbitrary attributes with <code class="literal">str</code> values below <code class="literal">settings</code>, but also
declares an option for the <code class="literal">settings.port</code> attribute to have it
type-checked and assign a default value. See
<a class="link" href="https://nixos.org/manual/nixos/stable/#ex-settings-typed-attrs" title="Example 32. Declaring a type-checked settings attribute">Example: Declaring a type-checked <code class="literal">settings</code> attribute</a>
for a more complete example.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ lib, config, ... }: {

  options.<span class="hljs-attr">settings</span> = lib.mkOption {
    <span class="hljs-attr">type</span> = lib.types.submodule {

      <span class="hljs-attr">freeformType</span> = <span class="hljs-keyword">with</span> lib.types; attrsOf str;

      <span class="hljs-comment"># We want this attribute to be checked for the correct type</span>
      options.<span class="hljs-attr">port</span> = lib.mkOption {
        <span class="hljs-attr">type</span> = lib.types.port;
        <span class="hljs-comment"># Declaring the option also allows defining a default value</span>
        <span class="hljs-attr">default</span> = <span class="hljs-number">8080</span>;
      };

    };
  };
}
</code></pre><p>And the following shows what such a module then allows</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-comment"># Not a declared option, but the freeform type allows this</span>
  settings.<span class="hljs-attr">logLevel</span> = <span class="hljs-string">"debug"</span>;

  <span class="hljs-comment"># Not allowed because the the freeform type only allows strings</span>
  <span class="hljs-comment"># settings.enable = true;</span>

  <span class="hljs-comment"># Allowed because there is a port option declared</span>
  settings.<span class="hljs-attr">port</span> = <span class="hljs-number">80</span>;

  <span class="hljs-comment"># Not allowed because the port option doesn't allow strings</span>
  <span class="hljs-comment"># settings.port = "443";</span>
}
</code></pre></div></div><br class="example-break"><div class="note"><h3 class="title">Note</h3><p>Freeform attributes cannot depend on other attributes of the same set
without infinite recursion:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-comment"># This throws infinite recursion encountered</span>
  settings.<span class="hljs-attr">logLevel</span> = lib.mkIf (config.settings.<span class="hljs-attr">port</span> == <span class="hljs-number">80</span>) <span class="hljs-string">"debug"</span>;
}
</code></pre><p>To prevent this, declare options for all attributes that need to depend
on others. For above example this means to declare <code class="literal">logLevel</code> to be an
option.</p></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-settings-options" class="title" style="clear: both">Options for Program Settings   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-settings-options" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Many programs have configuration files where program-specific settings
can be declared. File formats can be separated into two categories:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Nix-representable ones: These can trivially be mapped to a subset of
Nix syntax. E.g. JSON is an example, since its values like
<code class="literal">{"foo":{"bar":10}}</code> can be mapped directly to Nix:
<code class="literal">{ foo = { bar = 10; }; }</code>. Other examples are INI, YAML and TOML.
The following section explains the convention for these settings.</p></li><li class="listitem"><p>Non-nix-representable ones: These can’t be trivially mapped to a
subset of Nix syntax. Most generic programming languages are in this
group, e.g. bash, since the statement <code class="literal">if true; then echo hi; fi</code>
doesn’t have a trivial representation in Nix.</p><p>Currently there are no fixed conventions for these, but it is common
to have a <code class="literal">configFile</code> option for setting the configuration file
path directly. The default value of <code class="literal">configFile</code> can be an
auto-generated file, with convenient options for controlling the
contents. For example an option of type <code class="literal">attrsOf str</code> can be used
for representing environment variables which generates a section
like <code class="literal">export FOO="foo"</code>. Often it can also be useful to also include
an <code class="literal">extraConfig</code> option of type <code class="literal">lines</code> to allow arbitrary text
after the autogenerated part of the file.</p></li></ul></div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-settings-nix-representable" class="title">Nix-representable Formats (JSON, YAML, TOML, INI, …)   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-settings-nix-representable" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>By convention, formats like this are handled with a generic <code class="literal">settings</code>
option, representing the full program configuration as a Nix value. The
type of this option should represent the format. The most common formats
have a predefined type and string generator already declared under
<code class="literal">pkgs.formats</code>:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">pkgs.formats.javaProperties</code> { <span class="emphasis"><em><code class="literal">comment</code></em></span> ? <code class="literal">"Generated with Nix"</code> }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">comment</code></span></dt><dd><p>A string to put at the start of the
file in a comment. It can have multiple
lines.</p></dd></dl></div><p>It returns the <code class="literal">type</code>: <code class="literal">attrsOf str</code> and a function
<code class="literal">generate</code> to build a Java <code class="literal">.properties</code> file, taking
care of the correct escaping, etc.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.json</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with JSON-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/#pkgs-formats-result">below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.yaml</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with YAML-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/#pkgs-formats-result">below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.ini</code> { <span class="emphasis"><em><code class="literal">listsAsDuplicateKeys</code></em></span> ? false, <span class="emphasis"><em><code class="literal">listToValue</code></em></span> ? null, ... }</span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">listsAsDuplicateKeys</code></span></dt><dd><p>A boolean for controlling whether list values can be used to
represent duplicate INI keys</p></dd><dt><span class="term"><code class="literal">listToValue</code></span></dt><dd><p>A function for turning a list of values into a single value.</p></dd></dl></div><p>It returns a set with INI-specific attributes <code class="literal">type</code> and <code class="literal">generate</code>
as specified <a class="link" href="https://nixos.org/manual/nixos/stable/#pkgs-formats-result">below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.toml</code> { }</span></dt><dd><p>A function taking an empty attribute set (for future extensibility)
and returning a set with TOML-specific attributes <code class="literal">type</code> and
<code class="literal">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/#pkgs-formats-result">below</a>.</p></dd><dt><span class="term"><code class="literal">pkgs.formats.elixirConf { elixir ? pkgs.elixir }</code></span></dt><dd><p>A function taking an attribute set with values</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">elixir</code></span></dt><dd><p>The Elixir package which will be used to format the generated output</p></dd></dl></div><p>It returns a set with Elixir-Config-specific attributes <code class="literal">type</code>, <code class="literal">lib</code>, and
<code class="literal">generate</code> as specified <a class="link" href="https://nixos.org/manual/nixos/stable/#pkgs-formats-result">below</a>.</p><p>The <code class="literal">lib</code> attribute contains functions to be used in settings, for
generating special Elixir values:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">mkRaw elixirCode</code></span></dt><dd><p>Outputs the given string as raw Elixir code</p></dd><dt><span class="term"><code class="literal">mkGetEnv { envVariable, fallback ? null }</code></span></dt><dd><p>Makes the configuration fetch an environment variable at runtime</p></dd><dt><span class="term"><code class="literal">mkAtom atom</code></span></dt><dd><p>Outputs the given string as an Elixir atom, instead of the default
Elixir binary string. Note: lowercase atoms still needs to be prefixed
with <code class="literal">:</code></p></dd><dt><span class="term"><code class="literal">mkTuple array</code></span></dt><dd><p>Outputs the given array as an Elixir tuple, instead of the default
Elixir list</p></dd><dt><span class="term"><code class="literal">mkMap attrset</code></span></dt><dd><p>Outputs the given attribute set as an Elixir map, instead of the
default Elixir keyword list</p></dd></dl></div></dd></dl></div><p><span id="pkgs-formats-result"></span>
These functions all return an attribute set with these values:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">type</code></span></dt><dd><p>A module system type representing a value of the format</p></dd><dt><span class="term"><code class="literal">lib</code></span></dt><dd><p>Utility functions for convenience, or special interactions with the format.
This attribute is optional. It may contain inside a <code class="literal">types</code> attribute
containing types specific to this format.</p></dd><dt><span class="term"><code class="literal">generate</code> <span class="emphasis"><em><code class="literal">filename jsonValue</code></em></span></span></dt><dd><p>A function that can render a value of the format to a file. Returns
a file path.</p><div class="note"><h3 class="title">Note</h3><p>This function puts the value contents in the Nix store. So this
should be avoided for secrets.</p></div></dd></dl></div><div class="example"><span id="ex-settings-nix-representable"></span><p class="title"><strong>Example&nbsp;31.&nbsp;Module with conventional <code class="literal">settings</code> option</strong></p><div class="example-contents"><p>The following shows a module for an example program that uses a JSON
configuration file. It demonstrates how above values can be used, along
with some other related best practices. See the comments for
explanations.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ options, config, lib, pkgs, ... }:
<span class="hljs-keyword">let</span>
  <span class="hljs-attr">cfg</span> = config.services.foo;
  <span class="hljs-comment"># Define the settings format used for this program</span>
  <span class="hljs-attr">settingsFormat</span> = pkgs.formats.json {};
<span class="hljs-keyword">in</span> {

  options.services.<span class="hljs-attr">foo</span> = {
    <span class="hljs-attr">enable</span> = lib.mkEnableOption <span class="hljs-string">"foo service"</span>;

    <span class="hljs-attr">settings</span> = lib.mkOption {
      <span class="hljs-comment"># Setting this type allows for correct merging behavior</span>
      <span class="hljs-attr">type</span> = settingsFormat.type;
      <span class="hljs-attr">default</span> = {};
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Configuration for foo, see
        &lt;link xlink:href="https://example.com/docs/foo"/&gt;
        for supported settings.
      ''</span>;
    };
  };

  <span class="hljs-attr">config</span> = lib.mkIf cfg.enable {
    <span class="hljs-comment"># We can assign some default settings here to make the service work by just</span>
    <span class="hljs-comment"># enabling it. We use `mkDefault` for values that can be changed without</span>
    <span class="hljs-comment"># problems</span>
    services.foo.<span class="hljs-attr">settings</span> = {
      <span class="hljs-comment"># Fails at runtime without any value set</span>
      <span class="hljs-attr">log_level</span> = lib.mkDefault <span class="hljs-string">"WARN"</span>;

      <span class="hljs-comment"># We assume systemd's `StateDirectory` is used, so we require this value,</span>
      <span class="hljs-comment"># therefore no mkDefault</span>
      <span class="hljs-attr">data_path</span> = <span class="hljs-string">"/var/lib/foo"</span>;

      <span class="hljs-comment"># Since we use this to create a user we need to know the default value at</span>
      <span class="hljs-comment"># eval time</span>
      <span class="hljs-attr">user</span> = lib.mkDefault <span class="hljs-string">"foo"</span>;
    };

    environment.etc.<span class="hljs-string">"foo.json"</span>.<span class="hljs-attr">source</span> =
      <span class="hljs-comment"># The formats generator function takes a filename and the Nix value</span>
      <span class="hljs-comment"># representing the format value and produces a filepath with that value</span>
      <span class="hljs-comment"># rendered in the format</span>
      settingsFormat.generate <span class="hljs-string">"foo-config.json"</span> cfg.settings;

    <span class="hljs-comment"># We know that the `user` attribute exists because we set a default value</span>
    <span class="hljs-comment"># for it above, allowing us to use it without worries here</span>
    users.users.${cfg.settings.user} = { <span class="hljs-attr">isSystemUser</span> = <span class="hljs-literal">true</span>; };

    <span class="hljs-comment"># ...</span>
  };
}
</code></pre></div></div><br class="example-break"><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-settings-attrs-options" class="title">Option declarations for attributes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-settings-attrs-options" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Some <code class="literal">settings</code> attributes may deserve some extra care. They may need a
different type, default or merging behavior, or they are essential
options that should show their documentation in the manual. This can be
done using <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-freeform-modules" title="Freeform modules">the section called “Freeform modules”</a>.</p><p>We extend above example using freeform modules to declare an option for
the port, which will enforce it to be a valid integer and make it show
up in the manual.</p><div class="example"><span id="ex-settings-typed-attrs"></span><p class="title"><strong>Example&nbsp;32.&nbsp;Declaring a type-checked <code class="literal">settings</code> attribute</strong></p><div class="example-contents"><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-attr">settings</span> = lib.mkOption {
  <span class="hljs-attr">type</span> = lib.types.submodule {

    <span class="hljs-attr">freeformType</span> = settingsFormat.type;

    <span class="hljs-comment"># Declare an option for the port such that the type is checked and this option</span>
    <span class="hljs-comment"># is shown in the manual.</span>
    options.<span class="hljs-attr">port</span> = lib.mkOption {
      <span class="hljs-attr">type</span> = lib.types.port;
      <span class="hljs-attr">default</span> = <span class="hljs-number">8080</span>;
      <span class="hljs-attr">description</span> = <span class="hljs-string">''
        Which port this service should listen on.
      ''</span>;
    };

  };
  <span class="hljs-attr">default</span> = {};
  <span class="hljs-attr">description</span> = <span class="hljs-string">''
    Configuration for Foo, see
    &lt;link xlink:href="https://example.com/docs/foo"/&gt;
    for supported values.
  ''</span>;
};
</code></pre></div></div><br class="example-break">
</div>

</div>

</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-building-parts" class="title">Building Specific Parts of NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-building-parts" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>With the command <code class="literal">nix-build</code>, you can build specific parts of your NixOS
configuration. This is done as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /path/to/nixpkgs/nixos</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A config.option</span>
</code></pre><p>where <code class="literal">option</code> is a NixOS option with type “derivation” (i.e. something
that can be built). Attributes of interest include:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">system.build.toplevel</code></span></dt><dd><p>The top-level option that builds the entire NixOS system. Everything
else in your configuration is indirectly pulled in by this option.
This is what <code class="literal">nixos-rebuild</code> builds and what <code class="literal">/run/current-system</code>
points to afterwards.</p><p>A shortcut to build this is:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A system</span>
</code></pre></dd><dt><span class="term"><code class="literal">system.build.manual.manualHTML</code></span></dt><dd><p>The NixOS manual.</p></dd><dt><span class="term"><code class="literal">system.build.etc</code></span></dt><dd><p>A tree of symlinks that form the static parts of <code class="literal">/etc</code>.</p></dd><dt><span class="term"><code class="literal">system.build.initialRamdisk</code> , <code class="literal">system.build.kernel</code></span></dt><dd><p>The initial ramdisk and kernel of the system. This allows a quick
way to test whether the kernel and the initial ramdisk boot
correctly, by using QEMU’s <code class="literal">-kernel</code> and <code class="literal">-initrd</code> options:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A config.system.build.initialRamdisk -o initrd</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A config.system.build.kernel -o kernel</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">qemu-system-x86_64 -kernel ./kernel/bzImage -initrd ./initrd/initrd -hda /dev/null</span>
</code></pre></dd><dt><span class="term"><code class="literal">system.build.nixos-rebuild</code> , <code class="literal">system.build.nixos-install</code> , <code class="literal">system.build.nixos-generate-config</code></span></dt><dd><p>These build the corresponding NixOS commands.</p></dd><dt><span class="term"><code class="literal">systemd.units.unit-name.unit</code></span></dt><dd><p>This builds the unit with the specified name. Note that since unit
names contain dots (e.g. <code class="literal">httpd.service</code>), you need to put them
between quotes, like this:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A <span class="hljs-string">'config.systemd.units."httpd.service".unit'</span></span>
</code></pre><p>You can also test individual units, without rebuilding the whole
system, by putting them in <code class="literal">/run/systemd/system</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cp</span> $(nix-build -A <span class="hljs-string">'config.systemd.units."httpd.service".unit'</span>)/httpd.service \
    /run/systemd/system/tmp-httpd.service</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl daemon-reload</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start tmp-httpd.service</span>
</code></pre><p>Note that the unit must not have the same name as any unit in
<code class="literal">/etc/systemd/system</code> since those take precedence over
<code class="literal">/run/systemd/system</code>. That’s why the unit is installed as
<code class="literal">tmp-httpd.service</code> here.</p></dd></dl></div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-experimental-bootspec" class="title">Experimental feature: Bootspec   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-schema">Schema</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-extensions">Extensions mechanism</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-external-bootloaders">External bootloaders</a> </span></dt> </dl></div><p>Bootspec is a experimental feature, introduced in the <a class="link" href="https://github.com/NixOS/rfcs/pull/125" target="_top">RFC-0125 proposal</a>, the reference implementation can be found <a class="link" href="https://github.com/NixOS/nixpkgs/pull/172237" target="_top">there</a> in order to standardize bootloader support
and advanced boot workflows such as SecureBoot and potentially more.</p><p>You can enable the creation of bootspec documents through <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.bootspec.enable" target="_top"><code class="literal">boot.bootspec.enable = true</code></a>, which will prompt a warning until <a class="link" href="https://github.com/NixOS/rfcs/pull/125" target="_top">RFC-0125</a> is officially merged.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-experimental-bootspec-schema" class="title" style="clear: both">Schema   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-schema" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The bootspec schema is versioned and validated against <a class="link" href="https://cuelang.org/" target="_top">a CUE schema file</a> which should considered as the source of truth for your applications.</p><p>You will find the current version <a class="link" href="https://nixos.org/modules/system/activation/bootspec.cue" target="_top">here</a>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-experimental-bootspec-extensions" class="title" style="clear: both">Extensions mechanism   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-extensions" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Bootspec cannot account for all usecases.</p><p>For this purpose, Bootspec offers a generic extension facility <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.bootspec.extensions" target="_top"><code class="literal">boot.bootspec.extensions</code></a> which can be used to inject any data needed for your usecases.</p><p>An example for SecureBoot is to get the Nix store path to <code class="literal">/etc/os-release</code> in order to bake it into a unified kernel image:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, ... }: {
  boot.bootspec.<span class="hljs-attr">extensions</span> = {
    <span class="hljs-string">"org.secureboot.osRelease"</span> = config.environment.etc.<span class="hljs-string">"os-release"</span>.source;
  };
}
</code></pre><p>To reduce incompatibility and prevent names from clashing between applications, it is <span class="strong"><strong>highly recommended</strong></span> to use a unique namespace for your extensions.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-experimental-bootspec-external-bootloaders" class="title" style="clear: both">External bootloaders   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-experimental-bootspec-external-bootloaders" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>It is possible to enable your own bootloader through <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-boot.loader.external.installHook" target="_top"><code class="literal">boot.loader.external.installHook</code></a> which can wrap an existing bootloader.</p><p>Currently, there is no good story to compose existing bootloaders to enrich their features, e.g. SecureBoot, etc. It will be necessary to reimplement or reuse existing parts.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-switching-systems" class="title">What happens during a system switch?   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-switching-systems" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-unit-handling">Unit handling</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-activation-script">Activation script</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-non-switchable-system">Non Switchable Systems</a> </span></dt> </dl></div><p>Running <code class="literal">nixos-rebuild switch</code> is one of the more common tasks under NixOS.
This chapter explains some of the internals of this command to make it simpler
for new module developers to configure their units correctly and to make it
easier to understand what is happening and why for curious administrators.</p><p><code class="literal">nixos-rebuild</code>, like many deployment solutions, calls <code class="literal">switch-to-configuration</code>
which resides in a NixOS system at <code class="literal">$out/bin/switch-to-configuration</code>. The
script is called with the action that is to be performed like <code class="literal">switch</code>, <code class="literal">test</code>,
<code class="literal">boot</code>. There is also the <code class="literal">dry-activate</code> action which does not really perform
the actions but rather prints what it would do if you called it with <code class="literal">test</code>.
This feature can be used to check what service states would be changed if the
configuration was switched to.</p><p>If the action is <code class="literal">switch</code> or <code class="literal">boot</code>, the bootloader is updated first so the
configuration will be the next one to boot. Unless <code class="literal">NIXOS_NO_SYNC</code> is set to
<code class="literal">1</code>, <code class="literal">/nix/store</code> is synced to disk.</p><p>If the action is <code class="literal">switch</code> or <code class="literal">test</code>, the currently running system is inspected
and the actions to switch to the new system are calculated. This process takes
two data sources into account: <code class="literal">/etc/fstab</code> and the current systemd status.
Mounts and swaps are read from <code class="literal">/etc/fstab</code> and the corresponding actions are
generated. If the options of a mount are modified, for example, the proper <code class="literal">.mount</code>
unit is reloaded (or restarted if anything else changed and it’s neither the root
mount or the nix store). The current systemd state is inspected, the difference
between the current system and the desired configuration is calculated and
actions are generated to get to this state. There are a lot of nuances that can
be controlled by the units which are explained here.</p><p>After calculating what should be done, the actions are carried out. The order
of actions is always the same:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Stop units (<code class="literal">systemctl stop</code>)</p></li><li class="listitem"><p>Run activation script (<code class="literal">$out/activate</code>)</p></li><li class="listitem"><p>See if the activation script requested more units to restart</p></li><li class="listitem"><p>Restart systemd if needed (<code class="literal">systemd daemon-reexec</code>)</p></li><li class="listitem"><p>Forget about the failed state of units (<code class="literal">systemctl reset-failed</code>)</p></li><li class="listitem"><p>Reload systemd (<code class="literal">systemctl daemon-reload</code>)</p></li><li class="listitem"><p>Reload systemd user instances (<code class="literal">systemctl --user daemon-reload</code>)</p></li><li class="listitem"><p>Set up tmpfiles (<code class="literal">systemd-tmpfiles --create</code>)</p></li><li class="listitem"><p>Reload units (<code class="literal">systemctl reload</code>)</p></li><li class="listitem"><p>Restart units (<code class="literal">systemctl restart</code>)</p></li><li class="listitem"><p>Start units (<code class="literal">systemctl start</code>)</p></li><li class="listitem"><p>Inspect what changed during these actions and print units that failed and
that were newly started</p></li></ul></div><p>By default, some units are filtered from the outputs to make it less spammy.
This can be disabled for development or testing by setting the environment variable
<code class="literal">STC_DISPLAY_ALL_UNITS=1</code></p><p>Most of these actions are either self-explaining but some of them have to do
with our units or the activation script. For this reason, these topics are
explained in the next sections.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-unit-handling" class="title" style="clear: both">Unit handling   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-unit-handling" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>To figure out what units need to be started/stopped/restarted/reloaded, the
script first checks the current state of the system, similar to what <code class="literal">systemctl list-units</code> shows. For each of the units, the script goes through the following
checks:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>Is the unit file still in the new system? If not, <span class="strong"><strong>stop</strong></span> the service unless
it sets <code class="literal">X-StopOnRemoval</code> in the <code class="literal">[Unit]</code> section to <code class="literal">false</code>.</p></li><li class="listitem"><p>Is it a <code class="literal">.target</code> unit? If so, <span class="strong"><strong>start</strong></span> it unless it sets
<code class="literal">RefuseManualStart</code> in the <code class="literal">[Unit]</code> section to <code class="literal">true</code> or <code class="literal">X-OnlyManualStart</code>
in the <code class="literal">[Unit]</code> section to <code class="literal">true</code>. Also <span class="strong"><strong>stop</strong></span> the unit again unless it
sets <code class="literal">X-StopOnReconfiguration</code> to <code class="literal">false</code>.</p></li><li class="listitem"><p>Are the contents of the unit files different? They are compared by parsing
them and comparing their contents. If they are different but only
<code class="literal">X-Reload-Triggers</code> in the <code class="literal">[Unit]</code> section is changed, <span class="strong"><strong>reload</strong></span> the unit.
The NixOS module system allows setting these triggers with the option
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.reloadTriggers</a>. There are
some additional keys in the <code class="literal">[Unit]</code> section that are ignored as well. If the
unit files differ in any way, the following actions are performed:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: circle;"><li class="listitem"><p><code class="literal">.path</code> and <code class="literal">.slice</code> units are ignored. There is no need to restart them
since changes in their values are applied by systemd when systemd is
reloaded.</p></li><li class="listitem"><p><code class="literal">.mount</code> units are <span class="strong"><strong>reload</strong></span>ed if only their <code class="literal">Options</code> changed. If anything
else changed (like <code class="literal">What</code>), they are <span class="strong"><strong>restart</strong></span>ed unless they are the mount
unit for <code class="literal">/</code> or <code class="literal">/nix</code> in which case they are reloaded to prevent the system
from crashing. Note that this is the case for <code class="literal">.mount</code> units and not for
mounts from <code class="literal">/etc/fstab</code>. These are explained in <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-switching-systems" title="What happens during a system switch?"><em>What happens during a system switch?</em></a>.</p></li><li class="listitem"><p><code class="literal">.socket</code> units are currently ignored. This is to be fixed at a later
point.</p></li><li class="listitem"><p>The rest of the units (mostly <code class="literal">.service</code> units) are then <span class="strong"><strong>reload</strong></span>ed if
<code class="literal">X-ReloadIfChanged</code> in the <code class="literal">[Service]</code> section is set to <code class="literal">true</code> (exposed
via <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.reloadIfChanged</a>).
A little exception is done for units that were deactivated in the meantime,
for example because they require a unit that got stopped before. These
are <span class="strong"><strong>start</strong></span>ed instead of reloaded.</p></li><li class="listitem"><p>If the reload flag is not set, some more flags decide if the unit is
skipped. These flags are <code class="literal">X-RestartIfChanged</code> in the <code class="literal">[Service]</code> section
(exposed via
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.restartIfChanged</a>),
<code class="literal">RefuseManualStop</code> in the <code class="literal">[Unit]</code> section, and <code class="literal">X-OnlyManualStart</code> in the
<code class="literal">[Unit]</code> section.</p></li><li class="listitem"><p>Further behavior depends on the unit having <code class="literal">X-StopIfChanged</code> in the
<code class="literal">[Service]</code> section set to <code class="literal">true</code> (exposed via
<a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.stopIfChanged</a>). This is
set to <code class="literal">true</code> by default and must be explicitly turned off if not wanted.
If the flag is enabled, the unit is <span class="strong"><strong>stop</strong></span>ped and then <span class="strong"><strong>start</strong></span>ed. If
not, the unit is <span class="strong"><strong>restart</strong></span>ed. The goal of the flag is to make sure that
the new unit never runs in the old environment which is still in place
before the activation script is run. This behavior is different when the
service is socket-activated, as outlined in the following steps.</p></li><li class="listitem"><p>The last thing that is taken into account is whether the unit is a service
and socket-activated. If <code class="literal">X-StopIfChanged</code> is <span class="strong"><strong>not</strong></span> set, the service
is <span class="strong"><strong>restart</strong></span>ed with the others. If it is set, both the service and the
socket are <span class="strong"><strong>stop</strong></span>ped and the socket is <span class="strong"><strong>start</strong></span>ed, leaving socket
activation to start the service when it’s needed.</p></li></ul></div></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-activation-script" class="title" style="clear: both">Activation script   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-activation-script" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The activation script is a bash script called to activate the new
configuration which resides in a NixOS system in <code class="literal">$out/activate</code>. Since its
contents depend on your system configuration, the contents may differ.
This chapter explains how the script works in general and some common NixOS
snippets. Please be aware that the script is executed on every boot and system
switch, so tasks that can be performed in other places should be performed
there (for example letting a directory of a service be created by systemd using
mechanisms like <code class="literal">StateDirectory</code>, <code class="literal">CacheDirectory</code>, … or if that’s not
possible using <code class="literal">preStart</code> of the service).</p><p>Activation scripts are defined as snippets using
<a class="xref" href="https://nixos.org/manual/nixos/stable/options#opt-system.activationScripts"><code class="option">system.activationScripts</code></a>. They can either be a simple multiline string
or an attribute set that can depend on other snippets. The builder for the
activation script will take these dependencies into account and order the
snippets accordingly. As a simple example:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">system.activationScripts.<span class="hljs-attr">my-activation-script</span> = {
  <span class="hljs-attr">deps</span> = [ <span class="hljs-string">"etc"</span> ];
  <span class="hljs-comment"># supportsDryActivation = true;</span>
  <span class="hljs-attr">text</span> = <span class="hljs-string">''
    echo "Hallo i bims"
  ''</span>;
};
</code></pre><p>This example creates an activation script snippet that is run after the <code class="literal">etc</code>
snippet. The special variable <code class="literal">supportsDryActivation</code> can be set so the snippet
is also run when <code class="literal">nixos-rebuild dry-activate</code> is run. To differentiate between
real and dry activation, the <code class="literal">$NIXOS_ACTION</code> environment variable can be
read which is set to <code class="literal">dry-activate</code> when a dry activation is done.</p><p>An activation script can write to special files instructing
<code class="literal">switch-to-configuration</code> to restart/reload units. The script will take these
requests into account and will incorporate the unit configuration as described
above. This means that the activation script will “fake” a modified unit file
and <code class="literal">switch-to-configuration</code> will act accordingly. By doing so, configuration
like <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.restartIfChanged</a> is
respected. Since the activation script is run <span class="strong"><strong>after</strong></span> services are already
stopped, <a class="link" href="https://nixos.org/manual/nixos/stable/options#opt-systemd.services">systemd.services.&lt;name&gt;.stopIfChanged</a>
cannot be taken into account anymore and the unit is always restarted instead
of being stopped and started afterwards.</p><p>The files that can be written to are <code class="literal">/run/nixos/activation-restart-list</code> and
<code class="literal">/run/nixos/activation-reload-list</code> with their respective counterparts for
dry activation being <code class="literal">/run/nixos/dry-activation-restart-list</code> and
<code class="literal">/run/nixos/dry-activation-reload-list</code>. Those files can contain
newline-separated lists of unit names where duplicates are being ignored. These
files are not create automatically and activation scripts must take the
possibility into account that they have to create them first.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-activation-script-nixos-snippets" class="title">NixOS snippets   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-activation-script-nixos-snippets" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>There are some snippets NixOS enables by default because disabling them would
most likely break your system. This section lists a few of them and what they
do:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">binsh</code> creates <code class="literal">/bin/sh</code> which points to the runtime shell</p></li><li class="listitem"><p><code class="literal">etc</code> sets up the contents of <code class="literal">/etc</code>, this includes systemd units and
excludes <code class="literal">/etc/passwd</code>, <code class="literal">/etc/group</code>, and <code class="literal">/etc/shadow</code> (which are managed by
the <code class="literal">users</code> snippet)</p></li><li class="listitem"><p><code class="literal">hostname</code> sets the system’s hostname in the kernel (not in <code class="literal">/etc</code>)</p></li><li class="listitem"><p><code class="literal">modprobe</code> sets the path to the <code class="literal">modprobe</code> binary for module auto-loading</p></li><li class="listitem"><p><code class="literal">nix</code> prepares the nix store and adds a default initial channel</p></li><li class="listitem"><p><code class="literal">specialfs</code> is responsible for mounting filesystems like <code class="literal">/proc</code> and <code class="literal">sys</code></p></li><li class="listitem"><p><code class="literal">users</code> creates and removes users and groups by managing <code class="literal">/etc/passwd</code>,
<code class="literal">/etc/group</code> and <code class="literal">/etc/shadow</code>. This also creates home directories</p></li><li class="listitem"><p><code class="literal">usrbinenv</code> creates <code class="literal">/usr/bin/env</code></p></li><li class="listitem"><p><code class="literal">var</code> creates some directories in <code class="literal">/var</code> that are not service-specific</p></li><li class="listitem"><p><code class="literal">wrappers</code> creates setuid wrappers like <code class="literal">sudo</code></p></li></ul></div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-non-switchable-system" class="title" style="clear: both">Non Switchable Systems   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-non-switchable-system" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In certain systems, most notably image based appliances, updates are handled
outside the system. This means that you do not need to rebuild your
configuration on the system itself anymore.</p><p>If you want to build such a system, you can use the <code class="literal">image-based-appliance</code>
profile:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ modulesPath, ... }: {
  <span class="hljs-attr">imports</span> = [ <span class="hljs-string">"<span class="hljs-subst">${modulesPath}</span>/profiles/image-based-appliance.nix"</span> ]
}
</code></pre><p>The most notable deviation of this profile from a standard NixOS configuration
is that after building it, you cannot switch <span class="emphasis"><em>to</em></span> the configuration anymore.
The profile sets <code class="literal">config.system.switch.enable = false;</code>, which excludes
<code class="literal">switch-to-configuration</code>, the central script called by <code class="literal">nixos-rebuild</code>, from
your system. Removing this script makes the image lighter and slightly more
secure.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-documentation" class="title">Writing NixOS Documentation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-documentation" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-building-the-manual">Building the Manual</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-editing-docbook-xml">Editing DocBook XML</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-creating-a-topic">Creating a Topic</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-adding-a-topic">Adding a Topic to the Book</a> </span></dt> </dl></div><p>As NixOS grows, so too does the need for a catalogue and explanation of
its extensive functionality. Collecting pertinent information from
disparate sources and presenting it in an accessible style would be a
worthy contribution to the project.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-docs-building-the-manual" class="title" style="clear: both">Building the Manual   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-building-the-manual" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The DocBook sources of the <a class="xref" href="https://nixos.org/manual/nixos/stable/" title="NixOS Manual">NixOS Manual</a> are in the
<a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual" target="_top"><code class="literal">nixos/doc/manual</code></a>
subdirectory of the Nixpkgs repository.</p><p>You can quickly validate your edits with <code class="literal">make</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /path/to/nixpkgs/nixos/doc/manual</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-shell</span>
<span class="hljs-meta prompt_">nix-shell$ </span><span class="language-bash">devmode</span>
</code></pre><p>Once you are done making modifications to the manual, it’s important to
build it before committing. You can do that as follows:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">nix-build nixos/release.nix -A manual.x86_64-linux
</code></pre><p>When this command successfully finishes, it will tell you where the
manual got generated. The HTML will be accessible through the <code class="literal">result</code>
symlink at <code class="literal">./result/share/doc/nixos/index.html</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-docs-editing-docbook-xml" class="title" style="clear: both">Editing DocBook XML   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-editing-docbook-xml" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>For general information on how to write in DocBook, see <a class="link" href="https://tdg.docbook.org/tdg/5.1/" target="_top">DocBook 5: The
Definitive Guide</a>.</p><p>Emacs nXML Mode is very helpful for editing DocBook XML because it
validates the document as you write, and precisely locates errors. To
use it, see <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-emacs-docbook-xml" title="Editing DocBook 5 XML Documents">the section called “Editing DocBook 5 XML Documents”</a>.</p><p><a class="link" href="https://pandoc.org/" target="_top">Pandoc</a> can generate DocBook XML from a multitude of
formats, which makes a good starting point. Here is an example of Pandoc
invocation to convert GitHub-Flavoured MarkDown to DocBook 5 XML:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes">pandoc -f markdown_github -t docbook5 docs.md -o my-section.md
</code></pre><p>Pandoc can also quickly convert a single <code class="literal">section.xml</code> to HTML, which is
helpful when drafting.</p><p>Sometimes writing valid DocBook is too difficult. In this case,
submit your documentation updates in a <a class="link" href="https://github.com/NixOS/nixpkgs/issues/new" target="_top">GitHub
Issue</a> and someone will
handle the conversion to XML for you.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-docs-creating-a-topic" class="title" style="clear: both">Creating a Topic   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-creating-a-topic" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can use an existing topic as a basis for the new topic or create a
topic from scratch.</p><p>Keep the following guidelines in mind when you create and add a topic:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>The NixOS <a class="link" href="https://tdg.docbook.org/tdg/5.0/book.html" target="_top"><code class="literal">book</code></a>
element is in <code class="literal">nixos/doc/manual/manual.xml</code>. It includes several
<a class="link" href="https://tdg.docbook.org/tdg/5.0/book.html" target="_top"><code class="literal">parts</code></a> which are in
subdirectories.</p></li><li class="listitem"><p>Store the topic file in the same directory as the <code class="literal">part</code> to which it
belongs. If your topic is about configuring a NixOS module, then the
XML file can be stored alongside the module definition <code class="literal">nix</code> file.</p></li><li class="listitem"><p>If you include multiple words in the file name, separate the words
with a dash. For example: <code class="literal">ipv6-config.xml</code>.</p></li><li class="listitem"><p>Make sure that the <code class="literal">xml:id</code> value is unique. You can use abbreviations
if the ID is too long. For example: <code class="literal">nixos-config</code>.</p></li><li class="listitem"><p>Determine whether your topic is a chapter or a section. If you are
unsure, open an existing topic file and check whether the main
element is chapter or section.</p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-docs-adding-a-topic" class="title" style="clear: both">Adding a Topic to the Book   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-docs-adding-a-topic" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Open the parent CommonMark file and add a line to the list of
chapters with the file name of the topic that you created. If you
created a <code class="literal">section</code>, you add the file to the <code class="literal">chapter</code> file. If you created
a <code class="literal">chapter</code>, you add the file to the <code class="literal">part</code> file.</p><p>If the topic is about configuring a NixOS module, it can be
automatically included in the manual by using the <code class="literal">meta.doc</code> attribute.
See <a class="xref" href="https://nixos.org/manual/nixos/stable/#sec-meta-attributes" title="Meta Attributes">the section called “Meta Attributes”</a> for an explanation.</p>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="sec-nixos-tests" class="title">NixOS Tests   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-tests" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-writing-nixos-tests">Writing Tests</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests">Running Tests</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively">Running Tests interactively</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-linking-nixos-tests-to-packages">Linking NixOS tests to packages</a> </span></dt> </dl></div><p>When you add some feature to NixOS, you should write a test for it.
NixOS tests are kept in the directory <code class="literal">nixos/tests</code>, and are executed
(using Nix) by a testing framework that automatically starts one or more
virtual machines containing the NixOS system(s) required for the test.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-writing-nixos-tests" class="title" style="clear: both">Writing Tests   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-writing-nixos-tests" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>A NixOS test is a module that has the following structure:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{

  <span class="hljs-comment"># One or more machines:</span>
  <span class="hljs-attr">nodes</span> =
    { <span class="hljs-attr">machine</span> =
        { config, pkgs, ... }: { … };
      <span class="hljs-attr">machine2</span> =
        { config, pkgs, ... }: { … };
      …
    };

  <span class="hljs-attr">testScript</span> =
    <span class="hljs-string">''
      Python code…
    ''</span>;
}
</code></pre><p>We refer to the whole test above as a test module, whereas the values
in <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="literal">nodes.&lt;name&gt;</code></a> are NixOS modules themselves.</p><p>The option <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-testScript"><code class="literal">testScript</code></a> is a piece of Python code that executes the
test (described below). During the test, it will start one or more
virtual machines, the configuration of which is described by
the option <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="literal">nodes</code></a>.</p><p>An example of a single-node test is
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top"><code class="literal">login.nix</code></a>.
It only needs a single machine to test whether users can log in
on the virtual console, whether device ownership is correctly maintained
when switching between consoles, and so on. An interesting multi-node test is
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nfs/simple.nix" target="_top"><code class="literal">nfs/simple.nix</code></a>.
It uses two client nodes to test correct locking across server crashes.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-calling-nixos-tests" class="title">Calling a test   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-calling-nixos-tests" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>Tests are invoked differently depending on whether the test is part of NixOS or lives in a different project.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-call-nixos-test-in-nixos" class="title">Testing within NixOS   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-call-nixos-test-in-nixos" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Tests that are part of NixOS are added to <a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/all-tests.nix" target="_top"><code class="literal">nixos/tests/all-tests.nix</code></a>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">  <span class="hljs-attr">hostname</span> = runTest ./hostname.nix;
</code></pre><p>Overrides can be added by defining an anonymous module in <code class="literal">all-tests.nix</code>.</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">  <span class="hljs-attr">hostname</span> = runTest {
    <span class="hljs-attr">imports</span> = [ ./hostname.nix ];
    defaults.networking.firewall.<span class="hljs-attr">enable</span> = <span class="hljs-literal">false</span>;
  };
</code></pre><p>You can run a test with attribute name <code class="literal">hostname</code> in <code class="literal">nixos/tests/all-tests.nix</code> by invoking:</p><pre><code class="programlisting shell hljs language-shell" data-highlighted="yes">cd /my/git/clone/of/nixpkgs
nix-build -A nixosTests.hostname
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h4 id="sec-call-nixos-test-outside-nixos" class="title">Testing outside the NixOS project   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-call-nixos-test-outside-nixos" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h4>  </div> </div></div><p>Outside the <code class="literal">nixpkgs</code> repository, you can instantiate the test by first importing the NixOS library,</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-attr">nixos-lib</span> = <span class="hljs-built_in">import</span> (nixpkgs + <span class="hljs-string">"/nixos/lib"</span>) { };
<span class="hljs-keyword">in</span>

nixos-lib.runTest {
  <span class="hljs-attr">imports</span> = [ ./test.nix ];
  <span class="hljs-attr">hostPkgs</span> = pkgs;  <span class="hljs-comment"># the Nixpkgs package set used outside the VMs</span>
  defaults.services.foo.<span class="hljs-attr">package</span> = mypkg;
}
</code></pre><p><code class="literal">runTest</code> returns a derivation that runs the test.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-nodes" class="title">Configuring the nodes   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-nodes" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>There are a few special NixOS options for test VMs:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">virtualisation.memorySize</code></span></dt><dd><p>The memory of the VM in megabytes.</p></dd><dt><span class="term"><code class="literal">virtualisation.vlans</code></span></dt><dd><p>The virtual networks to which the VM is connected. See
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/nat.nix" target="_top"><code class="literal">nat.nix</code></a>
for an example.</p></dd><dt><span class="term"><code class="literal">virtualisation.writableStore</code></span></dt><dd><p>By default, the Nix store in the VM is not writable. If you enable
this option, a writable union file system is mounted on top of the
Nix store to make it appear writable. This is necessary for tests
that run Nix operations that modify the store.</p></dd></dl></div><p>For more options, see the module
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/virtualisation/qemu-vm.nix" target="_top"><code class="literal">qemu-vm.nix</code></a>.</p><p>The test script is a sequence of Python statements that perform various
actions, such as starting VMs, executing commands in the VMs, and so on.
Each virtual machine is represented as an object stored in the variable
<code class="literal">name</code> if this is also the identifier of the machine in the declarative
config. If you specified a node <code class="literal">nodes.machine</code>, the following example starts the
machine, waits until it has finished booting, then executes a command
and checks that the output is more-or-less correct:</p><pre><code class="programlisting py hljs language-bash" data-highlighted="yes">machine.start()
machine.wait_for_unit(<span class="hljs-string">"default.target"</span>)
<span class="hljs-keyword">if</span> not <span class="hljs-string">"Linux"</span> <span class="hljs-keyword">in</span> machine.succeed(<span class="hljs-string">"uname"</span>):
  raise Exception(<span class="hljs-string">"Wrong OS"</span>)
</code></pre><p>The first line is technically unnecessary; machines are implicitly started
when you first execute an action on them (such as <code class="literal">wait_for_unit</code> or
<code class="literal">succeed</code>). If you have multiple machines, you can speed up the test by
starting them in parallel:</p><pre><code class="programlisting py hljs language-undefined" data-highlighted="yes">start_all()
</code></pre><p>If the hostname of a node contains characters that can’t be used in a
Python variable name, those characters will be replaced with
underscores in the variable name, so <code class="literal">nodes.machine-a</code> will be exposed
to Python as <code class="literal">machine_a</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-machine-objects" class="title">Machine objects   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-machine-objects" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The following methods are available on machine objects:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">block()</span></dt><dd><p>Simulate unplugging the Ethernet cable that connects the machine to
the other machines.
This happens by shutting down eth1 (the multicast interface used to talk
to the other VMs). eth0 is kept online to still enable the test driver
to communicate with the machine.</p></dd><dt><span class="term">console_interact()</span></dt><dd><p>Allows you to directly interact with QEMU’s stdin, by forwarding
terminal input to the QEMU process.
This is for use with the interactive test driver, not for production
tests, which run unattended.
Output from QEMU is only read line-wise. <code class="literal">Ctrl-c</code> kills QEMU and
<code class="literal">Ctrl-d</code> closes console and returns to the test runner.</p></dd><dt><span class="term">copy_from_host(source, target)</span></dt><dd><p>Copies a file from host to machine, e.g.,
<code class="literal">copy_from_host("myfile", "/etc/my/important/file")</code>.</p><p>The first argument is the file on the host. Note that the “host” refers
to the environment in which the test driver runs, which is typically the
Nix build sandbox.</p><p>The second argument is the location of the file on the machine that will
be written to.</p><p>The file is copied via the <code class="literal">shared_dir</code> directory which is shared among
all the VMs (using a temporary directory).
The access rights bits will mimic the ones from the host file and
user:group will be root:root.</p></dd><dt><span class="term">copy_from_host_via_shell(source, target)</span></dt><dd><p>Copy a file from the host into the guest by piping it over the
shell into the destination file. Works without host-guest shared folder.
Prefer copy_from_host for whenever possible.</p></dd><dt><span class="term">copy_from_vm(source, target_dir)</span></dt><dd><p>Copy a file from the VM (specified by an in-VM source path) to a path
relative to <code class="literal">$out</code>. The file is copied via the <code class="literal">shared_dir</code> shared among
all the VMs (using a temporary directory).</p></dd><dt><span class="term">crash()</span></dt><dd><p>Simulate a sudden power failure, by telling the VM to exit immediately.</p></dd><dt><span class="term">dump_tty_contents(tty)</span></dt><dd><p>Debugging: Dump the contents of the TTY&lt;n&gt;</p></dd><dt><span class="term">execute(command, check_return, check_output, timeout)</span></dt><dd><p>Execute a shell command, returning a list <code class="literal">(status, stdout)</code>.</p><p>Commands are run with <code class="literal">set -euo pipefail</code> set:</p><div class="itemizedlist"><ul class="itemizedlist " style="list-style-type: disc;"><li class="listitem"><p>If several commands are separated by <code class="literal">;</code> and one fails, the
command as a whole will fail.</p></li><li class="listitem"><p>For pipelines, the last non-zero exit status will be returned
(if there is one; otherwise zero will be returned).</p></li><li class="listitem"><p>Dereferencing unset variables fails the command.</p></li><li class="listitem"><p>It will wait for stdout to be closed.</p></li></ul></div><p>If the command detaches, it must close stdout, as <code class="literal">execute</code> will wait
for this to consume all output reliably. This can be achieved by
redirecting stdout to stderr <code class="literal">&gt;&amp;2</code>, to <code class="literal">/dev/console</code>, <code class="literal">/dev/null</code> or
a file. Examples of detaching commands are <code class="literal">sleep 365d &amp;</code>, where the
shell forks a new process that can write to stdout and <code class="literal">xclip -i</code>, where
the <code class="literal">xclip</code> command itself forks without closing stdout.</p><p>Takes an optional parameter <code class="literal">check_return</code> that defaults to <code class="literal">True</code>.
Setting this parameter to <code class="literal">False</code> will not check for the return code
and return -1 instead. This can be used for commands that shut down
the VM and would therefore break the pipe that would be used for
retrieving the return code.</p><p>A timeout for the command can be specified (in seconds) using the optional
<code class="literal">timeout</code> parameter, e.g., <code class="literal">execute(cmd, timeout=10)</code> or
<code class="literal">execute(cmd, timeout=None)</code>. The default is 900 seconds.</p></dd><dt><span class="term">fail()</span></dt><dd><p>Like <code class="literal">succeed</code>, but raising an exception if the command returns a zero
status.</p></dd><dt><span class="term">forward_port(host_port, guest_port)</span></dt><dd><p>Forward a TCP port on the host to a TCP port on the guest.
Useful during interactive testing.</p></dd><dt><span class="term">get_screen_text()</span></dt><dd><p>Return a textual representation of what is currently visible on the
machine’s screen using optical character recognition.</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-enableOCR"><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">get_screen_text_variants()</span></dt><dd><p>Return a list of different interpretations of what is currently
visible on the machine’s screen using optical character
recognition. The number and order of the interpretations is not
specified and is subject to change, but if no exception is raised at
least one will be returned.</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-enableOCR"><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">reboot()</span></dt><dd><p>Press Ctrl+Alt+Delete in the guest.</p><p>Prepares the machine to be reconnected which is useful if the
machine was started with <code class="literal">allow_reboot = True</code></p></dd><dt><span class="term">screenshot(filename)</span></dt><dd><p>Take a picture of the display of the virtual machine, in PNG format.
The screenshot will be available in the derivation output.</p></dd><dt><span class="term">send_chars(chars, delay)</span></dt><dd><p>Simulate typing a sequence of characters on the virtual keyboard,
e.g., <code class="literal">send_chars("foobar   ")</code> will type the string <code class="literal">foobar</code>
followed by the Enter key.</p></dd><dt><span class="term">send_console(chars)</span></dt><dd><p>Send keys to the kernel console. This allows interaction with the systemd
emergency mode, for example. Takes a string that is sent, e.g.,
<code class="literal">send_console("\n\nsystemctl default\n")</code>.</p></dd><dt><span class="term">send_key(key, delay, log)</span></dt><dd><p>Simulate pressing keys on the virtual keyboard, e.g.,
<code class="literal">send_key("ctrl-alt-delete")</code>.</p><p>Please also refer to the QEMU documentation for more information on the
input syntax: https://en.wikibooks.org/wiki/QEMU/Monitor#sendkey_keys</p></dd><dt><span class="term">send_monitor_command(command)</span></dt><dd><p>Send a command to the QEMU monitor. This allows attaching
virtual USB disks to a running machine, among other things.</p></dd><dt><span class="term">shell_interact(address)</span></dt><dd><p>Allows you to directly interact with the guest shell. This should
only be used during test development, not in production tests.
Killing the interactive session with <code class="literal">Ctrl-d</code> or <code class="literal">Ctrl-c</code> also ends
the guest session.</p></dd><dt><span class="term">shutdown()</span></dt><dd><p>Shut down the machine, waiting for the VM to exit.</p></dd><dt><span class="term">start(allow_reboot)</span></dt><dd><p>Start the virtual machine. This method is asynchronous — it does
not wait for the machine to finish booting.</p></dd><dt><span class="term">succeed()</span></dt><dd><p>Execute a shell command, raising an exception if the exit status is
not zero, otherwise returning the standard output. Similar to <code class="literal">execute</code>,
except that the timeout is <code class="literal">None</code> by default. See <code class="literal">execute</code> for details on
command execution.</p></dd><dt><span class="term">switch_root()</span></dt><dd><p>Transition from stage 1 to stage 2. This requires the
machine to be configured with <code class="literal">testing.initrdBackdoor = true</code>
and <code class="literal">boot.initrd.systemd.enable = true</code>.</p></dd><dt><span class="term">systemctl(q, user)</span></dt><dd><p>Runs <code class="literal">systemctl</code> commands with optional support for
<code class="literal">systemctl --user</code></p><pre><code class="programlisting py hljs language-nix" data-highlighted="yes"><span class="hljs-comment"># run `systemctl list-jobs --no-pager`</span>
machine.systemctl(<span class="hljs-string">"list-jobs --no-pager"</span>)

<span class="hljs-comment"># spawn a shell for `any-user` and run</span>
<span class="hljs-comment"># `systemctl --user list-jobs --no-pager`</span>
machine.systemctl(<span class="hljs-string">"list-jobs --no-pager"</span>, <span class="hljs-string">"any-user"</span>)
</code></pre></dd><dt><span class="term">unblock()</span></dt><dd><p>Undo the effect of <code class="literal">block</code>.</p></dd><dt><span class="term">wait_for_closed_port(port, addr, timeout)</span></dt><dd><p>Wait until nobody is listening on the given TCP port and IP address
(default <code class="literal">localhost</code>).</p></dd><dt><span class="term">wait_for_console_text(regex, timeout)</span></dt><dd><p>Wait until the supplied regular expressions match a line of the
serial console output.
This method is useful when OCR is not possible or inaccurate.</p></dd><dt><span class="term">wait_for_file(filename, timeout)</span></dt><dd><p>Waits until the file exists in the machine’s file system.</p></dd><dt><span class="term">wait_for_open_port(port, addr, timeout)</span></dt><dd><p>Wait until a process is listening on the given TCP port and IP address
(default <code class="literal">localhost</code>).</p></dd><dt><span class="term">wait_for_open_unix_socket(addr, is_datagram, timeout)</span></dt><dd><p>Wait until a process is listening on the given UNIX-domain socket
(default to a UNIX-domain stream socket).</p></dd><dt><span class="term">wait_for_text(regex, timeout)</span></dt><dd><p>Wait until the supplied regular expressions matches the textual
contents of the screen by using optical character recognition (see
<code class="literal">get_screen_text</code> and <code class="literal">get_screen_text_variants</code>).</p><div class="note"><h3 class="title">Note</h3><p>This requires <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-enableOCR"><code class="literal">enableOCR</code></a> to be set to <code class="literal">true</code>.</p></div></dd><dt><span class="term">wait_for_unit(unit, user, timeout)</span></dt><dd><p>Wait for a systemd unit to get into “active” state.
Throws exceptions on “failed” and “inactive” states as well as after
timing out.</p></dd><dt><span class="term">wait_for_window(regexp, timeout)</span></dt><dd><p>Wait until an X11 window has appeared whose name matches the given
regular expression, e.g., <code class="literal">wait_for_window("Terminal")</code>.</p></dd><dt><span class="term">wait_for_x(timeout)</span></dt><dd><p>Wait until it is possible to connect to the X server.</p></dd><dt><span class="term">wait_until_fails(command, timeout)</span></dt><dd><p>Like <code class="literal">wait_until_succeeds</code>, but repeating the command until it fails.</p></dd><dt><span class="term">wait_until_succeeds(command, timeout)</span></dt><dd><p>Repeat a shell command with 1-second intervals until it succeeds.
Has a default timeout of 900 seconds which can be modified, e.g.
<code class="literal">wait_until_succeeds(cmd, timeout=10)</code>. See <code class="literal">execute</code> for details on
command execution.
Throws an exception on timeout.</p></dd><dt><span class="term">wait_until_tty_matches(tty, regexp, timeout)</span></dt><dd><p>Wait until the visible output on the chosen TTY matches regular
expression. Throws an exception on timeout.</p></dd></dl></div><p>To test user units declared by <code class="literal">systemd.user.services</code> the optional
<code class="literal">user</code> argument can be used:</p><pre><code class="programlisting py hljs language-bash" data-highlighted="yes">machine.start()
machine.wait_for_x()
machine.wait_for_unit(<span class="hljs-string">"xautolock.service"</span>, <span class="hljs-string">"x-session-user"</span>)
</code></pre><p>This applies to <code class="literal">systemctl</code>, <code class="literal">get_unit_info</code>, <code class="literal">wait_for_unit</code>,
<code class="literal">start_job</code> and <code class="literal">stop_job</code>.</p><p>For faster dev cycles it’s also possible to disable the code-linters
(this shouldn’t be committed though):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">skipLint</span> = <span class="hljs-literal">true</span>;
  nodes.<span class="hljs-attr">machine</span> =
    { config, pkgs, ... }:
    { configuration…
    };

  <span class="hljs-attr">testScript</span> =
    <span class="hljs-string">''
      Python code…
    ''</span>;
}
</code></pre><p>This will produce a Nix warning at evaluation time. To fully disable the
linter, wrap the test script in comment directives to disable the Black
linter directly (again, don’t commit this within the Nixpkgs
repository):</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">  <span class="hljs-attr">testScript</span> =
    <span class="hljs-string">''
      # fmt: off
      Python code…
      # fmt: on
    ''</span>;
</code></pre><p>Similarly, the type checking of test scripts can be disabled in the following
way:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">skipTypeCheck</span> = <span class="hljs-literal">true</span>;
  nodes.<span class="hljs-attr">machine</span> =
    { config, pkgs, ... }:
    { configuration…
    };
}
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-failing-tests-early" class="title">Failing tests early   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-failing-tests-early" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>To fail tests early when certain invariants are no longer met (instead of waiting for the build to time out), the decorator <code class="literal">polling_condition</code> is provided. For example, if we are testing a program <code class="literal">foo</code> that should not quit after being started, we might write the following:</p><pre><code class="programlisting py hljs language-nix" data-highlighted="yes">@polling_condition
def foo_running():
    machine.succeed(<span class="hljs-string">"pgrep -x foo"</span>)


machine.succeed(<span class="hljs-string">"foo --start"</span>)
machine.wait_until_succeeds(<span class="hljs-string">"pgrep -x foo"</span>)

<span class="hljs-keyword">with</span> foo_running:
    ...  <span class="hljs-comment"># Put `foo` through its paces</span>
</code></pre><p><code class="literal">polling_condition</code> takes the following (optional) arguments:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">seconds_interval</code></span></dt><dd><p>specifies how often the condition should be polled:</p></dd></dl></div><pre><code class="programlisting py hljs language-nix" data-highlighted="yes">@polling_condition(<span class="hljs-attr">seconds_interval=10)</span>
def foo_running():
    machine.succeed(<span class="hljs-string">"pgrep -x foo"</span>)
</code></pre><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="literal">description</code></span></dt><dd><p>is used in the log when the condition is checked. If this is not provided, the description is pulled from the docstring of the function. These two are therefore equivalent:</p></dd></dl></div><pre><code class="programlisting py hljs language-bash" data-highlighted="yes">@polling_condition
def foo_running():
    <span class="hljs-string">"check that foo is running"</span>
    machine.succeed(<span class="hljs-string">"pgrep -x foo"</span>)
</code></pre><pre><code class="programlisting py hljs language-bash" data-highlighted="yes">@polling_condition(description=<span class="hljs-string">"check that foo is running"</span>)
def foo_running():
    machine.succeed(<span class="hljs-string">"pgrep -x foo"</span>)
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="ssec-python-packages-in-test-script" class="title">Adding Python packages to the test script   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-python-packages-in-test-script" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>When additional Python libraries are required in the test script, they can be
added using the parameter <code class="literal">extraPythonPackages</code>. For example, you could add
<code class="literal">numpy</code> like this:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{
  <span class="hljs-attr">extraPythonPackages</span> = p: [ p.numpy ];

  <span class="hljs-attr">nodes</span> = { };

  <span class="hljs-comment"># Type checking on extra packages doesn't work yet</span>
  <span class="hljs-attr">skipTypeCheck</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-attr">testScript</span> = <span class="hljs-string">''
    import numpy as np
    assert str(np.zeros(4) == "array([0., 0., 0., 0.])")
  ''</span>;
}
</code></pre><p>In that case, <code class="literal">numpy</code> is chosen from the generic <code class="literal">python3Packages</code>.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-test-options-reference" class="title">Test Options Reference   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-test-options-reference" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The following options can be used when writing tests.</p><div class="variablelist">
<a id="test-options-list"></a>
 <dl class="variablelist">
<dt>
 <span class="term">
 <a id="test-opt-enableOCR"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-enableOCR"><code class="option">enableOCR</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to enable Optical Character Recognition functionality for
testing graphical programs. See <a class="link" href="https://nixos.org/manual/nixos/stable/%60ssec-machine-objects%60" target="_top">Machine objects</a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-defaults"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-defaults"><code class="option">defaults</code>
  </a>
 </span>
</dt>
<dd>
<p>NixOS configuration that is applied to all <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="option">nodes</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
module</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-driver"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-driver"><code class="option">driver</code>
  </a>
 </span>
</dt>
<dd>
<p>Package containing a script that runs the test.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Default:</em></span>
set by the test framework</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraBaseModules"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-extraBaseModules"><code class="option">extraBaseModules</code>
  </a>
 </span>
</dt>
<dd>
<p>NixOS configuration that, like <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-defaults"><code class="option">defaults</code></a>, is applied to all <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="option">nodes</code></a> and can not be undone with <a class="link" href="https://search.nixos.org/options?show=specialisation.%3Cname%3E.inheritParentConfig&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=specialisation" target="_top"><code class="literal">specialisation.&lt;name&gt;.inheritParentConfig</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
module</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraDriverArgs"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-extraDriverArgs"><code class="option">extraDriverArgs</code>
  </a>
 </span>
</dt>
<dd>
<p>Extra arguments to pass to the test driver.</p><p>They become part of <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-driver"><code class="option">driver</code></a> via <code class="literal">wrapProgram</code>.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of string</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-extraPythonPackages"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-extraPythonPackages"><code class="option">extraPythonPackages</code>
  </a>
 </span>
</dt>
<dd>
<p>Python packages to add to the test driver.</p><p>The argument is a Python package set, similar to <code class="literal">pkgs.pythonPackages</code>.</p>

<p><span class="emphasis"><em>Type:</em></span>
function that evaluates to a(n) list of package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">&lt;function&gt;</code></p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting hljs language-undefined" data-highlighted="yes">p: [ p.numpy ]

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-globalTimeout"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-globalTimeout"><code class="option">globalTimeout</code>
  </a>
 </span>
</dt>
<dd>
<p>A global timeout for the complete test, expressed in seconds.
Beyond that timeout, every resource will be killed and released and the test will fail.</p><p>By default, we use a 1 hour timeout.</p>

<p><span class="emphasis"><em>Type:</em></span>
signed integer</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">3600</code></p>

<p><span class="emphasis"><em>Example:</em></span>
<code class="literal">600</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-hostPkgs"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-hostPkgs"><code class="option">hostPkgs</code>
  </a>
 </span>
</dt>
<dd>
<p>Nixpkgs attrset used outside the nodes.</p>

<p><span class="emphasis"><em>Type:</em></span>
raw value</p>

<p><span class="emphasis"><em>Example:</em></span></p><pre><code class="programlisting hljs language-nix" data-highlighted="yes"><span class="hljs-built_in">import</span> nixpkgs { <span class="hljs-keyword">inherit</span> system config overlays; }

</code></pre>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-interactive"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-interactive"><code class="option">interactive</code>
  </a>
 </span>
</dt>
<dd>
<p>Tests <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively" title="Running Tests interactively">can be run interactively</a>
using the program in the test derivation’s <code class="literal">.driverInteractive</code> attribute.</p><p>When they are, the configuration will include anything set in this submodule.</p><p>You can set any top-level test option here.</p><p>Example test module:</p><pre><code class="programlisting nix hljs language-nix" data-highlighted="yes">{ config, lib, ... }: {

  nodes.<span class="hljs-attr">rabbitmq</span> = {
    services.rabbitmq.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  };

  <span class="hljs-comment"># When running interactively ...</span>
  interactive.nodes.<span class="hljs-attr">rabbitmq</span> = {
    <span class="hljs-comment"># ... enable the web ui.</span>
    services.rabbitmq.managementPlugin.<span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span>;
  };
}
</code></pre><p>For details, see the section about <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively" title="Running Tests interactively">running tests interactively</a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
submodule</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/interactive.nix" target="_top">
nixos/lib/testing/interactive.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-meta"><code class="option">meta</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-meta" target="_top"><code class="literal">meta</code></a> attributes that will be set on the returned derivations.</p><p>Not all <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#chap-meta" target="_top"><code class="literal">meta</code></a> attributes are supported, but more can be added as desired.</p>

<p><span class="emphasis"><em>Type:</em></span>
submodule</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.broken"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-meta.broken"><code class="option">meta.broken</code>
  </a>
 </span>
</dt>
<dd>
<p>Sets the <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-broken" target="_top"><code class="literal">meta.broken</code></a> attribute on the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-test"><code class="option">test</code></a> derivation.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.maintainers"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-meta.maintainers"><code class="option">meta.maintainers</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-maintainers" target="_top">list of maintainers</a> for this test.</p>

<p><span class="emphasis"><em>Type:</em></span>
list of raw value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">[ ]</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-meta.timeout"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-meta.timeout"><code class="option">meta.timeout</code>
  </a>
 </span>
</dt>
<dd>
<p>The <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-test"><code class="option">test</code></a>’s <a class="link" href="https://nixos.org/manual/nixpkgs/stable/#var-meta-timeout" target="_top"><code class="literal">meta.timeout</code></a> in seconds.</p>

<p><span class="emphasis"><em>Type:</em></span>
null or signed integer</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">3600</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/meta.nix" target="_top">
nixos/lib/testing/meta.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-name"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-name"><code class="option">name</code>
  </a>
 </span>
</dt>
<dd>
<p>The name of the test.</p><p>This is used in the derivation names of the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-driver"><code class="option">driver</code></a> and <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-test"><code class="option">test</code></a> runner.</p>

<p><span class="emphasis"><em>Type:</em></span>
string</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/name.nix" target="_top">
nixos/lib/testing/name.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.pkgs"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-node.pkgs"><code class="option">node.pkgs</code>
  </a>
 </span>
</dt>
<dd>
<p>The Nixpkgs to use for the nodes.</p><p>Setting this will make the <code class="literal">nixpkgs.*</code> options read-only, to avoid mistakenly testing with a Nixpkgs configuration that diverges from regular use.</p>

<p><span class="emphasis"><em>Type:</em></span>
null or Nixpkgs package set</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">null</code>, so construct <code class="literal">pkgs</code> according to the <code class="literal">nixpkgs.*</code> options as usual.</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.pkgsReadOnly"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-node.pkgsReadOnly"><code class="option">node.pkgsReadOnly</code>
  </a>
 </span>
</dt>
<dd>
<p>Whether to make the <code class="literal">nixpkgs.*</code> options read-only. This is only relevant when <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-node.pkgs"><code class="literal">node.pkgs</code></a> is set.</p><p>Set this to <code class="literal">false</code> when any of the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="literal">nodes</code></a> needs to configure any of the <code class="literal">nixpkgs.*</code> options. This will slow down evaluation of your test a bit.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">node.pkgs != null</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-node.specialArgs"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-node.specialArgs"><code class="option">node.specialArgs</code>
  </a>
 </span>
</dt>
<dd>
<p>An attribute set of arbitrary values that will be made available as module arguments during the resolution of module <code class="literal">imports</code>.</p><p>Note that it is not possible to override these from within the NixOS configurations. If you argument is not relevant to <code class="literal">imports</code>, consider setting <code class="option">defaults._module.args.&lt;name&gt;</code> instead.</p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of raw value</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">{ }</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-nodes"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="option">nodes</code>
  </a>
 </span>
</dt>
<dd>
<p>An attribute set of NixOS configuration modules.</p><p>The configurations are augmented by the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-defaults"><code class="literal">defaults</code></a> option.</p><p>They are assigned network addresses according to the <code class="literal">nixos/lib/testing/network.nix</code> module.</p><p>A few special options are available, that aren’t in a plain NixOS configuration. See <a class="link" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-nodes" title="Configuring the nodes">Configuring the nodes</a></p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of module</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/nodes.nix" target="_top">
nixos/lib/testing/nodes.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-passthru"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-passthru"><code class="option">passthru</code>
  </a>
 </span>
</dt>
<dd>
<p>Attributes to add to the returned derivations,
which are not necessarily part of the build.</p><p>This is a bit like doing <code class="literal">drv // { myAttr = true; }</code> (which would be lost by <code class="literal">overrideAttrs</code>).
It does not change the actual derivation, but adds the attribute nonetheless, so that
consumers of what would be <code class="literal">drv</code> have more information.</p>

<p><span class="emphasis"><em>Type:</em></span>
lazy attribute set of raw value</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/run.nix" target="_top">
nixos/lib/testing/run.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-qemu.package"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-qemu.package"><code class="option">qemu.package</code>
  </a>
 </span>
</dt>
<dd>
<p>Which qemu package to use for the virtualisation of <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-nodes"><code class="option">nodes</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">"hostPkgs.qemu_test"</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-skipLint"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-skipLint"><code class="option">skipLint</code>
  </a>
 </span>
</dt>
<dd>
<p>Do not run the linters. This may speed up your iteration cycle, but it is not something you should commit.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-skipTypeCheck"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-skipTypeCheck"><code class="option">skipTypeCheck</code>
  </a>
 </span>
</dt>
<dd>
<p>Disable type checking. This must not be enabled for new NixOS tests.</p><p>This may speed up your iteration cycle, unless you’re working on the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-testScript"><code class="option">testScript</code></a>.</p>

<p><span class="emphasis"><em>Type:</em></span>
boolean</p>

<p><span class="emphasis"><em>Default:</em></span>
<code class="literal">false</code></p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/driver.nix" target="_top">
nixos/lib/testing/driver.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-test"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-test"><code class="option">test</code>
  </a>
 </span>
</dt>
<dd>
<p>Derivation that runs the test as its “build” process.</p><p>This implies that NixOS tests run isolated from the network, making them
more dependable.</p>

<p><span class="emphasis"><em>Type:</em></span>
package</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/run.nix" target="_top">
nixos/lib/testing/run.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
<dt>
 <span class="term">
 <a id="test-opt-testScript"></a><a class="term" href="https://nixos.org/manual/nixos/stable/#test-opt-testScript"><code class="option">testScript</code>
  </a>
 </span>
</dt>
<dd>
<p>A series of python declarations and statements that you write to perform
the test.</p>

<p><span class="emphasis"><em>Type:</em></span>
string or function that evaluates to a(n) string</p>

<p><span class="emphasis"><em>Declared by:</em></span></p>
<table border="0" summary="Simple list" class="simplelist">
<tbody><tr><td>
<code class="filename"><a class="filename" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/lib/testing/testScript.nix" target="_top">
nixos/lib/testing/testScript.nix
</a></code>
</td></tr>
</tbody></table>
</dd>
 </dl>
</div>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-running-nixos-tests" class="title" style="clear: both">Running Tests   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can run tests using <code class="literal">nix-build</code>. For example, to run the test
<a class="link" href="https://github.com/NixOS/nixpkgs/blob/master/nixos/tests/login.nix" target="_top"><code class="literal">login.nix</code></a>,
you do:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /my/git/clone/of/nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build -A nixosTests.login</span>
</code></pre><p>After building/downloading all required dependencies, this will perform
a build that starts a QEMU/KVM virtual machine containing a NixOS
system. The virtual machine mounts the Nix store of the host; this makes
VM creation very fast, as no disk image needs to be created. Afterwards,
you can view a log of the test:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-store --read-log result</span>
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-running-nixos-tests-interactively" class="title" style="clear: both">Running Tests interactively   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-running-nixos-tests-interactively" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>The test itself can be run interactively. This is particularly useful
when developing or debugging a test:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build . -A nixosTests.login.driverInteractive</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">./result/bin/nixos-test-driver</span>
[...]
<span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span>
</code></pre><p>You can then take any Python statement, e.g.</p><pre><code class="programlisting py hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; start_all()</span>
<span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; test_script()</span>
<span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; machine.succeed(<span class="hljs-string">"touch /tmp/foo"</span>)</span>
<span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; <span class="hljs-built_in">print</span>(machine.succeed(<span class="hljs-string">"pwd"</span>)) <span class="hljs-comment"># Show stdout of command</span></span>
</code></pre><p>The function <code class="literal">test_script</code> executes the entire test script and drops you
back into the test driver command line upon its completion. This allows
you to inspect the state of the VMs after the test (e.g. to debug the
test script).</p><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-shell-access" class="title">Shell access in interactive mode   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-shell-access" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The function <code class="literal">&lt;yourmachine&gt;.shell_interact()</code> grants access to a shell running
inside a virtual machine. To use it, replace <code class="literal">&lt;yourmachine&gt;</code> with the name of a
virtual machine defined in the test, for example: <code class="literal">machine.shell_interact()</code>.
Keep in mind that this shell may not display everything correctly as it is
running within an interactive Python REPL, and logging output from the virtual
machine may overwrite input and output from the guest shell:</p><pre><code class="programlisting py hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; machine.shell_interact()</span>
machine: Terminal is ready (there is no initial prompt):
<span class="hljs-meta prompt_">$ </span><span class="language-bash">hostname</span>
machine
</code></pre><p>As an alternative, you can proxy the guest shell to a local TCP server by first
starting a TCP server in a terminal using the command:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">socat <span class="hljs-string">'READLINE,PROMPT=$ '</span> tcp-listen:4444,reuseaddr`</span>
</code></pre><p>In the terminal where the test driver is running, connect to this server by
using:</p><pre><code class="programlisting py hljs language-shell" data-highlighted="yes"><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; machine.shell_interact(<span class="hljs-string">"tcp:127.0.0.1:4444"</span>)</span>
</code></pre><p>Once the connection is established, you can enter commands in the socat terminal
where socat is running.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-port-forwarding" class="title">Port forwarding to NixOS test VMs   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-port-forwarding" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>If your test has only a single VM, you may use e.g.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">QEMU_NET_OPTS=<span class="hljs-string">"hostfwd=tcp:127.0.0.1:2222-:22"</span> ./result/bin/nixos-test-driver</span>
</code></pre><p>to port-forward a port in the VM (here <code class="literal">22</code>) to the host machine (here port <code class="literal">2222</code>).</p><p>This naturally does not work when multiple machines are involved,
since a single port on the host cannot forward to multiple VMs.</p><p>If the test defines multiple machines, you may opt to <span class="emphasis"><em>temporarily</em></span> set
<code class="literal">virtualisation.forwardPorts</code> in the test definition for debugging.</p><p>Such port forwardings connect via the VM’s virtual network interface.
Thus they cannot connect to ports that are only bound to the VM’s
loopback interface (<code class="literal">127.0.0.1</code>), and the VM’s NixOS firewall
must be configured to allow these connections.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-reuse-vm-state" class="title">Reuse VM state   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-reuse-vm-state" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>You can re-use the VM states coming from a previous run by setting the
<code class="literal">--keep-vm-state</code> flag.</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">./result/bin/nixos-test-driver --keep-vm-state</span>
</code></pre><p>The machine state is stored in the <code class="literal">$TMPDIR/vm-state-machinename</code>
directory.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h3 id="sec-nixos-test-interactive-configuration" class="title">Interactive-only test configuration   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-nixos-test-interactive-configuration" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h3>  </div> </div></div><p>The <code class="literal">.driverInteractive</code> attribute combines the regular test configuration with
definitions from the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-interactive"><code class="literal">interactive</code> submodule</a>. This gives you
a more usable, graphical, but slightly different configuration.</p><p>You can add your own interactive-only test configuration by adding extra
configuration to the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-interactive"><code class="literal">interactive</code> submodule</a>.</p><p>To interactively run only the regular configuration, build the <code class="literal">&lt;test&gt;.driver</code> attribute
instead, and call it with the flag <code class="literal">result/bin/nixos-test-driver --interactive</code>.</p>
</div>

</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-linking-nixos-tests-to-packages" class="title" style="clear: both">Linking NixOS tests to packages   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-linking-nixos-tests-to-packages" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>You can link NixOS module tests to the packages that they exercised,
so that the tests can be run automatically during code review when the package gets changed.
This is
<a class="link" href="https://nixos.org/manual/nixpkgs/stable/#ssec-nixos-tests-linking" target="_top">described in the nixpkgs manual</a>.</p>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="chap-developing-the-test-driver" class="title">Developing the NixOS Test Driver   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#chap-developing-the-test-driver" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-test-the-test-framework">Testing changes to the test framework</a> </span></dt> </dl></div><p>The NixOS test framework is a project of its own.</p><p>It consists of roughly the following components:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nixos/lib/test-driver</code>: The Python framework that sets up the test and runs the <a class="link" href="https://nixos.org/manual/nixos/stable/#test-opt-testScript"><code class="literal">testScript</code></a></p></li><li class="listitem"><p><code class="literal">nixos/lib/testing</code>: The Nix code responsible for the wiring, written using the (NixOS) Module System.</p></li></ul></div><p>These components are exposed publicly through:</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">nixos/lib/default.nix</code>: The public interface that exposes the <code class="literal">nixos/lib/testing</code> entrypoint.</p></li><li class="listitem"><p><code class="literal">flake.nix</code>: Exposes the <code class="literal">lib.nixos</code>, including the public test interface.</p></li></ul></div><p>Beyond the test driver itself, its integration into NixOS and Nixpkgs is important.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p><code class="literal">pkgs/top-level/all-packages.nix</code>: Defines the <code class="literal">nixosTests</code> attribute, used
by the package <code class="literal">tests</code> attributes and OfBorg.</p></li><li class="listitem"><p><code class="literal">nixos/release.nix</code>: Defines the <code class="literal">tests</code> attribute built by Hydra, independently, but analogous to <code class="literal">nixosTests</code></p></li><li class="listitem"><p><code class="literal">nixos/release-combined.nix</code>: Defines which tests are channel blockers.</p></li></ul></div><p>Finally, we have legacy entrypoints that users should move away from, but are cared for on a best effort basis.
These include <code class="literal">pkgs.nixosTest</code>, <code class="literal">testing-python.nix</code> and <code class="literal">make-test-python.nix</code>.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="sec-test-the-test-framework" class="title" style="clear: both">Testing changes to the test framework   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-test-the-test-framework" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>We currently have limited unit tests for the framework itself. You may run these with <code class="literal">nix-build -A nixosTests.nixos-test-driver</code>.</p><p>When making significant changes to the test framework, we run the tests on Hydra, to avoid disrupting the larger NixOS project.</p><p>For this, we use the <code class="literal">python-test-refactoring</code> branch in the <code class="literal">NixOS/nixpkgs</code> repository, and its <a class="link" href="https://hydra.nixos.org/jobset/nixos/python-test-refactoring" target="_top">corresponding Hydra jobset</a>.
This branch is used as a pointer, and not as a feature branch.</p><div class="orderedlist"><ol class="orderedlist compact" type="1"><li class="listitem"><p>Rebase the PR onto a recent, good evaluation of <code class="literal">nixos-unstable</code></p></li><li class="listitem"><p>Create a baseline evaluation by force-pushing this revision of <code class="literal">nixos-unstable</code> to <code class="literal">python-test-refactoring</code>.</p></li><li class="listitem"><p>Note the evaluation number (we’ll call it <code class="literal">&lt;previous&gt;</code>)</p></li><li class="listitem"><p>Push the PR to <code class="literal">python-test-refactoring</code> and evaluate the PR on Hydra</p></li><li class="listitem"><p>Create a comparison URL by navigating to the latest build of the PR and adding to the URL <code class="literal">?compare=&lt;previous&gt;</code>. This is not necessary for the evaluation that comes right after the baseline.</p></li></ol></div><p>Review the removed tests and newly failed tests using the constructed URL; otherwise you will accidentally compare iterations of the PR instead of changes to the PR base.</p><p>As we currently have some flaky tests, newly failing tests are expected, but should be reviewed to make sure that</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>The number of failures did not increase significantly.</p></li><li class="listitem"><p>All failures that do occur can reasonably be assumed to fail for a different reason than the changes.</p></li></ul></div>
</div>

</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h2 id="ch-testing-installer" class="title">Testing the Installer   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ch-testing-installer" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Building, burning, and booting from an installation CD is rather
tedious, so here is a quick way to see if the installer works properly:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_"># </span><span class="language-bash">mount -t tmpfs none /mnt</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">nixos-generate-config --root /mnt</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build <span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span> -A config.system.build.nixos-install</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">./result/bin/nixos-install</span>
</code></pre><p>To start a login shell in the new NixOS installation in <code class="literal">/mnt</code>:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build <span class="hljs-string">'&lt;nixpkgs/nixos&gt;'</span> -A config.system.build.nixos-enter</span>
<span class="hljs-meta prompt_"># </span><span class="language-bash">./result/bin/nixos-enter</span>
</code></pre>
</div>
</div><div class="chapter"> <div class="titlepage">  <div>   <div>    <h1 id="chap-contributing" class="title">Contributing to this manual   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#chap-contributing" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><div class="toc"> <p><strong>Table of Contents</strong></p> <dl class="toc">  <dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-contributing-options">Contributing to the <code class="literal">configuration.nix</code> options documentation</a> </span></dt><dt> <span class="section">  <a href="https://nixos.org/manual/nixos/stable/#sec-contributing-nixos-tools">Contributing to <code class="literal">nixos-*</code> tools’ manpages</a> </span></dt> </dl></div><p>The [DocBook] and CommonMark sources of the NixOS manual are in the <a class="link" href="https://github.com/NixOS/nixpkgs/tree/master/nixos/doc/manual" target="_top">nixos/doc/manual</a> subdirectory of the <a class="link" href="https://github.com/NixOS/nixpkgs" target="_top">Nixpkgs</a> repository.
This manual uses the <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-markup" target="_top">Nixpkgs manual syntax</a>.</p><p>You can quickly check your edits with the following:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /path/to/nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-variable">$EDITOR</span> doc/nixos/manual/... <span class="hljs-comment"># edit the manual</span></span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build nixos/release.nix -A manual.x86_64-linux</span>
</code></pre><p>If the build succeeds, the manual will be in <code class="literal">./result/share/doc/nixos/index.html</code>.</p><p>There’s also <a class="link" href="https://nixos.org/manual/nixpkgs/unstable/#sec-contributing-devmode" target="_top">a convenient development daemon</a>.</p><p>The above instructions don’t deal with the appendix of available <code class="literal">configuration.nix</code> options, and the manual pages related to NixOS. These are built, and written in a different location and in a different format, as explained in the next sections.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="sec-contributing-options" class="title" style="clear: both">Contributing to the <code class="literal">configuration.nix</code> options documentation   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-contributing-options" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><p>The documentation for all the different <code class="literal">configuration.nix</code> options is automatically generated by reading the <code class="literal">description</code>s of all the NixOS options defined at <code class="literal">nixos/modules/</code>. If you want to improve such <code class="literal">description</code>, find it in the <code class="literal">nixos/modules/</code> directory, and edit it and open a pull request.</p><p>To see how your changes render on the web, run again:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build nixos/release.nix -A manual.x86_64-linux</span>
</code></pre><p>And you’ll see the changes to the appendix in the path <code class="literal">result/share/doc/nixos/options.html</code>.</p><p>You can also build only the <code class="literal">configuration.nix(5)</code> manual page, via:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">cd</span> /path/to/nixpkgs</span>
<span class="hljs-meta prompt_">$ </span><span class="language-bash">nix-build nixos/release.nix -A nixos-configuration-reference-manpage.x86_64-linux</span>
</code></pre><p>And observe the result via:</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">man --local-file result/share/man/man5/configuration.nix.5</span>
</code></pre><p>If you’re on a different architecture that’s supported by NixOS (check file <code class="literal">nixos/release.nix</code> on Nixpkgs’ repository) then replace <code class="literal">x86_64-linux</code> with the architecture. <code class="literal">nix-build</code> will complain otherwise, but should also tell you which architecture you have + the supported ones.</p>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h1 id="sec-contributing-nixos-tools" class="title" style="clear: both">Contributing to <code class="literal">nixos-*</code> tools’ manpages   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#sec-contributing-nixos-tools" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h1>  </div> </div></div><p>The manual pages for the tools available in the installation image can be found in Nixpkgs by running (e.g for <code class="literal">nixos-rebuild</code>):</p><pre><code class="programlisting ShellSession hljs language-ShellSession" data-highlighted="yes"><span class="hljs-meta prompt_">$ </span><span class="language-bash">git <span class="hljs-built_in">ls</span> | grep nixos-rebuild.8</span>
</code></pre><p>Man pages are written in <a class="link" href="https://mandoc.bsd.lv/man/mdoc.7.html" target="_top"><code class="literal">mdoc(7)</code> format</a> and should be portable between mandoc and groff for rendering (except for minor differences, notably different spacing rules.)</p><p>For a preview, run <code class="literal">man --local-file path/to/file.8</code>.</p><p>Being written in <code class="literal">mdoc</code>, these manpages use semantic markup. This following subsections provides a guideline on where to apply which semantic elements.</p><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-cli-and-args" class="title" style="clear: both">Command lines and arguments   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-contributing-nixos-tools-cli-and-args" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In any manpage, commands, flags and arguments to the <span class="emphasis"><em>current</em></span> executable should be marked according to their semantics. Commands, flags and arguments passed to <span class="emphasis"><em>other</em></span> executables should not be marked like this and should instead be considered as code examples and marked with <code class="literal">Ql</code>.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>Use <code class="literal">Fl</code> to mark flag arguments, <code class="literal">Ar</code> for their arguments.</p></li><li class="listitem"><p>Repeating arguments should be marked by adding an ellipsis (spelled with periods, <code class="literal">...</code>).</p></li><li class="listitem"><p>Use <code class="literal">Cm</code> to mark literal string arguments, e.g. the <code class="literal">boot</code> command argument passed to <code class="literal">nixos-rebuild</code>.</p></li><li class="listitem"><p>Optional flags or arguments should be marked with <code class="literal">Op</code>. This includes optional repeating arguments.</p></li><li class="listitem"><p>Required flags or arguments should not be marked.</p></li><li class="listitem"><p>Mutually exclusive groups of arguments should be enclosed in curly brackets, preferably created with <code class="literal">Bro</code>/<code class="literal">Brc</code> blocks.</p></li></ul></div><p>When an argument is used in an example it should be marked up with <code class="literal">Ar</code> again to differentiate it from a constant. For example, a command with a <code class="literal">--host name</code> option that calls ssh to retrieve the host’s local time would signify this thusly:</p><pre><code class="programlisting hljs language-undefined" data-highlighted="yes">This will run
.Ic ssh Ar name Ic time
to retrieve the remote time.
</code></pre>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-options-and-environment" class="title" style="clear: both">Paths, NixOS options, environment variables   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-contributing-nixos-tools-options-and-environment" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>Constant paths should be marked with <code class="literal">Pa</code>, NixOS options with <code class="literal">Va</code>, and environment variables with <code class="literal">Ev</code>.</p><p>Generated paths, e.g. <code class="literal">result/bin/run-hostname-vm</code> (where <code class="literal">hostname</code> is a variable or arguments) should be marked as <code class="literal">Ql</code> inline literals with their variable components marked appropriately.</p><div class="itemizedlist"><ul class="itemizedlist compact" style="list-style-type: disc;"><li class="listitem"><p>When <code class="literal">hostname</code> refers to an argument, it becomes <code class="literal">.Ql result/bin/run- Ns Ar hostname Ns -vm</code></p></li><li class="listitem"><p>When <code class="literal">hostname</code> refers to a variable, it becomes <code class="literal">.Ql result/bin/run- Ns Va hostname Ns -vm</code></p></li></ul></div>
</div><div class="section"> <div class="titlepage">  <div>   <div>    <h2 id="ssec-contributing-nixos-tools-code-examples" class="title" style="clear: both">Code examples and other commands   <a class="anchorjs-link " aria-label="Anchor" data-anchorjs-icon="" href="https://nixos.org/manual/nixos/stable/#ssec-contributing-nixos-tools-code-examples" style="font: 1em / 1 anchorjs-icons; margin-left: 0.1875em; padding-right: 0.1875em; padding-left: 0.1875em;"></a></h2>  </div> </div></div><p>In free text names and complete invocations of other commands (e.g. <code class="literal">ssh</code> or <code class="literal">tar -xvf src.tar</code>) should be marked with <code class="literal">Ic</code>, fragments of command lines should be marked with <code class="literal">Ql</code>.</p><p>Larger code blocks or those that cannot be shown inline should use indented literal display block markup for their contents, i.e.</p><pre><code class="programlisting hljs language-undefined" data-highlighted="yes">.Bd -literal -offset indent
...
.Ed
</code></pre><p>Contents of code blocks may be marked up further, e.g. if they refer to arguments that will be substituted into them:</p><pre><code class="programlisting hljs language-nix" data-highlighted="yes">.Bd -literal -offset indent
{
  config.networking.<span class="hljs-attr">hostname</span> = <span class="hljs-string">"\c
.Ar hostname Ns \c
"</span>;
}
.Ed
</code></pre>
</div>

</div>

</div>
 </div>
  <div class="navfooter">
   <hr>
   <table width="100%" summary="Navigation footer">
    <tbody><tr>
    <td width="40%" align="left">&nbsp;</td>
    <td width="20%" align="center">&nbsp;</td>
    <td width="40%" align="right">&nbsp;<a accesskey="n" href="https://nixos.org/manual/nixos/stable/options">Next</a></td>
    </tr>
    <tr>
     <td width="40%" align="left" valign="top">&nbsp;</td>
     <td width="20%" align="center">&nbsp;</td>
     <td width="40%" align="right" valign="top">&nbsp;Appendix&nbsp;A.&nbsp;Configuration Options</td>
    </tr>
   </tbody></table>
  </div>
 
  <script src="./NixOS Manual_files/manual-version-switch.js"></script><div style="background: #333333;color: #FFFFFF;padding: 0.5em 1em;position: fixed;bottom: 0.5em;right: 0.5em;font-size: 0.8em;"><div style="text-align: right;cursor: pointer;"><span>v: stable</span> <strong aria-hidden="true">＋</strong><strong style="display: none;" aria-hidden="true">－</strong></div><dl style="width: 240px;margin: 0 0 1em 0;display: none;"><dt style="color: #999999;">Channels:</dt><dd style="display: inline-block;margin-left: 1em;"><a style="color: #FFFFFF;font-weight: bold;text-decoration: none;" href="https://nixos.org/manual/nixos/unstable">unstable (24.05)</a></dd><dd style="display: inline-block;margin-left: 1em;"><a style="color: #FFFFFF;font-weight: bold;text-decoration: none;" href="https://nixos.org/manual/nixos/stable">stable (23.11)</a></dd></dl></div>

</body></html>